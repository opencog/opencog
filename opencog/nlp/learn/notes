
Working Notes
-------------
This file contains a diary of random working notes, which I use to keep
track of what the heck it is that I'm doing.  It is almost surely totally
useless to you, except maybe for some weird voyeuristic reasons.

======================================================================
Jan-Feb 2014

Performance
-----------
Performance seems to suck:
-- two parsers, each takes maybe 4% cpu time total. Load avg of about 0.03
-- each parser runs 4 async write threads pushing atoms to postgres.
   each one complains about it taking too long to flush the write queues.
-- postmaster is running 10 threads, load-avg of about 2.00  so about
   2 cpu's at 100%
-- vmstat shows 500 blks per second written. This is low...
-- top shows maybe 0.2% wait state. So its not disk-bound.
-- what is taking so long?

So, take a tcpdump:
-- a typical tcpdump packet:
   UPDATE Atoms SET tv_type = 2, stv_mean = 0 , stv_confidence = 0, stv_count = 54036 WHERE uuid = 367785;
   its maybe 226 bytes long.
-- this gets one response from server, about 96 bytes long.
-- then one more req, one more repsonse, seems to be a 'were'done' mesg
   or something ...  which I guess is due to SQLFreeHandle(SQL_HANDLE_STMT ???
-- time delta in seconds, of tcpdump of traffic packets, between update, and
   response from server:
   0.0006  0.0002 0.0002 0.0002 0.028 (yow!!) 0.001 0.0002

-- so it looks like about every 8-10 packets are replied to fairly quick,
   then there's one that takes 0.025 seconds to reply.... stair-steps in
   response time like this all the way through the capture.

Wild guess:
-- Hmm ... this seems to be related to the commit delay in postgresql.conf
   Change commit_delay to 1 second
   change wal_bufers to 32MB since its mostly update traffic.
   change checkpoint_segments to 32 (each one takes up 16MB of disk space.)

-- Making these changes has no obvious effect ... bummer.

I don't get it; performance sucks and I don't see why.  Or rather: postmaster
is chewing up vast amounts of cpu time for no apparent reason...


select * from pg_stat_user_tables;
select * from pg_stat_all_tables;
select * from pg_statio_user_tables;
select * from pg_database;

pg_stat_user_indexes
pg_stat_all_indexes

select * from pg_catalog.pg_stat_activity;
select * from pg_catalog.pg_locks;


-- WOW!!!   VACUUM ANALYZE; had a huge effect!!

-- vacuum tells em to do following:
   change max_fsm_pages to 600K
   chage max_fsm_relations to 10K

Anyway ... performance measured as of 27 Dec 2013:

Takes about 105 millisecs to clear 90 eval-links from the write-back
queues. This each eval-link is 5 atoms (eval, defind, list, word, word)
so this works out to 5*90 atoms /0.105 seconds = 4.3KAtoms/sec
which is still pretty pathetic...

gdb:
---
handle SIGPWR nostop noprint
handle SIGXCPU nostop noprint


How about using a reader-writer lock?
----------------------------------

boost::shared_lock  for reading,
unique_lock for writing ...

upgrade_lock<shared_mutex> lock(workerAccess);
        upgrade_to_unique_lock<shared_mutex> uniqueLock(lock);


shared_mutex
write uses:  unique_lock<shared_mutex>
readers use shared_lock<shared_mutex>

writer does:

  // get upgradable access
  boost::upgrade_lock<boost::shared_mutex> lock(_access);

  // get exclusive access
  boost::upgrade_to_unique_lock<boost::shared_mutex> uniqueLock(lock);
  // now we have exclusive access
}

am using boost-1.49 on cray

======================================================================
======================================================================

31 Dec 2016
-----------

psql en_pairs
\dt

select count(*) from atoms;
 18487291

loadmodule libPersistModule.so

sql-open learn-pairs linas asdf
sql-open en-pairs linas asdf

password authentication failed for user "linas"

sql-open opencog_test opencog_tester cheese

/etc/postgresql/9.6/main/pg_hba.conf looks OK...

So: I have en_pairs and 
 opencog_test | linas    | UTF8     | en_US.UTF-8 | en_US.UTF-8 | 
but the owner of the tables is opencog_tester

/var/log/postgresql/postgresql-9.6-main.log

2017-01-03 16:15:50 CST [2856-1] linas@en_pairs FATAL:  password authentication
failed for user "linas"
2017-01-03 16:15:50 CST [2856-2] linas@en_pairs DETAIL:  User "linas" has no password
assigned.


2017-01-01 17:20:54 CST [4829-1] opencog_tester@opencog_test ERROR:  insert or update
on table "atoms" violates foreign key constraint "atoms_space_fkey"
2017-01-01 17:20:54 CST [4829-2] opencog_tester@opencog_test DETAIL:  Key (space)=(2)
is not present in table "spaces".

(use-modules (opencog persist-sql))
(sql-open "en-pairs" "learner" "asdf")

\du
alter user learner password 'asdf';
grant CONNECT ON DATABASE en_pairs to learner;
grant SELECT,INSERT,UPDATE on table atoms to learner;

sql-open en-pairs learner asdf

it worked!
(sql-load)

18 million atoms

Loaded 9045489 atoms at height 2
Finished loading 18487291 atoms in total
12:35 to load .. !? 18487291 atoms/755 secs = 24.5K atoms/sec

psql -h localhost -U ubuntu lt_pairs 

ALTER USER ubuntu PASSWORD 'asdf';

========================================================
-----------------------------------------
lxc -- create an all-updated opencog-base

lxc-start -n opencog-base --daemon

time lxc-copy -n  opencog-learn -N learn-lt

------------------------------------
4 Jan 2016
----------
https://dumps.wikimedia.org/zhwiki/20170101/
https://dumps.wikimedia.org/zh_yuewiki/20170101/
https://dumps.wikimedia.org/frwiki/20170101/

lynx https://dumps.wikimedia.org/ltwiki/20170101/ltwiki-20170101-pages-articles-multistream.xml.bz2

time cat ltwiki-20170101-pages-articles-multistream.xml.bz2 |bunzip2 |/home/ubuntu/src/relex/src/perl/wiki-scrub.pl
real	4m58.871s
user	5m35.652s
sys	0m11.700s

find |wc gives 209011 total articles
find |wc gives 178514 after cat/template removal

createdb lt_pairs
createdb lt_morph
cat opencog/persist/sql/odbc/atom.sql | psql lt_pairs
cat opencog/persist/sql/odbc/atom.sql | psql lt_morph

=============================================================

time cat zh_yuewiki-20170101-pages-articles.xml.bz2 |bunzip2 |/home/ubuntu/src/relex/src/perl/wiki-scrub.pl

about 48 seconds
find |wc gives 67363 total articles
find |wc gives 49170 after cat/template removal

apt-get install fonts-arphic-ukai fonts-arphic-uming fonts-babelstone-han
fonts-wqy-zenhei fonts-hanazono

fonts-arphic-bkai00mp
fonts-arphic-bsmi00lp
fonts-arphic-gbsn00lp
fonts-arphic-gkai00mp

Arghh. None of the above provide the Kangxi radicals for the terminal.
Which I think are coming from fonts-wqy-microhei

U+2F13  Kangxi Radicals,

U+42AA  U+4401   CJK_Ext_A  CJK-Ext.A

createdb yue_pairs

cd ~/src/atomspace
cat opencog/persist/sql/odbc/atom.sql | psql yue_pairs

。。

\p{Block: CJK}   
\p{Block=CJK_Symbols_And_Punctuation} 
\p{Punct}
\p{InCJK}) 
\p{Close_Punctuation}   aka \p{Pe}   (close parent)
 \p{Final_Punctuation}   aka \p{Pf})  more quote-close or open.. things
\p{Ps} open quote


full stop

relex-server-port relex-server-host


; -- count-all -- Return the total number of atoms in the atomspace.
; -- cog-get-atoms -- Return a list of all atoms of type 'atom-type'
; -- cog-prt-atomspace -- Prints all atoms in the atomspace
; -- cog-count-atoms -- Count of the number of atoms of given type.
; -- cog-report-counts -- Return an association list of counts.


wtf 
(define (foo atom) (display "duude\n")(display atom) (newline) #f) 

WARNING: No known abbreviations for language 'yue', attempting fall-back
to English version..    FIXED

odbc is still logging! FIXED
CommLog           = No in /etc/odbcinst.ini

don't use "foo", it prints a warning .. better yet, don't warn! FIXED


below is due to bug opencog/relex#248 and is now fixed.
It  needed a new link-grammar version
link-grammar: Error: EMPTY-WORD.zzz must be defined!

link-grammar: Error: Word 'EMPTY-WORDzzz': Internal error: NULL X_node

link-grammar: Error: sentence_split(): Internal error detected
Warning: No parses found for:
港 區 全 國 人 大 代 表 係 代 表 香 港 居 民 響 中 華 人 民 共 和 國 全 國 人 民 代 表 大 會 行 使 國 家 立 法 權 嘅 代 表 ， 名 額 36 人 （1997 年 香 港 主 權 移 交 之 後 ）。


link-grammar: Error: EMPTY-WORD.zzz must be defined!

link-grammar: Error: Word 'EMPTY-WORDzzz': Internal error: NULL X_node

link-grammar: Error: sentence_split(): Internal error detected
Warning: No parses found for:
深 圳 習 慣 叫 特 區 範 圍 做 「 關 內 」， 而 特 區 範 圍 之 外 嘅 ，
包 括 寶 安 區 、 龍 崗 區 同 光 明 新 區 、 坪 山 新 區 就 叫 「 關 外
」； 由 「 關 外 」 入 特 區 叫 「 入 關 」， 反 之 係 「 出 關 」。

<title>永利街</title>  contains junk yest it does...


Started 5 Jan 2017 16:00 exactly.
ten minutes later: 5048 atoms -- so 500 atoms per minute...
after some halts and hiccups:
2211 articles after 1 hour = 37 articles/minute
18529 atoms after about 1 hour ...
or about 8.4 atoms per article... 

There are only about 48K articles, so it should conclude in 24 hours
...!?

hours later... 219127 atoms 6345 articles done ...
Now its about 34.5 atoms per article.. whoa ... 

java claims to have parsed 12424 sentences
11459 articles processed.
457009 atoms


29291 articles processed 19919 remaining
668042 atoms ...


; -- cog-report-counts -- Return an association list of counts.

(count-all)
(cog-report-counts)
(gc-stats)

... ram usage slowly increasing...

 (gc-stats)
((gc-time-taken . 315428672862) (heap-size . 3479842816) (heap-free-size
. 1406132224) (heap-total-allocated . 132540491040)
(heap-allocated-since-gc . 906048240) (protected-objects . 500)
(gc-times . 414))

(gc-stats)
((gc-time-taken . 327615529234) (heap-size . 3582787584) (heap-free-size
. 1584795648) (heap-total-allocated . 138942040624)
(heap-allocated-since-gc . 1123554048) (protected-objects . 500)
(gc-times . 422))

((gc-time-taken . 491224665617) (heap-size . 4601581568) (heap-free-size
. 2257489920) (heap-total-allocated . 211782122608)
(heap-allocated-since-gc . 399939472) (protected-objects . 500)
(gc-times . 485))


if (number-of-cells-collected-recently < GUILE_MIN_YIELD_X)
  then
    allocate-new-heap
  else
    run-a-collection

`scm_i_gc_grow_heap_p ()' and `scm_gc_for_newcell ()'.)


(WordSequenceLink lots of these ... 


 gcprof procedure in the statprof library
https://www.gnu.org/software/guile/manual/html_node/Statprof.html

guile-yue> (statprof-display)
%     cumulative   self             self     total             
time   seconds    seconds  calls    ms/call  ms/call       name
 49.18  11506.88  11506.88   13516   851.35   851.35  inc
  4.92  23397.33   1150.69      27 42618.08 866567.64  catch
  4.92  12657.57   1150.69     215  5352.04 58872.42  cog-map-type
  3.28    767.13    767.13    1420   540.23   540.23  char=?
  3.28    767.13    767.13     619  1239.30  1239.30  write-char
  3.28    767.13    767.13     372  2062.17  2062.17  memq
  3.28    767.13    767.13     182  4214.97  4214.97  call-with-output-string
  1.64   2684.94    383.56     182  2107.49 14752.41  tilde-dispatch
  1.64    383.56    383.56      29 13226.30 13226.30  close-port
  1.64    383.56    383.56     240  1598.18  1598.18  assv-ref
...
  0.00  12657.57      0.00     215     0.00 58872.42  cog-count-atoms

above over about 24K seconds total, so accurate... ish

(use-modules (statprof))
(statprof-reset 0 50000 #t) ;
(statprof-start)
(do-something)
(statprof-stop)
(statprof-display)
(gcprof (λ () (observe-text "1769 年 ： 伊 萬 克 雷 洛 夫 ， 俄 國 寓 言 作 家 1910 年 ： 威 廉  肖 克 利 （William Shockley）， 美 國 物 理 學 家 ， 有 份 發 明 半 導 體 ，1956 年 諾 貝 爾 物 理 獎 得 主 1915 年 ： 昂 山 ， 緬 甸 國 父 1921 年 ： 趙 無 極 ， 法 國 華 裔 畫 家 1974 年 ：Robbie Williams， 英 國 歌 手 1974 年 ： 馬 國 明 ， 香 港 無 綫 電 視 演 員 1981 年 ： 何 紫 綸 ， 香 港 模 特 兒 1990 年 ： 西 藏 第 十 一 世 班 禪 額 爾 德 尼 金 瑞 瑤 ， 台 灣 音 樂 經 理 人 1993 年 ： 宋 希 濂 ， 抗 日 戰 爭 同 國 共 內 戰 時 期 中 國 國 民 黨 將 軍 2006 年 ： 王 選 ， 中 國 計 算 機 學 者 ， 發 明 漢 字 激 光 照 排 技 術")))

Maybe use it in "observe-text"? ...

total time is correct...
... its a thread thing. staprof with threads is borked.
See comments in ./module/statprof.scm ~ Implementation notes ~


compute-mi.scm:		(for-each inc atom-list)
compute-mi.scm:		(define (inc atom) (set! cnt (+ cnt (tv-count
(cog-tv atom)))))

Maybe lots and lots of threads ... ? Seems to get very backed-up.
No .. only 14 threads

(hash-map->list cons (module-obarray (current-module)))

(module-map (λ (sym var) sym) (resolve-interface '(guile)))
(module-map (λ (sym var) sym) (resolve-interface '(opencog)))
(module-map (λ (sym var) sym) (resolve-interface '(opencog learn)))

who is using a module?
(module-uses (resolve-module '(guile-user)))

>>>> excellent for modules!
http://git.net/ml/guile-user-gnu/2016-06/msg00040.html

101000   26627  256 11.9 15129736 11795708 pts/6 Sl+ 18:41 516:33 guile
-l pair-count-yue.scm


not being split: FIXED.
fix is
$text =~ s/([\.?!]) *(\p{InCJK})/$1\n$2/g;

呢度啲路順序係從南去到北嚟排列嘅，其中加粗咗嘅字係主幹道：美華北路.新河浦二橫路.新河浦五橫路.新慶路.煙墩路、寺右新馬路.寺貝通津.共和大街.松崗東.共和西路.中山一路.

2012年，《向前走向愛走》.第四十五屆金鐘獎個人獎戲劇節目女主角獎.郭采潔官方網站.


No database persistant storage configured! Use the STORAGE config
keyword to define.

Java gets slower and slower

=========================

replace call to scm_gc_register_collectable_memory by call to 
scm_gc_register_allocation(size)


whoa --- 
GC Warning: Repeated allocation of very large block (appr. size 27369472):
        May lead to memory leak and poor performance.
GC Warning: Repeated allocation of very large block (appr. size 28766208):
        May lead to memory leak and poor performance.
Loaded 280000 atoms.
GC Warning: Repeated allocation of very large block (appr. size 28766208):
        May lead to memory leak and poor performance.
GC Warning: Repeated allocation of very large block (appr. size 28766208):
        May lead to memory leak and poor performance.
        Loaded 270000 atoms.
GC Warning: Repeated allocation of very large block (appr. size 28766208):
        May lead to memory leak and poor performance.
GC Warning: Repeated allocation of very large block (appr. size 14385152):
        May lead to memory leak and poor performance.
        Loaded 260000 atoms.

================================

fresh, guile-2.0
 (gc-stats)
$6 = ((gc-time-taken . 114568428) (heap-size . 14409728) (heap-free-size .
2711552) (heap-total-allocated . 18881904) (heap-allocated-since-gc .
1054528) (protected-objects . 137) (gc-times . 14))

after half-minute:
(gc-stats)
((gc-time-taken . 7534031063) (heap-size . 19734528) (heap-free-size
. 5259264) (heap-total-allocated . 939889168) (heap-allocated-since-gc .
1657120) (protected-objects . 143) (gc-times . 326))
guile> foo
(ConceptNode "foo" (ctv 0 0 2520410))

 6861 101000    20   0  735404  42952  16680 R 109.9  0.0  14:33.40 guile       
 6861 101000    20   0  735404  42952  16680 R 114.5  0.0  44:35.68 guile       


(gc-stats)
((gc-time-taken . 148069551756) (heap-size . 19734528) (heap-free-size .
2740224) (heap-total-allocated . 28219212944) (heap-allocated-since-gc .
790384) (protected-objects . 143) (gc-times . 4930))
guile> foo
(ConceptNode "foo" (ctv 0 0 54310643))


replace call to scm_gc_register_collectable_memory by call to
scm_gc_register_allocation(size)


   static std::atomic<size_t> _tv_pend_cnt;
   static std::atomic<size_t> _tv_total_cnt;
   static std::atomic<size_t> _tv_pend_sz;
   static std::atomic<size_t> _tv_total_sz;


(define (inc atom) (cog-set-tv! atom (cog-new-ctv 0 0 (+ 1 (tv-count (cog-tv
atom))))))
scheme@(guile-user)> 
scheme@(guile-user)> (define foo (Concept "foo"))
scheme@(guile-user)> (define (loo) (inc foo) (loo))
scheme@(guile-user)> (loo)
duuude its pend cnt=11425 (274200) tot=1400000 (33600000)
duuude its pend cnt=14379 (345096) tot=1500000 (36000000)
duuude its pend cnt=15600 (374400) tot=2200000 (52800000)

duuude its pend cnt=8047 (193128) tot=48300000 (1159200000)
duuude its pend cnt=1230 (29520) tot=49300000 (1183200000)
duuude its pend cnt=12432 (298368) tot=49400000 (1185600000)
duuude its pend cnt=19857 (476568) tot=50000000 (1200000000)
(gc-stats)
((gc-time-taken . 54370538078) (heap-size . 10948608) (heap-free-size . 1925120)
(heap-total-allocated . 8532174704) (heap-allocated-since-gc . 10336)
(protected-objects . 7) (gc-times . 2051))
guile-yue> foo
(ConceptNode "foo" (ctv 0 0 26737610))
 4617 linas     20   0  847596  50284  27072 R 133.2  0.1   5:26.89 guile       

(ConceptNode "foo" (ctv 0 0 46416463))
duuude its pend cnt=20565 (493560) tot=94300000 (2263200000)

so -- 46M incrs but 94M take-tvs -- so two takes for each incr.
-- one to get the value, one to set the value.


 4617 linas     20   0  847584  50612  27156 R 135.2  0.1  23:46.94 guile       

(define (rate)
(define shu (Concept "shu"))
(define cnt 0)
(define start (- (current-time) 0.1))
(define (finc atom) 
	(if (eq? 0 (modulo cnt 100000))
		(begin (display "rate=")
		(display (/ cnt (- (current-time) start))) (newline)))
	(set! cnt (+ cnt 1))
	(cog-set-tv! atom (cog-new-ctv 0 0 (+ 1 (tv-count (cog-tv atom))))))

(define (floo) (finc shu) (floo))
(floo)
)

(define (inc atom) (cog-set-tv! atom (cog-new-ctv 0 0 (+ 1 (tv-count (cog-tv atom))))))

(define foo (Concept "foo"))
(define (loo) (inc foo) (loo))

(statprof-stop)
(statprof-display)


with the atomics: rate == about 145.5K/sec
without the atomics: about 103.2K/sec !!
again with atomics: rate == 125K/sec !! wtf .. why not as high as before?
stop restart, rate=130K ...
stop restart - rate= 107K ... wtf
stop, restart = 109K
stop restart = 107K   glargle
again --- without atomics:
rate = 147K   dafuq
stop restart = 151K
stop restart = 79K   crazy shit
stop restart = 141K  this is so not making sense, except as a
crazy cache-line issue.


clean start: without atomics
(gc-stats)
((gc-time-taken . 845338507) (heap-size . 5963776) (heap-free-size . 421888)
(heap-total-allocated . 73153424) (heap-allocated-since-gc . 902704)
(protected-objects . 7) (gc-times . 65))

(gc-stats)
((gc-time-taken . 605534396784) (heap-size . 6025216) (heap-free-size . 356352)
(heap-total-allocated . 29673578224) (heap-allocated-since-gc . 361904)
(protected-objects . 7) (gc-times . 32428))

no growth at all.


OK, so ... a leak in sql?
a leak in TLB!! ... no because that doesn't explain guile heap...
unless guile heap is confused...

on startup:
(gc-stats)
$1 = ((gc-time-taken . 170774772) (heap-size . 15364096) (heap-free-size .
3166208) (heap-total-allocated . 18421440) (heap-allocated-since-gc .
770768) (protected-objects . 149) (gc-times . 15))

 wtf .. why no printing?


_tv_pend_cnt++;
_tv_pend_sz += sizeof(*tv);

// _tv_total_cnt++;
_tv_total_sz += sizeof(*tv);

if (0 == ((size_t) (_tv_total_cnt.fetch_add(1))) % 100000) {
printf("duuude its pend cnt=%lu (%lu) tot=%lu (%lu)\n",
(size_t) _tv_pend_cnt, (size_t) _tv_pend_sz, (size_t) _tv_total_cnt,
(size_t) _tv_total_sz);
logger().info("duuude its pend cnt=%lu (%lu) tot=%lu (%lu)",
(size_t) _tv_pend_cnt, (size_t) _tv_pend_sz, (size_t) _tv_total_cnt,
(size_t) _tv_total_sz);
}


OK, so its not the TV ... (not the TV in guile gc)

So maybe its prim environ?? Nooo not that either
Maybe handles?? (in guile) no its not that. (not in guile gc)

 well, its not the TLB...
and not the atoms ... TLB has 400K entries, with 18MB of pairs
atoms allocated are 466286 for 63414896 = 63MBytes but guile is
1.6GB resident, 9.3GB virt.... wtf...

each atom is 136 MB ex tv.

2.9 gb resident, but 1.6M atoms for 215MB size, and 64MB of tlb contents
what about atomspace?  only 19922 atoms in atomspace...
heap size is 2GB ... 

Maybe stub out capture-stack? it was the cuplrit before...
Nope seems to make no difference.

are we leaking SCM values somwhere?  How?

misc_to_string ?  no, code audit.
scm_to_utf8_string   no, code audit...

--------------------------------------------------------------
try guile-2.2 from git
Great. that seg-faults... maybe some other version doesn't ...
try 2.1.5 ? 2.1.4 ?   No, because even though it segfaulted
it did seem to also grow.

Seg-faults twice in a row, within 10 minutes wall-clock time
(about 36 mins cpu time).

---------------------------------------------------------------

Try below. ... It does not leak.

(use-modules (opencog) (opencog cogserver))
(start-cogserver)

(define (slu)
(define cnt 0)
(define start (- (current-time) 0.1))
(define (mka) 
	(if (eq? 0 (modulo cnt 100000))
		(begin (display "rate=")
		(display (/ cnt (- (current-time) start))) (newline)
		(cog-map-type (lambda (ato) (cog-extract ato) #f) 'ListLink)
		(cog-map-type (lambda (ato) (cog-extract ato) #f) 'ConceptNode)
	))
	(set! cnt (+ cnt 1))
	(ListLink
		(ConceptNode (string-append "concepto " (number->string cnt )))
		(ConceptNode (string-append "glorg " (number->string cnt )))))

(define (aloo) (mka) (aloo))
(aloo)
)

(count-all)
(cog-report-counts)

(gc-stats)
((gc-time-taken . 6660684289) (heap-size . 15646720) (heap-free-size . 3055616)
(heap-total-allocated . 861940880) (heap-allocated-since-gc . 5203440)
(protected-objects . 7) (gc-times . 298))

((gc-time-taken . 15414762477) (heap-size . 16101376) (heap-free-size . 2859008)
(heap-total-allocated . 2665977008) (heap-allocated-since-gc . 5064624)
(protected-objects . 7) (gc-times . 562))

rate=47.3K  (concept only)
rate=15.7K (listlinks+concepts)

---------------------------------------------------------------

/tmp/bang.sh
#!/bin/bash

i=0
while true ; do
  let i=$i+1
  if [ "$(($i % 2000))" -eq "0" ] ; then
    echo loop $i
  fi
  echo '(display ctr)' | nc localhost 17001
  # echo '(NumberNode ctr)' | nc 10.0.3.239 17001
  # echo '(NumberNode' $i ')' | nc 10.0.3.239 17001
  # echo '(NumberNode 42)' | nc localhost 17001
echo '(ConceptNode "fooo ' $i $$ ' you too")' | nc localhost 17001 >> /dev/null

done

run 10 copies of above.
--- no leak   ... and no crash...  so this is very stable. wtf.

---------------------------------------------------------------
OK, so lets try the full pipeline.
but without updates

Whoops. Its blowing up

((gc-time-taken . 8772615322) (heap-size . 820801536) (heap-free-size . 90624000)
(heap-total-allocated . 6508583904) (heap-allocated-since-gc . 84464688)
(protected-objects . 313) (gc-times . 210))

((gc-time-taken . 8772615322) (heap-size . 1179750400) (heap-free-size . 27713536)
(heap-total-allocated . 16069320928) (heap-allocated-since-gc . 339494096)
(protected-objects . 313) (gc-times . 255))


what if we just do one article over and over?
./ss-one.sh yue beta-pages/A-Z/Zyu4 localhost 17006

It blows up.

what if we do one sentence over and over?
(observe-text "係 拉 丁 字 母 同 阿 剌 伯 數 字 串 字")

run it once, goes from (heap-size . 5963776)  to (heap-size . 20996096)
run 10 times: (heap-size . 28332032) 
It still blows up....

without bang.sh

(define (lo)
(define cnt 0)
(define start (- (current-time) 0.1))
(define (mke) 
	(if (eq? 0 (modulo cnt 20))
		(begin (display "rate=")
		(display (/ cnt (- (current-time) start))) (newline)
	))
	(set! cnt (+ cnt 1))
	(observe-text "係 拉 丁 字 母 同 阿 剌 伯 數 字 串 字")
)

(define (aloo) (mke) (aloo))
(aloo)
)

Above is .. wow its stable :
(heap-size . 21184512) (gc-times . 70)
(heap-size . 40243200) (gc-times . 242)
(heap-size . 40243200) (gc-times . 1458)  14:19.43 cpu
(heap-size . 40243200) (gc-times . 2554)  23:48.49 guile 

ssooo .. its something thread-related.  But just having netcat did not do the
trick. ... using java on one thread doesn't trigger it.  Using observe-text
does not trigger it. (ie. relex-parse, etc from one thread.)

do we have zombie threads?

(define x (call-with-new-thread (lambda () (observe-text " 係 拉 丁 字 母 同 阿 剌
伯 數 字 串 字"))))

(define (th)
(define cnt 0)
(define start (- (current-time) 0.1))
(define (thu v) (call-with-new-thread (lambda () 
	(observe-text " 係 拉 丁 字 母 同 阿 剌 伯 數 字 串 字"))))

(define lst (list 1 2 3 4 5 6 7 8 9 0))
(define lst (make-list 10 42))

(define (mke) 
	(define thl (map thu lst))
	(length (all-threads))
	(map join-thread thl)

	(set! cnt (+ cnt 1))
	(display "rate=")
	(display (/ cnt (- (current-time) start))) (newline)
)

(define (aloo) (mke) (aloo))
(aloo)
)

Hmmm ... above is blowing up!  but also .. its not actually threading,
(the atoms stuff is not happening out of order...)
either.   Oh, but it is blowing up ....

(heap-size . 87683072) (gc-times . 4295)
(heap-size . 104460288) (gc-times . 4513)
(heap-size . 255717376) (gc-times . 4884)

OK, full production system with the new guile:
(heap-size . 481013760) (gc-times . 301)
(heap-size . 755843072) (gc-times . 402) 11 minutes CPU
(heap-size . 797286400) (gc-times . 530) 15 mins cpu
(heap-size . 1285570560) (gc-times . 1713) 100 mins CPU
(heap-size . 1546678272) (gc-times . 2251) 140 mins CPU 

but is this really new? It was recompiled, but the version number is
wrong...

Again, full prduction: with guile -v
guile (GNU Guile) 2.1.5.19-7e9395 (8 Jan 2017)

(heap-size . 652918784) (gc-times . 233) ; about 8 mins CPU
(heap-size . 737722368) (gc-times . 339) ; 12 mins CPU
(heap-size . 1332973568) (gc-times . 1797) ; 120 mins CPU
(heap-size . 1441443840) (gc-times . 2221) ; 151 min CPU
(heap-size . 1521213440) (gc-times . 2441) ; 168 min cpu
(heap-size . 1595101184) (gc-times . 3061) ; 218 min cpu
(heap-size . 1726119936) (gc-times . 3292) ; 237 min
(heap-size . 1960865792) (gc-times . 6698) ; 510 minn
(heap-size . 1960865792) (gc-times . 10383) ; 805 min
(heap-size . 2931556352) (gc-times . 14211) ; 1199 min
(heap-size . 3302985728) (gc-times . 23278) ; 2186

 
Much improved: an earlier result was:
(heap-size . 4601581568) (gc-times . 485) ; almost 5GB!



===========================================

Non-openccog test case showing problem: bug 
https://debbugs.gnu.org/cgi/bugreport.cgi?bug=25386

(define junk 0)
(define halt #f)

(define (wtf-thr)
	(define start (- (current-time) 0.1))

	; Create thread that does junk and exits.  Yes, the increment
	; of `junk` is not protected, and its racey, but so what.
	(define (mkthr v) (call-with-new-thread (lambda () (set! junk (+ junk 1)))))

	; thread arguments
	(define thrarg (make-list 10 0))

	(define cnt 0)
	(define (mke) 
		; Create a limited number of threads
		(define thr-list (map mkthr thrarg))
		; (display (length (all-threads)))
		(map join-thread thr-list)

		; Some handy debug printing.
		(set! cnt (+ cnt 1))
		(if (eq? 0 (modulo cnt 500))
			(begin
				(display "rate=")
				(display (/ cnt (- (current-time) start))) (newline)
            (display "num threads=")
            (display (length (all-threads))) (newline)
            (display (gc-stats)) (newline) (newline)
			)))

	; tail recursive infinite loop.
	(define (aloop) (mke) (if (not halt) (aloop)))

	; while forever.
	(aloop)
)

(call-with-new-thread wtf-thr)
(set! halt #t)

Gahh seg-faults too

Thread 1 "guile" received signal SIGSEGV, Segmentation fault.
thread_mark (addr=0x55556a3f9e00, mark_stack_ptr=<optimized out>, 
    mark_stack_limit=0x7fffffffd350, env=<optimized out>)
    at ../../libguile/threads.c:111
warning: Source file is more recent than executable.
111	/* No threads; we can just use GC_stackbottom.  */
(gdb) bt
#0  thread_mark (addr=0x55556a3f9e00, mark_stack_ptr=<optimized out>, 
    mark_stack_limit=0x7fffffffd350, env=<optimized out>)
    at ../../libguile/threads.c:111

bug-guile@gnu.org 

https://debbugs.gnu.org/cgi/bugreport.cgi?bug=25386

----------------------------------------------------


(heap-size . 5939200)  (gc-times . 70)
(heap-size . 45510656) (gc-times . 147)
(heap-size . 399896576) (gc-times . 1018)

(hash-map->list cons (module-obarray (current-module)))

(heap-size . 183734272)  with gc inside the thread ... (gc-times . 402007)
(heap-size . 183734272) (gc-times . 976989)
(heap-size . 183734272) (gc-times . 1869962)
(heap-size . 183734272) (gc-times . 8526663)

stochastic gc: 
(heap-size . 369917952) (gc-times . 40387)
(heap-size . 428638208) (gc-times . 511116)
(heap-size . 428638208) (gc-times . 1218770)
(heap-size . 428638208) (gc-times . 6515758)

every-17th gc:
(heap-size . 1875902464) (gc-times . 290105)
(heap-size . 2068840448) (gc-times . 2605562) -- 44325000 threads

every 10th-gc in main loop, not in thread:
(heap-size . 544063488) (gc-times . 113)
(heap-size . 5151375360) (gc-times . 1113)
(heap-size . 8322269184) (gc-times . 2113)
Too many heap sections: Increase MAXHINCR or MAX_HEAP_SECTS

gc must be done at thread-exit, for this plan to work!

size=120MB+90MB * n

(define mtx (make-mutex))

   (define (mkthr v) (call-with-new-thread (lambda ()
                (lock-mutex mtx)
                (if (eq? 0 (modulo junk 17)) (gc))
                (set! junk (+ junk 1))
                (unlock-mutex mtx)
                )))


--------
OK new guile-2.2 doesn't blow up any more:

(heap-size . 7921664) (gc-times . 40)
(heap-size . 14344192) (gc-times . 953)
(heap-size . 14344192) (gc-times . 5219)  ; after 4 minutes CPU
(heap-size . 26419200) (gc-times . 64975) ; after 77 minutes CPU
(heap-size . 26419200) (gc-times . 133346) ; after 154 mins CPU
(heap-size . 26419200) (gc-times . 170083) ; after 192 mins CPU
(heap-size . 26419200) (gc-times . 249102) ; after 283 mins cpu
(heap-size . 26419200) (gc-times . 420031) ; after 468 min cpu
(heap-size . 26419200) (gc-times . 557039) ; after 804 mins CPU

alt version: 510 threads:
(heap-size . 10604544) (gc-times . 32)
(heap-size . 19505152) (gc-times . 484)
(heap-size . 35926016) (gc-times . 1761)
(heap-size . 48238592) (gc-times . 4217)  ; after 8 minutes cpu time
(heap-size . 48238592) (gc-times . 47902) ; after 76 mins CPU
(heap-size . 48238592) (gc-times . 73063) ; after 114 mins CPU
(heap-size . 65540096) (gc-times . 128094) ; after 209 mins cpu
(heap-size . 65540096) (gc-times . 248321) ; after 399 mins
(heap-size . 65540096) (gc-times . 344197) ; after 546 min

dffe495d0de1466f62a91a6d74cc0f388e0f4f3f
* libguile/threads.c (on_thread_exit): Lessen excess retention.
12eb7b8256f579fab60ebe0b38eb8788c1276eb8

scm_i_vm_free_stack 

=================================================================
Also 25387

https://debbugs.gnu.org/cgi/bugreport.cgi?bug=25387



===================================================================

(make-dynamic-state (current-dynamic-state))

(define (ds)
	(define cnt 0)
	(define start (- (current-time) 0.1))

	(define (mke) 
		(define x (make-dynamic-state (current-dynamic-state)))
	
		(set! cnt (+ cnt 1))
		(if (eq? 0 (modulo cnt 1000000))
			(begin
				(display "iter=") (display cnt) (newline)
				(display "rate=")
				(display (/ cnt (- (current-time) start))) (newline)
			)))

	(define (aloo) (mke) (aloo))
	(aloo)
)

Above looks just fine.


(count-all)
(cog-report-counts)
(cog-prt-atomspace)
(length (all-threads))
(gc-stats)

====================================================================
Bug -- split needs to put whitespace around parent, before/after commas,
etc. and begin-end quotes  FIXED

====================================================================
Bugg- the utf8 is fucked up.   Fixed. Its a guile-2.1.5 regression
its ok in the containers ... select * from atoms where type=110;
(cog-get-atoms 'WordInstanceNode)

but guile-2.2 fucks up. 
(string-append "a" "係" "c") is OK.
(Concept "係") is broken
scm_c_eval_string
scm_print_state
scm_puts now does scm_c_put_latin1_chars fuuuuuck,.

scm_lfwrite (s, strlen (s), port); --- again with latin1
scm_c_put_string
arggg
bug-guile@gnu.org  --  bug#25397:
https://debbugs.gnu.org/cgi/bugreport.cgi?bug=25387  
GUILE_VERSION_MINOR 1


====================================================================

call-with-new-thread
threads.c

  data = scm_gc_typed_calloc (launch_data);
  err = scm_i_pthread_create (&id, NULL, launch_thread, data);


scm_i_pthread_detach (scm_i_pthread_self ());
pthread-threads.h:#define scm_i_pthread_detach                pthread_detach
#define scm_i_pthread_self                  pthread_self


join_thread_var  libguile/threads.x  uh no 


(with-continuation-barrier
(set! (thread-join-data thread) (cons cv mutex))

scm_i_with_guile calls ...
	GC_call_with_stack_base  which is from boehm
	calls with_guile
		calls scm_i_init_thread_for_guile calls scm_i_init_guile
		scm_c_with_continuation_barrier

scm_current_dynamic_state ()   -- save_dynamic_state  ? maybe not freed?

what is in the currrent dynamic state?

everything looks kosher.  best guess: copy of dyanmic state is not being gc'ed.
SCM_USE_PTHREAD_THREADS ?? defined ?? yes.
build/libguile/scmconfig.h:#define SCM_USE_PTHREAD_THREADS 1 

GC_register_my_thread

on_thread_exit ??? thread_count--; seems to be called because throead count 
is correct ... who sets scm_i_thread_key ? .. guile init does.


---------------------------------------------------------------
Ongoing failure:
If I gc after every thread, then hit this:

guile: hashtab.c:137: vacuum_weak_hash_table: Assertion `removed <= len'
failed.
Aborted

2x... once after a minute
3x ...

try 2.0.13
autoconf flex gettext libunistring-dev libffi-dev texinfo

apt-get purge guile-2.0 guile-2.0-libs

---------------------------------------------------------------
Bug --- java fucks up like this:
above: java is runnning at 900% so its getting stuff in paralel.
It seems to be responding slowly, though ... and guile is not running
at high cpu .. its under 100% wtf... ah haha -- java is spinning 
on socket wait in some way...

Its messed up. Java is buggy.
------------------------------------------------------------------

Bug --- java always gives back exactly the same ... is the rand
num generator being reset each time??? I think it is, for
reproducibility?  No .. it was a bug. Fixed. pull req #471 in LG

for morphemes, anysplit.c always sets seed=0 every call.


anysplit.c:
rng_uniform 
sample_point
use_sampling 

api.c:				(rand_r(&sent->rand_state) %
parse_options_set_repeatable_rand

struct anysplit_params * anysplit;
 set by 

duuuude wtf 0 3b23e1b0 240 st=1840299789
duuuude wtf 1 78520aa1 33 st=-895367152
duuuude wtf 2 6372c222 322 st=1780636463
duuuude wtf 3 5c322e38 312 st=-231201766
duuuude wtf 4 303c3bea 146 st=-1008023999
duuuude wtf 5 2a463357 233 st=-480833580

      Linkage lkg = &sent->lnkages[in];
      Linkage_info *lifo = &lkg->lifo;
iindex
sentence_parse

63  70 248 277 -- birthday paradox



------------------------------------
LG:   FIXED, will be in version 5.3.14  -- LG pull req #470
any is ignoring the last word
no its not, its just not displaying it. so its a minor bug.
linkage_print_diagram

l->r pass removed 1
LEFT-WALL[1] 港[2] 區[2] 全[2] 國[2] 人[2] 

utf8_strlen


------------------------

BUGGGGGGGGGGG -- delete everything fails, cause  still counting in the other
threads!! Aieee! ... 

its also probably picking up the wrong sentence...

use .. parse-get-relex-outputs ? Uh no

(define foo
	(let ((mtx (make-mutex)))
		(lambda ()
			(display mtx) (newline)
			(format #t "duude is locked? ~A\n" (mutex-locked? mtx))
			(format #t "duude owner ~A\n" (mutex-owner mtx))
			(format #t "duude try ~A\n" (try-mutex mtx))
	))
)

(use-modules (opencog))

(AnchorNode "foo")
(ListLink (AnchorNode "foo") (Concept "a"))
(ListLink (AnchorNode "foo") (Concept "b"))
(ListLink (AnchorNode "foo") (Concept "c"))

(SentenceSequenceLink
(WordSequenceLink
(cog-extract-recursive sent)


Delete (SentenceSequenceLink (sent numbernode))
(use-modules (ice-9 receive) (srfi srfi-1) (opencog) (opencog
atom-types))

(use-modules (opencog) (opencog persist) (opencog persist-sql))
(use-modules (opencog nlp learn))
(sql-open "opencog_test" "opencog_tester" "cheese")
(observe-text "this is a foo")


psql -h localhost -U opencog_tester opencog_test


PACKAGE_VERSION
config.h:#define PACKAGE_VERSION "2.1.5.19-7e9395"

Seem to have 

libgc-dev

dpkg -l libgc1c2
Desired=Unknown/Install/Remove/Purge/Hold
|
Status=Not/Inst/Conf-files/Unpacked/halF-conf/Half-inst/trig-aWait/Trig-pend
|/ Err?=(none)/Reinst-required (Status,Err: uppercase=bad)
||/ Name           Version      Architecture Description
+++-==============-============-============-=================================
ii  libgc1c2:amd64 1:7.4.2-8    amd64        conservative garbage
collector fo

---------------------------------------------------------------

        May lead to memory leak and poor performance.
GC Warning: Repeated allocation of very large block (appr. size
21573632):
        May lead to memory leak and poor performance.
GC Warning: Repeated allocation of very large block (appr. size
43147264):
        May lead to memory leak and poor performance.
GC Warning: Repeated allocation of very large block (appr. size
9056256):
        May lead to memory leak and poor performance.
GC Warning: Repeated allocation of very large block (appr. size
43147264):
        May lead to memory leak and poor performance.
GC Warning: Repeated allocation of very large block (appr. size
43147264):
        May lead to memory leak and poor performance.
GC Warning: Repeated allocation of very large block (appr. size
86290432):
        May lead to memory leak and poor performance.
GC Warning: Repeated allocation of very large block (appr. size
7438336):
        May lead to memory leak and poor performance.
GC Warning: Repeated allocation of very large block (appr. size
9588736):
        May lead to memory leak and poor performance.


In conclusion:

(gc-stats)
Entering scheme shell; use ^D or a single . on a line by itself to exit.
guile-yue> ((gc-time-taken . 7077498787602) (heap-size . 15487754240)
(heap-free-size . 3580190720) (heap-total-allocated . 900893846432)
(heap-allocated-since-gc . 6264284448) (protected-objects . 288)
(gc-times . 1059))

15.5GB in total, 3.6GB free

guile-yue> (gc)

guile-yue> (gc-stats)
((gc-time-taken . 7122988472428) (heap-size . 15487754240)
(heap-free-size . 8725934080) (heap-total-allocated . 900895104976)
(heap-allocated-since-gc . 1142496) (protected-objects . 288) (gc-times
. 1060))

Now its 8.7GB free, leaving 7GB in use.

guile-yue> (cog-report-counts)
((ListLink . 331150) (EvaluationLink . 331150) (AnchorNode . 1)
(WordNode . 10720) (LinkGrammarRelationshipNode . 1) (LgConnectorNode .
1) (LgConnMultiNode . 1) (LgConnDirNode . 2) (LgConnector . 4) (LgAnd .
4))

guile-yue> (count-all)
673034

So why is guile so splurgy?  This is just not that many atoms ... 
is bdwgc too conservative, somehow finding the TLB stuff?
what If I close out the TLB, does guile free it all?

1244:00 start of sql-close cpu time at start
1244:36 at stop -- so about 40 cpu-sconds, OK.

((gc-time-taken . 7128743570856) (heap-size . 15487754240)
(heap-free-size . 14163222528) (heap-total-allocated . 900991577328)
(heap-allocated-since-gc . 172640) (protected-objects . 288) (gc-times .
1061))

whoa -- that was it:
fre is now 14.2 out of 15.5GB so actual use is only 1.3GB 
... for 673K atoms, so about 2KBytes/atom which is still a lot, but 
... plausible.

So bdwgc was confused about the TLB... how? why? what about atom
creation that leaves around this handle-confusion?

before sql close:

ubuntu    4335  217 29.4 32768196 29150768 pts/6 Sl+ Jan11 1243:04 guile -l pair-count-yue.scm

after:
ubuntu    4335  210 28.9 32164608 28616384 pts/6 Sl+ Jan11 1244:45 guile -l pair-count-yue.scm

so no shrinkage directly....

(cog-map-type (lambda (ato) (cog-extract-recursive ato) #f) 'WordNode)
(gc)
.. fails to shrink the heap!

stop the cogserver ... (gc) still no shrinkage


void fn (char*, GC_word)

GC_set_warn_proc (fn)
https://www.hboehm.info/gc/gcinterface.html

GC_warn_proc GC_set_warn_proc(GC_warn_proc p)

libcord
libgc.so -> libgc.so.1.0.3

GC_current_warn_proc
GC_default_warn_proc
WARN


select count(*) from atoms;
1480054
1522104

        6: ??:0 GC_alloc_large()
        7: ??:0 GC_generic_malloc()
        8: ??:0 GC_core_malloc_atomic()
        9: strings.c:165        make_wide_stringbuf()
        10: strings.c:331       scm_i_make_wide_string()
        11: strings.c:1165      scm_string()
        12: vm-engine.c:763     vm_debug_engine()

SCM_STRING_LENGTH_HISTOGRAM
%stringbuf-hist

        6: ??:0 GC_alloc_large()
        7: ??:0 GC_generic_malloc()
        8: weak-table.c:362     allocate_entries()
        9: weak-table.c:432     is_acceptable_size_index()
        10: weak-table.c:677    weak_table_put_x()
        11: weak-table.c:893    scm_c_weak_table_put_x()
        12: read.c:423  maybe_annotate_source()
        13: gc.h:182    maybe_annotate_source()
        14: read.c:725  scm_read_string()
        15: read.c:476  scm_read_sexp()
        16: read.c:1814 read_inner_expression()
        17: read.c:476  scm_read_sexp()
        18: read.c:1814 read_inner_expression()
        19: read.c:1964 scm_read()
        20: vm-engine.c:763     vm_debug_engine()

scm_sys_string_dump
scm_sys_symbol_dump

scm_ilength

#define SCM_CHAR(x) ((scm_t_wchar)SCM_ITAG8_DATA(x))


Ah hah ... very long strings are ... very long strings
from java.


---------------------------------------------------------------


local_id_cache
add_id_to_cache
get_ids

maybe_create_id
id_create_cache

WordInstanceNode
LgLinkInstanceNode
  119 | WordInstanceNode
  120 | WordInstanceLink

  159 | LgLinkInstanceNode
  160 | LgLinkInstanceLink

how are these getting in the TLB???

SQLBackingStore::getLink(Handle& h) const
{

AtomSpace::fetch_atom
persist/guile/PersistSCM.cc

fetch-atom
fetch-incoming-set

is id deadlocking on the resolve? 

t1
delete
get table lock
rele table lock
  now t2 gets the table lock.
get tlb lock  << maybe halt here?
<<<< safe because nothing inside, so forward progress...
relese tlb lock
get table lock. << maybe halt here?


t2
add
table lock 1
tlb lock
do_res
table lock  2
<<< should wordwar prgress cause in ssame thread.

argh 201 theads
 201 -- do_poll_result SchemeEval.cc:655
 200 -- join from eval_loop GenericShell.cc:457
 197 -- getNodeHandle AtomTable.cc:255 
        owenr 20950 whih is 44
  44 -- TLB::removeAtom TLB.cc:143
        owner is 21423 which is 179
 179 -- AtomTable::getNodeHandl AtomTable.cc:255
        owner is 20950 which is 44

 so TLB can't get lock cause its held by 179 

but 179 is holding lock and calling do_res while holding the
atomspace lock. called by tlb::add atom

solutions(s): TLB must drop lock while doing do_res
atomtable must fully unwindws recursive lock


so who in 44 has it?
AtomTable.cc:841 is hwere we are ... 
called at line 762 with lock held at line 729  so we are at least
one-deep. maybe more??

std::unique_lock<std::recursive_mutex> 

    double frac = 100.0 * extra / ((double) all.size());
    printf("sql-stats: Examined %lu atoms in atomspace; %lu extra in TLB
(%f percent) \n", 
        all.size(), extra, frac);


    double frac = 100.0 * extra / ((double) all.size());
    printf("sql-stats: Found %lu atoms in atomspace; %lu extra in TLB
(%f percent) \n",
        all.size(), extra, frac);
frac = 100.0 * extra / ((double) _store->_tlbuf.size());
    printf("sql-stats: tlbuf size=%lu extra=%f percent\n",
_store->_tlbuf.size(), 
frac);
}




the __data.__owner member of the pthread_mutex_t 
print mutex.__data.__owner

---------------------------------------------------------------

(near-startup)
sql-stats: Atomspace holds 55484 atoms
sql-stats: tlbuf holds 19928 atoms
sql-stats: tlbuf holds 0 atoms not in atomspace (0.000000 pct)
sql-stats: tlbuf holds 2031 unremapped atoms (6.600585 pct)
sql-stats: 211017858 of 211020413 uuids unused (99.998789 pct)

Gaaaaackk .. this implies that 99.999 percent of calls to sql
are wasted ! well, actually not, since the cache should stop
the bad acting.

sql-stats: Atomspace holds 420064 atoms
sql-stats: tlbuf holds 154316 atoms
sql-stats: tlbuf holds 0 atoms not in atomspace (0.000000 pct)
sql-stats: tlbuf holds 16398 unremapped atoms (6.627275 pct)
sql-stats: 211339442 of 211467072 uuids unused (99.939645 pct)

sql-stats: Atomspace holds 86550 atoms
sql-stats: tlbuf holds 80674 atoms
sql-stats: tlbuf holds 0 atoms not in atomspace (0.000000 pct)
sql-stats: tlbuf holds 59344 unremapped atoms (72.948089 pct)
sql-stats: 212784068 of 212861833 uuids unused (99.963467 pct)


====================================================
clean start:

sql-stats: Atomspace holds 13949 atoms
sql-stats: tlbuf holds 5750 atoms
num_get_nodes=18537 num_got_nodes=235 (1.267735 pct)
num_get_links=56472 num_got_links=1116 (1.976201 pct)
num_get_insets=0 num_get_inatoms=0
num_node_inserts=6 num_node_updates=31444
num_link_inserts=256 num_link_updates=20732
Remove 21485 of 64000 (33.570312 pct) calls tlbzz=9219
sql-stats: tlbuf holds 0 atoms not in atomspace (0.000000 pct)
sql-stats: tlbuf holds 1484 unremapped atoms (20.694464 pct)
sql-stats: 213462841 of 213464601 uuids unused (99.999176 pct)

sql-stats: Atomspace holds 31687 atoms
sql-stats: tlbuf holds 23769 atoms
num_get_nodes=253402 num_got_nodes=1131 (0.446326 pct)
num_get_links=779439 num_got_links=14328 (1.838245 pct)
num_get_insets=0 num_get_inatoms=0
num_node_inserts=70 num_node_updates=517152
num_link_inserts=4190 num_link_updates=340938
sql-stats: tlbuf holds 0 atoms not in atomspace (0.000000 pct)
sql-stats: tlbuf holds 15624 unremapped atoms (66.088575 pct)
sql-stats: 213763992 of 213783890 uuids unused (99.990692 pct)

sql-stats: AtomSpace not set
sql-stats: Atomspace holds 45225 atoms
sql-stats: tlbuf holds 45225 atoms
num_get_nodes=646388 num_got_nodes=1763 (0.272746 pct)
num_get_links=1988905 num_got_links=33444 (1.681528 pct)
num_get_insets=0 num_get_inatoms=0
num_node_inserts=107 num_node_updates=1339311
num_link_inserts=9898 num_link_updates=883771
sql-stats: tlbuf holds 0 atoms not in atomspace (0.000000 pct)
sql-stats: tlbuf holds 46231 unremapped atoms (52.940099 pct)
sql-stats: 214585523 of 214645132 uuids unused (99.972229 pct)


sql-stats: Atomspace holds 446035 atoms
sql-stats: tlbuf holds 212056 atoms
num_get_nodes=1572865 num_got_nodes=2519 (0.160154 pct)
num_get_links=4838305 num_got_links=68870 (1.423432 pct)
num_get_insets=0 num_get_inatoms=0
num_node_inserts=215 num_node_updates=3172207
num_link_inserts=22422 num_link_updates=2094051
sql-stats: tlbuf holds 0 atoms not in atomspace (0.000000 pct)
sql-stats: tlbuf holds 72188 unremapped atoms (28.542847 pct)
sql-stats: 215438536 of 215580711 uuids unused (99.934050 pct)

after 10 hours:
sql-stats: AtomSpace not set
sql-stats: Atomspace holds 731146 atoms
sql-stats: tlbuf holds 725447 atoms
num_get_nodes=20215212 num_got_nodes=6866 (0.033965 pct)
num_get_links=61851573 num_got_links=404021 (0.653211 pct)
num_get_insets=0 num_get_inatoms=0
num_node_inserts=4251 num_node_updates=42211029
num_link_inserts=307398 num_link_updates=27844955
sql-stats: tlbuf holds 0 atoms not in atomspace (0.000000 pct)
sql-stats: tlbuf holds 411009 unremapped atoms (56.626772 pct)
sql-stats: 240293860 of 241016540 uuids unused (99.700153 pct)

20 gb resident 81 M atoms removed.

Finally:
---------
sql-stats: Atomspace holds 726040 atoms
sql-stats: tlbuf holds 726040 atoms
num_get_nodes=20356005 num_got_nodes=6882 (0.033808 pct)
num_get_links=62281852 num_got_links=405421 (0.650946 pct)
num_get_insets=0 num_get_inatoms=0
num_node_inserts=4264 num_node_updates=42510570
num_link_inserts=309468 num_link_updates=28042704
sql-stats: tlbuf holds 0 atoms not in atomspace (0.000000 pct)
sql-stats: tlbuf holds 412287 unremapped atoms (56.785714 pct)
sql-stats: 240482670 of 241208711 uuids unused (99.698999 pct)


((gc-time-taken . 7898668634177) (heap-size . 17208950784)
(heap-free-size . 9361924096) (heap-total-allocated . 996784769424)
(heap-allocated-since-gc . 1247263344) (protected-objects . 292)
(gc-times . 1068))

heap is 17.2GB!! free is 9.4GB so 7.8GB in use

((gc-time-taken . 7910648760945) (heap-size . 17208950784)
(heap-free-size . 12845494272) (heap-total-allocated . 996787132704)
(heap-allocated-since-gc . 331136) (protected-objects . 292) (gc-times .
1069))

heap is 17.2GB!! free  12.8GB so actually only 4.4GB is needed.

guile-yue> (sql-close)
guile-yue> (gc)
guile-yue> (gc-stats)
((gc-time-taken . 7912464056925) (heap-size . 17208950784)
(heap-free-size . 16106553344) (heap-total-allocated . 996792364160)
(heap-allocated-since-gc . 164096) (protected-objects . 292) (gc-times .
1070))

free is 16.1GB so somehow the TLB was chewing up 3.3GB holding
412287 unremapped atoms!?  How is this possible? Should I have run gc a
bunch more times? 
-------------------------------------------------------------
New API:
Very fast: in 3 minutes:
sql-stats: Atomspace holds 113815 atoms
sql-stats: tlbuf holds 1195 atoms
num_get_nodes=26378 num_got_nodes=26361 (99.935552 pct)
num_get_links=8813 num_got_links=8251 (93.623057 pct)
num_get_insets=0 num_get_inatoms=0
num_node_inserts=133 num_node_updates=52697
num_link_inserts=1062 num_link_updates=16550
sql-stats: tlbuf holds 0 atoms not in atomspace (0.000000 pct)
sql-stats: tlbuf holds 0 unremapped atoms (0.000000 pct)
sql-stats: 0 of 1196 uuids unused (0.000000 pct)



wtf...

(cog-report-counts)
((NumberNode . 46505) (ListLink . 163927) (EvaluationLink . 215741)
(AnchorNode . 1) (WordNode . 5199) (ReferenceLink . 99275) (SentenceNode
. 55) (ParseNode . 837) (ParseLink . 835) (WordInstanceNode . 47312)
(WordInstanceLink . 47437) (WordSequenceLink . 47464)
(SentenceSequenceLink . 55) (LinkGrammarRelationshipNode . 1)
(LgConnectorNode . 1) (LgConnMultiNode . 1) (LgConnDirNode . 2)
(LgConnector . 4) (LgAnd . 4) (LgWordCset . 46306) (LgLinkInstanceNode .
52608) (LgLinkInstanceLink . 52715))


Runnning
sql-stats: Atomspace holds 687522 atoms
sql-stats: tlbuf holds 684142 atoms
num_get_nodes=39921257 num_got_nodes=40050951 (100.324875 pct)
num_get_links=13354387 num_got_links=13011199 (97.430148 pct)
num_get_insets=0 num_get_inatoms=0
num_node_inserts=10662 num_node_updates=80083214
num_link_inserts=673480 num_link_updates=26027646
sql-stats: tlbuf holds 0 atoms not in atomspace (0.000000 pct)
sql-stats: tlbuf holds 0 unremapped atoms (0.000000 pct)
sql-stats: 0 of 684143 uuids unused (0.000000 pct)

(gc-stats)
((gc-time-taken . 49802336967563) (heap-size . 14738780160)
(heap-free-size . 9885679616) (heap-total-allocated . 947281529744)
(heap-allocated-since-gc . 1685837392) (protected-objects . 352)
(gc-times . 1242))

So while running: 14.7GB heap, 9.9GB free

guile-yue> (cog-report-counts)
((NumberNode . 737) (ListLink . 337776) (EvaluationLink . 338599)
(AnchorNode . 1) (WordNode . 10670) (ReferenceLink . 1557) (SentenceNode
. 1) (ParseNode . 16) (ParseLink . 16) (WordInstanceNode . 736)
(WordInstanceLink . 736) (WordSequenceLink . 736) (SentenceSequenceLink
. 1) (LinkGrammarRelationshipNode . 1) (LgConnectorNode . 1)
(LgConnMultiNode . 1) (LgConnDirNode . 2) (LgConnector . 4) (LgAnd . 4)
(LgWordCset . 720) (LgLinkInstanceNode . 821) (LgLinkInstanceLink .
821))

while idle:
(cog-report-counts)
((ListLink . 339276) (EvaluationLink . 339276) (AnchorNode . 1)
(WordNode . 10750) (LinkGrammarRelationshipNode . 1) (LgConnectorNode .
1) (LgConnMultiNode . 1) (LgConnDirNode . 2) (LgConnector . 4) (LgAnd .
4))
So the cruuft goes away.

((gc-time-taken . 49831001288560) (heap-size . 14738780160)
(heap-free-size . 5885931520) (heap-total-allocated . 956146319472)
(heap-allocated-since-gc . 4515746160) (protected-objects . 296)
(gc-times . 1243))

Heap:free: 5.9GB wow -- lots smaller than while runing.
Because 4.5GB alloced since last gc
(heap-free-size . 9419513856)
(heap-free-size . 13306900480)
(heap-free-size . 13710024704) 
(heap-free-size . 13740257280)  wow
of
(heap-size . 14738780160) 14.7 so only 1 GB needed.




ten-word-java: 289105 bytes 2m18 backlog
20-word java: 550294 bytes 3m12.772s
40-word hava: 1101459 bytes: 3m15 delay


ignoreType is not being used

 Wow .. the remove is completely un-needed!  DONE

The "Loaded 370000 atoms" not needed at all, if not bulk-loading. DONE

this dead-locks the shell:
(observe-test "商 餘 質 數 分 解 質 數 定 理 相 對 質 數")
ERROR: In procedure apply-smob/1:
ERROR: Throw to key `decoding-error' with args `("scm_from_utf8_stringn"
"input locale conversion error" 29 #vu8(40 111 98 115 101 114 118 101 45
116 101 115 116 32 34 229 149 134 32 233 164 152 32 232 179 170 32 230
149 184 32 229 136 134 32 232 167 163 32 232 179 170 32 230 149 184 32
229 174 255 237 255 253 6 10))'.

ERROR: In procedure fetch-atom: Earlier version of atom has mis-matched
UUID! (/home/ubuntu/src/atomspace/opencog/atomspaceutils/TLB.cc:85)


---------------------------------------------------------------
-- fix TLB tables in sql -  underway
    (deadlock) DONE

-- fix sennas bug.  DONE
-- publish new LG DONE
---------------------------------------------------------------

The fetch not needed if in the atomspace already. Well,
then don't fetch it!

There is no TV invalidation mechanism...
---------------------------------------------------------------
-- fetch not requied, unless updating the TV ... !!
   (or getting the tv...
-- fix pgsql variant .. maybe
-- update all lxc's.

=======================================================================
20 Jan 2017 Friday
OK, all bugs above fixed, reinstalled the latest LG in yue,
erase all tables, start from scratch. At 4PM exactly, wall-clock time
to the second.

at start
$ find beta-pages |wc          49193   52687 1489227
$ find submitted-articles |wc     24      24     629

-------

After 40 minutes:
select count(*) from atoms;   111632
Java/do-count: 1064 sentences  
find submitted-articles |wc      205

so, rate: 4.5 articles/minute, 5.9 sentences/article.
rate: 26.6 sents/minute
projected finish: 182 hours === 7.5 days

(do-count "report-stuff") gives alternate sentence count...


------

After 4.000 hours:
select count(*) from atoms;    454240
Java: cnt=6533  but 6610 from do-count !! wtf.
$ find submitted-articles |wc 919
38.9M node insert/updates   7164 total nodes!?
12.99 link insert/updates   447516 total links!?
== 51946920 total stores, so that cross-checks OK
total number of atoms also checks out (skew for measurement delay) OK

so, rate: 3.73 articles/minute, 7.4 sents/article
rate: 27.5 sents/minute
projected finish: 220 hours = 9.1 days

So the article-rate is bouncing around, but sentences/minute holds
steady.  Numbers are checking out.

-------

After 8.00 hours:
select count(*) from atoms;  666606
Java: cnt=10787 but  do-count says cnt=11464
$ find submitted-articles |wc 1634
66.1M node updates
22.0M link updates

So...
rate: 1610 / 8 hours = 201 articles/hour, 3.35 articles/minute
rate: 11464 / 480 min = 23.9 sents/min

22 minutes downtime for system upgrade....


4 concurrent writers:
after 15 mins: 
write items=417737 drains=2532 fill_fraction=164.983017 concurrency=51.921801

after 20 mins cpu:
write items=616070 drains=3826 fill_fraction=161.021955 concurrency=53.232358


12 concurrent writers:
after 15 mins
write items=372257 drains=1805 fill_fraction=206.236565 concurrency=53.760111

after 20 mins:
write items=539921 drains=2802 fill_fraction=192.691292 concurrency=54.867595

... doesn't improve concurrency, and seems slower for total CPU, but
that may be fucked up java. ... XXX see below: because there were only
6 connections to postgres, so really of the 12 writers, 7 were blocked.
(assumiong one reader thread, or more...)


New code, where no atom get: (and 12 writer threads)

write items=21516264 drains=167609 fill_fraction=128.371770 concurrency=4.759196
avg drain time=0.345310 seconds; longest drain time=80.337000

New code, 12 writers, and C impl of count-increment:
write items=7817004 drains=61061 fill_fraction=128.019587 concurrency=3.714679
avg drain time=0.517914 seconds; longest drain time=29.733000


New code, 4 writers, and C impl of count-increment:
drains=7186 fill_fraction=136.883245 concurrency=3.445728
drains=25794 fill_fraction=124.202528 concurrency=3.613825
avg drain time=0.440724 seconds; longest drain time=5.136000

4 writers is not obvious worse and seems better than 12.

Ohh .. well, turns out there were only 6 odbc connections
available to work with.

--------------------------------------------------
21 January -- saturday -- start from scratch, again.

start at exactly 15:00

after 15 mins:
select count(*) from atoms; 66221
find submitted* |wc  127

sql-stats: total loads = 296 total stores = 4379768 ratio=14796.513514

num_get_nodes=4246 num_got_nodes=296 (6.971267 pct)
num_get_links=61974 num_got_links=0 (0.000000 pct)
num_get_insets=0 num_get_inatoms=0 ratio=-nan
num_node_inserts=2123 num_node_updates=3282677 ratio=1546.244465
num_link_inserts=61974 num_link_updates=1033002 ratio=16.668313
total stores for node=3284800 link=1094976 ratio=2.999883

write items=2189854 flushes=0 flush_ratio=inf
drains=17804 fill_fraction=122.997866 concurrency=3.866659
avg drain time=0.418640 seconds; longest drain time=4.090000

(monitor-rate "foo")

------------
18:15 -- 3hrs 15 mins later:
find submitted* |wc gives 1025 so 
exactly 1000 articles in 195 minutes = 5.12 articles per minute

select count(*) from atoms; 482295
total loads = 803 total stores = 55843525 
num_node_inserts=7427 num_node_updates=41875213 ratio=5638.240609
num_link_inserts=472298 num_link_updates=13488591 ratio=28.559492
total stores for node=41882640 link=13960889 ratio=2.999998

write items=27921766 flushes=0 flush_ratio=inf
drains=234012 fill_fraction=119.317667 concurrency=2.665735
avg drain time=0.348755 seconds; longest drain time=6.107000

why is write-items=27.9M but total stores=55.8M ?

write-items is exactly half of total stores ...
select sum(stv_count) from atoms; gives 28995086 shortly later.

they're close ... so write-items actually matches word-counting...
so we are double-storing somehow...

-------------------------------------------------
on shutdown, at 22:30 --
select sum(stv_count) from atoms; 62921108
select count(*) from atoms; 861867

find submitted* |wc 2314  

total stores = 125995216
write items=62997608

write items=62997608 flushes=0 flush_ratio=inf
drains=532502 fill_fraction=118.304923 concurrency=2.559669
avg drain time=0.344836 seconds; longest drain time=6.107000

Rearrange; total stores still running at 2x write-items.

But ... 2 links, 3 nodes:
  Eval link --
     Pred node
     List link
        left node
        right node

so the list link is never explicitly stored.  which leaves 1 link, 3
nodes being explicit i.e. 4 explicit stores (for 5 atoms)
is write-items counting only the links? that would be only two, in tat
case...  but the write items are counted in the queue.



--------------------------------------------

Bugs:
if there is a store in the queue, and there is is a get for something
in the queue, then the get will get stale data, and then try to write
back more stale data, ad infinitum... causing the counts to be bad.

well, its up to user to use the barrier, which should now work.

 So .. need mechanism to fetch locally, until fully retired!
Better yet, in scheme, just don't .. don't what? 
don't fetch, unless stv is the default stv ...!

-----------------------------------------------
23 Jan 2017:
------------
Holy cow -- postgres is sooo much faster!!
check this out:

after just a few minutes:

write items=94794 flushes=0 flush_ratio=inf
drains=70 fill_fraction=1354.200000 concurrency=4.385714
avg drain time=0.065023 seconds; longest drain time=0.623000


fill fraction used to be only about 150, before, and average drain time
was something like 0.3 seconds... this is a whole new ballgame!

after 1/2 hour wall clock
write items=1462482 flushes=0 flush_ratio=inf
drains=1830 fill_fraction=799.170492 concurrency=5.049180
avg drain time=0.080646 seconds; longest drain time=1.829000

after 100 minutes
write items=4580980 flushes=0 flush_ratio=inf
drains=5394 fill_fraction=849.273267 concurrency=4.693919
avg drain time=0.118629 seconds; longest drain time=70.343000

after 7 hours
write items=18375732 flushes=0 flush_ratio=inf
drains=21386 fill_fraction=859.241186 concurrency=4.406621
avg drain time=0.084344 seconds; longest drain time=70.343000

after 13 hours:
write items=32066762 flushes=0 flush_ratio=inf
drains=37044 fill_fraction=865.639834 concurrency=4.370316
avg drain time=0.077263 seconds; longest drain time=70.343000

after 24 hours:
write items=56233665 flushes=0 flush_ratio=inf
drains=67199 fill_fraction=836.822944 concurrency=4.378875
avg drain time=0.072986 seconds; longest drain time=70.343000

So this looks to be stable.
after 3 days:
write items=199535356 flushes=0 flush_ratio=inf
drains=310946 fill_fraction=641.704206 concurrency=5.116091
avg drain time=0.087041 seconds; longest drain time=70.343000

so its ogt a little worse... but atomspace is much much bigger, now.


---------------
and also: java is fixed: the magic fix was:
-- shut everything down every 500 sentences,
-- run gc five times in a row,
-- restart everything. 
This unclogs the kitchen sink. -- java now stays up for 4+ hours,
without tanking.

progress:
as of 23 jan 01:50 AM have find submitted* |wc being 8198
              2:15 AM 8299  and (monitor-rate "foo") cnt=2080 rate=0.740
                   i.e. 0.74 sents/sec = 44 sents/minute!
                     that's nearly double the previous rate.
              9:15 AM 10711 -> 10711-8299=2412/(7*60+25) = 5.4 articles/min
                            -> 325 articles/hour = 7805 articles/day
                       cnt=18200 rate=0.65566 -> 39 sentences/minute
              10:47 AM cnt=21430 rate=0.640945
              12:43 PM cnt=27054 rate=0.668858
              15:04 PM cnt=33874 rate=0.692012
      24 jan  01:34 AM cnt=57497 rate=0.663148
                       18160 articles->(18160-8198)/24 = 415 articles/hour
                       10K articles/day
      25 Jan  12:04 PM cnt=134017 rate=0.63543
                       27967 articles->(27967-8198)/59 = 335 articles/hour
      26 Jan  15:26 PM cnt=196794 rate=0.63602
                       35736 articles


-----------------
CentOS 5

psql opencog_test -U opencog_tester -W -h localhost

PGPORT=5433
PGDATA=/home/linas/postgres/var/lib/pgsql/data
PGLOG=/tmp/pgstartup.log

postgres -c "/usr/bin/postmaster -p '$PGPORT' -D '$PGDATA' &" >> "$PGLOG" 2>&1 
postgres -c "/usr/bin/postmaster -p 5432 -D /home/linas/postgres/var/lib/pgsq/data &" >> /home/linas/postgres/tmp/pgstartup.log 2>&1 

alt: chroot /home/linas/postgres; /etc/init.d/postgresql start
nooo dudn't work.

just this:
/home/linas/postgres/etc/init.d/postgresql start

/usr/bin/postmaster -p 5432 -D /home/linas/postgres/var/lib/pgsql/data &
>> /home/linas/postgres/tmp/pgstartup.log 2>&1 

psql opencog_test -U opencog_tester -W -h localhost
Nooooo
look at .odbc.ini

psql test-persist -p 6543

CREATE TABLE Spaces (
    space  BIGINT PRIMARY KEY,
    parent BIGINT
);  
INSERT INTO Spaces VALUES (0,0); -- no space defined; raw atoms.
INSERT INTO Spaces VALUES (1,1); -- default root

ALTER TABLE atoms ADD COLUMN space INT REFERENCES spaces(space);

select count(*) from atoms;
select sum(stv_count) from atoms;


all of these are only the ANY type:

fr_pairs -- learn-fr -- 11161199 (11M) atoms, 6842302577 (6.8G) count
                         ANY-count = 1200368900 = 1.2GB relations

lt_pairs -- learn-lt --  9798103 (10M) atoms, 2873920459 (2.8G) count
                         ANY-count = 647356630 = 0.65G relations

pl_pairs -- learn-pl -- 16192701 (16M) atoms, 4331274070 (4.3G) count
                         ANY-count = 1061898400 = 1G relations

simple_pairs -- learn-simple -- empty
pair_data -- 532 atoms, junk

frwiki-20131220-pages-articles
   find alpha-pages |wc -- 1452754 - 1.4M
   find beta-pages |wc -- 1436278 
   find submitted-articles |wc -- 16505

plwiki-20131218-pages-articles
   find alpha-pages | wc -- 1007645 -- 1.0M
   find submitted-articles |wc -- 107190

ltwiki-20131216-pages-articles
   find alpha-pages | wc -- 161488 -- 161K
   submitted-articles |wc -- 18108

fr_ady : mophology pairs.
.odbc.ini -> fr-ady

relex is not spewing ady correctly -- FIXED

fr-ady on 17003, ady relex on 4446

Warning: Combinatorial explosion! nulls=1 cnt=2147483647
FIXED -- hacked on LG; works-ish, but slow for long sentences.

psql -p 6543 fr_ady
select type, name,stv_count from atoms where height=0;

Argh.
after a day: guile hung; but also, no articles moved from
split to submitted!

crash: string_set_add + 0x47
000000000003ad90 t string_set_add

  e0:	84 c9                	test   %cl,%cl
  e2:	0f 84 89 01 00 00    	je     271 <string_set_add+0x1b1>
  e8:	48 8b 36             	mov    (%rsi),%rsi
  eb:	49 89 f8             	mov    %rdi,%r8
  ee:	0f b6 d1             	movzbl %cl,%edx
  f1:	45 31 ed             	xor    %r13d,%r13d
  f4:	0f 1f 40 00          	nopl   0x0(%rax)
  f8:	41 c1 e5 08          	shl    $0x8,%r13d
  fc:	49 83 c0 01          	add    $0x1,%r8
 100:	41 8d 44 15 00       	lea    0x0(%r13,%rdx,1),%eax
 105:	31 d2                	xor    %edx,%edx
 107:	48 f7 f6             	div    %rsi

but RSI is zero

liblink-grammar.so.5+0x3b6b3]  int+0x3
000000000003b6b0 t is_capitalizable.isra.9


PrintWriter out -- done
outs  OutputStream  done
in_sock  Socket  -- done
send_sock Socket  ... is null

23:30: 2159 articles
23:43: 2535 articles : 276/13 minutes = 21 articles/min

23:48  2540 articles
23:59  2872 articles : 332 aritcles/ 11 mins = 30 articles/min! waa

00:45  3651 articles
select sum(stv_count) from atoms; 1375507899  == 1.38 G counts
select count(*) from atoms; 7146891 == 7.1M atoms

# C  [liblink-grammar.so.5+0x120d5]  print_flat_constituents+0xbd5
# C  [liblink-grammar.so.5+0x120d5]  print_flat_constituents+0xbd5

from 
C  [liblink-grammar.so.5+0x12a25]  linkage_print_constituent_tree+0x85

4180 + bd5 = 4d55
objdump -d -F -g -S

in build tree:
0000000000011500 t print_flat_constituents
00000000000120e0 t print_tree

in build tree so:


4ccd:
   1207f:   31 c9                   xor    %ecx,%ecx
   12081:   31 c0                   xor    %eax,%eax
   12083:   e8 78 2a 01 00          callq  24b00 <feature_enabled>
   12088:   48 85 c0                test   %rax,%rax
   1208b:   0f 85 1f ff ff ff       jne    11fb0
<print_flat_constituents+0xab0>
   12091:   eb d6                   jmp    12069
<print_flat_constituents+0xb69>
   12093:   48 89 c3                mov    %rax,%rbx
   12096:   48 8b 00                mov    (%rax),%rax
   12099:   48 8b b8 98 00 00 00    mov    0x98(%rax),%rdi
   120a0:   e8 9b 89 01 00          callq  2aa40 <post_process_new>
   120a5:   48 89 c7                mov    %rax,%rdi
   120a8:   48 89 bb 88 00 00 00    mov    %rdi,0x88(%rbx)
   120af:   e9 ff f7 ff ff          jmpq   118b3
<print_flat_constituents+0x3b3>
   120b4:   e8 47 3e ff ff          callq  5f00 <__stack_chk_fail@plt>
   120b9:   48 8d 3d b0 00 05 00    lea    0x500b0(%rip),%rdi        # 62170 <__func__.7560+0x8f0>
   120c0:   31 c0                   xor    %eax,%eax
   120c2:   e8 e9 3b ff ff          callq  5cb0 <prt_error@plt>
   120c7:   48 8d 3d ac bf 05 00    lea    0x5bfac(%rip),%rdi        # 6e07a <_ZTSN7Minisat6SolverE+0xca>
4d22:
   120ce:   31 c0                   xor    %eax,%eax
   120d0:   e8 db 3b ff ff          callq  5cb0 <prt_error@plt>
>>>>>>>>>>>>>>>>>>>> crash here.
   120d5:   0f 0b                   ud2
   120d7:   48 8d 3d 0a 00 05 00    lea    0x5000a(%rip),%rdi        # 620e8 <__func__.7560+0x868>
   120de:   eb e0                   jmp    120c0 <print_flat_constituents+0xbc0>

OK
00000000000120e0 <print_tree>:
   120e0:   48 85 d2                test   %rdx,%rdx
   120e3:   0f 84 ab 08 00 00       je     12994 <print_tree+0x8b4>
   120e9:   41 57                   push   %r15
   120eb:   41 56                   push   %r14
   120ed:   49 89 ff                mov    %rdi,%r15
   120f0:   41 55                   push   %r13

So: 

blank banshee
I just wasn't made for these times -- beach boys -- pet sounds

linkage_print_constituent_tree
getConstituentString
LinkGrammar.java -- wraps the C api w/static funcs
    public static native String getConstituentString();
LGService.java -- where the struture is restored
if (config.isStoreConstituentString())


finish
Java_org_linkgrammar_LinkGrammar_close(JNIEnv *env, jclass cls)
    public static native void close();

LGService.do_finalize()

allowSkippedWords
setAllowSkippedWords

linkgrammar_get_dict_version+0x0  <-- crash here twice ...
parser.parse(sentence);

parseSentence   159

parser.parse(sentence);

start again yue 30 Jan 22:19 
at 22:49 -- 488 articles/30 minutes = 16 articles/minute! -- 3x faster than before.
at 23:48 -- 796 articles in 90 minutes = 9 artciles/min
at 00:19 -- 926 articles in 120 mins = 7.7 articles/min
            4500 sents = 4.86 sents/article
            22908000 stored, stv total = 18315330
            stv/5 = 3.66M pairs or 814 pairs/sent(!)
at 11:55 -- 4275 articles in 816 mins = 5.24 articles/min - back to old rates.
            restart java, no noticable diference in rate: its same cpu/loadavg
restart, and load all. Before stopping:
            tlbuf holds 1381888 atoms Atomspace holds 1381901 atoms Hmm.

restart: explicit load: 1381888 atoms in 31 cpu-secs: 44.6K atoms/sec load speed.
at 12:13 -- restarted. Baseline: 4304 articles
at 18:13 -- 6094-4304 = 1790/6 hrs = 4.97 articles/min
at 00:26 -- 7547-6094 = 1453/373 mins = 3.90 articles/min
at 12:22 -- 12376-7547 = 4829/716 mins = 6.74 articles/min (!)
24-hour avg: 12376 - 4304 = 8072/1449min = 5.57 articles/min

1 Feb 2017:
change postgres shared_buffers = 24576MB  from 1GB previously.
also -- change java to 2GB from 1GB
restart at 12:31 no explicit load.
at 14:14 -- 13926 - 12376 = 1550/103min = 15.0 articles/min(!)

at 15:40 - 12:31 = 189 mins, have 
         guile=637:07 mins, or 637/189 = 3.37 load
         java = 50:25 = 50/189 = 0.267 load
         postgres = 10974 secs = 182.9 mins = 182.9/189 = 0.968 load

at 21:27  -- 17014 - 13926 = 3088 / 433 mins = 7.13 articles/min

at 21:30 - 12:31 = 539 mins
        guile = 1850:15 / 539 = 3.42 load
        java  =  148:04 / 539 = 0.274 load
        postgres = 519 / 539 = 0.963 load

2 Feb 2017 -- guile crashed! no prints no dump. 
restart at 12:05 -- 21174 articles
        at 12:43 -- 21411 articles = 411-174/38 = 237/38 = 6.2 artciles/min
        at 19:28 -- 23422 articles = 23422-21174/443 = 2248/443 = 5.07 arts/min
3 Feb   at 07:46 -- 26828 articles = 26828-23422/738 = 3406/738 = 4.62 arts/min
           11:45 -- 27691 articles = 27691-26828/239 = 863/239 = 3.61 arts/min

Hmm. the rate keeps dropping...

final stats for above:
sql-stats: total loads = 1228941 total stores = 286453870 ratio=233.090010
write items=57290774 flushes=0 flush_ratio=inf
drains=98324 fill_fraction=582.673345 concurrency=6.286054
avg drain time=0.109933 seconds; longest drain time=9.216000

scheme@(guile-user)> (gc-stats)
$9 = ((gc-time-taken . 19242586423) (heap-size . 5229101056) (heap-free-size .
5109686272) (heap-total-allocated . 3874090716576) (heap-allocated-since-gc . 509440)
(protected-objects . 301) (gc-times . 53424))

select sum(stv_count) from atoms; -- 801969742 -- 802M
select count(*) from atoms; -- 4786479 -- 4.8M


3 Feb 2017 -- restart. All-new atomspace, all-new link-grammar
      at 12:18PM -- 27691 articles 
      at 12:30 -- crash of guile, restart.
      at 14:11 -- 28246 articles, 28246-27691/100 = 555 / 100 = 5.5 arts/min
      at 15:47 -- 28772 articles, 28772-28246/96 = 526 / 96 = 5.48 articles/min
      at 20:03 -- 30166 articles, 30166-28772/256 = 1394/256 = 5.45 arts/min
4 Feb at 11:20 -- 35014 articles, 35014-30166/917 = 4848/917 = 5.29 artciles/min
5 Feb at 00:02 -- 38511 articles; there was accidental pause of system for hours.
      at 11:25 -- 43905 articles; 43905-38511/683 = 5394/683 = 7.90 arts/min whoa!
6 Feb completed -- 49194 articles.

sql-stats: total loads = 2013739 total stores = 741785040 ratio=368.362057
write items=148357008 flushes=0 flush_ratio=inf
drains=256330 fill_fraction=578.773487 concurrency=5.138489
avg drain time=0.100850 seconds; longest drain time=10.537000

select count(*) from atoms;           6927244 -- 6.9M  -- 6 Feb final
select sum(stv_count) from atoms;  1396889746 -- 1.40G -- 6 Feb final


cpu-ratio guile/java: 4846/425 = 11.4 at 11:20 4 Feb
                      6732/602 = 11.2 at 00:02 5 Feb
                      9001/786 = 11.5 at 11:30 5 Feb
                     12532/1127 = 11.1 final 6 Feb at completion

114022593 total stores in  1820 cpu-mins = 62.6K atoms/min = 1.04K sto/sec
292674070 total stores in  4846 cpu-mins = 60.4K atoms/min = 1.01K sto/sec
534084730 total stores in  8978 cpu-mins = 59.5K atoms/min = 991 stores/sec
741785040 total stores in 12532 cpu-mins = 59.2K atoms/min = 987 stores/sec

 vs cx1 (fr-ady):
 76688189 stores in  3325 cpu-mins = 23.1K stores/min = 384 stores/sec
193457228 stores in  6838 cpu-mins = 28.3K stores/min = 472 stores/sec
378934530 stores in 12396 cpu-mins = 30.6K stores/min = 509 stores/sec

cx1 has old, inefficient kernel and/or old-ineffcient postgres (and
crappy odbc)


postgres:
ps ax |grep postgres > x
cat  x |cut -f 4 > y


EPOCH='jan 1 1970'
sum=")"

for i in 00:03:34 00:00:35 00:12:34
do
  sum="$(date -u -d "$EPOCH $i" +%s) $sum"
done
echo "(+" $sum| guile

=====================================================================
French pairs

cx1: what to do.
/home/linas/postgres/etc/init.d/postgresql start
psql -p 6543
psql -p 6543 fr_ady
cd /storage/wikipedia/frwiki-20131220-pages-articles
./run-all-servers.sh



french pairs: start again: 22:36PM 30 Jan - find submitted* |wc 17053 
                           12:25PM  2 Feb - find submitted* |wc 24563
                           11:43AM  4 Feb - find submitted* |wc 25361
                           11:34AM  5 Feb - find submitted* |wc 25830
                           19:19PM 10 Feb - find submitted* |wc 27763
                           20:16PM 14 Feb - find submitted* |wc 29720
                                    2 Jul - find submitted* |wc 32526
                                   19 Jul - 39077

disk: 206447916 used 41097304 free
disk  206574808 used 40970412 free  24 hours later... about 100MB more
disk  206888724 used 40656496 free  12:25 2 Feb
disk  208585480 used 38959740 free  11:42 4 Feb ... 2.1GB more
disk  208897572 used 38647648 free  00:00AM 5 feb
disk  211829000 used 35716220 free  19:20 10 Feb
disk  213607532 used 33937688 free  20:16 14 Feb
-
psql -p 6543 fr_ady:

select count(*) from atoms;         2090064 --   2.1M -- 12:25PM  2 Feb
select sum(stv_count) from atoms; 115251031 -- 115M   -- 12:25PM  2 Feb

select count(*) from atoms;          5676118 --    5.7M -- 11:19AM  4 Feb
select sum(stv_count) from atoms;  351323640 --  351M   -- 11:19AM  4 Feb

select count(*) from atoms;          7714679 --    7.7M -- 11:38AM  5 Feb
select sum(stv_count) from atoms;  502509756 --  503M   -- 11:38AM  5 Feb

select count(*) from atoms;         16945084 --    16.9M -- 19:21PM 10 Feb
select sum(stv_count) from atoms; 1289249056 -- 1.29G    -- 19:21PM 10 Feb

select count(*) from atoms;         23072988 --    23.1M -- 20:20PM 14 Feb
select sum(stv_count) from atoms; 1856669388 -- 1.86G    -- 20:20PM 14 Feb

select count(*) from atoms;         33519967 --    33.5M - 2 Jul 2017
select sum(stv_count) from atoms; 2923838351 -- 2.92G    -

select count(*) from atoms;         54337413 --    54.3M - 19 Jul 2017
select sum(stv_count) from atoms; 5257433115 -- 5.26G

vs fr_pairs:
select count(*) from atoms; 11161199 -- 11M
select sum(stv_count) from atoms; 6842302577 -- 6.8G !!



guile/java ratio: 6781/683  = 9.93 -- 11:19AM  4 Feb
                  9401/1001 = 9.40 -- 00:00AM  5 Feb
                 12433/1304 = 9.53 -- 11:40AM  5 Feb
                 47250/4576 = 10.3 -- 19:23PM 10 Feb
                 22980/2340 = 9.82 -- 20:20PM 14 Feb

guile hangs:
cx1 - 30 jan hang after 4.4M stores 
      31 jan hang after 42M stores
       1 Feb hang after 33M stores -- 2000:26 cpu
       1 Feb hang after 6.9M stores
       2 Feb hang
       2 Feb hang after 20M stores -- 865:47 cpu


155 threads

155: pthread_cond_wait - multi-driver/SQLAtomStorage.cc:325

Ahhh ... too many open sockets, and one is deadlocked.

wait ... deadlocked in conn_pool.pop()
in SQLAtomStorage::get_conn() SQLAtomStorage.cc:325

so who is using all these conns?

154: ~GenericShell 152 150 148 .. 130 .. 127

153: same as 155 151 149 147 ... 131 .. 128

alternates like this till 131 or so

129: SchemeEval::do_poll_result SchemeEval.cc:655  86

90 76: nanosleep --SQLAtomStorage::storeAtom SQLAtomStorage.cc:754
    waiting to drain ... so its not draining ... why?

25: GC25: GC

24: get_conn, do_store_single --- this is the write-back handler.
    there are 8 of these .. through 17 

so .. the 8 busy writers are blocking readers, cause there are only 8
conns total ... 

works better if we double the pool...

no one seems to be waiting on postgres ... suggests that the 
we've lost track of the number items in the queue ...

15: console list
14: logger
13-2: gc
12

So, its idle ... and ... we've leaked:
currently in_drain=0 num_busy=0 queue_size=0
current conn_pool free=4 of 20


ahhh its due to throws, which kill the put_conns ...

[2017-02-03 05:44:02:785] [WARN] (34) The # of binded parameters < the #
of parameter markers;
Unrecognized key passed to SQLGetInfo30.

[2017-02-03 05:44:02:785] [WARN]    Query was: SELECT * FROM Atoms WHERE
type = 110 AND name = $ocp$?$ocp$ ;

[2017-02-03 05:44:02:785] [ERROR] Can't perform query rc=-1
(/home/linas/src/atomspace-git/opencog/persist/sql/multi-driver/odbcxx.cc:259)
   Stack Trace:

Query was: SELECT * FROM Atoms WHERE type = 110 AND name =
$ocp$?,!ANY-PUNCT$ocp$ ;

... need to try-catch these blocks.

SELECT * FROM Atoms WHERE type = 110 AND name = $ocp$?$ocp$ ;
Seems to be an ODBC issue ...

(34) The # of binded parameters < the # of parameter markers;
Unrecognized key passed to SQLGetInfo30.

SQLBindParameter


glurg. ODBC needs this: replace ? by &#63; what a clusterfuck

Also: 

[2017-02-08 08:16:43:154] [WARN] ODBC Driver: (1) ODBC escape convert
error

[2017-02-08 08:16:43:155] [WARN] ODCB Driver: Query was: SELECT * FROM
Atoms WHERE type = 110 AND name = $ocp${x$ocp$ ;

[2017-02-08 08:16:43:155] [ERROR] Can't perform query rc=-1
(/home/linas/src/atomspace-git/opencog/persist/sql/multi-driver/odbcxx.cc:340)




------------------
very late:
link-grammar: Info: Dictionary 'ady/4.0.dict': No locale definition -
"en_US.UTF-8" will be used.
link-grammar: Info: Dictionary 'ady/4.0.dict': No locale definition -
"en_US.UTF-8" will be used.
link-grammar: Error: Could not open dictionary "ady/4.0.dict"


restart not happen until connection... OK.
link-grammar not loaded until the next round!

re.setMaxParses

_is_in
dict=0x7f053c1bb0b0
dict=0x7f2e2c1f35a0
local-ptd=0x7f2e2c1f3550

checking for locale_t in locale.h... no
checking for locale_t in xlocale.h... no

__USE_GNU
       semant = new AlgorithmApplier(
         "relex.semalgpath", "relex-semantic.algs");

wordnet.configfile file_properties.xml

src/java/relex/morphy/MapMorphy.java:
src/java/relex/morphy/MorphyFactory.java:

               getJWNLConfigFileStream(
                     WORDNET_PROPERTY,
                     JWNL_FILE_PROPERTIES_XML,
                     JWNL_DIR_PROPERTIES_XML
               )

Info: hndlr=3 recv input: "- |3-1|25-23|20-25|25-17|25-11||95-76|couleur=gris}} - |3-0|28-26|25-19|25-23|||78-68}} - |3-1|25-21|25-21|13-25|25-12||88-79|couleur=gris}} - |3-1|21-25|33-31|40537|25-15||104-83}} - |3-2|25-23|22-25|25-22|17-25|17-15|106-110|couleur=gris}} - |3-0|25-19|25-13|25-23|||75-55}}"

Info: hndlr=8 recv input: "- |3-0|25-16|26-24|25-17|||76-57|couleur=gris}} - |3-1|25-22|23-25|25-20|25-20||98-87}} - |3-2|25-22|20-25|25-27|33-31|15-12|118-117|couleur=gris}} - |3-0|25-14|25-22|25-19|||75-55}} - |3-0|25-14|25-20|25-21|||75-55|couleur=gris}} - |3-0|26-24|25-18|33-31|||84-73}}"

then crash

"ISBN 0-380-72001-9.  http://books.google.be/books?id=FMsNAG-gresC&pg=PA144&lpg=PA144&dq=vlakfontein+Dixon+kemp&source=web&ots=8cB7anqlpV&sig=REOVNA8sQO8iTZhI-0_IHVdhySQ&hl=en&sa=X&oi=book_result&resnum=3&ct=result."


crash again:
C  [libc.so.6+0x7a97b]  unsigned long+0xa5b
C  [liblink-grammar.so.5+0x3dad4]  short+0x164
3dad4 - 164 = 3d970

000000000003d970 t separate_word.isra.12

if (not dict->affix_table ) jump pst anysplit
   3dab8:   74 1a                   je     3dad4 <separate_word.isra.12+0x164>
   3daba:   48 83 78 58 00          cmpq   $0x0,0x58(%rax)
if (not dict->affix_table->anysplit) jump past anysplit
   3dabf:   74 13                   je     3dad4 <separate_word.isra.12+0x164>
   3dac1:   48 8b b5 30 ff ff ff    mov    -0xd0(%rbp),%rsi  # arg2: unsplit_word
   3dac8:   48 8b bd 20 ff ff ff    mov    -0xe0(%rbp),%rdi  # arg1: sent
   3dacf:   e8 4c a9 fc ff          callq  8420 <anysplit>
   3dad4:   48 8b 95 70 ff ff ff    mov    -0x90(%rbp),%rdx  # arg3: word
crash here
RBP=0x00002b9ecaf2e450, RDX=0x0000000000000000

call convention arg 1 2 3 in RDI RSI RDX

looks like RBP is pointing into the stack... and 0x00002b9ecaf2e3c0 is
null ...

0x00002b9ecaf2e3a8:   00002b9eeef04f10 000000004bb2c580
0x00002b9ecaf2e3b8:   00002b9e00000000 0000000000000000
0x00002b9ecaf2e3c8:   0000000000000000 00002b9eec065490
0x00002b9ecaf2e3d8:   fffffffe00000026 00002b9ecaf2e310
0x00002b9ecaf2e3e8:   0000000000000001 00002b9e00737470

OK, this is fine, the crash is somewhere inside of anysplit.

unsplit word is.... at 0x00002b9ecaf2e450 - d0 = ...380 

0x00002b9ecaf2e380: 000000004bb2c960 -- same as contents to rbx



   3dadb:   48 8b b5 30 ff ff ff    mov    -0xd0(%rbp),%rsi  # arg2: unsplit_word
   3dae2:   48 8b bd 20 ff ff ff    mov    -0xe0(%rbp),%rdi # arg1: sent
   3dae9:   e8 a2 f8 ff ff          callq  3d390 <morpheme_split>
   3daee:   80 bd 1f ff ff ff 00    cmpb   $0x0,-0xe1(%rbp)
   3daf5:   89 c3                   mov    %eax,%ebx
   3daf7:   75 2e                   jne    3db27 <separate_word.isra.12+0x1b7>
   3daf9:   84 c0                   test   %al,%al

==================================
again
https://sourceware.org/bugzilla/show_bug.cgi?id=21104

Info: hndlr=1 sentence: "Chaussande (de) [http://gallica.bnf.fr/ark:/12148/bpt6k1120033/f177.image.r=], baron par bref pontifical de 1707, Comtat Venaissin, ANF-1969."
*** glibc detected *** java: free(): invalid pointer: 0x0000000059551940
***
======= Backtrace: =========
/lib64/libc.so.6[0x3e296714af]
/lib64/libc.so.6(cfree+0x4b)[0x3e296757ab]
/usr/local/lib/liblink-grammar.so.5[0x2b3a2392a7ce]
/usr/local/lib/liblink-grammar.so.5[0x2b3a2392b396]
/usr/local/lib/liblink-grammar.so.5(sentence_parse+0x99)[0x2b3a2392bb69]
/usr/local/lib/liblink-grammar-java.so.5.3.15(Java_org_linkgrammar_LinkGrammar_parse+0xf5)[0x2b3a236f8995]
[0x2b3a1690eeee]


#5  0x00002b3a2392a7ce in wordgraph_path_free (free_final_path=true, wp=0x59551860)
    at ../../link-grammar/api.c:937
#6  sane_linkage_morphism (sent=sent@entry=0x586bb130, lkg=lkg@entry=0x5877b850, 
    opts=opts@entry=0x586baef0) at ../../link-grammar/api.c:1021


(gdb) print twp
$1 = (Wordgraph_pathpos *) 0x59551890
(gdb) print *twp
$3 = {word = 0x587d7f40, same_word = 56, next_ok = 74, used = 149, path = 0x59551940}

(gdb) x/16g 0x59551940
0x59551940:	0x00000000587d6ef0	0x0000000000000000
0x59551950:	0x0000000000001270	0x0000000000000021
0x59551960:	0x000000005894f650	0x0000003e29954a68
0x59551970:	0x0000000000000020	0x0000000000000040
0x59551980:	0x00000000595516f0	0x000000005a5c82a0

Hmm everything looks OK, so what's the problem???

struct Wordgraph_pathpos_s
{
   Gword *word;      /* Position in the Wordgraph */
   /* Only for wordgraph_flatten(). */
   bool same_word;   /* Still the same word - issue an empty word */
   bool next_ok;     /* OK to proceed to the next Wordgraph word */
   bool used;        /* Debug - the word has been issued */
   /* Only for sane_morphism(). */
   const Gword **path; /* Linkage candidate wordgraph path */
};

wordgraph_pathpos_resize could take bigger jumps.


wordgraph_pathpos_len

len == len not counting the null.

e.g. n=1 insert = 0
memomve from 0 to 1 for 1 item

=========================================================
Arghh...
scheme@(guile-user)> GC Warning: Repeated allocation of very large block (appr. size
18894848):
        May lead to memory leak and poor performance.
*** Error in `guile': double free or corruption (out): 0x00000000623e6010 ***
======= Backtrace: =========
/lib/x86_64-linux-gnu/libc.so.6(+0x777e5)[0x7f3a6db117e5]
/lib/x86_64-linux-gnu/libc.so.6(+0x7fe0a)[0x7f3a6db19e0a]
/lib/x86_64-linux-gnu/libc.so.6(cfree+0x4c)[0x7f3a6db1d98c]
/usr/local/lib/libguile-2.2.so.0(scm_string_to_utf8+0xd7)[0x7f3a6e0ca067]
/usr/local/lib/libguile-2.2.so.0(scm_mkstrport+0x6b)[0x7f3a6e13d0ab]
/usr/local/lib/libguile-2.2.so.0(+0xbc5cd)[0x7f3a6e1465cd]
/usr/local/lib/libguile-2.2.so.0(scm_call_n+0x186)[0x7f3a6e154046]
/usr/local/lib/libguile-2.2.so.0(scm_call_3+0x2f)[0x7f3a6e0d2eaf]
/usr/local/lib/libguile-2.2.so.0(+0xbc5cd)[0x7f3a6e1465cd]
/usr/local/lib/libguile-2.2.so.0(scm_call_n+0x186)[0x7f3a6e154046]
/usr/local/lib/libguile-2.2.so.0(scm_call_3+0x2f)[0x7f3a6e0d2eaf]
/usr/local/lib/libguile-2.2.so.0(+0xbc5cd)[0x7f3a6e1465cd]
/usr/local/lib/libguile-2.2.so.0(scm_call_n+0x186)[0x7f3a6e154046]
/usr/local/lib/libguile-2.2.so.0(+0xb7fd2)[0x7f3a6e141fd2]
/usr/local/lib/opencog/libsmob.so(_ZN7opencog10SchemeEval7do_evalERKNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEE+0xb9)[0x7f3a6539be09]
/usr/local/lib/opencog/libsmob.so(_ZN7opencog10SchemeEval11c_wrap_evalEPv+0x1a)[0x7f3a6539beba]
/usr/local/lib/libguile-2.2.so.0(+0x4324a)[0x7f3a6e0cd24a]
/usr/local/lib/libguile-2.2.so.0(+0xbc5cd)[0x7f3a6e1465cd]
/usr/local/lib/libguile-2.2.so.0(scm_call_n+0x186)[0x7f3a6e154046]
/usr/local/lib/libguile-2.2.so.0(+0xb7fd2)[0x7f3a6e141fd2]
/usr/local/lib/libguile-2.2.so.0(+0x43860)[0x7f3a6e0cd860]
/usr/local/lib/libguile-2.2.so.0(scm_c_with_continuation_barrier+0x45)[0x7f3a6e0cd945]
/usr/lib/x86_64-linux-gnu/libgc.so.1(GC_call_with_gc_active+0x77)[0x7f3a6d8438e7]
/usr/local/lib/libguile-2.2.so.0(+0xb6ad1)[0x7f3a6e140ad1]
/usr/lib/x86_64-linux-gnu/libgc.so.1(GC_call_with_stack_base+0x22)[0x7f3a6d83d952]
/usr/local/lib/libguile-2.2.so.0(scm_with_guile+0x38)[0x7f3a6e140e88]
/usr/local/lib/opencog/libsmob.so(_ZN7opencog10SchemeEval9eval_exprERKNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEE+0x2e)[0x7f3a6539bf3e]
/usr/local/lib/opencog/modules/libscheme-shell.so(_ZN7opencog12GenericShell9eval_loopEv+0x2ec)[0x7f3a582ea9cc]
/usr/lib/x86_64-linux-gnu/libstdc++.so.6(+0xb8c80)[0x7f3a63f4ac80]
/lib/x86_64-linux-gnu/libpthread.so.0(+0x76ba)[0x7f3a6de716ba]
/lib/x86_64-linux-gnu/libc.so.6(clone+0x6d)[0x7f3a6dba082d]
======= Memory map: ========
00400000-00401000 r-xp 00000000 fd:00 80300005 /usr/local/bin/guile
00600000-00601000 r--p 00000000 fd:00 80300005 /usr/local/bin/guile
00601000-00602000 rw-p 00001000 fd:00 80300005 /usr/local/bin/guile
01d52000-6258b000 rw-p 00000000 00:00 0                                  [heap]
7f3870000000-7f38764e3000 rw-p 00000000 00:00 0 
7f38764e3000-7f3878000000 ---p 00000000 00:00 0 
7f3878000000-7f387c000000 rw-p 00000000 00:00 0 
7f387d7bb000-7f387d7bc000 ---p 00000000 00:00 0 
7f387d7bc000-7f387dfbc000 rw-p 00000000 00:00 0 
7f387dfbc000-7f387dfbd000 ---p 00000000 00:00 0 
7f387dfbd000-7f387e7bd000 rw-p 00000000 00:00 0 
7f387e7bd000-7f387e7be000 ---p 00000000 00:00 0 
7f387e7be000-7f387efbe000 rw-p 00000000 00:00 0 
7f387efbe000-7f387efbf000 ---p 00000000 00:00 0 
7f387efbf000-7f387f7bf000 rw-p 00000000 00:00 0 
7f387f7bf000-7f387f7c0000 ---p 00000000 00:00 0 
7f387f7c0000-7f387ffc0000 rw-p 00000000 00:00 0 
7f387ffc0000-7f387ffc1000 ---p 00000000 00:00 0 
7f387ffc1000-7f38807c1000 rw-p 00000000 00:00 0 
7f38807c1000-7f38807c2000 ---p 00000000 00:00 0 
7f38807c2000-7f3880fc2000 rw-p 00000000 00:00 0 
7f3880fc2000-7f3880fc3000 ---p 00000000 00:00 0 
7f3880fc3000-7f38817c3000 rw-p 00000000 00:00 0 
7f38817c3000-7f38817c4000 ---p 00000000 00:00 0 
7f38817c4000-7f3881fc4000 rw-p 00000000 00:00 0 



12 Feb 2017
-----------------
postgres: change  shared_buffers = 64576MB         # min 128kB
/etc/postgresql/9.5/main/postgresql.conf

apt-get update
apt-get upgrade
apt-get install autoconf-archive autoconf automake
apt-get install libgmp-dev libgc-dev libunistring-dev libffi-dev
apt-get install flex gettext texinfo
git clone git://git.sv.gnu.org/guile.git
cd guile; ./autogen.sh --no-configure;
mkdir build; cd build; ../configure; make -j

apt-get install libpq-dev
apt-get purge unixodbc-dev
apt-get autoremove
install link-grammar-5.3.15
cd relex; git pull; ant; ant install

update pair-count.scm to use URL
(sql-open "postgres:///yue_pairs?user=ubuntu&password=asdf")

lynx https://dumps.wikimedia.org/zhwiki/20170101/zhwiki-20170101-pages-articles.xml.bz2

time bzcat zhwiki-20170101-pages-articles.xml.bz2 |/home/ubuntu/src/relex/src/perl/wiki-scrub.pl

real	39m9.964s
user	39m15.964s
sys	1m14.940s

find wiki-stripped/* |wc 1211823
cd wiki-stripped
/home/ubuntu/src/relex/src/perl/wiki-clean-zh.sh
find  |wc   1018923
cd ..

Portal:
Draft:
模块:

mkdir alpha-pages
cd alpha-pages
~/src/relex/src/perl/wiki-alpha-zh.sh
find |wc  1018946

cd ../..
cp -pr alpha-data/alpha-pages beta-pages

createdb zh_pairs
cat src/atomspace/opencog/persist/sql/multi-driver/atom.sql | psql zh_pairs

cp ~/src/relex/src/split-sentences/nonbreaking_prefixes/* ~/run/nonbreaking_prefixes
cp ~/src/relex/src/split-sentences/split-sentences.pl ~/run

.... etc.


===============================================================
Again:
sudo cgm create all linas
sudo cgm chown all linas $(id -u) $(id -g)
cgm movepid all linas $$

14 April status:
---------------
ZH:
select count(*) from atoms;  18941255

14 April 2017
-------------
Start from scratch with English.

time lxc-copy -n  opencog-learn -N learn-en
real	6m43.362s
wget https://dumps.wikimedia.org/enwiki/20170320/enwiki-20170320-pages-articles-multistream.xml.bz2
2 hours 2 mins

time cat enwiki-20170320-pages-articles-multistream.xml.bz2 |bunzip2
|/home/ubuntu/src/relex/src/perl/wiki-count.pl
Counted 955001762 lines in 17398694 pages -- 17.4M articles
real    65m31.329s

time cat enwiki-20170320-pages-articles-multistream.xml.bz2 |bunzip2 |/home/ubuntu/src/relex/src/perl/wiki-scrub.pl
real    604m9.767s
user    413m17.996s
sys     13m8.680s


find |wc gives 7495026 total articles
real    267m1.295s

find |wc gives 5423537 after cat/template removal

createdb en_pairs
cat src/atomspace/opencog/persist/sql/multi-driver/atom.sql | psql en_pairs


----------------
Arghh more bugs:
* failure in LG to split punctuation
* failure to strip regex markup.
linkage_get_word
UBSCRIPT_MARK
SUBSCRIPT_DOT
linkage_print_diagram
DISPLAY_GUESS_MARKS
HIDE_MORPHO  for any language.... except its set to rue for jni
where are the square bracekts removed??????
orig_str in java....
feature/LinkableView.java line 286

LocalLGParser.java circa line 150
-----------------------------
yue: 
17006 -- 21876 submitted 27342 left


en: java crashed:
/home/ubuntu/run/hs_err_pid3206.log
# C  [liblink-grammar.so.5+0x2aa00]  linkage_set_domain_names+0xe0


-------------------------
en_pairs from 2016:
select count(*) from atoms;  18487291 atoms. == 18.5M
select sum(stv_count) from atoms; 1775388151 = 1.77 B

select sum(floatvalue[3]) from valuations where type=177; CountTru

select count(*) from  atoms where type =73;   396255 this is words
select count(*) from  atoms where type =47;   9045489 this is pairs
select count(*) from  atoms where type =8;    9045489 this is list links

select count(*) from valuations where type=121;  -- FloatValue
 select * from valuations where type != 176 and type != 177 limit 50;
select count(*) from valuations where type != 176 and type != 177;

select count(*) from valuations where key =2440463582;  -- 9672428
select count(*) from valuations where key =2440463583;  -- 8880904


(use-modules (opencog) (opencog persist) (opencog persist-sql))
(use-modules (opencog nlp) (opencog nlp learn))
(sql-open "postgres:///en_pairs?user=linas")
(batch-all-pairs)

 (load "compute-mi.scm")
(init-trace "/tmp/progress")
702
(load-atoms-of-type item-type)
(sql-stats)
; hangs... because it is walking the TLB which has 2.4GB of uuid
    _store->print_stats();
(length (cog-get-atoms item-type))

(define lgr (LinkGrammarRelationshipNode "ANY"))
(fetch-incoming-set lgr)
; there aren't any yet....

(define word (car (cog-get-atoms item-type)))
(compute-pair-wildcard-counts word lgr)

delete all-pair-wildcard-counts

      (par-for-each
         (lambda (word)
            (compute-pair-wildcard-counts word lgr)
            (trace-msg-cnt "Wildcard-count did ")) al)

         (cog-get-atoms item-type)
      )

(define al (take (cog-get-atoms item-type) 1000))

scheme@(guile-user) [1]> ,bt
In ice-9/threads.scm:
   289:22  5 (loop _)
In ice-9/futures.scm:
   259:13  4 (touch #<future 55c59c4adb40 queued #<partial-continuation
55c5…>)
   243:14  3 (work)
In unknown file:
           2 (wait-condition-variable #t)
While executing meta-command:
ERROR: In procedure cdr: Wrong type argument in position 1 (expecting
pair): ()


(use-modules (srfi srfi-1))
(define al (list-tabulate 100000 values))
(define foo 0)
(par-for-each (lambda (x) (set! foo (+ x foo))) al)

^CERROR: In procedure scm-error:
ERROR: User interrupt

Entering a new prompt.  Type `,bt' for a backtrace or `,q' to continue.
scheme@(guile-user) [1]> ,bt
In ice-9/threads.scm:
   289:22  5 (loop _)
In ice-9/futures.scm:
   265:11  4 (touch #<future 55e1984d3400 started #<procedure 55e198659f60 a…>)
   243:14  3 (work)
In unknown file:
           2 (wait-condition-variable #t)
While executing meta-command:
ERROR: In procedure cdr: Wrong type argument in position 1 (expecting pair): ()
scheme@(guile-user) [1]>

bug#26616: Acknowledgement (guile-2.2 par-for-each hangs for large lists)


https://debbugs.gnu.org/cgi/bugreport.cgi?bug=26616

-------
(cog-new-value type list) string float link
(cog-set-value! atom key value)
(cog-value atom key)
(cog-value?
cog-value->list
cog-tv-count

confidence

---------
(use-modules (opencog) (opencog persist) (opencog persist-sql))
(use-modules (opencog nlp) (opencog nlp learn))
(sql-open "postgres:///en_pairs?user=linas")
(load-atoms-of-type 'WordNode)

(define lgr (LinkGrammarRelationshipNode "ANY"))
(fetch-incoming-set lgr)
(cog-incoming-set lgr)

(define word (car (cog-get-atoms 'WordNode)))
(fetch-incoming-set word)
(cog-incoming-set word)
(define lpr (car (cog-incoming-set word)))
(fetch-incoming-set lpr)
(length (cog-incoming-set lgr))

scheme@(guile-user)> (length (cog-incoming-set lgr))
Too many heap sections: Increase MAXHINCR or MAX_HEAP_SECTS
Aborted


(load-atoms-of-type 'LinkGrammarRelationshipNode)
(fetch-atom lg_rel)

fetch_incoming_set_cb
SQLAtomStorage::getIncomingSet
tlb get uuid
getNod

h = as->fetch_atom(h);

   Handle h(doGetNode(t, str));
   Handle hg(doGetLink(t, hs));

getUUID  INVALID_UUID

select * from atoms where type = 89;

en_pairs=> select * from atoms where type = 89;
    uuid    | space | type | height | name | outgoing 
------------+-------+------+--------+------+----------
        152 |     1 |   89 |      0 | ANY  | 
 2439209701 |     1 |   89 |      0 | ANY  | 
 2439209706 |     1 |   89 |      0 | ANY  | 
 2439209711 |     1 |   89 |      0 | ANY  | 
 2439209716 |     1 |   89 |      0 | ANY  | 
(5 rows)

OK, so that's a bug .. no unique constraint


   8: SQLAtomStorage.cc:324
opencog::SQLAtomStorage::Response::get_all_values_cb()
"SELECT * FROM Valuations WHERE atom = 

SELECT * FROM Valuations WHERE atom = 152;
   1 |  152 |  177 | {1,0,402733330} |             | 

loading_typemap

(cog-new-ctv 0 0 right-total

set-count   vs ctv, stv, confidence, count etc.
AnyN
any-left
any-right

mst-parser.scm

Going to batch-logli wildcards
Elapsed secs 53
Going to do individual word-pair mi


Noting for pair (When *) -- no frequency!
no frequency's anywhere...
(PredicateNode \"*-FrequencyKey-*\") was never stored!

select * from atoms where type=53; -- the predicateNodes 

wtf line 646 ... sote the keyy....

Wildcard-count did 396255    compute-pair-wildcard-counts -- stores count
Elapsed secs 11
Done with wild-card count
Elapsed secs 0
Going to batch-count all-pairs
Start all-pair-count
Done with all-pair count -- again a count...
Elapsed secs 130
Going to batch-logli wildcards -- batch-all-pair-wildcard-logli
    compute-atom-logli
Elapsed secs 53
Going to do individual word-pair mi

(define k (PredicateNode "*-FrequencyKey-*"))
(define w (WordNode "When"))
(define e (EvaluationLink
(LinkGrammarRelationshipNode "ANY")
(ListLink  (WordNode "When") (AnyNode "right-word")))) 

(cog-value e k)

well ... e has no counts ... and thus no logli

(length (cog-incoming-set (WordNode "When") ))
except there are lots so wtf?

(define lg_rel (LinkGrammarRelationshipNode "ANY"))

(define (get-total-atom-count atom-list)
   (fold + 0.0 (map get-count atom-list))

 (compute-pair-wildcard-counts   w lg_rel

... there are no counts on any e's ... wtf ??

(EvaluationLink  ; uuid  2434162536
   (LinkGrammarRelationshipNode "ANY") ; uuid 152
   (ListLink   ; uuid 2434162535
      (WordNode "Hear")  ; uuid 17490475
      (WordNode "When")  ; uuiid 1537161
   )
)

incoming set failed to load the values!!!
also cog-value is real slowww

   // Get the correct UUID; its possible that we don't know it yet.
   UUID uuid = _tlbuf.getUUID(h);
   if (TLB::INVALID_UUID == uuid)
   {
      Handle hg(doGetAtom(h));
      uuid = _tlbuf.getUUID(hg);
   }
get_uuid
_vindex
_keyset
std::unordered_multimap<ContentHash, Handle>
std::unordered_map<
#include <unordered_map>
std::unordered_set<Handle, handle_hash>  -- kill this -- done
HandlePair

-----------------------------------------

(use-modules (opencog) (opencog persist) (opencog persist-sql))
(use-modules (opencog nlp) (opencog nlp learn))
(sql-open "postgres:///en_pairs?user=linas")
(use-modules (opencog cogserver))
(start-cogserver)
(batch-all-pairs)
(define lg_rel  (LinkGrammarRelationshipNode "ANY"))
      (init-trace "/tmp/progress")
(load "common.scm")
(load "compute-mi.scm")
 (load-atoms-of-type item-type)
 (length (cog-get-atoms item-type))
 (fetch-incoming-set lg_rel)

 (compute-pair-wildcard-counts w lg_rel)


(EvaluationLink (ctv 0 0 90720) ; uuid = 143501595
   (LinkGrammarRelationshipNode "ANY") ; uuid = 152
   (ListLink  ; uuid = 143501594
      (AnyNode "left-word")  ; uuid = 143427138
      (WordNode "When")  ; uuid = 1537161
   )
)
elect * from valuations where atom=143501595;

(store-atom left-star) took forever...

WordNode load took 36s, 38s

9112060 in incoming set

serial inc fetch= 28m11 ,  28m03
serial inc fetch w/GIN idx= 28m39
parallel inc fecth w/GIN idex = 38s, 28s, 29s
parallel inc fetch no idx = 32s, 30s, 33s

serial value fetch=  24m30
parallel value fetch=  1m36, 1m35
parallel resurse+value= 5m16, 6m47(!?), 6m47, 6m50, 7m6

atomspace add = 8m51 = 531 secs, 9m02, 7m56, 7m55, 8m00, 8m21

atsomapce add: added 9112060 atoms in 8m51 = 531 secs = 17.1K/sec
well, each atom is actually 5 atoms so this is 5x faster = 86K/sec

do a parallel type fetch...
as->fetch_all_atoms_of_type(t);
_backing_store->loadType(_atom_table, t);

o_store_single_ato
add_id_to_cache(uuid)
   puts it in local_id_cache
   erases from id_create_cach

maybe_create_id(uuid)

where is check for existance?????
well, get_uuid() does checking()
soo  iif in tlb then works

rp.id_set ...!?
get_ids get all id's  in 

do_store_single_atom
do_store_atom
_write_q

does tlbuf???

I don'd see it being tlbuff....

   UUID uuid = _tlbuf.getUUID(h);
   if (TLB::INVALID_UUID != uuid) return uuid;


+CREATE INDEX ON Atoms USING GIN(outgoing);

TODO:
parallelize get_ids...
actually get_ids is not needed.....

XXX need to store the keys

do_store_atom

total stroes is miscounted!aactually, its right, values don't count.

num_get_nodes=3 num_got_nodes=1 (33.333333 pct)
num_get_links=0 num_got_links=0 (-nan pct)
sql-stats: total loads = 19741116 total stores = 2 ratio=0.000000

get_recursive is not counting what it got.
values and valuations are not counting....

Also: type load doesn't ...? grab the TV's!?  FIXED

type load needs to be conservative with recursion! DONE

do-store_atom stores values recursively. It should have a flag for that.
Documented....

Also: ato->setValue() does not work for raw atoms!  so incoming is
broken.
RuntimeException
move printing exceptiioon ot guile

fetch_incoming_set false
MultiThreadUTest
tv-conf
cog-tv

14:37
 (use-modules (opencog) (opencog persist) (opencog persist-sql))
 (use-modules (opencog nlp) (opencog nlp learn))
 (sql-open "postgres:///en_pairs?user=linas")

 (load-atoms-of-type 'WordNode)   ;; approx 1 minutes?
 (define lg_any (LinkGrammarRelationshipNode "ANY"))
 (fetch-incoming-set lg_any) ;; approx 15 minutes ?
;
(mst-parse-text "this is a test")

 _tlbuf.addAtom(node, p->uuid); can replace!?
line 1427
line 378

start-cost-pair is bogus!
and subsequent crash

 (define e (EvaluationLink 
   (LinkGrammarRelationshipNode "ANY")
   (ListLink (WordNode "this") (WordNode "test"))))

 (cog-value e mi-key)

select * from atoms where name='this'; -- 953769
test -- 1712336
select * from atoms where outgoing='{953769,1712336}'; -- 29138136
select * from atoms where outgoing='{152,29138136}'; -- 29138137

select * from valuations where atom=29138137;


all count-tvs being stored as length 2...
fetch-atom aint getting the tv.

store-atom crashed. ... cause type=-1
store after fetch truncates
ctv print is fuckec
crap. Are teh datbases corrupt???

also .. reload the typemap
type_map_was_loaded = false
nameserver().getNumberOfClasses();

INSERT INTO Valuations
   (SELECT 1 AS key,  -- 1 here is the predicate node
      uuid AS atom,
      176 as type,
      ARRAY[stv_mean, stv_confidence] as floatvalue
      FROM Atoms_Backup WHERE tv_type = 1);

INSERT INTO Valuations
   (SELECT 1 AS key, -- 1 here is the predicate node
      uuid AS atom,
      177 as type,
      ARRAY[stv_mean, stv_confidence, stv_count] as floatvalue
      FROM Atoms_Backup WHERE tv_type = 2);

wait .. link pipeline!???

observ-ext ... load???


the -FrequencyKey- shows {0,Infinity} ... wtf. MI is nan!!

Maybe 4 hours

 (use-modules (opencog) (opencog persist) (opencog persist-sql))
 (use-modules (opencog nlp) (opencog nlp learn))
 (sql-open "postgres:///en_pairs?user=linas")

 (load-atoms-of-type 'WordNode)   ;; approx 3 minutes?
 (define lg_any (LinkGrammarRelationshipNode "ANY"))
 (fetch-incoming-set lg_any) ;; approx 15 minutes ?
;
(mst-parse-text "this is a test") ; OK
-----------------
Ben,

Just got out of surgery for my broken leg; this email attempts to prove
that the general anesthesia didn't kill too many brain cells.  Its a report
on some the langauge-learning results.

Lets dive in.
(mst-parse-text "this is a test")

Raw hard-to-read result below.  Easier-to-read versions later.
ctv holds the raw count of how many times the word was observed.

((2.862118287646645 ((2 (WordNode "is" (ctv 1 0 8165736))) (3 (WordNode "a" (ctv 1 0 14691104))
))) (2.1880378875282904 ((1 (WordNode "this" (ctv 1 0 1300681))) (2 (WordNode "is" (ctv 1 0 8165736))
))) (2.8103625339100944 ((1 (WordNode "this" (ctv 1 0 1300681))) (4 (WordNode "test" (ctv 1 0 60328))
))))

The floating point number above and below is the Yuret MI of the word pair.
I've ameneded
https://github.com/opencog/opencog/tree/master/opencog/nlp/learn/learn-lang-diary/learn-lang-diary.pdf
pages 2-5 so that its less confusing and the formulas are accurate.
Basically, it derives Yuret's formulas in a more rigorous
way; if I recall, his argument was scattered, and just asserted the
result without deriving it.  So the PDF derives it.

((2.862118287646645 ((2 (WordNode "is" )) (3 (WordNode "a" ))))
 (2.1880378875282904 ((1 (WordNode "this" )) (2 (WordNode "is" ))))
(2.8103625339100944 ((1 (WordNode "this" )) (4 (WordNode "test" )))))

Simplifying further:

(((2 (WordNode "is" )) (3 (WordNode "a" )))
 ((1 (WordNode "this" )) (2 (WordNode "is" )))
((1 (WordNode "this" )) (4 (WordNode "test" ))))

The integer is the ordinal of the word.  Note that the linkage
"is-a" was selected over "a test" -- that's because "a test" has an
MI of 2.0935.  This is not terribly surprising; any MI of less than
four is pretty crappy, and these four words occur so commonly that
the correlation between them really is quite qeak -- they're alomost
drowning in noise.  Extracting disjuncts should strongly sharpen the
results.  Next email.

Here's a "better" example:

(mst-parse-text "cats eat cat food")
$5 = ((7.329 ((2 (WordNode "eat" (ctv 20938))) (4 (WordNode "food" (ctv 73924)))))
(4.992 ((3 (WordNode "cat" (ctv 18408))) (4 (WordNode "food" (ctv 73924)))))
(-1000 ((1 (WordNode "cats" (ctv 5902))) (4 (WordNode "food" (ctv 73924))))))

So "eat food" has a decent MI, as expected.  Also "cat food" is decent.
The minus-1000 means that the word pair "cats food" was never observed.
(get-pair-mi-str "cats" "eat") = -1000 means that "cats eat" was never
observed!  Bummer! The word "cats" was observed 6000 times, and this was
not enough to discover a sentence that has "cats eat" in it.  These
statistics are from some relatively smallish sample of WP articles, so
lack of such a sentence is maybe not surprising. Here, childrens &
young-adult lit may be better.

Anyway, clustering that reveals that cats, dogs, etc are similar should
help with this, or so goes the hypothesis.

The word-pair "cats cat" does occur and has an MI of 5 but is prevented
from linking by the link-crossing constraint.  Have not attempted to
figure out if the Dick Hudson landmark transitivity idea can be mutated
to apply to this situation. I suppose I should think about things before
writing about them, but not thinking is faster.

Lets try again:

(mst-parse-text "dogs eat dog food")
((7.329 ((2 (WordNode "eat" (ctv 20938))) (4 (WordNode "food" (ctv 73924)))))
(7.047 ((3 (WordNode "dog" (ctv 41896))) (4 (WordNode "food" (ctv 73924)))))
(5.050 ((1 (WordNode "dogs" (ctv 14852))) (2 (WordNode "eat" (ctv 20938))
))))

Well, that's much better. Let's try something harder:
(mst-parse-text "It is not uncommon to discover strange things")

((7.515 ( (WordNode "not" ) (WordNode "uncommon" )))
 (4.142 ( (WordNode "is" ) (WordNode "uncommon" )))
 (4.412 ( (WordNode "It" ) (WordNode "is" )))
 (2.739 ( (WordNode "uncommon" ) (WordNode "to" )))
(3.529 ( (WordNode "to" ) (WordNode "discover" )))
(0.822 ( (WordNode "to" ) (WordNode "things" )))
(6.171 ( (WordNode "strange" ) (WordNode "things" ))))

Almost right -- the stinker in there is "to things" and it has a
terrible MI.  The correct link would have been "discover things"
but again, this word-pair was never ever observed.

That's it for now, more later.

p.s. The above is obtained with code that uses values in full
generality; so for example the normalized word frequency is stored as

(Valuation
    (WordNode "foo")
    (PredicateNode "*-Frequency Key-*")
    (FloatValue 0.1234567 3.018))

Note that "Valuation" is like an EvaluationLink but different.
The first number is the normalized frequency of observation N(foo) / N(all words)
and the second number of log-base-2 of the first number (its easier to
read, than counting zeros in a frequency).

I had to fix a dozen bugs in brand-new SQL backend code to get this to
work right. It all seems stable, now.

==========================================

   (EvaluationLink
      (LinkGrammarRelationshipNode "ANY")
      (ListLink
			(AnyNode "left-word")
			(AnyNode "right-word")))

fooo  failed to store counts for lw, rw...

Hmm
total word pair counts = 4.1823518e+08

(define-public (count-all-words)
	(define total-wordcnt 0)
   (for-each
      (lambda (word)
         (set! total-wordcnt (+ total-wordcnt (get-count word))))
      (cog-get-atoms item-type))
	total-wordcnt
)
836420450.0

342:48 342:50

(define-public (count-all-words)
	(get-total-atom-count (cog-get-atoms item-type))
)

(get-count (WordNode "the"))
$28 = 41658552.0

(define (mkhist)
	(define nbins 100)
	(define lo -0.7)
	(define hi 0.7)
	(define inc (/ nbins (- hi lo)))
	(define hist (make-array 0 nbins))
	(define (rat w) (/ (- (get-left-count-str w) (get-right-count-str w)) (get-word-count-str w)))

	(define x lo)

	(for-each (lambda (w)
			(define bin (round (* inc (- (rat (cog-name w)) lo))))

			(if (nan? bin) (set! bin 0))
				(set! bin (inexact->exact bin))
			(if (>= bin nbins) (set! bin (- nbins 1)))
			(if (< bin 0) (set! bin 0))
			(array-set! hist (+ 1 (array-ref hist bin)) bin))
		(cog-get-atoms 'WordNode))

	(array-for-each (lambda (cnt)
			(format #t "~A	~A\n" x cnt)
			(set! x (+ x (/ 1.0 inc))))
		hist)
)

=============================================

(cog-incoming-by-type
	(LinkGrammarRelationshipNode "ANY")
	'EvaluationLink)

get_left_wildcard_count word lg_rel)
(get-total-atom-count (get-all-pairs))

(define (wtf)
	(for-each
		(lambda (pair)
			(if (> 0.5 (get-count (get-left-word-of-pair pair)))
				(format #t "wtf left of pair ~A" pair))
			(if (> 0.5 (get-count (get-right-word-of-pair pair)))
				(format #t "wtf right of pair ~A" pair))
		)
		(get-all-pairs)))

418235182.0

(get-total-atom-count (get-all-words))
836420450.0
(length (get-all-pairs))

(LgWordCset 
    (WordInstanceNode "adsf@62e9c582-1984-472b-a2f5-b61b2b0707e8")
    (LgAnd 
        (LgConnector 
            (LgConnectorNode "ANY")
            (LgConnDirNode "-")
            (LgConnMultiNode "@")
        )
        (LgConnector 
            (LgConnectorNode "ANY")
            (LgConnDirNode "+")
            (LgConnMultiNode "@")
        )
    )
)

No cset for the last word!!

no DISJUNCT srcNode.get("DISJUNCT"); on last word .. line 139
no attr on the last word
load_senses
config.isStoreSense

ERROR: Throw to key `C++-EXCEPTION' with args `("fetch-atom" "Error:
get_uuid(): cannot find (WordNode \"abcccccccccc\" (ctv 1.000000
0.000000 4.000000)) ; [8608664669745395561][1]\n\n
(/home/linas/src/novamente/src/atomspace-git/opencog/persist/sql/multi-driver/SQLAtomStorage.cc:934)\nFunction
args:\n((EvaluationLink\n   (LinkGrammarRelationshipNode \"ANY\")\n
(ListLink\n      (WordNode \"###LEFT-WALL###\" (ctv 1 0 19431131))\n
(WordNode \"abcccccccccc\" (ctv 1 0 4))\n   )\n)\n)")'.


(fetch-atom (Word "asdfasdfasdf"))
(fetch-atom (EvaluationLink (LinkGrammarRelationshipNode "ANY")
    (ListLink (Word "###LEFT-WALL###") (Word "asdfasdfqewr"))))

(fetch-atom (ListLink (Word "###LEFT-WALL###") (Word "asdfasdfqewr")))

SQLAtomStorage::doGetLink
IOException
 fixed in commit 327fc6c0a3c8b4b62ac80a61e2fdfc6971190c30

arghhh, last checkpoint: 24304265 24M distinct words
select sum(floatvalue[3]) from valuations where type=7;

gives 1914173302 == 1.9G observations

single-quote -- leading
semicolon -- leading
foobar
sql-stats should print name of the DB and the login user.<F4>
/home/ubuntu/run/hs_err_pid31730.log
but only when sock is dropped...
bug https://github.com/opencog/atomspace/issues/1054


Using bdwgc as of 
0f4244e130541a591d638c98f820b6b49e915ac0
Author: Ivan Maidanski <ivmai@mail.ru>
Date:   Thu Jan 12 00:58:41 2017 +0300


stack below seen twice 3 4
#0  0x00007ffff762c350 in pthread_kill ()
   from /lib/x86_64-linux-gnu/libpthread.so.0
#1  0x00007ffff785f490 in GC_suspend_all () at pthread_stop_world.c:640
#2  0x00007ffff785f564 in GC_stop_world () at pthread_stop_world.c:748
#3  0x00007ffff784b19e in GC_stopped_mark (
    stop_func=stop_func@entry=0x7ffff784aca0 <GC_never_stop_func>)
    at alloc.c:650
#4  0x00007ffff784bd19 in GC_try_to_collect_inner (
    stop_func=0x7ffff784aca0 <GC_never_stop_func>) at alloc.c:488
#5  0x00007ffff784bf9a in GC_try_to_collect_general (
    stop_func=stop_func@entry=0x0, force_unmap=force_unmap@entry=0)
    at alloc.c:1064
#6  0x00007ffff784c06d in GC_gcollect () at alloc.c:1088
#7  0x00007ffff7b06529 in scm_i_gc (what=<synthetic pointer>)
    at ../../libguile/gc.c:266
#8  scm_gc () at ../../libguile/gc.c:255
#9  0x00005555555551f2 in Eval::~Eval() ()


stack below seen twice.3 
#0  0x00007ffff762c350 in pthread_kill ()
   from /lib/x86_64-linux-gnu/libpthread.so.0
#1  0x00007ffff785f6fb in GC_start_world () at pthread_stop_world.c:990
#2  0x00007ffff784b2d6 in GC_stopped_mark (
    stop_func=stop_func@entry=0x7ffff784aca0 <GC_never_stop_func>)
    at alloc.c:728
#3  0x00007ffff784bd19 in GC_try_to_collect_inner (
    stop_func=0x7ffff784aca0 <GC_never_stop_func>) at alloc.c:488
#4  0x00007ffff784bf9a in GC_try_to_collect_general (
    stop_func=stop_func@entry=0x0, force_unmap=force_unmap@entry=0)
    at alloc.c:1064
#5  0x00007ffff784c06d in GC_gcollect () at alloc.c:1088
#6  0x00007ffff7b06529 in scm_i_gc (what=<synthetic pointer>)
    at ../../libguile/gc.c:266
#7  scm_gc () at ../../libguile/gc.c:255
#8  0x00005555555551f2 in Eval::~Eval() ()

==============================================
latest bdwgc does this:
#0  GC_push_all_eager (bottom=<optimized out>, 
    top=top@entry=0x7ffff43f7000 <error: Cannot access memory at address
0x7ffff43f7000>) at mark.c:1599
#1  0x00007ffff7855625 in GC_push_all_stack (bottom=<optimized out>, 
    top=top@entry=0x7ffff43f7000 <error: Cannot access memory at address
0x7ffff43f7000>) at mark.c:1609
#2  0x00007ffff78568aa in GC_push_all_stack_sections (lo=<optimized
out>, 
    lo@entry=0x7ffff43f56c0 <error: Cannot access memory at address
0x7ffff43f56c0>, 
    hi=hi@entry=0x7ffff43f7000 <error: Cannot access memory at address
0x7ffff43f7000>, traced_stack_sect=<optimized out>) at mark_rts.c:565
#3  0x00007ffff785f2fd in GC_push_all_stacks () at
pthread_stop_world.c:557
#4  0x00007ffff7855bcf in GC_mark_some (
    cold_gc_frame=0x7fffe43d5d00 "\274ǧ\367\377\177") at mark.c:343
#5  0x00007ffff784b20d in GC_stopped_mark (
    stop_func=stop_func@entry=0x7ffff784aca0 <GC_never_stop_func>)
    at alloc.c:702
#6  0x00007ffff784bd19 in GC_try_to_collect_inner (
    stop_func=0x7ffff784aca0 <GC_never_stop_func>) at alloc.c:488
#7  0x00007ffff784bf9a in GC_try_to_collect_general (
    stop_func=stop_func@entry=0x0, force_unmap=force_unmap@entry=0)
    at alloc.c:1064
#8  0x00007ffff784c06d in GC_gcollect () at alloc.c:1088
#9  0x00007ffff7b06529 in scm_i_gc (what=<synthetic pointer>)
    at ../../libguile/gc.c:266
#10 scm_gc () at ../../libguile/gc.c:255
#11 0x00005555555551f2 in Eval::~Eval() ()


apt-cache show libgc-dev
libgc-dev_7.4.2-8_amd64.deb
git tag
gc7_4_2
gc7_4_4
gc7_6_0 <---  try this one -- notpe still bad.


    txt="Error: get_uuid(): cannot find (ListLink\n  (WordNode \"Hume\"
(ctv 1.000000 0.000000 16.000000)) ; [1287745831931189139][1]\n
(WordNode \",\" (ctv 1.000000 0.000000 64.000000)) ;
[7731950238383222497][1]\n"...)

            result = RAISE_SIGNAL(p, GC_sig_thr_restart);


Guess  some of the threads are exiting when gc runs...

for (p = GC_threads[i]; p != 0; p = p -> next) {
p 

#define RAISE_SIGNAL(t, sig) pthread_kill(THREAD_SYSTEM_ID(t), sig)
#define THREAD_SYSTEM_ID(t) (t)->id

ohhh 7.6 sometimes deadlocks...

------------------ done iteration 14
Done creating 120 threads

Thread 1917 "a.out" received signal SIGSEGV, Segmentation fault.
[Switching to Thread 0x7fffc639b700 (LWP 27872)]
0x00007ffff762d350 in pthread_kill ()
   from /lib/x86_64-linux-gnu/libpthread.so.0
(gdb) bt
#0  0x00007ffff762d350 in pthread_kill ()
   from /lib/x86_64-linux-gnu/libpthread.so.0
#1  0x00007ffff785fe70 in GC_suspend_all () at pthread_stop_world.c:640
#2  0x00007ffff785ff44 in GC_stop_world () at pthread_stop_world.c:748

(igdb) up
#1  0x00007ffff785fe70 in GC_suspend_all () at pthread_stop_world.c:640
640	              result = RAISE_SIGNAL(p, GC_sig_suspend);
(gdb) print p
$1 = (GC_thread) 0x7ffff7a7d380 <first_thread>
(gdb) print i
$2 = 0
(gdb) print p->id
$3 = 140737198868224
(gdb) print /x p->id
$4 = 0x7fffeebec700

Sooo.. p->id  is not self.

(gdb) print /x p->next
$5 = 0x0

(gdb) print GC_threads[1]
$6 = (volatile GC_thread) 0x0

(gdb) print /x self
$10 = 0x7fffc639b700   -- yes this agreees with gdb message on top.

(gdb) info thr --  lists all the threads. ...  0x7fffeebec700 is not listed,
its not a valid thread.

sure looks like bdwgc is failing to keep GC_threads[0] accurate.!!

(gdb) print p->flags
$11 = 6 '\006'

include/private/pthread_support.h
#       define FINISHED 1       /* Thread has exited.
#       define DETACHED 2       /* Thread is treated as detached.
                                /* Thread may really be detached, or
                                /* it may have been explicitly
                                /* registered, in which case we can
                                /* deallocate its GC_Thread_Rep once
                                /* it unregisters itself, since it
                                /* may not return a GC pointer.
#       define MAIN_THREAD 4    /* True for the original thread only.

but its not teh main thread::: .. p is neoither of the below:
(gdb) info thr
  Id   Target Id         Frame 
  1    Thread 0x7ffff7fc7300 (LWP 24666) "a.out" 0x00007ffff762767d in pthread_join () from /lib/x86_64-linux-gnu/libpthread.so.0
* 1917 Thread 0x7fffc639b700 (LWP 27872) "a.out" 0x00007ffff762d350 in pthread_kill () from /lib/x86_64-linux-gnu/libpthread.so.0

(gdb) print *p
$12 = {next = 0x0, id = 140737198868224, stop_info = {last_stop_count = 1545, 
    stack_ptr = 0x7fffeebeb6c0 <error: Cannot access memory at address 0x7fffeebeb6c0>}, flags = 6 '\006', thread_blocked = 0 '\000', finalizer_skipped = 0, 
  finalizer_nested = 0 '\000', stack_end = 0x0, altstack = 0x0, 
  altstack_size = 0, stack = 0x0, stack_size = 0, traced_stack_sect = 0x0, 
  status = 0x0, tlfs = {_freelists = {{0x1, 0xbd, 0x555555818520, 
        0x55555591f5d0, 0x5555557ff500, 0x3d, 0x1, 0x1, 0x1, 0x65, 
        0x1 <repeats 14 times>, 0x1a}, {0x1, 0x5555559242d0, 0x55555587d820, 
        0x555555908540, 0x10, 0x3d, 0x5555558ff2a0, 0xb9, 0x1c, 0xb, 0x0, 0x1, 
        0x1, 0x1, 0x1, 0x1, 0x555555927d00, 0x1, 0x14, 0x1, 0x1, 0x1, 0x1, 
        0x1, 0x1}, {0x1 <repeats 25 times>}}, gcj_freelists = {
      0xffffffffffffffff, 0x1 <repeats 24 times>}}}


new thread handled at line 538
threa delete on 572
GC_delete_thread  line 550
but also ... GC_delete_gc_thread line 592

GC_delete_thread called from only one place:
GC_unregister_my_thread_inner
called from two places:
   GC_unregister_my_thread
   GC_thread_exit_proc  -- not called by guile

pthread_start.c:    pthread_cleanup_push(GC_thread_exit_proc, me);


scm_gc is NOT being called in guile mode.!!  Example 1
but fixing this does not cure the bug.

threads.c:    GC_unregister_my_thread ();

libguile/gc.c

static void on_thread_exit (void *v)
calls GC_unregister_my_thread() but only if t->needs_unregister) is set
called by init_thread_key 
by scm_i_init_thread_for_guile
by scm_init_guile()

Hmm   scm_i_with_guile no longer calls scm_init_guile()
but with_guile() does call scm_i_init_thread_for_guile
which does call init....

maybe the exit handler is still running.... when the gc is called.

except the thread should remain valid until all of the exit handlers
have returned.  So maybe a thread handler did not run? ??


Program terminated with signal SIGSEGV, Segmentation fault.
#0  0x00007f19e496f350 in pthread_kill ()
   from /lib/x86_64-linux-gnu/libpthread.so.0
[Current thread is 1 (Thread 0x7f19aa6a7700 (LWP 7486))]

sconew not being called !  
GC_register_my_thread
print notin
print nxt

x /150xg &board

[Current thread is 1 (Thread 0x7f7aa3a6d700 (LWP 25905))]

 print p
$3 = (GC_thread) 0x7f7abb142380 <first_thread>

(gdb) print /x p->id
$5 = 0x7f7ab7a95700  this is the first thread....

Needs_unreg was not set!!
scm_init_guile ()

------------------ done iteration 540
Done creating 120 threads


argh  this is broken:
cog-map-chase-links-chk
cog-par-chase-links-chk

thus all users of map-parses might be broken
map-parses
parallel-map-parses
map-word-instances

 (use-modules (opencog) (opencog persist) (opencog persist-sql))
 (use-modules (opencog nlp) (opencog nlp learn))
 (sql-open "postgres:///en_pairs?user=linas")
 (use-relex-server "127.0.0.1" 4445)

==========================================

again: using the rohit data:

select count(*) from atoms where type=73; gives 396K unique words.
select count(8) from atoms where type=47; gives number fo evluation
links which is 9672K  but 2*396K of these are anynodes, so really only
9672-792=8880K unique word-pairs.
which were observed 

en_pairs=> select * from atoms where type=74;
   uuid    | space | type | height |    name    | outgoing 
-----------+-------+------+--------+------------+----------
 143427138 |     1 |   74 |      0 | left-word  | 
 143427163 |     1 |   74 |      0 | right-word | 

en_pairs=> select * from atoms where outgoing='{143427138,143427163}';
   uuid    | space | type | height | name |       outgoing        
-----------+-------+------+--------+------+-----------------------
 143670792 |     1 |    8 |      1 |      | {143427138,143427163}

en_pairs=> select * from atoms where outgoing='{152,143670792}';
   uuid    | space | type | height | name |    outgoing     
-----------+-------+------+--------+------+-----------------
 143670793 |     1 |   47 |      2 |      | {152,143670792}

en_pairs=> select * from valuations where atom=143670793;
 key |   atom    | type |   floatvalue    | stringvalue | linkvalue 
-----+-----------+------+-----------------+-------------+-----------
   1 | 143670793 |  177 | {0,0,418235182} |             | 

So 418M observations of word-pairs.

ALTER DATABASE en_pairs RENAME TO en_pairs_rohit;

=========================================================
 (use-modules (opencog) (opencog persist) (opencog persist-sql))
 (use-modules (opencog nlp) (opencog nlp learn))
 (sql-open "postgres:///en_pairs?user=ubuntu")

(fetch-all-words)
(length (get-all-words)) 65021 
(total-word-observations) 7181662.0 7.2M
(PredicateNode "*-Sentence Word Pair-*")
(SchemaNode "*-Pair Distance-*")o
   (define pair-pred (PredicateNode "*-Sentence Word Pair-*"))
   (define pair-dist (SchemaNode "*-Pair Distance-*"))

(length (cog-incoming-set pair-pred))
(get-total-atom-count (cog-incoming-set pair-pred))

get-any-left-wildcard-count
get-any-right-wildcard-count
set-any-pair-total

set-any-left-wildcard-count
set-any-right-wildcard-count
get-any-pair-link
batch-all-pair-wildcard-counts
get-all-words

batch-all-pair-wildcard-logli
get-pair-total

GET-LEFT-WILD
(store-atom
      (set-count GET-LEFT-WILD TOTAL))
batch-all-pair-wildcard-logli
compute-pair-mi
get-any-pair-link-> GET-PAIR
get-word-pairs

cog-incoming-by-type
.scm:		(par-map get-endpoint (cog-filter link-type 
utilities.scm:
cog-map-chase-link dead
cog-map-chase-link-dbg   used by ppars ranker
cog-map-chase-links-chk  used by cog-chase-link-chk
cog-chase-link-chk   used by  nlp-utils

cog-map-apply-link  dead used by cog-get-link
cog-get-link used by 
cog-get-pred

(define bar (let ((done #f))
	(lambda () (format #t "duude ~A\n" done) (set! done #t))))

(AnyNode \"left-word\") (WordNode \"###LEFT-WALL###\"

get-logli
      (catch #t
         (lambda () (xxxxx))
         (lambda (key . args) #f)))


(start-trace msg)

get-any-pair  get-clique-pair

wow 32 gigs to load all pairs!

tlb.clear()
reserve_upto(uuid)
getMaxUUID

(make-narrow-links (mst-parse-text "The game is played on a level playing field"))

(LgWordCset 
    (WordInstanceNode "foo@e5bfab2f-b3b1-4cf1-ae89-89aaa47bf871")
    (LgAnd 
        (LgConnector 
            (LgConnectorNode "ANY")
            (LgConnDirNode "-")
        )
    )
)

(unfold

 (use-modules (opencog) (opencog persist) (opencog persist-sql))
 (use-modules (opencog nlp) (opencog nlp learn))
 (sql-open "postgres:///en_pairs_rohit?user=linas")
 (fetch-all-words)
 (fetch-any-pairs)



=========================================================
(sql-open "postgres:///en_snapshot?user=ubuntu")
Start counting, num words=106696
num words=106696

select count(*) from atoms where type=123;  -- 123 is wordNode

   85 | SchemaNode
   88 | PredicateNode
  123 | WordNode
  142 | LinkGrammarRelationshipNode


 uuid | space | type | height |          name          | outgoing 
------+-------+------+--------+------------------------+----------
   29 |     1 |   88 |      0 | *-Sentence Word Pair-* | 
   30 |     1 |   85 |      0 | *-Pair Distance-* | 
  141 |     1 |  142 |      0 | ANY  | 


select count(*) from atoms where outgoing[1]='29';
gives ... 12956699
30 gives ... 26174210   ... wtf!?

after loading clique only: 37925105 atoms = 38M/51G = 1.35KB/atom

(ListLink (WordNode "playing") (WordNode "field"))
zero

(ListLink (WordNode "day") (WordNode "field"))
1 and 1 at 30
Lincoln
the
which

   (ListLink (Word "the" ) (Word "field" ))
(cog-chase-link
(cog-get-link 'EvaluationLink PAIR (Pred


(define cnt 0)
(for-each
	(lambda (PAIR)
		(set! cnt (+ cnt 1))
		(if (not (eqv? (count-dist-pair PAIR) (count-clique-pair PAIR)))
			(throw 'bad-count 'foobar PAIR)
			(format #t "Its OK ~A\n" cnt)
		))
	(get-all-pairs))



115 | LgWordCset
2440463600
   1 | 2440463600 |  177 | {1,0,12}   |             | 
2440463720   {636276,2440463719}
2440463718   {107,2440463716}
2440463717   {101,2440463715}
2440463714   {1748714,2440463710}
2440463669  {2440463611,2440463599}


19741227 = 19.8M atoms / 30G = 1.52KB/atom

echo "" | ./submit-one.pl localhost 17001 observe-mst


(mst-parse-text "Area: total: 29,743 km² country comparison to the world: 149. land: 28,454 km² water: 1,289 km² Area comparative Australia comparative: about one third (33%) the size of Tasmania.")

freshie (0 ())
28 words

74  -- 34
108 -- 32
140 -- 30
170 -- 28
198 -- 26
224 -- 24
248 -- 
270
269
290

bad-pair in max-of-pair-list


 (use-modules (opencog) (opencog persist) (opencog persist-sql))
 (use-modules (opencog nlp) (opencog nlp learn))
 (sql-open "postgres:///en_pairs_mst?user=linas")
 (fetch-all-words)
 (length (get-all-words))
396262
 (fetch-pseudo-csets (get-all-words))
 (length (filter-words-with-csets  (get-all-words)))
30127

 (cset-observations (get-all-words))
436595.0


425186
(cset-vec-support (Word "the"))
(cset-vec-len (Word "the"))

(

   (length (cog-incoming-by-type WORD 'LgWordCset))

(define n 0)
(for-each
	(lambda (cset) 
		(set! n (+ 1 n)))
	(cog-incoming-by-type (Word "the") 'LgWordCset))

Ben, Ruiting,

For your enjoyment: I have some very preliminary results on word
similarity.  They look pretty nice, even thogh based on a fairly
small number of observations. 

If you've been watching TV instead of reading email, here's the story
so far: Starting from a large text corpus, the mutual information (MI)
of word-pairs are counted. This MI is used to perform a maximum
spanning-tree (MST) parse (of a different subset of) the corpus. From each
parse, a pseudo-disjunct is extracted for each word.  The
pseudo-disjunct is like a real LG disjunct, except that each connector
in the disjunct is the word at the far end of the link.

So, for example, in in idealized world, the MST parse of the sentence
"Ben ate pizza" would prodouce the parse Ben <--> ate <--> pizza and
from this, we can extract the psuedo-disjunct (Ben- pizza+) on the
word "ate".  Similarly, the sentence "Ben puked pizza" should produce
the disjunct (Ben- pizza+) on the word "puke".  Since these two 
disjuncts are the same, we can conclude that the two words "ate"
and "puke" are very similar to each other.  Considering all of the
other disjuncts that arise in this example, we can conclude that these
are the only two words that are similar.

Note that a given word may have very many psuedo-disjuncts attached
to it. Each disjunct has a count of the number of times it has been
observed.  Thus, this set of disjuncts can be imagined to be a vector
in a high-dimensional vector space, which each disjunct being a single
basis element.  The similarity of two words can be taken to be the
cosine-similariy between the disjunct-vectors (or pick another,
different metric, as you please.)

Below are a set of examples, for English, on a somewhat smmall dataset.
Collected over a few days, it contains just under half-a-million 
observations of disjuncts, distributed across about 30K words.
Thus, most words will have only a copule of disjuncts on them, 
which may have been seen only a couple of times. its important, at
this stage, to limit oneself to only the most popular words.

We expect the determiners "the" and "a" to be similar, and they are:
(cset-vec-cosine (Word "the") (Word "a")) = 0.1554007744026141

Even more similar:
(cset-vec-cosine (Word "the") (Word "this")) = 0.3083725359820755

Not very similar at all:
(cset-vec-cosine (Word "the") (Word "that")) = 0.01981486048876119

Oh hey this and that are similar. Notice the triangle with "the".
(cset-vec-cosine (Word "this") (Word "that")) = 0.14342403062507977

Some more results
 (cset-vec-cosine (Word "this") (Word "these")) = 0.23100101197144984
 (cset-vec-cosine (Word "this") (Word "those")) = 0.1099725424243773
 (cset-vec-cosine (Word "these") (Word "those")) = 0.13577971016706158

We expect that determiners, nouns and verbs to all be very differrent
from one-another. And they are:
 (cset-vec-cosine (Word "the") (Word "ball")) = 2.3964597196461594e-4
 (cset-vec-cosine (Word "the") (Word "jump")) = 0.0
 (cset-vec-cosine (Word "ball") (Word "jump")) = 0.0

We expect verbs to be similar, and they sort-of are.
 (cset-vec-cosine (Word "run") (Word "jump")) = 0.05184758473652128
 (cset-vec-cosine (Word "run") (Word "look")) = 0.05283524652572603

Since this is a sampling from wikipedia, there will be very few
"action" verbs, unless the sample accidentally contains articles
about sports. A "common sense" corpus, or a corpus that talks about
what people do, could/should improve the above verbs.  These are
very basic to human behavior, but are rare in most writing.

I'm thinking that a corpus of children's lit, and young-adult-lit
would be much better for these kinds of things.

An adjective.
 (cset-vec-cosine (Word "wide") (Word "narrow")) = 0.06262242910851494
 (cset-vec-cosine (Word "wide") (Word "look")) = 0.0
 (cset-vec-cosine (Word "wide") (Word "ball")) = 0.02449979787750126
 (cset-vec-cosine (Word "wide") (Word "the")) = 0.04718158900583385

 (cset-vec-cosine (Word "heavy") (Word "wide")) = 0.05752237416355278

Here's a set of antonyms!
 (cset-vec-cosine (Word "heavy") (Word "light")) = 0.16760038078849773

A pronoun
 (cset-vec-cosine (Word "ball") (Word "it")) = 0.009201177048960233
 (cset-vec-cosine (Word "wide") (Word "it")) = 0.005522960959398417

 (cset-vec-cosine (Word "the") (Word "it")) = 0.01926824360790382

Wow!! In English, "it" is usually a male!
 (cset-vec-cosine (Word "it") (Word "she")) = 0.1885493638629482
 (cset-vec-cosine (Word "it") (Word "he")) = 0.4527656594627214
 (cset-vec-cosine (Word "he") (Word "she")) = 0.1877589816088902

I can post the database on mondy, let me know when you're ready to
receive it.

above dataset has 200183 (200K) disjuncts in it

SIMILARITY_LINK

ac

scheme@(guile-user)> (batch-sim (Word "him") ac)
terminate called after throwing an instance of
'opencog::RuntimeException'
  what():  Failed to execute!
(/home/linas/src/novamente/src/atomspace-git/opencog/persist/sql/multi-driver/ll-pg-cxx.cc:113)
Aborted


[2017-05-07 17:01:27:152] [WARN] PQresult message: ERROR:  duplicate key
value violates unique constraint "atoms_uuid_idx"
DETAIL:  Key (uuid)=(2441253852) already exists.

[2017-05-07 17:01:27:152] [WARN] PQ query was: INSERT INTO Atoms (uuid,
space, type, height, outgoing) VALUES (2441253852, 1, 43, 1, '{1888882,
127137759}');


dohhh Need to reserve some uuid's!


[2017-05-04 17:31:29:122] [ERROR] There is no value for key
(PredicateNode "link count") ; [8812231717367445517][1]
 on atom (AnchorNode "MST data") ; [1539316140051770629][1]

createdb -T en_pairs_mst -e en_pairs_sim "forked from en_pairs_mst, holds similarity data"

COMMENT ON DATABASE en_pairs_mst IS 'forked from en_pairs_rohit, holds disjunct data';

COMMENT ON DATABASE en_pairs_rohit IS 'forked from en_pairs_2016, converted to modern format';

COMMENT ON DATABASE en_pairs_2016 IS 'Rohits original pair data; old format; missing correct word-counts';

(define ac (filter-words-with-csets (get-all-words)))

(cset-vec-len
(cset-vec-observations

(define lens (map (lambda (wrd) (cons (cset-vec-len wrd) wrd)) ac))

(define slens (sort lens (lambda (a b) (> (car a) (car b)))))

(define obs (map (lambda (wrd) (cons (cset-vec-observations wrd) wrd)) ac))

(define sobs (sort obs (lambda (a b) (> (car a) (car b)))))


(define firm (filter (lambda (wrd) (< 8.0 (cset-vec-len wrd))) ac))

*) count words during MST
err this can be reconstructed by taking:
   counts of disjuncts  based on counts of csets .... 
so never mind....

what are teh most comon disjuncts???

(filter (lambda (cset) (< 10 (get-count cset)))
	(cog-incoming-by-type (Word "United") 'LgWordCset))

156 ... 125.888

5  41.44827196747233 "and"
8  31.658516707416464 "as"
10  30.140583554376658 "well"
11  29.969530201342277 "in"
18  18.805788982259568 "first"
21  17.254613233923575 "is"
22  16.742203742203742 "also"
23  15.386776859504135 "can"
24  15.359470949456778 "on"
25  14.910157559503853 "at"
26  14.424603174603176 "been"
31  13.231375985977214 "but"
32  13.122743682310471 "part"
34  12.835568802781918 "with"
35  12.835051546391755 "old"
36  12.726962457337885 "same"
38  11.925403225806452 "one"
39  11.611694152923539 "which"
43  10.856905158069885 "not"

(filter (lambda (cset) (< 5 (get-count cset)))
	(cog-incoming-by-type (Word "Gestalt") 'LgWordCset))

(.+) 34
(of -)  14

(is+) 216
was+ 197
(has+ 55
was+ was+ 12
is+ was+ 10

get-cset-vec
ad   cset-vec-observations
(define disjunct-entropy
(define total-cset-count (cset-observations all-cset-words))
(define all-cset-words (filter-words-with-csets (get-all-words)))

(define total-cset-count 0)
(cog-map-type 
	(lambda (cset) 
		(set! total-cset-count (+ total-cset-count (get-count cset))) #f)
	'LgWordCset)

7.984991833299495  bits total MI bits

(cset-vec-mi (Word "United"))  7.116097374166928
is the relative(?) MI to the disjuncts in the word.
(is how much MI this word contributes to the total MI)
(and its slightly below average)

(cset-vec-frequency (Word "United"))

(/ (log (cset-vec-frequency (Word "United"))) (log 2))
-10.48276867673862  is the entropy for that word, only.

"Cao" "Award" "x" "y" "Prime" "we" "per" "Division" "League" "Game"

(define cao (get-cset-vec (Word "Cao")))

34 (length cao)

(filter (lambda (cset) (< 10 (get-count cset))) cao)

18  ,- Cao- Cao+  garbage !!

8 Grammy- for+ Best+
7 Academy- for+ Best+

23 Minister+
5 the- Minister+
3 as- Minister+
3 Governor-General- Minister+

 "The" "a" "to" "in" "of" "and" "the" "," "."

 "Bay" "Street" "Island" "of" "century" "right" "Game" "Georgian" "or" "a" ";" "near" "Party" "team" "law" "Australia" "her" "research" "Church" "east" "Government"

--------------------------------------------------------------

1985 words of length > 8
all pairs of above with cosine > 0.5

23993 pairs, but some are junk
15809 good pairs.

store-sim
 (sim-pair WORD-A WORD-B) cos-key
            (FloatValue SIM (get-angle SIM)))
(define (sim-pair WORD-A WORD-B) (SimilarityLink WORD-A WORD-B))
(define cos-key (PredicateNode "*-Cosine Distance Key-*"))


(define all-sims '())
(cog-map-type
	(lambda (sim)  (set! all-sims (cons sim all-sims)) #f)
	'SimilarityLink)

(define (cosine-of-sim SIM)
	(car (cog-value->list (cog-value SIM cos-key))))

(define good-sims
(filter
	(lambda (sim)
		(< 0.5 (car (cog-value->list (cog-value sim cos-key)))))
	all-sims))


(map (lambda (sim) (sim-cosine sim)) (take ranked-sims 20))
	

 'Poir .. Perls'
 'Poir .. Sevan'
 'Sevan .. Perls'
 'Sevan .. Ruins'
 'Ruins .. Perls'
 'Poir .. Ruins'
 'Gongora .. Perls'
  'Poir .. Gongora'
  'Gongora .. Sevan'
  'Gongora .. Ruins'
  'Poir .. Gag'

 (use-modules (opencog) (opencog persist) (opencog persist-sql))
 (use-modules (opencog nlp) (opencog nlp learn))
 (sql-open "postgres:///en_pairs_sim?user=linas")
 (use-modules (opencog cogserver))
 (start-cogserver "opencog2.conf")
 (fetch-all-words)
(fetch-pseudo-csets (get-all-words))

70 74 128

95  0.953598053136202  'conjunction .. accordance'

504  0.868429815807705  'in .. from'
633  0.8549756852697713  'in .. at'
637  0.8545553489854567  'In .. By'
643  0.8540378312493768  'in .. After'
740  0.846034030453443  'canal .. swamp'


754  0.843837363738534  'at .. At'
757  0.8436223414042503  'in .. In'
818  0.838269351079866  'in .. on'
840  0.8366056647469058  'creation .. existence'
878  0.8332692184393486  'e.g .. i.e'
965  0.8265058609938521  'and .. but'
969  0.8264399296782371  'in .. With'
971  0.8263325988164274  'in .. inside'


canal -- 68 dj 

(define (prt-sim sim port)
   (format port "~A  '~A .. ~A'\n" (sim-cosine sim)
      (cog-name (gar sim)) (cog-name (gdr sim))))

get-disjunct-string

20.0  canal  the-
8.0  canal  the- .+
5.0  canal  the- ,+

14.0  swamp  the-
3.0  swamp  the- .+


18.0  creation  the- of+
10.0  existence  the- of+

627  in  the+
75  in  a+
61  in  which+
49  in  the+ the+
36  in  used-
33  in  his+
32  in  order+
31  in  United+
27  in  gallantry-
26  in  born-
23  in  role-

8338 -- in
2185 from

155  from  the+
20  from  :+ :+ :+ :+ :+ :+ :+ :+ :+ :+ 0+ 0+ 0+ 0+ 0+ 0+ 0+ 0+ 0+ 0+
18  from  a+
9  from  derived-
9  from  until+
9  from  degree-
8  from  his+
8  from  comes-
8  from  away-
7.0  from  time+
7.0  from  the+ the+

get-pair-mi
get-pair-mi-str ("

MI(fast, horse) = 5.258979
MI(fast, car) = 3.805734

(get-pair-logli get-any-pair (Word "fast") (Word "horse"))
-log P(fast, horse) = 24.054777  P = 5.7383969102974027e-8
-log P(fast, car) = 23.832385  P = 6.694794440144226e-8


-log P(*, horse) = 14.383531  P = 4.6787056718009e-5
-log P(*, car) = 12.707894    P = 1.4946610743515038e-4
-log P(fast, *) =  14.930225  P = 3.2029815202410256e-5


MI(fast, {hosrse, car}) = linear interploation of the two. 
  [
  p(fast,horse) log p(fast, horse) / p(fast,*) p(*,horse)
+
  p(fast,car) log p(fast, car) / p(fast,*) p(*,car) ] 
   / [p(fast,horse) + p(fast,car)]

= [ p(fast,horse) 5.258979 + p(fast,car) 3.805734] /
     1.2433191350441628e-7
= 5.565671566878678e-7 / 1.2433191350441628e-7 
= 4.476462567015012



(get-left-wild-prob GETTER WORD)
(get-left-wild-log-prob GETTER WORD)
(get-pair-prob GETTER WORD WORD)

(get-logli ATOM)

(define (get-left-wild-prob GETTER WORD)
	(EvaluationLink any-pair-pred (ListLink any-left word))
(define (get-any-wild-wild)
   (EvaluationLink any-pair-pred (ListLink any-left any-right))
)

(define (get-any-wild-wild)
   (EvaluationLink any-pair-pred (ListLink any-left any-right))
)

get-any-pair PAIR -- public OK defined in common.scm
get-clique-pair PAIR --public OK

kill get-pair-mi-str 
make get-pair-mi public. done


(define all-cset-words (filter-words-with-csets (get-all-words)))
(define all-disjuncts (get-all-disjuncts))
(define all-csets (get-all-csets))
(define total-cset-count (get-total-cset-count))

in the en_pairs sim: MI is  7.9849918332741225
(- (+ 10.280666542033556 16.00578269190252) 18.301457400661953)

in en_pairs_mst:
(length all-cset-words) 49423
(length all-disjuncts) 486824  + 73 more
(length all-csets) 749337 + 118 more
total-cset-count 1154809  + 235 more
word-entropy-bits 10.353641069558124
disjunct-entropy-bits 16.48346995957877
cset-entropy-bits 18.958440018522307
MI is 7.878671010614585

all connectors ...
(length (get-all-pseudo-connectors)) 81557


wtf:
(length all-disjuncts) 225396 
wiki-mst-en.sh is running
why is get_nodes bad? because no nodes are being created. so that OK.
why is total stores for node =0?  just like above. its OK.

postgres:///en_pairs_mst?user=linas  is the ongoing accumulation of mst stats...

guile -l mst-count-en.scm
335 secs for words
1071 secs for pairs
results size is 32G for 19741168 atoms
1213 secs for csets


fix message -- done
add  sql-clear-stats -- done

./mst-one.sh en gamma-pages/G/Gzhelian localhost 17001


move base-stats.scm to pair-stats.scm -- DONE

Cannot connect to database: FATAL:  remaining connection slots are reserved for non-replication superuser connections

get-clique-pair get-any-pair

(display-backtrace (fluid-ref the-last-stack))

Throw to key `bad-summation' with args `(count-all-pairs "Error:
pair-counts unequal: 5974976.0 5754410.0\n")'.
pair-counts unequal: 5974600.0 5761584.0\n")'. afer redoing the left!
pair-counts unequal: 5974600.0 5761584.0\n")'  afer doing left 2x
pair-counts unequal: 5974976.0 5761682.0\n")' after redoing right.
pair-counts unequal: 5974976.0 5761682.0\n")' after right 2x
pair-counts unequal: 5974600.0 5761584.0\n") after redoing  left

(define aw (get-all-words))

(ob 'left-stars)

(define save-1 (map (lambda (w) (cons (ob 'left-wild-count w) w)) aw))

(length (cob 'cache-all-left-counts))

(for-each (lambda (a b) (if (not (equal? a b)) (error "aiiide ~A ~A" a b)))
	save-1 save-2)

ERROR: aiiide ~A ~A (54.0 . (WordNode "d'Urville")
) (56.0 . (WordNode "d'Urville")
)

So... recomputing the right counts changed the left-count on above....

wtf.... (ob 'left-wildcard w) is empty....

set-pair-count calls make-pair
set-left-wild-count calls set-pair-count with 'left-wildcard  which is null

foobar confused about which pari si which

Glurg. and now its this:

pair-counts unequal: 2133920.0 1168749.0\n")'
(define w (WordNode "d'Urville"))
(define ob (make-pair-wild (make-any-link)))
(define ob (make-pair-count-api ob))
(define cob (make-compute-count ob))

(ob 'left-support-size)
(length (ob 'left-stars))
 (cob 'compute-total-count)
(length (cob 'cache-all-left-counts))
(cob 'compute-total-count)
(define save-1 (map (lambda (w) (cons (ob 'left-wild-count w) w)) aw))

(cob 'compute-left-count w)
(ob 'left-wildcard w)
(ob 'right-wildcard w)
(ob 'left-wild-count w)

(for-each (lambda (a b) (if (not (equal? a b)) (error "aiiide ~A ~A" a b)))
	save-1 save-2)

(fold (lambda (p s) (+ s (car p))) 0 save-1)   1173656.0

(define rave-1 (map (lambda (w) (cons (ob 'right-wild-count w) w)) aw))

(fold (lambda (p s) (+ s (car p))) 0 rave-1)   2133920.0

(define (lsum w)
	(

1) fetch failed
2) compute failed.
3) left-stars returns junk fixed

(define mave-1 (map (lambda (w) (cons (ob 'left-wild-count w) w)) aw))

pair-counts unequal: 34692424.0 34689203.0\n")'.

Elapsed time to load words: 45 secs
Done loading words, now loading any-pairs
Elapsed time to load ANY-link pairs: 322 secs
Finished loading any-word-pairs
Support: num left=106696 num right=106696
Done with wild-card count N(*,w) and N(w,*) in 222 secs << par-map vs..  217
Done computing N(*,*) total-count=34688664.0 in 13 secs
Start computing log P(*,w)
Done computing 106696 left-wilds in 39 secs  << 120% vs. 15
Done storing 106696 left-wilds in 458 secs  << par-for vs 101 secs for non-par
Done with -log P(*,w), start -log P(w,*)
Done computing 106696 right-wilds in 45 secs vs. 15 now
Done storing 106696 right-wilds in 458 secs << par-for vs 103 now
Done computing -log P(w,*) and <-->
Going to do individual word-pair MI
Done computing 2360328 pair MI's in 962 secs (1124 secs under load)
Stored 100000 of 2360328 pairs in 191 secs (523.5602094240837 pairs/sec)
....
Stored 2000000 of 2360328 pairs in 317 secs (315.45741324921136 pairs/sec)
Stored 2100000 of 2360328 pairs in 251 secs (398.40637450199205 pairs/sec)
Stored 2200000 of 2360328 pairs in 254 secs (393.7007874015748 pairs/sec)
Stored 2300000 of 2360328 pairs in 300 secs (333.3333333333333 pairs/sec)
Done storing 2360328 pair MI's in 6964 secs  <<< 6847 under load
Finished with MI computations

Sooo any-pair:
  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
 5180 linas     20   0 11.819g 8.935g  37080 S   0.0  3.5 117:00.53 guile
 5525 linas     20   0 11.483g 8.931g  37616 S   0.0  3.5 129:07.73 guile


----------------
clique pairs:

Start loading words ...
Elapsed time to load words: 45 secs
Done loading words, now loading clique pairs
Elapsed time to load clique pairs: 1145 secs  <<< vs 322 for any-pairs
Finished loading clique-word-pairs
Support: num left=106696 num right=106696
Done with wild-card count N(*,w) and N(w,*) in 737 secs  <<< vs 215 for any
Done computing N(*,*) total-count=31628463.0 in 14 secs  <<<!? almost the same??
Start computing log P(*,w)
Done computing 106696 left-wilds in 14 secs
Done storing 106696 left-wilds in 103 secs
Done with -log P(*,w), start -log P(w,*)
Done computing 106696 right-wilds in 15 secs
Done storing 106696 right-wilds in 103 secs
Done computing -log P(w,*) and <-->
Going to do individual word-pair MI
Done computing 4810 pair MI's in 37872 secs << 10.5 hours!!!
Done storing 4810 pair MI's in 7 secs   << whhhat!????
Finished with MI computations


  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
17274 linas     20   0 26.656g 0.024t  37676 S   0.0  9.6 406:04.03 guile


=================================================================
=================================================================
disjuncts & csets:

Start loading words ...
Elapsed time to load words: 126 secs   << now 112 ...814 ... 22 .. 20
Done loading words, now loading pairs
Elapsed time to load csets: 783 secs  << now 367 on fresh..553...294..309
Finished loading any-word-pairs
Support: num left=396262 num right=291637  << in 18 13
Done with wild-card count N(*,w) and N(w,*) in 39 secs  `<< now 203 !???  fluke
    << 85 after redesign ,, 72
Done computing N(*,*) total-count=661104.0 in 34 secs << uncahnged
    << 14 after redesign 15
Done computing 446204 pairs in 13 secs << 23 after red 24
Start computing log P(*,w)
Done computing 291637 left-wilds in 33 secs << 27
Done storing 291637 left-wilds in 670 secs << now  493 .. 711 (spin media)
    << dropped to 87 secs on SSD
Done with -log P(*,w), start -log P(w,*)
Done computing 396262 right-wilds in 26 secs  now 4 secs
Done storing 396262 right-wilds in 549 secs  <<< now  28 !! wtf ??? .. 47
Done computing -log P(w,*) and <-->
Going to do individual word-pair MI
Done computing 446204 pair MI's in 88 secs << 70 secs
Stored 100000 of 446204 pairs in 268 secs (373.13432835820896 pairs/sec)
Stored 200000 of 446204 pairs in 238 secs (420.16806722689074 pairs/sec)
Stored 300000 of 446204 pairs in 286 secs (349.65034965034965 pairs/sec)
Stored 400000 of 446204 pairs in 303 secs (330.03300330033005 pairs/sec)
Done storing 446204 pair MI's in 1215 secs ... 1345 (spin media)
    << 201 secs SSD
Going to do column and row subtotals
Finished left entropy subtotals in 46 secs << 43
Finished right entropy subtotals in 20 secs << 16
Finished left MI subtotals in 40 secs << 35
Finished right MI subtotals in 12 secs << 8

Finished with MI computations



(use-modules (opencog) (opencog persist) (opencog persist-sql))
(use-modules (opencog nlp) (opencog nlp learn))
(sql-open "postgres:///en_pairs_sim?user=linas")
(use-modules (opencog cogserver))
(start-cogserver "opencog2.conf")
(define pca (make-pseudo-cset-api))
(batch-pairs pca)

(pca 'fetch-pairs)
(print-matrix-summary-report pca #t)
(define psa (add-pair-stars pca))(define psa (add-pair-stars pca))
(define sup (add-support-compute psa))
(sup 'cache-all)
(define cca (make-central-compute psa))
(cca 'cache-all)
(define sto (make-store psa))
(sto 'store-wildcards)

(print-matrix-summary-report pca #t)
Summary Report for Correlation Matrix Word-Disjunct Pairs (aka Connector
Sets)
Left type: WordNode    Right Type: LgAnd    Pair Type: LgWordCset
Wildcard: (ListLink (ctv 0 0 661104)
   (AnyNode "cset-word")
   (AnyNode "cset-disjunct")
)
Rows: 37413 Columns: 291637
Size: 446204 non-zero entries of 10911015081 possible
Fraction non-zero: 4.0895E-5 Sparsity (-log_2): 14.578
Total observations: 661104.0  Avg obs per pair: 1.4816
Entropy Total: 18.301   Left: 16.006   Right: 10.281
Total MI: -7.985

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  4122.        370.0
Count   (l_1)  8763.        680.7         2.126        1.839
Length  (l_2)  236.8        51.39         5.7452E-2    .1389
RMS Count      216.6        46.40         5.2550E-2    .1254



duuuu
(define pca (make-pseudo-cset-api))
(define wpca (add-pair-wildcards pca))
(define cpca (add-pair-count-api pca))
(define fpca (add-pair-freq-api pca))

(define w (car (wpca 'left-support)))
(define d (car  (wpca 'right-support)))
(cpca 'left-wild-count d)
(define d (car (drop-while 
	(lambda (dj) (> 10 (cpca 'left-wild-count dj))) (wpca 'right-support))))

(define w (car (drop-while 
	(lambda (wrd) (> 10 (cpca 'right-wild-count wrd))) (wpca 'left-support))))

(cpca 'right-wild-count w)

(fpca 'left-wild-freq d)
(/ (cpca 'left-wild-count d) (cpca 'wild-wild-count))

(fpca 'right-wild-freq w)
set-right-wild-freq

(define cf (make-compute-freq (add-pair-freq-api (add-pair-wildcards cpca))))
(cf 'init-freq)
(cf 'compute-right-freq w)
(cf 'cache-right-freq w)
'compute-right-freq w

(define righties (cf 'cache-all-right-freqs))
(define okr (filter (lambda (x) (not (null? x))) righties))
(length okr)

etierh not iint or ot being computed.   FIXED

ERROR: In procedure cog-value: There is no value for key (PredicateNode
"*-FrequencyKey-*") ; [6632538966455889482][1]
 on atom (LgWordCset (ctv 1.000000 0.000000 1.000000)

(LgWordCset 
   (WordNode "dentist" 
   (LgAnd
      (PseudoConnector
         (WordNode "an")
         (LgConnDirNode "-"))
      (PseudoConnector
         (WordNode ",")
         (LgConnDirNode "+"))))


there's no compute-pair    'set-pair-freq

=========================================================================


2017-05-13 01:35:49 UTC [229-2879] LOG:  checkpoints are occurring too frequently (29 seconds apart)
2017-05-13 01:35:49 UTC [229-2880] HINT:  Consider increasing the configuration parameter "max_wal_size".

pre postgres 9.5:
 checkpoint segments. 100 or so is not out of the ordinary.
 increase your checkpoint_timeout to 1 hour, as well as look at
increasing your checkpoint_completion_target
------

2017-05-17 07:48:25 UTC [228-1] LOG:  database system was shut down at 2017-05-17 05:02:36 UTC
2017-05-17 07:48:25 UTC [229-1] [unknown]@[unknown] LOG:  incomplete startup packet
2017-05-17 07:48:25 UTC [228-2] LOG:  invalid primary checkpoint record
2017-05-17 07:48:25 UTC [228-3] LOG:  invalid secondary checkpoint record
2017-05-17 07:48:25 UTC [228-4] PANIC:  could not locate a valid checkpoint record
2017-05-17 07:48:25 UTC [230-1] postgres@postgres FATAL:  the database system is starting up
2017-05-17 07:48:25 UTC [203-1] LOG:  startup process (PID 228) was terminated by signal 6: Aborted
2017-05-17 07:48:25 UTC [203-2] LOG:  aborting startup due to startup process failure
2017-05-17 07:51:21 UTC [1430-1] LOG:  database system was shut down at 2017-05-17 05:02:36 UTC
2017-05-17 07:51:21 UTC [1430-2] LOG:  invalid primary checkpoint record
2017-05-17 07:51:21 UTC [1430-3] LOG:  invalid secondary checkpoint record
2017-05-17 07:51:21 UTC [1430-4] PANIC:  could not locate a valid checkpoint record
2017-05-17 07:51:21 UTC [1429-1] LOG:  startup process (PID 1430) was terminated by signal 6: Aborted
2017-05-17 07:51:21 UTC [1429-2] LOG:  aborting startup due to startup process failure


http://stackoverflow.com/questions/8799474/postgresql-error-panic-could-not-locate-a-valid-checkpoint-record

 time cp -pr main main-fu  <<< 23 minutes
 du -sm  <<  81638  -- 82 gigabytes!

/usr/lib/postgresql/9.5/bin/pg_resetxlog  /var/lib/postgresql/9.5/main
Transaction log reset

sudo service postgresql start

2017-05-17 13:17:08 UTC [15452-1] LOG:  database system was shut down at 2017-05-17 13:05:10 UTC
2017-05-17 13:17:08 UTC [15452-2] FATAL:  could not access status of transaction 2804419190
2017-05-17 13:17:08 UTC [15452-3] DETAIL:  Could not open file "pg_clog/0A72": No such file or directory.
2017-05-17 13:17:08 UTC [15451-1] LOG:  startup process (PID 15452) exited with exit code 1
2017-05-17 13:17:08 UTC [15451-2] LOG:  aborting startup due to startup process failure


https://www.postgresql.org/message-id/AANLkTims48njGKkvkXHiTG6=19hQ31VFmFRPPLg+5w03@mail.gmail.com

dd if=/dev/zero of=Transaction_missing_file_of pg_clog bs=256K count=1
(To make the uncommitted record as they haven't been committed).

dd if=/dev/zero of=0A72 bs=256K count=1


Last entries in pg_clog are from 14 May, so 3 days of nothingness.
2017-05-17 13:27:53 UTC [24212-1] LOG:  database system was interrupted; last known up at 2017-05-17 13:17:08 UTC
2017-05-17 13:27:53 UTC [24212-2] LOG:  database system was not properly shut down; automatic recovery in progress
2017-05-17 13:27:53 UTC [24212-3] LOG:  invalid record length at D62/6C000098
2017-05-17 13:27:53 UTC [24212-4] LOG:  redo is not required
2017-05-17 13:27:53 UTC [24212-5] FATAL:  could not access status of transaction 2124106599
2017-05-17 13:27:53 UTC [24212-6] DETAIL:  Could not open file "pg_multixact/offsets/7E9B": No such file or directory.

dd if=/dev/zero of=7E9B bs=256K count=1
members/1FA5

psql
\l

en_pairs
en_pairs_old
en_pairs_partial
en_snapshot

pg_dump en_pairs
pg_dump -cC en_pairs
pg_dumpall 

time pg_dump en_pairs >en_pairs.sql 

pg_dump: Dumping the contents of table "valuations" failed: PQgetResult() failed.
pg_dump: Error message from server: ERROR:  could not access status of transaction 2786849088
DETAIL:  Could not open file "pg_clog/0A61": No such file or directory.

dd if=/dev/zero of=~/9.5/main/pg_clog/0A61 bs=256K count=1
pg_clog/0A51
pg_clog/0A70
pg_clog/0A59
pg_clog/0A5C
pg_clog/0A50
pg_clog/093A

everything from that to 0A5E

for ((i=0;i<293;i++))
do
        b=$(echo "ibase=16;93A" | bc)
        j=$(echo "$b+$i" |bc)
        k=$(echo "obase=16;$j" | bc)
        echo dd if=/dev/zero of=~/9.5/main/pg_clog/0$k bs=256K count=1
done

pg_clog/0923
pg_clog/08E4
pg_clog/085E
0524
pg_clog/0523

mv /var/lib/postgresql/9.5/main /var/lib/postgresql/9.5/main-semi-fu

/usr/lib/postgresql/9.5/bin/initdb /var/lib/postgresql/9.5/main
CREATE ROLE ubuntu WITH CREATEDB;
ALTER ROLE ubuntu WITH LOGIN;
createdb en_pairs
psql en_pairs < ~/src/atomspace/opencog/persist/sql/multi-driver/atom.sql

time psql en_pairs < /var/lib/postgresql/en_pairs.sql
real    59m16.468s
user    0m57.480s
sys     0m12.480s

psql en_pairs
select count(*) from atoms where type=123; 123 == wordnode
276715  << there used to be about a million, here

select count(*) from atoms where type=81; 81 == evaluationlink.
37199086  37 M. Hmmm

select sum(floatvalue[3]) from valuations where type=7;
select * from valuations limit 1;
select * from atoms, valuations where valuations.type=7 and valuations.atom=atoms.uuid and atoms.type = 81 limit 1;

Total counts on all evaluationlinks.
(this should be doubled, clique and any.)
select sum(floatvalue[3]) from atoms, valuations where valuations.type=7 and valuations.atom=atoms.uuid and atoms.type = 81;

gives: 327030163 == 327M observations of links! wow!

Nonetheless, restart from scratch.

ALTER DATABASE en_pairs RENAME TO en_pairs_semi_fu;

COMMENT ON DATABASE en_pairs_semi_fu IS 
   'rohit-pairs and some gutenberg, after the crash'; 




=======================================
and again, on fanny:

time cp -pr main main-fu

real    23m29.237s
user    0m0.464s
sys     2m54.152s

/usr/lib/postgresql/9.6/bin/pg_resetxlog  /var/lib/postgresql/9.6/main
/usr/lib/postgresql/9.6/bin/pg_resetxlog  -f /var/lib/postgresql/9.6/main

pg_clog/0351

dd if=/dev/zero of=~/9.6/main/pg_clog/0351 bs=256K count=1
pg_multixact/offsets/057A
pg_multixact/members/0E99
Those 3 fixed it.

time pg_dumpall > everything.sql
pg_clog/033C 
create all from 02CE to pg_clog/0350

#!/bin/bash


# inclusive
start=$(echo "ibase=16;2CE" | bc)
end=$(echo "ibase=16;350" | bc)

len=$(echo "$end-$start+1" | bc)
echo $len

for ((i=0;i<$len;i++))
do
        j=$(echo "$start+$i" |bc)
        k=$(echo "obase=16;$j" | bc)
        # echo $k
        dd if=/dev/zero of=~/9.6/main/pg_clog/0$k bs=256K count=1
done

cd /home2/postgresql/data-lost-dumps
time pg_dumpall > everything.sql
real    13m5.740s
user    1m13.272s
sys     1m3.764s
-rw-r--r--  1 postgres postgres 15190388055 May 17 15:59 everything.sql
so 15 gigabytes.

sudo service postgresql stop
mv /var/lib/postgresql/9.6/main /var/lib/postgresql/9.6/main-semi-fu
/usr/lib/postgresql/9.6/bin/initdb  /var/lib/postgresql/9.6/main

sudo service postgresql start

time psql < /home2/postgresql/data-lost-dumps/everything.sql
real    55m43.405s
user    1m13.960s
sys     0m21.596s


=======================================
objdump -d post-process.o

linkage_set_domain_names +0xe0

linkage->pp_info[j].num_domains = k;
for (d = pp->d_type_array[j]; d != NULL; d = d->next) k++;
char buff[] = {d->type, '\0'}
string_set_add (buff, postprocessor->string_set);
build_type_array  not needed if not printed.

linkage->pp_info[j].domain_name[k] =

=====================================================
en_pairs_2016
-------------
Rohit's original pair data; old format; missing correct word-counts.
All data is from Wikipedia article random planar-tree parses.
Contains word-pair counts only (and some MI calcs in obsolete format).

STATUS: obsolete, archived.
DATE: 17 May 2017
REASON: converted to newer format.

en_pairs_2016=> \dt+
                       List of relations
 Schema |   Name    | Type  | Owner |    Size    | Description
--------+-----------+-------+-------+------------+-------------
 public | atoms     | table | linas | 2198 MB    |
 public | global    | table | linas | 8192 bytes |
 public | spaces    | table | linas | 8192 bytes |
 public | typecodes | table | linas | 48 kB      |
(4 rows)


select count(atoms.stv_count) from atoms, typecodes where
atoms.type=typecodes.type and typecodes.typename='EvaluationLink';

gives: 9045489  i.e. 9M different evlinks
gives 536234371 i.e. 536M observations  when sum()
gives 396255  distinct wordnodes

866733953 bytes uncompressed.
141609207 bytes compressed
md5sum en_pairs_2016.sql.bz2
28577666fb51d3dc3658688a73e8bee6  en_pairs_2016.sql.bz2

==================================================================

en_pairs_rohit
--------------
forked from en_pairs_2016, converted to modern format
This includes 8.9 word-pairs with MI on them. (But the MI is
in the old format).

STATUS: obsolete, archived.
DATE: 18 May 2017
REASON: This is included in the newer en_pairs_mst, which contains
all data here, plus data from MST parsing. Also, since its word-pairs
from wikipedia only, the data quality is mediocre.

en_pairs_rohit=> \dt+
                        List of relations
 Schema |     Name     | Type  | Owner |    Size    | Description
--------+--------------+-------+-------+------------+-------------
 public | atoms        | table | linas | 1735 MB    |
 public | atoms_backup | table | linas | 2198 MB    |
 public | global       | table | linas | 8192 bytes |
 public | spaces       | table | linas | 8192 bytes |
 public | typecodes    | table | linas | 48 kB      |
 public | valuations   | table | linas | 2321 MB    |
 public | values       | table | linas | 8192 bytes |
(7 rows)

atoms_backup is a copy of atoms from en_pairs_2016

SELECT count(*) FROM atoms;  <<< 19741280 = 19M atoms total

SELECT count(*) FROM atoms WHERE height=0; <<<  396313 = 396K
SELECT count(*) FROM atoms WHERE height=1; <<< 9672482 = 9.6M
SELECT count(*) FROM atoms WHERE height=2; <<< 9672472 = 9.6M
SELECT count(*) FROM atoms WHERE height=3; <<<      13

select count(atoms.uuid) from atoms,typecodes where
atoms.type=typecodes.type and typecodes.typename='EvaluationLink';

gives 9672459 i.e. 9.6M atoms. This is a 6% more than en_pairs_2016,
(which had 9.0M) because maybe it includes the partial sums??

gives 396262 WordNodes -- as before, plus 7 new test words.

select sum(valuations.floatvalue[3]) from atoms,typecodes,valuations where
valuations.atom = atoms.uuid and
atoms.type=typecodes.type and typecodes.typename='EvaluationLink';

gives 1672941118 == 1.6GB of counts so this is triple the pairs, because
it includes: left and right sums, and the total sum. Hmm. Should be
quadruple!?  Yes, see below.

select * from atoms where outgoing='{143427138,143427163}';
is the ListLink (Any Any)

select * from atoms where outgoing='{152,143670792}';
select * from valuations where atom=143670793;
gives 418235277 == 418M observations of ANY,ANY

 2440463583 |   53 |  *-Mutual Info Key-* | PredicateNode

select count(*) from valuations where key=2440463583;
8880914  so 8.9M pairs with mutual info on them.


2957364787 bytes uncompressed -- 2.9GB
448704179 bytes compressed -- 448 MBytes

 md5sum en_pairs_rohit.sql
792a8830520c8cdddb5b723656ae82cc  en_pairs_rohit.sql

 md5sum en_pairs_rohit.sql.bz2
6f85e89787cbf20c54167868867cf41c  en_pairs_rohit.sql.bz2

==================================================================

en_pairs_mst
------------
forked from en_pairs_rohit, holds disjunct data from MST parsing.
Both word-pairs and MST  parses came from wikipedia articles;
this appears to give only mediocre results.

STATUS: archived. Total junk, should be deleted.
DATE: 18 May 2017
REASON: The wikipedia-based data is mediocre.
Also:
a) it fails to separate quotation marks.
b) The any-disjuncts are junk.
c) The LgWordCset typename needs to be changed to Section
d) FATAL ERROR: all disjunct created with minus-the-MI and so are junk.

                       List of relations
 Schema |    Name    | Type  | Owner |    Size    | Description
--------+------------+-------+-------+------------+-------------
 public | atoms      | table | linas | 1886 MB    |
 public | spaces     | table | linas | 8192 bytes |
 public | typecodes  | table | linas | 48 kB      |
 public | valuations | table | linas | 2421 MB    |
 public | values     | table | linas | 8192 bytes |
(5 rows)

SELECT count(*) FROM atoms; <<< 21381856 = 21M atoms

SELECT count(*) FROM atoms WHERE height=0; <<<   396313 = 396K == rohit.
SELECT count(*) FROM atoms WHERE height=1; <<<  9763966 = 9.8M almost rohit
SELECT count(*) FROM atoms WHERE height=2; <<< 10280485 = 10.2M = 6% larger
SELECT count(*) FROM atoms WHERE height=3; <<<   941092 = 941K

The height-3 are exactly the pseudo-disjuncts.

SELECT count(atoms.uuid) FROM atoms,typecodes WHERE
atoms.type=typecodes.type AND typecodes.typename='EvaluationLink';

gives 9672459 so exactly the same as en_pairs_rohit, that's good.

'WordNode' gives 396262 -- 400K words, exactly same as before, Good.

'LgWordCset' gives 941092 - almost a million connector sets.

SELECT sum(valuations.floatvalue[3]) FROM atoms,typecodes,valuations
WHERE valuations.atom = atoms.uuid AND
atoms.type=typecodes.type AND typecodes.typename='LgWordCset';

gives 1669981 -- 1.7M observations of csets or maybe 1.8 obs per cset.
A bit disappointing....

2205218439 bytes uncompressed (2.2GB)
325948435 bytes compressed (325 MByte)

 md5sum en_pairs_mst.sql
955b7fe0578ded9a266f0874e8a02d6f  en_pairs_mst.sql

 md5sum en_pairs_mst.sql.bz2
ee81f6b11e4629ffa30efc0950af3595  en_pairs_mst.sql.bz2

==================================================================

simil_en
--------
The similarity database published on the web, forked from an earlier
version of en_pairs_mst.  Contains pairs derived only from wikipedia.
plus some number of disjuncts from mst parses.

STATUS: Total junk, should be deleted.
REASON: FATAL ERROR: all disjunct created with minus-the-MI and so are junk.

Published on web 12 May 2017
322343968 bytes compressed (322MBytes)

 md5sum simil_en.sql.bz2
b9bb221069867c5f4a307670a34387c8  simil_en.sql.bz2


==================================================================

en_pairs_sim
------------
Forked from earlier version of en_pairs_mst, contains less data.
(half as many disjuncts) This is the dataset analyzed in the diary.

The simil_en is a snapshot of this; the en_pairs_sim contains
additional caches of partial sums across disjuncts, etc.

STATUS: TOTAL JUNK, should be deleted.
DATE: 21 May 2017
REASON: FATAL ERROR: all disjuncts created with minus-the-MI,
        and so are junk.


                       List of relations
 Schema |    Name    | Type  | Owner |    Size    | Description
--------+------------+-------+-------+------------+-------------
 public | atoms      | table | linas | 1840 MB    |
 public | spaces     | table | linas | 8192 bytes |
 public | typecodes  | table | linas | 48 kB      |
 public | valuations | table | linas | 2702 MB    |
 public | values     | table | linas | 8192 bytes |
(5 rows)

SELECT count(atoms.uuid) FROM atoms,typecodes WHERE
atoms.type=typecodes.type AND typecodes.typename='EvaluationLink';

gives 9672459 so exactly the same as en_pairs_rohit, that's good.

'LgWordCset' gives 446204 which is as expected, (as reported in diary)

We are not creating a backup of this yet, the simil_en is good enough
backup; this dataset marches on as a working dataset.

==================================================================

en_pairs_semi_fu
----------------
Forked from en_pairs_rohit, plus more WP data, plus some gutenberg.
Has some data loss (many missing words, missing LGLink-pairs), due to
server lockup + crash failure (and fsync was off, dohhhh).

Large database, bloated with ExecutationLinks, and the clique pairs,
which just are not useful at this time. In fact, 95% of the atoms are
these junk atoms.  This dataset is just wayyy too bloated to be useful.

STATUS: obsolete, archived.
DATE: 18 May 2017
REASON: abandoned. Too bloated to be useful, per above.

                       List of relations
 Schema |    Name    | Type  | Owner |    Size    | Description 
--------+------------+-------+-------+------------+-------------
 public | atoms      | table | linas | 12 GB      | 
 public | spaces     | table | linas | 8192 bytes | 
 public | typecodes  | table | linas | 48 kB      | 
 public | valuations | table | linas | 9633 MB    | 
 public | values     | table | linas | 8192 bytes | 
(5 rows)

SELECT count(*) FROM atoms;   <<< 132172780 = 132M atoms total


SELECT count(atoms.uuid) FROM atoms,typecodes WHERE
atoms.type=typecodes.type AND typecodes.typename='EvaluationLink';

gives 37199086 = 37M evlinks compared to rohits 9M

However, of these
SELECT count(*) FROM Atoms WHERE outgoing @> ARRAY[CAST(29 AS BIGINT)];
where PredicateNode "*-Sentence Word Pair-*" uuid=29;
gives 29637409 = 29.6M clique-pairs

vs LinkGrammarRelationshipNode uuid=141; <<< 7561677 7.5M

So many of rohit's pairs were lost, and most of the new data are the
cliique pairs.

'WordNode' gives 276715 which is 2/3rds of rohits 400K so where did
   all the words go? More importantly, why aren't the foreign-key 
   constraints violated???

'ExecutionLink' has 62936410 = 62M counted pairs

SELECT count(*) FROM atoms WHERE height=0;   <<<     276972  = 277K
SELECT count(*) FROM atoms WHERE height=1;   <<<   30958666  = 30M
SELECT count(*) FROM atoms WHERE height=2;   <<<  100135499  = 100M
SELECT count(*) FROM atoms WHERE height=3;   <<<     801643  = 802K
SELECT count(*) FROM atoms WHERE height=4;   <<<          0

wtf is height=3? Answer: some (many?) random "ANY" disjuncts
from the random tree parses. (!)  These have low UUID's!

Max observed UUID is 135947882
Loaded 276972 atoms at height 0 <<< so a lot of words are missing.
also: there are 508 links with missing uuids in thier outgoing set.

7721725512 bytes uncompressed (7.7GB) 17 May 2017
1207333639 bytes compressed (1.2GB)

 md5sum en_pairs_semi_fu.sql.bz2
06b0acfecf9f5d4b25cca903b8f3b2a7  en_pairs_semi_fu.sql.bz2

==================================================================
en_snap
-------
STATUS: deleted
DATE: 21 May 2017
REASON: bloated junk, looks like wikipedia.

select count(*) from atoms;   <<< 41511869 = 41M

A total of 106696 = 106K WordNodes

 SELECT count(*) FROM Atoms WHERE outgoing @> ARRAY[CAST(141 AS BIGINT)]; 
gives 2786640 == 2.7M  LG links.

and 9587761 = 9.6M clique pairs, and 18M ExecutionLinks.

==================================================================
en_pairs_tone
-------------
Random-planar-tree parsed books from "tranche-1" of mostly project
gutenberg books. Contains counts for word-pairs, words and disjuncts.

STATUS: poor
DATE: 24 May 2017
REASON: Multiple issues:
a) it fails to separate quotation marks.
b) The any-disjuncts are junk.
c) Missing links to ###LEFT-WALL### 
d) FATAL ERROR: all disjuncts created with minus-the-MI, and so are junk.

                        List of relations
 Schema |    Name    | Type  | Owner  |    Size    | Description 
--------+------------+-------+--------+------------+-------------
 public | atoms      | table | ubuntu | 909 MB     | 
 public | spaces     | table | ubuntu | 40 kB      | 
 public | typecodes  | table | ubuntu | 56 kB      | 
 public | valuations | table | ubuntu | 591 MB     | 
 public | values     | table | ubuntu | 8192 bytes | 
(5 rows)

select count(*) from atoms;  <<< 10317409 = 10M atoms total
WordNodes: 139790 -- 140K
EvaluationLink : 4886362 -- 4.9M
ListLink: exactly the same.
LgWordCset: 404882 = 405K   Hmm Curious.

select count(*) from valuations; <<< 5431036 = 5.4M values

SELECT sum(floatvalue[3]) FROM valuations WHERE type=7;
 gives  396713166 << 397M total obs.

SELECT sum(valuations.floatvalue[3]) FROM valuations, atoms, typecodes
WHERE valuations.atom=atoms.uuid AND atoms.type=typecodes.type AND
typecodes.typename='EvaluationLink';

gives 139806259 << 140M pair observations
.. WordNode: 125696239 << 125M obs
...LgWordCset: 125707119 << 126M disjuncts

SentenceNode: 330376 == 330K unique sentences
ParseNode: 5173173 == 5.1M parses
###LEFT-WALL### seen 5173095 = ... a few missing left-walls!?

464744628 bytes uncompressed == 464MB en_pairs_tone.sql 24 May 2017
81217915 bytes compressed == 81MB en_pairs_tone.sql.bz2

md5sum:
28562003d0567039571006803b716dc0  en_pairs_tone.sql
c4a981af336075f0121ac020887bfa47  en_pairs_tone.sql.bz2

==================================================================
en_pairs_tone_mst
-----------------
Disjuncts from MST-parsed books from "tranche-1" of mostly project
gutenberg books. Based off of the en_pairs_tone. Contains MI for tone,
but not the cosine angles.

STATUS: poor, obsolete.  Replaced by en_pairs_tone_mst_rev
        Should be deleted.
DATE: 27 May 2017  obsoleted on 9 June
REASON: Three issues:
 a) fails to separate quoation marks (inherited from tone)
 b) contains junk lg-any disjuncts
 c) Uses LgWordCset for for connectors and pseudo-connectors.
    Which screws up statistics. 
 d) FATAL ERROR: all disjuncts created with minus-the-MI, and so are junk.

en_pairs_tone_mst=> \dt+
                        List of relations
 Schema |    Name    | Type  | Owner  |    Size    | Description 
--------+------------+-------+--------+------------+-------------
 public | atoms      | table | ubuntu | 1496 MB    | 
 public | spaces     | table | ubuntu | 40 kB      | 
 public | typecodes  | table | ubuntu | 56 kB      | 
 public | valuations | table | ubuntu | 1871 MB    | 
 public | values     | table | ubuntu | 8192 bytes | 
(5 rows)

select count(*) from atoms; << 16487725 = 16.5M (6M more than baseline)

select count(*) from valuations; <<< 19330366 = 19.3M (14M more than base)

SELECT sum(valuations.floatvalue[3]) FROM valuations, atoms, typecodes
WHERE valuations.atom=atoms.uuid AND atoms.type=typecodes.type AND
valuations.type=7 AND typecodes.typename='EvaluationLink';

EaluationLink:  559225036 = 559M almost 4X more than baseline.
WordNode: 125696239 = 126M = identical to baseline;
LgWordCset: 133363005 = 134M  Hm. 9M more ob.
XXX Wait. Since 134M were ANY links, that means only 9M are MST links.
Oh wow. We need to fix this.

Key 10317416  *-FrequencyKey-*
Key 10872983  *-Mutual Info Key-*

1461271903 bytes uncompressed = 1.46G
208591406 bytes compressed = 209 MB

180dff2b3d683ad5559290338b5815fa  en_pairs_tone_mst.sql
e7dddab32c92b0fd0e88adfe6be1a87b  en_pairs_tone_mst.sql.bz2

==================================================================
en_pairs_tone_mst_rev
---------------------
Disjuncts from MST-parsed books from "tranche-1" of mostly project
gutenberg books. Based off of the en_pairs_tone. Contains MI for tone,
but not the cosine angles.

Uses the new PseudoAnd and PseudoWordCset types.
Kills the bogus lg-any disjuncts.
Contains table summaries for pairs and csets.

STATUS: Total junk, should be deleted.
DATE:  9 June 2017
REASON: Several issues:
 a) Missing links to LEFT-WALL
 b) fails to separate quotation marks (inherited from tone)
 c) fails to separete various other punctuation.
 d) The PseudoWordCset typename needs to be changed to Section, etc.
 e) FATAL ERROR: all disjunct created with minus-the-MI and so are junk.

en_pairs_tone_mst=> \dt+
                        List of relations
 Schema |    Name    | Type  | Owner  |    Size    | Description 
--------+------------+-------+--------+------------+-------------
 public | atoms      | table | ubuntu | 1998 MB    | 
 public | spaces     | table | ubuntu | 40 kB      | 
 public | typecodes  | table | ubuntu | 56 kB      | 
 public | valuations | table | ubuntu | 5153 MB    | 
 public | values     | table | ubuntu | 8192 bytes | 

select count(*) from atoms; --- 18083439 = 18M
select count(*) from valuations; -- 36903851 = 36M

(print-matrix-summary-report asa)
Summary Report for Correlation Matrix Link Grammar ANY link Word Pairs
Left type: WordNode    Right Type: WordNode    Pair Type: ListLink
Rows: 138014 Columns: 139770
Size: 4886362 non-zero entries of 19290216780 possible
Fraction non-zero: 2.5331E-4 Sparsity (-log_2): 11.947
Total observations: 139806259.0  Avg obs per pair: 28.612
Entropy Total: 17.725   Left: 9.9308   Right: 9.8248
Total MI: -2.030

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  1.6405E+4    1.6483E+4
Count   (l_1)  1.9950E+6    1.8453E+6     121.6        112.0    
Length  (l_2)  2.2904E+5    1.9881E+5     13.96        12.06    
RMS Count      2.2878E+5    1.9854E+5     13.95        12.05    

(print-matrix-summary-report psa)
Summary Report for Correlation Matrix Word-Disjunct Pairs (aka Connector Sets)
Left type: WordNode    Right Type: LgAnd    Pair Type: LgWordCset
Wildcard: (ListLink (ctv 0 0 7655886)
   (AnyNode "cset-word")
   (AnyNode "cset-disjunct")
)
Rows: 133022 Columns: 1860793
Size: 3571037 non-zero entries of 247526406446 possible
Fraction non-zero: 1.4427E-5 Sparsity (-log_2): 16.081
Total observations: 7655886.0  Avg obs per pair: 2.1439
Entropy Total: 20.558   Left: 14.711   Right: 10.004
Total MI: -4.156

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  3.4890E+4    6946.    
Count   (l_1)  9.1434E+4    3.4736E+4     2.621        5.001    
Length  (l_2)  2143.        1397.         6.1427E-2    .2011    
RMS Count      2107.        1368.         6.0395E-2    .1970    

2652501065 Bytes = 2.65 GB uncompressed
295210074 Bytes = 295M compressed

70494c6108a2fb952003f86264e5fd35  en_pairs_tone_mst_rev.sql
4176f8600d56867301e51462da2b8b6e  en_pairs_tone_mst_rev.sql.bz2


==================================================================
en_pairs_ttwo
-------------
Random parses from tranche-1 and tranche-2. 

STATUS: fair
DATE: 29 May 2017
REASON: Three issues:
 a) fails to separate quoation marks (inherited from tone)
 b) contains junk lg-any disjuncts
 c) Missing links to LEFT-WALL


                        List of relations
 Schema |    Name    | Type  | Owner  |    Size    | Description 
--------+------------+-------+--------+------------+-------------
 public | atoms      | table | ubuntu | 1483 MB    | 
 public | spaces     | table | ubuntu | 40 kB      | 
 public | typecodes  | table | ubuntu | 56 kB      | 
 public | valuations | table | ubuntu | 956 MB     | 
 public | values     | table | ubuntu | 8192 bytes | 

select count(*) from atoms; <<< 16817599 = 16.8M atoms (6M more than tone)
select count(*) from valuations; <<< 8770525 = 8.8m (3.4M more)

SELECT count(atoms.uuid) FROM atoms,typecodes WHERE
atoms.type=typecodes.type AND typecodes.typename='foobar';

WordNode: 186573 = 187K (47K more)
EvaluationLink:  8047063 = 8M (3.1M more)

SELECT sum(floatvalue[3]) FROM valuations WHERE type=7;
767377888 << 767M observations = 370M more

SELECT sum(valuations.floatvalue[3]) FROM valuations, atoms, typecodes
WHERE valuations.atom=atoms.uuid AND atoms.type=typecodes.type AND
typecodes.typename='EvaluationLink';

EvaluationLink: 267913561 << 268M pair obs, more than double of tone.
WordNode: 243085829 << 243 M -- almost double
LgWordCset: << 243114608 -- almost double

SentenceNode << 795835 = 796K more than double
ParseNode << 12468055 = 12.5M parses more than double.

772033746 Bytes = 772M uncompressed.
132694670 Bytes = 133M compressed

8bbfb8f0f4956f21ec1120b550890e0f  en_pairs_ttwo.sql
0b1908dfc232de4ea4e20d616cbbe290  en_pairs_ttwo.sql.bz2

==================================================================
en_pairs_ttwo_mst
-----------------
Random parses from tranche-1 and tranche-2, together with MST parses from
both tranches. The bogus ANY-disjuncs got removed, and the correct 
PseudoWordCsets are used.  Contains the summary stats for csets, too.

STATUS: Total junk, should be deleted.
DATE: 9 Jun 2017
REASON: Multiple issues:
 a) Missing links to LEFT-WALL
 b) fails to separete various punctuation
 c) The PseudoWordCset typename needs to be changed to Section, etc.
 d) FATAL ERROR: all disjunct created with minus-the-MI and so are junk.


                        List of relations
 Schema |    Name    | Type  | Owner  |    Size    | Description 
--------+------------+-------+--------+------------+-------------
 public | atoms      | table | ubuntu | 3616 MB    | 
 public | spaces     | table | ubuntu | 40 kB      | 
 public | typecodes  | table | ubuntu | 56 kB      | 
 public | valuations | table | ubuntu | 9220 MB    | 
 public | values     | table | ubuntu | 8192 bytes | 

select count(*) from atoms; --- 30689942 = 30.6M 
select count(*) from valuations; --- 63432483 = 63M 

Summary Report for Correlation Matrix Link Grammar ANY link Word Pairs
Left type: WordNode    Right Type: WordNode    Pair Type: ListLink
Wildcard: (EvaluationLink (ctv 0 0 2.6791356e+08)
   (LinkGrammarRelationshipNode "ANY")
)
Rows: 183290 Columns: 186523
Size: 8047063 non-zero entries of 34187800670 possible
Fraction non-zero: 2.3538E-4 Sparsity (-log_2): 12.053
Total observations: 267913561.0  Avg obs per pair: 33.293
Entropy Total: 17.827   Left: 9.9014   Right: 9.7626
Total MI: -1.837

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  2.3078E+4    2.2456E+4
Count   (l_1)  4.0365E+6    3.4647E+6     174.9        154.3    
Length  (l_2)  4.2779E+5    3.4953E+5     18.54        15.56    
RMS Count      4.2741E+5    3.4915E+5     18.52        15.55    


Summary Report for Correlation Matrix Word-Disjunct Pairs (aka Connector Sets)
Left type: WordNode    Right Type: PseudoAnd    Pair Type: PseudoWordCset
Wildcard: (ListLink (ctv 0 0 14382276)
   (AnyNode "cset-word")
   (AnyNode "cset-disjunct")
)
Rows: 175559 Columns: 3401462
Size: 6438484 non-zero entries of 597157267258 possible
Fraction non-zero: 1.0782E-5 Sparsity (-log_2): 16.501
Total observations: 14382276.0  Avg obs per pair: 2.2338
Entropy Total: 21.006   Left: 14.906   Right: 10.007
Total MI: -3.906

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  6.1010E+4    9176.    
Count   (l_1)  1.5853E+5    6.4221E+4     2.598        6.999    
Length  (l_2)  5694.        3476.         9.3332E-2    .3788    
RMS Count      5666.        3444.         9.2870E-2    .3753    

4316209411 Bytes = 4.31 GB uncompressed
517697226 Bytes = 518 MB compressed

5103471bb355c863d8082dd4fcd99955  en_pairs_ttwo_mst.sql
8cfd247413d2429273657974a42a24be  en_pairs_ttwo_mst.sql.bz2


==================================================================
en_pairs_tthree
---------------
Random parses from tranche-1, tranche-2 and tranche_3.

STATUS: good
DATE: 8 Jun 2017
REASON: I think it's good.  Has some extra cruft: has the bogus disjuncts
that were collected.

                        List of relations
 Schema |    Name    | Type  | Owner  |    Size    | Description 
--------+------------+-------+--------+------------+-------------
 public | atoms      | table | ubuntu | 2831 MB    | 
 public | spaces     | table | ubuntu | 40 kB      | 
 public | typecodes  | table | ubuntu | 56 kB      | 
 public | valuations | table | ubuntu | 2099 MB    | 
 public | values     | table | ubuntu | 8192 bytes | 
(5 rows)

select count(*) from atoms;  <<< 32125825 = 32M atoms (15M more than before)
select count(*) from valuations; <<< 16901543 = 16.9M (8.1M more)

SELECT count(atoms.uuid) FROM atoms,typecodes WHERE
atoms.type=typecodes.type AND typecodes.typename='foobar';

WordNode: 431609 = 432K (245K more) !!! that's a lot. More than double.
EvaluationLink: 15224271 = 15.2 M (7.2M more, almost double) 

SELECT sum(floatvalue[3]) FROM valuations WHERE type=7;
1588822019 << 1.59 G observations (832M more, more than double)

SELECT sum(valuations.floatvalue[3]) FROM valuations, atoms, typecodes
WHERE valuations.atom=atoms.uuid AND atoms.type=typecodes.type AND
typecodes.typename='EvaluationLink';

EvaluationLink: 557197874 = 557M pair obs, nearly double of before.
WordNode: 503467934 = 503M -- more than double.
LgWordCset: 503537347 = 503M -- double

SentenceNode: 1487169 = 1.5M -- double
ParseNode: 23131695 = 23M -- double

1506102265 Bytes = 1.51 GB uncompressed
256913537 Bytes = 257 GB compressed

1cb778a18a51244c7a5c919337a38557  en_pairs_tthree.sql
df1109d706bc5d088097713d7f85188e  en_pairs_tthree.sql.bz2

==================================================================
en_pairs_tthree_mi
------------------
Random parses from tranche-1, tranche-2 and tranche_3, and pair MI.
Removed the junk disjuncts from ANY parsing.

STATUS: Misleading
DATE: 9 Jun 2017
REASON: Worthless: the sign on the MI is backwards.

                        List of relations
 Schema |    Name    | Type  | Owner  |    Size    | Description 
--------+------------+-------+--------+------------+-------------
 public | atoms      | table | ubuntu | 2983 MB    | 
 public | spaces     | table | ubuntu | 40 kB      | 
 public | typecodes  | table | ubuntu | 56 kB      | 
 public | valuations | table | ubuntu | 5852 MB    | 
 public | values     | table | ubuntu | 8192 bytes | 

select count(*) from atoms;  -- 32593133 = 32M atoms
select count(*) from valuations; -- 50386820 = 50M valuations

Summary Report for Correlation Matrix Link Grammar ANY link Word Pairs
Left type: WordNode    Right Type: WordNode    Pair Type: ListLink
Wildcard: (EvaluationLink (ctv 0 0 5.5719787e+08)
   (LinkGrammarRelationshipNode "ANY")
   (ListLink
      (AnyNode "left-word")
      (AnyNode "right-word")
   )
)
Rows: 424940 Columns: 431538
Size: 15224271 non-zero entries of 183377757720 possible
Fraction non-zero: 8.3021E-5 Sparsity (-log_2): 13.556
Total observations: 557197874.0  Avg obs per pair: 36.599
Entropy Total: 18.317   Left: 10.191   Right: 10.061
Total MI: -1.935

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  4.4098E+4    4.3839E+4
Count   (l_1)  8.3106E+6    7.4675E+6     188.5        170.3    
Length  (l_2)  9.1631E+5    7.7754E+5     20.78        17.74    
RMS Count      9.1591E+5    7.7713E+5     20.77        17.73    

3411596887 = 3.4GB uncompressed 
470255603 = 470 MB compressed

209da5230c7ac24c6ae0b8182ddb2412  en_pairs_tthree_mi.sql
ea257e5ab807b70555d182caa6d712df  en_pairs_tthree_mi.sql.bz2

==================================================================
en_pairs_tthree_mst
------------------
MST parses from tranche-1, tranche-2 and tranche_3, and summary stats.

STATUS: Total junk, should be deleted.
DATE: 19 Jun 2017
REASON: Several issues:
 a) Missing many links to LEFT-WALL (on tranche-1,2, and some of 3)
 b) fails to separete some of the punctuation
 c) FATAL ERROR: all disjunct created with minus-the-MI and so are junk.

                        List of relations
 Schema |    Name    | Type  | Owner  |    Size    | Description 
--------+------------+-------+--------+------------+-------------
 public | atoms      | table | ubuntu | 5557 MB    | 
 public | spaces     | table | ubuntu | 40 kB      | 
 public | typecodes  | table | ubuntu | 56 kB      | 
 public | valuations | table | ubuntu | 14 GB      | 
 public | values     | table | ubuntu | 8192 bytes | 


select count(*) from atoms; -- 61026822 = 61M
select count(*) from valuations; --  127753161 = 128M

Summary Report for Correlation Matrix Word-Disjunct Pairs (aka Connector
Sets)
Left type: WordNode    Right Type: ConnectorSeq    Pair Type: Section
Wildcard: (ListLink (ctv 0 0 31507285)
   (AnyNode "cset-word")
   (AnyNode "cset-disjunct")
)
Rows: 378412 Columns: 7179578
Size: 13176250 non-zero entries of 2716838470136 possible
Fraction non-zero: 4.8498E-6 Sparsity (-log_2): 17.654
Total observations: 31507285.0  Avg obs per pair: 2.3912
Entropy Total: 21.941   Left: 15.630   Right: 10.282
Total MI: -3.971

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  1.2948E+5    1.7353E+4
Count   (l_1)  3.6454E+5    1.3127E+5     2.815        7.565    
Length  (l_2)  9336.        5603.         7.2108E-2    .3229    
RMS Count      9298.        5557.         7.1812E-2    .3203    

8158333695 Bytes = 8.16 GBytes uncompressed
1018619547 Bytes = 1.02 GBytes compressed

487fbe4f636fb40e75a802dcda315d05  en_pairs_tthree_mst.sql
086f9fdae0f27a2d0e6b857d1adc901b  en_pairs_tthree_mst.sql.bz2

==================================================================
en_pairs_rone
-------------
Random-planar-tree parsed books from "tranche-1" of mostly project
gutenberg books. Contains counts for word-pairs, words and disjuncts.
This is a "clean" reparse, with correct quotation mark handling,
and no record of the broken ANY-disjuncts.  This fixes the issues
in en_pairs_tone.

STATUS: good
DATE: 9 June 2017
REASON: Best so far, I think.  One issue:
  infix-marks: dashes, ellipsis, long-dashes are not split.
  It now seems that this would have been the right thing to do.

                        List of relations
 Schema |    Name    | Type  | Owner  |    Size    | Description 
--------+------------+-------+--------+------------+-------------
 public | atoms      | table | ubuntu | 1024 MB    | 
 public | spaces     | table | ubuntu | 40 kB      | 
 public | typecodes  | table | ubuntu | 56 kB      | 
 public | valuations | table | ubuntu | 1390 MB    | 
 public | values     | table | ubuntu | 8192 bytes | 

select count(*) from atoms; -- 11224348 = 11M
select count(*) from valuations; -- 5679764 = 5.7M

Does not contain MI info, but it if did, it would be this:
Left type: WordNode    Right Type: WordNode    Pair Type: ListLink
Wildcard: (EvaluationLink (ctv 0 0 1.7409991e+08)
   (LinkGrammarRelationshipNode "ANY")
   (ListLink
      (AnyNode "left-word")
      (AnyNode "right-word")
   )
)
Rows: 133792 Columns: 135156
Size: 5544578 non-zero entries of 18082791552 possible
Fraction non-zero: 3.0662E-4 Sparsity (-log_2): 11.671
Total observations: 174099906.0  Avg obs per pair: 31.400
Entropy Total: 17.667   Left: 9.8592   Right: 9.7506
Total MI: 1.9426

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  1.7398E+4    1.7417E+4
Count   (l_1)  2.4875E+6    2.2524E+6     143.0        129.3
Length  (l_2)  2.8788E+5    2.4347E+5     16.55        13.98
RMS Count      2.8758E+5    2.4316E+5     16.53        13.96


502761623 Bytes = 503MB uncompressed
86534772 Bytes = 86MBytes compressed

29c23c43826e8aeb5037b99acdda02a3  en_pairs_rone.sql
37f9a6ef2415ba708ffbf42f9c5948de  en_pairs_rone.sql.bz2

==================================================================
en_pairs_rone_mst
-----------------
The en_pairs_rone dataset used to perform MST parses of tranche-1
books.  Contains both pair-MI and cset-MI data and summaries.

STATUS: Total junk, should be deleted.
DATE: 13 June 2017
REASON: Multiple issues:
 a) Missing links to LEFT-WALL
 b) fails to separete various punctuation
 c) The PseudoWordCset typename needs to be changed to Section, etc.
 d) MI values have the float truncation bug.
 e) FATAL ERROR: all disjunct created with minus-the-MI and so are junk.


en_pairs_rone_mst=> \dt+
                        List of relations
 Schema |    Name    | Type  | Owner  |    Size    | Description 
--------+------------+-------+--------+------------+-------------
 public | atoms      | table | ubuntu | 1890 MB    | 
 public | spaces     | table | ubuntu | 40 kB      | 
 public | typecodes  | table | ubuntu | 56 kB      | 
 public | valuations | table | ubuntu | 4601 MB    | 
 public | values     | table | ubuntu | 8192 bytes | 

select count(*) from atoms;  20840690 == 20.8 M atoms
select count(*) from valuations; 42809795 == 42.8M values

(print-matrix-summary-report asa)
Summary Report for Correlation Matrix Link Grammar ANY link Word Pairs
Left type: WordNode    Right Type: WordNode    Pair Type: ListLink
Wildcard: (EvaluationLink (ctv 0 0 1.7409991e+08)
   (LinkGrammarRelationshipNode "ANY")
   (ListLink
      (AnyNode "left-word")
      (AnyNode "right-word")
   )
)
Rows: 133792 Columns: 135156
Size: 5544578 non-zero entries of 18082791552 possible
Fraction non-zero: 3.0662E-4 Sparsity (-log_2): 11.671
Total observations: 174099906.0  Avg obs per pair: 31.400
Entropy Total: 17.667   Left: 9.8592   Right: 9.7506
Total MI: -1.943
                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  1.7398E+4    1.7417E+4
Count   (l_1)  2.4875E+6    2.2524E+6     143.0        129.3    
Length  (l_2)  2.8788E+5    2.4347E+5     16.55        13.98    
RMS Count      2.8758E+5    2.4316E+5     16.53        13.96    


(print-matrix-summary-report pca)
Summary Report for Correlation Matrix Word-Disjunct Pairs (aka Connector Sets)
Left type: WordNode    Right Type: PseudoAnd    Pair Type:
PseudoWordCset
Wildcard: (ListLink (ctv 0 0 9326663)
   (AnyNode "cset-word")
   (AnyNode "cset-disjunct")
)
Rows: 131247 Columns: 2242794
Size: 4275308 non-zero entries of 294359984118 possible
Fraction non-zero: 1.4524E-5 Sparsity (-log_2): 16.071
Total observations: 9326663.0  Avg obs per pair: 2.1815
Entropy Total: 20.715   Left: 14.926   Right: 9.9403
Total MI: -4.151

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  4.1304E+4    7307.    
Count   (l_1)  1.1025E+5    3.9464E+4     2.669        5.401    
Length  (l_2)  3011.        1778.         7.2909E-2    .2433    
RMS Count      2975.        1748.         7.2030E-2    .2392    

3059640344 Bytes = 3.1GB uncompressed
332027863 Bytes = 332 MB compressed

4ad62e404a1473f44173800c456a1934  en_pairs_rone_mst.sql
f90db044b2fae8baeffd1e7decbc3f45  en_pairs_rone_mst.sql.bz2

==================================================================
en_pairs_rtwo
-------------
Random-planar-tree parsed books from "tranche-1" and "tranche-2".
A continutation of en_pairs_rone.

STATUS: good
DATE: 12 June 2017
REASON: One issue, see en_pairs_rone for description.

                        List of relations
 Schema |    Name    | Type  | Owner  |    Size    | Description 
--------+------------+-------+--------+------------+-------------
 public | atoms      | table | ubuntu | 1596 MB    | 
 public | spaces     | table | ubuntu | 40 kB      | 
 public | typecodes  | table | ubuntu | 56 kB      | 
 public | valuations | table | ubuntu | 1390 MB    | 
 public | values     | table | ubuntu | 8192 bytes | 

Strange: the above looks wrong. \l+ says total is 6608 MB so wtf?
Maybe the rest is indexes....

select count(*) from atoms; -- 18082606 = 18M (7M more than rone)
select count(*) from valuations; -- 9135195 = 9M (3.4M more)

825319194 Bytes = 825MB uncompressed
140784957 Bytes = 141MB compressed.

bzfc3a573593f60c6e2b546da22ce915f6  en_pairs_rtwo.sql
f86114cf3f342dcd574406890a3a7168  en_pairs_rtwo.sql.bz2

==================================================================
en_pairs_rtwo_mst
-----------------
en_pairs_rtwo, with tranche-1 and tranche-2 MST parses.

STATUS: Total junk, should be deleted.
DATE: 14 June 2017
REASON: Multiple issues:
 a) Missing links to LEFT-WALL
 b) fails to separete various punctuation
 c) The PseudoWordCset typename needs to be changed to Section, etc.
 d) MI values have the float truncation bug.
 e) FATAL ERROR: all disjunct created with minus-the-MI and so are junk.


                        List of relations
 Schema |    Name    | Type  | Owner  |    Size    | Description 
--------+------------+-------+--------+------------+-------------
 public | atoms      | table | ubuntu | 3150 MB    | 
 public | spaces     | table | ubuntu | 40 kB      | 
 public | typecodes  | table | ubuntu | 56 kB      | 
 public | valuations | table | ubuntu | 7081 MB    | 
 public | values     | table | ubuntu | 8192 bytes | 

select count(*) from atoms;  -- 34720695 = 34.7M
select count(*) from valuations; -- 72196748 = 72.2M

> (print-matrix-summary-report ala)
Summary Report for Correlation Matrix Link Grammar ANY link Word Pairs
Left type: WordNode    Right Type: WordNode    Pair Type: ListLink
Wildcard: (EvaluationLink (ctv 0 0 3.2123033e+08)
   (LinkGrammarRelationshipNode "ANY")
   (ListLink
      (AnyNode "left-word")
      (AnyNode "right-word")
   )
)
Rows: 184681 Columns: 187712
Size: 8947405 non-zero entries of 34666839872 possible
Fraction non-zero: 2.5810E-4 Sparsity (-log_2): 11.920
Total observations: 321230333.0  Avg obs per pair: 35.902
Entropy Total: 17.770   Left: 9.8499   Right: 9.7062
Total MI: -1.786

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  2.4698E+4    2.3820E+4
Count   (l_1)  4.9158E+6    4.1130E+6     199.0        172.7    
Length  (l_2)  5.3153E+5    4.2463E+5     21.52        17.83    
RMS Count      5.3111E+5    4.2421E+5     21.50        17.81    

Summary Report for Correlation Matrix Word-Disjunct Pairs (aka Connector Sets)
Left type: WordNode    Right Type: PseudoAnd    Pair Type:
PseudoWordCset
Wildcard: (ListLink (ctv 0 0 17048845)
   (AnyNode "cset-word")
   (AnyNode "cset-disjunct")
)
Rows: 179487 Columns: 3979599
Size: 7503114 non-zero entries of 714286285713 possible
Fraction non-zero: 1.0504E-5 Sparsity (-log_2): 16.539
Total observations: 17048845.0  Avg obs per pair: 2.2722
Entropy Total: 21.146   Left: 15.105   Right: 9.9507
Total MI: -3.910

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  7.0869E+4    9633.    
Count   (l_1)  1.9041E+5    7.1256E+4     2.687        7.397    
Length  (l_2)  7130.        4017.         .1006        .4171    
RMS Count      7100.        3985.         .1002        .4137    

5034299859 Bytes = 5.0 GB uncompressed.
560626052 Bytes = 561MB compressed

688143b9152f920f52d5cc4df317d9d3  en_pairs_rtwo_mst.sql
4f36561722a0689bf213c304b61334d4  en_pairs_rtwo_mst.sql.bz2

==================================================================
en_pairs_rthree
---------------
Random-planar-tree parsed books from tranche-1, 2 and 3. Includes
the pair-MI computations.  A continutation of en_pairs_rtwo.

STATUS: good
DATE: 21 June 2017
REASON: Best so far, I think.  Two issues:
  1) infix-marks: dashes, ellipsis, long-dashes are not split.
     It now seems that this would have been the right thing to do.
  2) The pair-MI values are bad; they suffer from the float-point
     truncation bug. (opencog/atomspace#1295) Solution: recompute
     MI before using.
  3) The pair-MI values have the wrong sign.

                        List of relations
 Schema |    Name    | Type  | Owner  |    Size    | Description 
--------+------------+-------+--------+------------+-------------
 public | atoms      | table | ubuntu | 3090 MB    | 
 public | spaces     | table | ubuntu | 40 kB      | 
 public | typecodes  | table | ubuntu | 56 kB      | 
 public | valuations | table | ubuntu | 6024 MB    | 
 public | values     | table | ubuntu | 8192 bytes | 

select count(*) from atoms;      -- 35044156 = 35M atoms
select count(*) from valuations; -- 54073127 = 54M values

(print-matrix-summary-report asa)
Summary Report for Correlation Matrix Link Grammar ANY link Word Pairs
Left type: WordNode    Right Type: WordNode    Pair Type: ListLink
Wildcard: (EvaluationLink (ctv 0 0 6.3884586e+08)
   (LinkGrammarRelationshipNode "ANY")
   (ListLink
      (AnyNode "left-word")
      (AnyNode "right-word")
   )
)
Rows: 428185 Columns: 433810
Size: 16442999 non-zero entries of 185750934850 possible
Fraction non-zero: 8.8522E-5 Sparsity (-log_2): 13.464
Total observations: 638845863.0  Avg obs per pair: 38.852
Entropy Total: 18.270   Left: 10.149   Right: 10.017
Total MI: -1.896

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  4.5589E+4    4.5082E+4
Count   (l_1)  9.4861E+6    8.4112E+6     208.1        186.6    
Length  (l_2)  1.0437E+6    8.7608E+5     22.89        19.43    
RMS Count      1.0433E+6    8.7564E+5     22.88        19.42    

3633274138 Bytes = 3.6GBytes uncompressed = 41 bytes per atom or valuation.
509100498 Bytes = 509MBytes compressed = 5.7 Bytes/atom

286f8b84338af370465d2face539b5a7  en_pairs_rthree.sql
4cd74f0093a99e1855d61ef896738fd3  en_pairs_rthree.sql.bz2


==================================================================
en_pairs_rfour
---------------
Random-planar-tree parsed books from tranche-1, 2, 3 and 4. 
A continutation of en_pairs_rthree. Does NOT contain pair-MI values.

STATUS: good
DATE: 29 June 2017
REASON: Best so far, I think.  One issue:
  1) infix-marks: dashes, ellipsis, long-dashes are not split.
     It now seems that this would have been the right thing to do.

                        List of relations
 Schema |    Name    | Type  | Owner  |    Size    | Description 
--------+------------+-------+--------+------------+-------------
 public | atoms      | table | ubuntu | 3937 MB    | 
 public | spaces     | table | ubuntu | 40 kB      | 
 public | typecodes  | table | ubuntu | 56 kB      | 
 public | valuations | table | ubuntu | 2619 MB    | 
 public | values     | table | ubuntu | 8192 bytes | 

select count(*) from atoms;      -- 44676827 = 45M atoms
select count(*) from valuations; -- 22638956 = 23M valations

2083700214 Bytes = 2.1 GBytes uncompressed
 354780718 Bytes compressed = 355 MBytes

md5sum en_pairs_rfour.sql 
98e873b7626d22e04f914b043c14d6ec  en_pairs_rfour.sql
6726298084cb8b6ad92a63419c91b416  en_pairs_rfour.sql.bz2


==================================================================
en_pairs_rfive
---------------
Random-planar-tree parsed books from tranche-1, 2, 3, 4 and 5. 
A continutation of en_pairs_rfour. Does NOT contain pair-MI values.

STATUS: good
DATE: 12 July 2017
REASON: Best so far, I think.  One issue:
  1) infix-marks: dashes, ellipsis, long-dashes are not split.
     It now seems that this would have been the right thing to do.

                        List of relations
 Schema |    Name    | Type  | Owner  |    Size    | Description 
--------+------------+-------+--------+------------+-------------
 public | atoms      | table | ubuntu | 5380 MB    | 
 public | spaces     | table | ubuntu | 40 kB      | 
 public | typecodes  | table | ubuntu | 56 kB      | 
 public | valuations | table | ubuntu | 3365 MB    | 
 public | values     | table | ubuntu | 8192 bytes | 

select count(*) from atoms;      -- 61069212 = 61M atoms
select count(*) from valuations; -- 30960586 = 31M values

2860579197 bytes uncompressed = 2.86 GB
 488196590 bytes compressed   = 488MB

dd28f22ef60b1d7f3f5854bfba793116  en_pairs_rfive.sql
2bbe479fe0caa77c5a1438568a22a4c4  en_pairs_rfive.sql.bz2


==================================================================
en_pairs_rthree_mone
--------------------
MST-parsed books from tranche-1, using pairs from rthree.

STATUS: Total junk, should be deleted.
DATE: 2 July 2017
REASON: FATAL ERROR: all disjunct created with minus-the-MI, and so are junk.

select count(*) from atoms;      -- 42237812 = 42.2M i.e. 7.2M more than rthree
select count(*) from valuations; -- 58709672 = 58.7M i.e. 4.6M more than rthree

5114130466 Bytes = 5.1 GBytes uncompressed.
 870711778 Bytes = 871 MB compressed

564717bc7a950ede64218cf316459cd9  en_pairs_rthree_mone.sql
8d508e61dcc2ee0ee4a739273ec37033  en_pairs_rthree_mone.sql.bz2

==================================================================
en_pairs_rfive_mone
-------------------
Random-planar-tree parsed books from tranche-1, 2, 3, 4 and 5. 
MST-parsed tranche-one. Contains pair-MI values; does NOT contain
any disjunct marginals.

STATUS: good
DATE: 16 July 2017
REASON: Best so far, I think.  Same issues as en_pairs_rfive

                        List of relations
 Schema |    Name    | Type  | Owner  |    Size    | Description 
--------+------------+-------+--------+------------+-------------
 public | atoms      | table | ubuntu | 6502 MB    | 
 public | spaces     | table | ubuntu | 40 kB      | 
 public | typecodes  | table | ubuntu | 56 kB      | 
 public | valuations | table | ubuntu | 11 GB      | 
 public | values     | table | ubuntu | 8192 bytes | 

select count(*) from atoms;  -- 73314120 = 73M
select count(*) from valuations; -- 104615442 = 105M

Summary Report for Correlation Matrix Link Grammar ANY link Word Pairs
Rows: 839266 Columns: 850510
Size: 30108620 non-zero entries of 713804125660 possible
Fraction non-zero: 4.2181E-5 Sparsity (-log_2): 14.533
Total observations: 1352780591.0  Avg obs per pair: 44.930
Entropy Total: 18.535   Left: 10.247   Right: 10.125
Total MI: 1.8370

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  8.0633E+4    8.0657E+4
Count   (l_1)  2.0090E+7    1.8514E+7     249.2        229.5    
Length  (l_2)  2.2769E+6    1.9732E+6     28.24        24.46    
RMS Count      2.2764E+6    1.9726E+6     28.23        24.46    

9088177187 bytes uncompressed = 9.1GB
1542005839 bytes compressed = 1.54GB

f226416e374414c0ef8decb19047b596  en_pairs_rfive_mone.sql
a4f8fbc42f802dd4ffc218296d20f703  en_pairs_rfive_mone.sql.bz2

==================================================================
en_pairs_rfive_mtwo
-------------------
Random-planar-tree parsed books from tranche-1, 2, 3, 4 and 5. 
MST-parsed tranche-1 and 2. Contains pair-MI values; does NOT contain
any disjunct marginals.

STATUS: good
DATE: 17 July 2017
REASON: Best so far, I think.  Same issues as en_pairs_rfive_mone

                        List of relations
 Schema |    Name    | Type  | Owner  |    Size    | Description 
--------+------------+-------+--------+------------+-------------
 public | atoms      | table | ubuntu | 7082 MB    | 
 public | spaces     | table | ubuntu | 40 kB      | 
 public | typecodes  | table | ubuntu | 56 kB      | 
 public | valuations | table | ubuntu | 11 GB      | 
 public | values     | table | ubuntu | 8192 bytes | 

select count(*) from atoms;      --  79586531 = 79M = 6M more
select count(*) from valuations; -- 108255875 = 108M = 5M more

9455749625 Bytes uncompressed = 9.45 GB
1610511576 Bytes compressed   = 1.61 GB

83fa68d57ec5db8604e3487862223efb  en_pairs_rfive_mtwo.sql
de95af1f2ddb7c696b19a4cc3a3e443e  en_pairs_rfive_mtwo.sql.bz2

==================================================================
en_pairs_rfive_mthree
---------------------
Random-planar-tree parsed books from tranche-1, 2, 3, 4 and 5. 
MST-parsed tranche-1, 2 and 3. Contains pair-MI values; does NOT
contain any disjunct marginals.

STATUS: good
DATE: 2 August 2017
REASON: Best so far, I think.  Same issues as en_pairs_rfive_mone

                        List of relations
 Schema |    Name    | Type  | Owner  |    Size    | Description 
--------+------------+-------+--------+------------+-------------
 public | atoms      | table | ubuntu | 8437 MB    | 
 public | spaces     | table | ubuntu | 40 kB      | 
 public | typecodes  | table | ubuntu | 56 kB      | 
 public | valuations | table | ubuntu | 11 GB      | 
 public | values     | table | ubuntu | 8192 bytes | 

select count(*) from atoms;      --  94097585 =  94M = 15M more
select count(*) from valuations; -- 116409279 = 116M =  8M more

10315553282 Bytes uncompressed = 10.3 GB
 1767006478 Bytes compressed = 1.7GB

2ec9c3544f307c7f58a49fa22762724e  en_pairs_rfive_mthree.sql
ca4bcdf8d041053ac0d4bc72624a2978  en_pairs_rfive_mthree.sql.bz2


==================================================================
en_pairs_rfive_mfour
--------------------
Random-planar-tree parsed books from tranche-1, 2, 3, 4 and 5. 
MST-parsed tranche-1, 2, 3 and 4. Contains pair-MI values; does NOT
contain any disjunct marginals.

STATUS: good
DATE: 8 August 2017
REASON: Best so far, I think.  Same issues as en_pairs_rfive_mone

                        List of relations
 Schema |    Name    | Type  | Owner  |    Size    | Description 
--------+------------+-------+--------+------------+-------------
 public | atoms      | table | ubuntu | 9598 MB    | 
 public | spaces     | table | ubuntu | 40 kB      | 
 public | typecodes  | table | ubuntu | 56 kB      | 
 public | valuations | table | ubuntu | 12 GB      | 
 public | values     | table | ubuntu | 8192 bytes | 

select count(*) from atoms;      -- 106482665 = 106M = 12M more
select count(*) from valuations; -- 123419676 = 123M =  7M more

11069504769 bytes uncompressed = 11.1 GBytes
 1901439821 bytes compressed   = 1.90 GBytes

eff6127b82ab205502bc1f9e8b4e139d  en_pairs_rfive_mfour.sql
763ffc8bf032127501692a5ee61538ec  en_pairs_rfive_mfour.sql.bz2

==================================================================
en_pairs_rfive_mfive
--------------------
Random-planar-tree parsed books from tranche-1, 2, 3, 4 and 5. 
MST-parsed tranche-1, 2, 3, 4 and 5. Contains pair-MI values; does NOT
contain any disjunct marginals.

STATUS: good
DATE: 14 August 2017
REASON: Best so far, I think.  Same issues as en_pairs_rfive_mone

                        List of relations
 Schema |    Name    | Type  | Owner  |    Size    | Description 
--------+------------+-------+--------+------------+-------------
 public | atoms      | table | ubuntu | 11 GB      | 
 public | spaces     | table | ubuntu | 40 kB      | 
 public | typecodes  | table | ubuntu | 56 kB      | 
 public | valuations | table | ubuntu | 13 GB      | 
 public | values     | table | ubuntu | 8192 bytes | 

select count(*) from atoms;      -- 124866072 = 125M = 19M more
select count(*) from valuations; -- 133848790 = 134M = 11M more

12210323166 bytes uncompressed = 12.2GBytes
 2104485691 byttes compressed  = 2.10 GBytes

988be345ccaffc9312db6446693a3625  en_pairs_rfive_mfive.sql
1bd09cb8c014ec2c8e33ee7d101f4357  en_pairs_rfive_mfive.sql.bz2

==================================================================
en_pairs_rfive_mst
------------------
Same as en_pairs_rfive_mfive, but with word-disjunct marginals in it.

STATUS: good
DATE: 6 Sept 2017
REASON: Best so far, I think. Except it contains infixed punctuation.
    Which is a pointless waste of space. And which throws off stats
    slightly, I suppose.
ISSUES: Too big to fit into RAM.  Just loading disjunct marginals
    requires 75GBytes. (25M csets and 25M ListLinks and umpteen valuations) 

                        List of relations
 Schema |    Name    | Type  | Owner  |    Size    | Description 
--------+------------+-------+--------+------------+-------------
 public | atoms      | table | ubuntu | 13 GB      | 
 public | spaces     | table | ubuntu | 40 kB      | 
 public | typecodes  | table | ubuntu | 56 kB      | 
 public | valuations | table | ubuntu | 34 GB      | 
 public | values     | table | ubuntu | 8192 bytes | 

select count(*) from atoms;      -- 150550752 = 150M (so +25M for marginals)
select count(*) from valuations; -- 330716326 = 331M (+200M for marginals!!!)

Not possible to load the whole dataset, so:
(fetch-incoming-set (AnyNode "cset-word"))
(print-matrix-summary-report psa)
Summary Report for Correlation Matrix Word-Disjunct Pairs (Connector Sets)
Left type: WordNode    Right Type: ConnectorSeq    Pair Type: Section
Wildcard: (ListLink (ctv 0 0 77798246)
   (AnyNode "cset-word")
   (AnyNode "cset-disjunct")
)
Rows: 522243 Columns: 25162434
Size: 34222079 non-zero entries of 13140905019462 possible
Fraction non-zero: 2.6042E-6 Sparsity (-log_2): 18.551
Total observations: 77798246.0  Avg obs per pair: 2.2733
Entropy Total: 22.821   Left: 20.920   Right: 10.085
Total MI: 8.1836

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  2.2054E+5    392.2    
Count   (l_1)  1.0180E+6    1.0483E+4     4.616        26.73    
Length  (l_2)  4.0497E+4    4661.         .1836        11.88    
RMS Count      4.0447E+4    4596.         .1834        11.72    

26935688497 bytes uncomepressed = 26.9 GBytes
 3389925594 bytes compressed = 3.4 GBytes

61bd65b782182bf98c66abc2bc2e4612  en_pairs_rfive_mst.sql
28cce911418ca8c82428cb1e6776aa2d  en_pairs_rfive_mst.sql.bz2


==================================================================
en_pairs_cfive
---------------
Random-planar-tree parsed books from tranche-1, 2, 3, 4 and 5. 
A cleaned-up version of en_pairs_rfive.  Words with infix marks
were removed.  However, hyphenated words and apostrophised words
remain.  Does NOT contain pair-MI values.

STATUS: good
DATE: 1 Sept 2017
REASON: Best so far, I think.  One issue:

                        List of relations
 Schema |    Name    | Type  | Owner  |    Size    | Description 
--------+------------+-------+--------+------------+-------------
 public | atoms      | table | ubuntu | 5380 MB    | 
 public | spaces     | table | ubuntu | 40 kB      | 
 public | typecodes  | table | ubuntu | 56 kB      | 
 public | valuations | table | ubuntu | 3365 MB    | 
 public | values     | table | ubuntu | 8192 bytes | 

select count(*) from atoms;      -- 56409030 = 56M = 5M fewer than rfive.
select count(*) from valuations; -- 28516287 = 28.5M = 2.5M fewer 

2638878848 bytes uncompressed = 2.64 GBytes
 453916099 bytes compressed   = 454 MBytes

3f9a82d6f5ab8547d15b8a32b27896a2  en_pairs_cfive.psql
ad6e0ad034855441be507344f201f624  en_pairs_cfive.psql.bz2


==================================================================
en_pairs_cfive_mst
------------------
Same as en_pairs_rfive_mst, but with infix-punctuation words removed.

STATUS: good
DATE: 12 Sept 2017
REASON: Best so far, I think. The pair marginals have been recomputed.
    and the dj marginals also.
ISSUES: Too big to fit into RAM. 
    Loading word-pairs and marginals requires 72GBytes.
    Just loading disjunct marginals requires 75GBytes. 
    (25M csets and 25M ListLinks and umpteen valuations) 
    Recomputing disjunct marginals uses 134GB RAM.

                        List of relations
 Schema |    Name    | Type  | Owner  |    Size    | Description 
--------+------------+-------+--------+------------+-------------
 public | atoms      | table | ubuntu | 13 GB      | 
 public | spaces     | table | ubuntu | 40 kB      | 
 public | typecodes  | table | ubuntu | 56 kB      | 
 public | valuations | table | ubuntu | 57 GB      | 
 public | values     | table | ubuntu | 8192 bytes | 

select count(*) from atoms;      -- 139638908 = 140 M atoms (10M less)
select count(*) from valuations; -- 307109283 = 307 M values (24M less)

Summary Report for Correlation Matrix Link Grammar ANY link Word Pairs
Rows: 619168 Columns: 580804
Size: 27892737 non-zero entries of 359615251072 possible
Fraction non-zero: 7.7563E-5 Sparsity (-log_2): 13.654
Total observations: 1247457239.0  Avg obs per pair: 44.723
Entropy Total: 18.645   Left: 10.053   Right: 10.390
Total MI: 1.7982

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  5.3758E+4    7.3126E+4
Count   (l_1)  1.5140E+7    1.8578E+7     281.6        254.1    
Length  (l_2)  1.8653E+6    1.8923E+6     34.70        25.88    
RMS Count      1.8647E+6    1.8917E+6     34.69        25.87    

Summary Report for Correlation Matrix Word-Disjunct Pairs (Connector Sets)
Left type: WordNode    Right Type: ConnectorSeq    Pair Type: Section
Wildcard: (ListLink (ctv 0 0 69447009)
   (AnyNode "cset-word")
   (AnyNode "cset-disjunct")
)
Rows: 444903 Columns: 23444293
Size: 31914870 non-zero entries of 10430436288579 possible
Fraction non-zero: 3.0598E-6 Sparsity (-log_2): 18.318
Total observations: 69447009.0  Avg obs per pair: 2.1760
Entropy Total: 23.092   Left: 21.137   Right: 10.112
Total MI: 8.1569

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  2.2742E+5    367.6    
Count   (l_1)  9.4430E+5    7917.         4.152        21.54    
Length  (l_2)  2.4549E+4    2397.         .1079        6.520    
RMS Count      2.4499E+4    2379.         .1077        6.472    

24893983049 bytes uncompressed = 24.9 GB 
 3197324260 bytes compressed   =  3.2 GB

85a872a283314d5bc1900b20da35a017  en_pairs_cfive_mst.sql
8f5eab41474c92c1a084ce9fc60f243c  en_pairs_cfive_mst.sql.bz2


==================================================================
zh_pairs_one
------------
Mandarin individual character pairs.  Only that, without any pair stats.
Wikipedia articles only!

STATUS: good
DATE: 7 July 2017
REASON: No known serious defects.  Minor issue: its wikipedia and does
    not contain any fiction or action or narrative text.


zh_pairs     | 4235 MB |  \l+

select count(*) from atoms;  -- 12003950 = 12.0M
select count(*) from valuations; -- 6081472 = 6.08 M

537357532 bytes uncompressed = 537MB 
 96333834 bytes compressed = 96.3MB

0718a3670ac5ea3e3f6bca3a7fb560e9  zh_pairs_one.sql
cf45874b8d353ca9332040c9acd783ae  zh_pairs_one.sql.bz2

==================================================================
zh_pairs_sone
-------------
Mandarin individual character pairs.  Same as above, but includes the
pair-MI stats. (After the minus-sign fix!)

STATUS: good
DATE: 12 July 2017
REASON: No known defects.  Minor issue: its wikipedia and does
    not contain any fiction or action or narrative text.

select count(*) from atoms;      -- 12638021 = 12.6M - 600K more than above.
select count(*) from valuations; -- 19511577 = 19.5M - 13.4M more

Conclude: 6M word-pairs, total three valuations per word-pair; two added
here.  What are they? a) pair-count b) pair-freq c) pair-mi
(plus additional marginals.)

Rows: 158038 Columns: 158991
Size: 5922477 non-zero entries of 25126619658 possible
Fraction non-zero: 2.3571E-4 Sparsity (-log_2): 12.051
Total observations: 728947854.0  Avg obs per pair: 123.08
Entropy Total: 18.452   Left: 10.265   Right: 10.207
Total MI: 2.0195

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  6819.        6411.    
Count   (l_1)  3.7360E+6    3.1244E+6     547.9        487.4    
Length  (l_2)  2.8408E+5    2.4156E+5     41.66        37.68    
RMS Count      2.8231E+5    2.3990E+5     41.40        37.42    

1647543636 bytes uncompressed = 1.65 GB
 290683964 bytes compressed = 291 GB

4ab27184db51048f362fc5d6134113c6  zh_pairs_sone
39748c2abc0be436f266dec021ee4402  zh_pairs_sone.bz2

==================================================================
zen_pairs
---------
Mandarin word-pairs. Segmentation into words done by Ruiting. Does
NOT include pair-MI stats. This is the alpha-segmented-1 texts only.

STATUS: good
DATE: 17 July 2017
REASON: No known defects. Except that the dataset is too small.

                        List of relations
 Schema |    Name    | Type  | Owner  |    Size    | Description 
--------+------------+-------+--------+------------+-------------
 public | atoms      | table | ubuntu | 303 MB     | 
 public | spaces     | table | ubuntu | 8192 bytes | 
 public | typecodes  | table | ubuntu | 48 kB      | 
 public | valuations | table | ubuntu | 187 MB     | 
 public | values     | table | ubuntu | 8192 bytes | 

select count(*) from atoms;      -- 3419298 = 3.4M
select count(*) from valuations; -- 1739721 = 1.7M whoa

152263232 Bytes uncompressed = 152MB
 25488421 Bytes compressed = 25MBytes

fe8a58ae4f66f61c57da90a92d5787c3  zen_pairs.sql
16e651cf0a719fe9e6d0883155e9a5b8  zen_pairs.sql.bz2

==================================================================
zen_pairs_mi
------------
Mandarin word-pairs. Segmentation into words done by Ruiting.
This is the alpha-segmented-1 texts only.  Includes word-pair
MI statstics.

STATUS: good
DATE: 17 July 2017
REASON: No known defects.

                        List of relations
 Schema |    Name    | Type  | Owner  |    Size    | Description 
--------+------------+-------+--------+------------+-------------
 public | atoms      | table | ubuntu | 325 MB     | 
 public | spaces     | table | ubuntu | 8192 bytes | 
 public | typecodes  | table | ubuntu | 48 kB      | 
 public | valuations | table | ubuntu | 622 MB     | 
 public | values     | table | ubuntu | 8192 bytes | 

select count(*) from atoms;      -- 3659843 = 3.6M
select count(*) from valuations; -- 5700207 = 5.7M

Rows: 60123 Columns: 60143
Size: 1679575 non-zero entries of 3615977589 possible
Fraction non-zero: 4.6449E-4 Sparsity (-log_2): 11.072
Total observations: 87843720.0  Avg obs per pair: 52.301
Entropy Total: 17.473   Left: 10.253   Right: 10.107
Total MI: 2.8871

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  8170.        8702.    
Count   (l_1)  1.5620E+6    1.3583E+6     191.2        156.1    
Length  (l_2)  1.4766E+5    1.3177E+5     18.07        15.14    
RMS Count      1.4721E+5    1.3142E+5     18.02        15.10    

472247960 Bytes uncompressed = 472 MB
 84150547 Bytes compressed = 84 MB

b4e48f00a94fa8d3d1d08e8331d0d84a9  zen_pairs_mi.sql
2c6d2667a4ff2d9f54d89765a91c3e37  zen_pairs_mi.sql.bz2

==================================================================
zen_pairs_mst
-------------
Mandarin word-pairs. Segmentation into words done by Ruiting.
This is the alpha-segmented-1 texts only.  Includes word-pair
MI statstics, disjuncts and disjunct-MI. MST texts were the
same alpha-segmented-1 texts.

STATUS: good
DATE: 17 July 2017
REASON: No known defects.

                        List of relations
 Schema |    Name    | Type  | Owner  |    Size    | Description 
--------+------------+-------+--------+------------+-------------
 public | atoms      | table | ubuntu | 522 MB     | 
 public | spaces     | table | ubuntu | 40 kB      | 
 public | typecodes  | table | ubuntu | 56 kB      | 
 public | valuations | table | ubuntu | 1219 MB    | 
 public | values     | table | ubuntu | 8192 bytes | 

Summary Report for Correlation Matrix Word-Disjunct Pairs (Connector Sets)
Rows: 60143 Columns: 602124
Size: 800855 non-zero entries of 36213543732 possible
Fraction non-zero: 2.2115E-5 Sparsity (-log_2): 15.465
Total observations: 1188456.0  Avg obs per pair: 1.4840
Entropy Total: 18.859   Left: 17.994   Right: 10.125
Total MI: 9.2606

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  6327.        7.399    
Count   (l_1)  1.8066E+4    94.14         2.855        12.72    
Length  (l_2)  722.8        67.89         .1142        9.175    
RMS Count      695.7        62.85         .1100        8.494    

select count(*) from atoms;      -- 5845332 = 5.85 M atoms
select count(*) from valuations; -- 11414113 = 11.4M values

901757880 Bytes uncompressed = 902 MB
125868179 Bytes compressed   = 126 MB

c4df6f2da0c476a561cbea82981a6853  zen_pairs_mst.sql
ff7cb1628cb7aad0a59c71b98a626121  zen_pairs_mst.sql.bz2


==================================================================
zen_pairs_two
-------------
Mandarin word-pairs. Segmentation into words done by Ruiting. Does
NOT include pair-MI stats. This is includes alpha-segmented-1 and
alpha-segmented-2 texts.

STATUS: good
DATE: 10 Sept 2017
REASON: No known defects. Except that the dataset is too big.

                        List of relations
 Schema |    Name    | Type  | Owner  |    Size    | Description 
--------+------------+-------+--------+------------+-------------
 public | atoms      | table | ubuntu | 8947 MB    | 
 public | spaces     | table | ubuntu | 40 kB      | 
 public | typecodes  | table | ubuntu | 56 kB      | 
 public | valuations | table | ubuntu | 103 GB     | 
 public | values     | table | ubuntu | 8192 bytes | 

select count(*) from atoms;      -- 101322902 = 101 M atoms
select count(*) from valuations; --  54922685 =  55 M valuations

5140909514 bytes uncompressed = 5.14 GBytes
 863704716 bytes compressed   = 864 MBytes

c8ec47ba53fedad6ce0871c8a7482410  zen_pairs_two.sql
c8dc76a1bd5e68c8a6d08689f6485610  zen_pairs_two.sql.bz2


==================================================================
==================================================================
==================================================================
==================================================================
==================================================================

dropdb  en_pairs_tthree en_pairs_ttwo en_pairs_rone 

Plan:
load en_pairs_mst
load en_pairs_semi_fu
recompute MI for word-pairs.
fork, and restart mst counting...


(use-modules (opencog) (opencog persist) (opencog persist-sql))
(sql-open "postgres:///en_pairs_mst?user=linas")
(use-modules (opencog cogserver))
(start-cogserver "opencog3.conf")
(sql-load)

sql-load has no docs

also missing type inheritance!  (but what if inheritance conflicts!?)

SQLAtomStorage.cc:1583 thrown by makeAtom
but who calls makeAtom?
load_all_atoms_cb

QLAtomStorage.cc:1360 null pointer deref.
get_recursive_if_not_exists
from :1377 PseudoPtr po(petAtom(idu)); returned null ptr for 132204462

132204462
132272910
132300252
133895580
133896697
133884903

27 missing uuids so far.  They're not in rohit, so wtf?

1673 should be omp-algo


#define OC_OMP 1
setting_omp(num_threads(), 3);
num_threads


SELECT uuid, name FROM atoms WHERE type = 73
  EXCEPT SELECT atoms.uuid,atoms.name FROM atoms, atoms_wtf 
     WHERE atoms_wtf.uuid = atoms.uuid;

 2293473835 | tail-piece
 1621296002 | dendropark
 2146998680 | Fellers
  244689200 | PVC
 1438975809 | Arntzenius
  709360907 | server-based
 2400387025 | Kihelkonna
  799467208 | Crispe's
  610089230 | Byssocallis
  325547913 | leveraging
  179977711 | amounted
  492116248 | Kampf
  209124496 | Barranca
 1158151745 | Ilisl
 1005621585 | Caravans
 1926542305 | agonising
 1593374046 | Urged


SELECT * FROM Atoms WHERE outgoing @> ARRAY[CAST(2293473835 AS BIGINT)];

 2293477332 |     1 |    8 |      1 |      | {570739,2293473835}
 2293477368 |     1 |    8 |      1 |      | {1537258,2293473835}
 2293477336 |     1 |    8 |      1 |      | {2293473835,241}
 2293477334 |     1 |    8 |      1 |      | {573730097,2293473835}
 2293477354 |     1 |    8 |      1 |      | {4369780,2293473835}
 2439795736 |     1 |    8 |      1 |      | {143427138,2293473835}
 2439795738 |     1 |    8 |      1 |      | {2293473835,143427163}


CREATE TABLE tmp_atoms AS 
   SELECT   uuid,  space, type, height, name, outgoing 
   FROM atoms WHERE height=0
     EXCEPT SELECT atoms.uuid,  atoms.space, atoms.type, atoms.height, atoms.name, atoms.outgoing
          FROM atoms, atoms_wtf 
          WHERE atoms_wtf.uuid = atoms.uuid;

338354

UPDATE tmp_atoms SET type= x WHERE NAME='joe';

INSERT INTO atoms_wtf 
   SELECT   uuid,  space, type, height, name, outgoing 

fuck it. 
load rohit first, then load semi_fu then load mst

(use-modules (opencog) (opencog persist) (opencog persist-sql))
(use-modules (opencog nlp))
(use-modules (opencog cogserver))
(sql-open "postgres:///en_pairs_rohit?user=linas")
(start-cogserver "opencog2.conf")
(sql-load)
OK, that's loading in parallel yayyy! peaked over 17K/second
dropped down to 11.3K per sec
Need to load 19M for this one <<< 19741280 
     ... in 1691 seconds (11674 per second)
     ... using 27GB RAM
     ... in approx 260 cpu-minutes.

OK, so can hit rates over 20K atoms/sec during loads, when the 
DB is in RAM (or maybe SSD). Drops to 300 atoms/sec when DB is
on spinning disk. Ouch!

Hmmm .. 20K/sec if there are not values on the atom.
10K/sec if there are values ...

So when bulk loading....
calls load_all_atoms_cb
which does get values.   get_atom_values
get_all_values_cb

(sql-close)
(sql-open "postgres:///en_pairs_semi_fu?user=linas")
(sql-load)
loaded 132172832  in 9938 seconds (13299 per second)
Atomspace holds 146629585 atoms in 171GBytes RAM. Ouch. 1159:08 CPU
again: 953:04.24 CPU again 949:04.10

(sql-close) <<< 1163:38 CPU
(sql-open "postgres:///en_pairs_semi_ok?user=linas")
(sql-store)
Store rate is 20K atoms/minute! 1.2M/hour --> 100 hours (4 days) to
store fu.  Lets try again. parallelize too

So... store queues not being used. Lots of fetches, but these
seem pointless ?  FIXED
Max UUID is 2 !!!!??   FIXED

OK, better: 1.3K/sec, about 100K/min - 1470 min = 24 hours

num_get_links and write queues not used.  FIXED
... and max uuid is still 2. FIXED
should call storeAtom(h, false) FIXED

OK, store queues are cranking away, 100% i/o bound.  1.1K/sec
--> 38 hours to complete!  Ouch.
... dropped to 603 per second after 15% complete.

Plan B:
copy en_pairs_semi_fu to en_pairs_wiki
load en_pairs_mst
close
open en_pairs_wiki

=================================
/home/ubuntu/src/atomspace/opencog/persist/sql/multi-driver/ll-pg-cxx.cc:113)

PQresult message: ERROR:  could not read block 479803 in file
"base/16446/16452.3": read only 0 of 8192 bytes
SELECT * FROM Atoms WHERE type = 82 AND outgoing = '{23, 7830585, 9}';
SELECT * FROM Atoms WHERE type = 137 AND outgoing = '{232023, 14}';
SELECT * FROM Atoms WHERE type = 137 AND outgoing = '{2433080, 852}';
SELECT * FROM Atoms WHERE type = 137 AND outgoing = '{9196089, 2499}';
SELECT * FROM Atoms WHERE type = 137 AND outgoing = '{3250528, 10}';
SELECT * FROM Atoms WHERE type = 82 AND outgoing = '{23, 30218901, 9}';

/usr/lib/postgresql/9.5/bin/pg_resetxlog  /var/lib/postgresql/9.5/main

Crap.  Total data corruption.
Restart, again
====================================
/etc/postgresql/9.6/main/postgresql.conf
increase shared_buffers to 24GB
shared_buffers = 24GB
max_worker_processes = 24
fsync = on  
effective_cache_size = 128GB

increse  /etc/sysctl.d/30-postgresql-shm.conf too

grep ^VmPeak /proc/4170/status

hugpages may be too big... but anonhugepages shoud work fine

no commit delay:  300%, 70% idle 6% wait 10 loadavg 10m val/h 20a/h
10K commit
11:18

=====================================================
-- Restart counting. Done,  May 21 06:15 UTC

As of: 2017-05-21 18:59:08 i.e. 12.7 hours later,
284 articles 

select count(*) from atoms; <<< 1832992 = 1.8M

SELECT count(atoms.uuid) FROM atoms,typecodes WHERE
atoms.type=typecodes.type AND typecodes.typename='EvaluationLink';
gives 840285 = 840K  and equal number of ListLink
39772 = 39K WordNode

SELECT sum(floatvalue[3]) FROM valuations WHERE type=7;
aka
SELECT sum(valuations.floatvalue[3]) FROM valuations,typecodes
WHERE valuations.type=typecodes.type AND typecodes.typename='CountTruthValue';

gives 39459145 = 39M counts = 3.1M counted per hour = 863 pairs/second

----------------
As of 2017-05-22 05:56:04 i.e. 24 hours later
497 articles  .. really 500 a day, avg.

select count(*) from atoms; << 2829421 = 2.8M
1309922 = 1.3M EvaluationLinks
53781 = 54K words

67789172 = 68M counts = 2.8M/hour = 784 pairs/sec

----------------
As of 2017-05-22 23:58:10 
888 articles

select count(*) from atoms; <<< 4239364 = 4.2M 
1980561 = 2M eval links
71595 = 71K words

116752710 = 117M counts in 42 hours = 2.8M/hour
          or (117M-68M) / 18 hours = 2.7M/hour

------------------
Restart from scratch 2017-05-23 00:10:00
at 01:51 have 129302108= 129M so 12M in 1.7 hours = 7M/hour
So now its more than 2x faster. almost 3x, with rounding errors
Yayyyy!!!

05:30 152806491 =153 -117 = 36M obs in 5.4 hours = 6.7M obs/hour
                = 1854 obs/second

----------------------------------------------------

Why is it slowing?
---------------
1) why is valuation updates about 3.5x of sum(3)?
2) why is get-got almost 2x bigger than delta for nodes? A: 
3) why is get-got almost 1.5x bigger than delta for links? A: LgAnd's

One sentence:
sum valuations=245   but 461 valuation updates!?
5 WordNodes
7 ListLinks
7 EvaluationLinks
----------------- expect 19 atoms
got 41 atoms... many are LgWordCsets, LgAnd's OK.  total stores is perfect.

num_get_nodes=34 huh???
this time, 922 updates!!!! wtf
why are fecth and store counts same?? maybe cause not syn
cog-logger-set-sync!

There were 23 fetches logged:
1 sent
1 parse
5 word
 -- total 7 nodes
?? where are the connectors? not fetched, cause not incr'ed so OK.
7 eval
9 lgwordcset
 -- total 16 links
 ListLinks, not fetched cause not incr'ed. so OK.

245 stores. again 922 updates of values...

SentenceNode got update twice...
ParseNode twice ... 
2x for all the words ... 

Then lots of updates, even when not teh main target of the store...
Now, only 490 updates. Still too many. should be 245 ... !?
barrier is broken.. wewell its not forcing a flush

does close have a barrier?

well, busy_writers is a bad idea... because it races.
but queue size was wrong.

OK, so 105 of 245 ... 123 

 why is fillfraction 55K ? Because drain is no longer being hit.

=====================================================
TODO:
-- verify integrity of the database.
-- verify that MST has all the pairs that rohit does. OK.
-- Update the dump status above; copy it over. OK, Done.
-- Create the missing status on en_pairs_sim from the paper.


(use-modules (opencog) (opencog persist) (opencog persist-sql))
(use-modules (opencog nlp) (opencog nlp learn))
(sql-open "postgres:///en_pairs_sim?user=linas")
(use-modules (opencog cogserver))
(start-cogserver "opencog2.conf")
(define pca (make-pseudo-cset-api))
(batch-pairs pca)

So now word-pair loading is out of control...
loadeed csets in 553 seconds, same as before, but at 2400% cpu

Crap.  Below is a disaster.
commit_delay = 0
synchronous_commit = local
Stored 1000 of 291637 lefties in 270 secs (3.7037037037037037 stores/sec)
Stored 2000 of 291637 lefties in 320 secs (3.125 stores/sec)

Try again:
commit_delay = 0
synchronous_commit = off
Stored 20000 of 291637 lefties in 45 secs (444.44444444444446 stores/sec)
Stored 40000 of 291637 lefties in 47 secs (425.531914893617 stores/sec)
Stored 60000 of 291637 lefties in 62 secs (322.5806451612903 stores/sec)

OK, so we are back in business
======================================================================

(add-pair-mi-api pca) 'compute-left-fractional

right-wild gives dj

/tmp/ranked-word-ent.dat

(define cs (cog-incoming-by-type (Word "possible") 'LgWordCset))

(filter (lambda (cset) (< 10 (get-count cset))) cs)

possible N=3 has 1: a-
         N=2 has 5: (is- that+) (it- to+) 
         N=1 = 106

education: 100  N=3 has 1  N=2 has 7

lost 100  1 and 7
days  98 2 7
children 101 1 9

(define bins (second binned-pair-mi))
(fold + 0 (array->list bins))

-----------------------------------------------------------
1 word was observed 38977 times
 37502
32517
22632

differences:
there is a left and a right diff.
The wild-card support needs to be a union
overload 'left-stars 'right-stars 'pair-count 'item-pair
this can be a generic map function of any kind! not just a diff!

=======================================
There is no value for key (PredicateNode "*-FrequencyKey-*")

en_pairs_tone_mst: spinnning drives:
Done storing 4886362 pair MI's in 6903 secs


=======================================

OK, so:
pca is the pseudo-cset-api
pma adds special stars to it
pdi will provide utilities
   pdi takes pma and wraps it with default stars
      default stars should see the pma under it.

15265 pos only

15420 the all by itself
 7168 for "a"
total 15420+7168 -256 = 22588 - 256 = 22332  which is what union reports...
unions 22260 < so wtf is this? oh 72 obse are identical!
256 interested!  sum = 22260+256 = 22516

Hmmm. 
-       (filter!
-               (lambda (wrd)
-                       (not (null? (get-cset-vec wrd))))
-               WORD-LIST)

(cog-incoming-by-type ITEM 'LgWordCset)

 Error: do_store_single_atom: Maxiumum Link size is 330.
 (/home/ubuntu/src/atomspace/opencog/persist/sql/multi-driver/SQLAtomStorage.cc:1202)
Aborted

relex crash always on this:
“What the hell is happening here?!”
split-books/gneiosric-ab   three out of three crashes

cat gneiosric-ab | ./split-sentences.pl > g-split
./ss-one.sh en gneiosric-ab localhost 17005

cat g-split | ./submit-one.pl localhost 17005 observe-text  breaks
g2  breaks
g2b breaks
g2guess is OK
g2bb is OK
g2ba breaks
g2baa is OK
g2bab breaks
g2baba breaks
g2babaa is OK
g2babab breaks
g2bababa breaks
g3 is OK

cat g4 |nc localhost 4445   breaks!
echo 「...」 |nc localhost 4445  breks
link-parser works ... but eats the trailing character...!?

and generates zillions of parses!!??

of which most are identical...
relex definitely crashes...
linkage_set_domain_names+0xe0

6 links,
5th link crashes..
dtype array holds junk

dtsz supposed to be the actual size of valid entries
ppn->dtsz

chk_d_type reallocs but does not memset....
dtsz is too small.!!
chk_d_type

chk_d_type(pp->pp_node, numli...
 do not set the pipinfo if domains is zero.
so do not free. either

*** START OF THIS PROJECT GUTENBERG EBOOK
***START OF THE PROJECT GUTENBERG EBOOK

END OF THIS PROJECT GUTENBERG EBOOK

*** START: FULL LICENSE ***
The Full Project Gutenberg License

sed -n '/PROJECT GUTENBERG EBOOK/,$p' filename

schweben

getp "is a"
54756-0.txt

grep -l 大
grep -l Anmerkungen *

purezza
quella

if

Langauge:

54637-0.txt
54640-0.txt
54652-0.txt
54655-0.txt
54660-0.txt
54665-0.txt
54667-0.txt
54668-0.txt
54672-0.txt
54675-0.txt
54676-0.txt
54679-0.txt
54681-0.txt
54706-0.txt
54711-0.txt
54714-0.txt
54719-0.txt
54721-0.txt
54724-0.txt
54729-0.txt


guile

(use-modules (opencog) (opencog persist) (opencog persist-sql))
(use-modules (opencog nlp) (opencog nlp learn))
(use-modules (opencog cogserver))
(start-cogserver "opencog2.conf")
(sql-open "postgres:///en_pairs_tone_mst?user=ubuntu")
(sql-load)
(sql-stats)
(sql-close)
Finished loading 16487725 atoms in total in 2212 seconds (7453 per second)
started at 20K/sec .. towards end, was 75% system cpu... why????
21GB ram = 1400Bytes/atom. as usual. Need a diet plan.

(sql-open "postgres:///en_pairs_ttwo?user=ubuntu")
(sql-load)
(sql-stats)
(sql-close)
Finished loading 16817599 atoms in total in 991 seconds (16970 per second)
Much faster because most atoms are in atomspace already.
sql-stats: Atomspace holds 22987920 atoms ... and is 26GB in size.


(sql-open "postgres:///en_pairs_ttwo_mst?user=ubuntu")
(sql-store)
(sql-stats)
(sql-close)

Initial rate is (3389 per second) on SSD which is 10x the spinning-disk
Peaked at (3546 per second) half-way throough
Dropped to (2537 per second) overall average.
version but is still pathetically slow.
iotop shows 3.2 MBytes/sec  and about 770 tps
so where is the bottleneck?
 Bottleneck is still disk i/o, even though its SSD:
how can I tell?
1) guile is under 90% cpu
2) 20+ postgres procs show 30% cpu, each
3) sql-stats shows 8 threads busy draining.
4) loadavg shows 6
5) top shows > 2.0% wait,  (on 24 cpus!) 4% system 18% user 75% idle
   viz about 0.5 cou wait, 1 cpu system, 4cpu's busy
   and since guile is less than  1 cpu, the postgres take up the
   remaining cpu.  Since 18 cpus are idle, we must be stalled in i/o.
So, somehow still stuck in i/o waiting for postgres to flush to disk.

6) iotop shows 60 to 100 MBytes/sec, highly variable.
   wait sometimes spikes to 15% (and io dropts to zero)
   sometimes rate spikes to 300MB/sec! but rarely.

7) Launching any-parsing does not seem to affect iowait!
   Nore does it change store performance at all!!!
   but it does raise the write rates and the tps

?? Is it postgres indexing? Can we suspend that while storing?

--------- meanwhile continue pair-parsing
launch tranche-3 any-parsing Tue May 30 04:39:44 UTC 2017
Done
en_pairs_tthree
(sql-open "postgres:///en_pairs_tthree?user=ubuntu")
(fetch-all-words)
(define ala (make-any-link-api))
(define asa (add-pair-stars ala))
(asa 'fetch-pairs)
(batch-all-pair-mi asa)
Finished with MI computations; this took 11.9 hours
(print-matrix-summary-report asa)

Summary Report for Correlation Matrix Link Grammar ANY link Word Pairs
Left type: WordNode    Right Type: WordNode    Pair Type: ListLink
Wildcard: (EvaluationLink (ctv 0 0 5.5719787e+08)
   (LinkGrammarRelationshipNode "ANY")
   (ListLink
      (AnyNode "left-word")
      (AnyNode "right-word")
   )
)
Rows: 424940 Columns: 431538
Size: 15224271 non-zero entries of 183377757720 possible
Fraction non-zero: 8.3021E-5 Sparsity (-log_2): 13.556
Total observations: 557197874.0  Avg obs per pair: 36.599
Entropy Total: 18.317   Left: 10.191   Right: 10.061
Total MI: -1.935

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  4.4098E+4    4.3839E+4
Count   (l_1)  8.3106E+6    7.4675E+6     188.5        170.3    
Length  (l_2)  9.1631E+5    7.7754E+5     20.78        17.74    
RMS Count      9.1591E+5    7.7713E+5     20.77        17.73    

OK, So I think we are done with en_pairs_tthree.

----- anyway, recompute pair mi and resume mst-parsing

en_pairs_ttwo_mst

(define ala (make-any-link-api))
(define asa (add-pair-stars ala))
(asa 'fetch-pairs)

(batch-all-pair-mi asa)
Final store: about  (1250.0 pairs/sec)
Done storing 8047063 pair MI's in 6905 secs

sql-stats: Atomspace holds 23178644 atoms = 23M = 35GBytes
Now can start tranche-2 MST parsing.

Done. Wow. That was fast! did anything actually happen?
Well, after a series of issues, yes, it looks like this run was good.

select count(*) from atoms; <<< 27638783 = 27M

get-all-words -- 188793  vs. tone: 139790 Seems  OK.
all-cset-words -- 83131  vs tone 139790 ??  Crazy talk WTF? did we not
                                          load correctly?
disjuncts -- 1670883 vs tone 1860796

wtf somethng broke....

(define (filter-words-with-csets WORD-LIST)
   (filter!  (lambda (wrd) (not (null? (get-cset-vec wrd)))) WORD-LIST))

Recompute the matrices again.

(sql-open "postgres:///en_pairs_ttwo_mst?user=ubuntu")
(fetch-all-words)
(define ala (make-any-link-api))
(define asa (add-pair-stars ala))
(asa 'fetch-pairs) << 1077 1154
(batch-all-pair-mi asa)

Support: found num left=183290 num right=186523 in 389 secs
Done with wild-card count N(x,*) and N(*,y) in 733 secs
Done computing N(*,*) total-count=267913561.0 in 23 secs
Done computing 8047063 pairs in 480 secs
Done computing 183290 left-wilds in 25 secs
Done storing 186523 left-wilds in 86 secs
Done storing 183290 right-wilds in 95 secs
....
Going to compute the left, right and total entropy
Finished left norm totals in 100 secs
Finished right norm totals in 106 secs
Done computing totals; start saving wildcards
terminate called after throwing an instance of
'opencog::RuntimeException'
  what():  Failed to execute!
(/home/ubuntu/src/atomspace/opencog/persist/sql/multi-driver/ll-pg-cxx.cc:113)
arghhh. The valuation table was missing a lock.
Fixed in 32d8ae4be6164a9c3594eab05f2d5af5e2c9fec6

Finished with MI computations; this took 6.25 hours

Summary Report for Correlation Matrix Link Grammar ANY link Word Pairs
Left type: WordNode    Right Type: WordNode    Pair Type: ListLink
Wildcard: (EvaluationLink (ctv 0 0 2.6791356e+08)
   (LinkGrammarRelationshipNode "ANY")
)
Rows: 183290 Columns: 186523
Size: 8047063 non-zero entries of 34187800670 possible
Fraction non-zero: 2.3538E-4 Sparsity (-log_2): 12.053
Total observations: 267913561.0  Avg obs per pair: 33.293
Entropy Total: 17.827   Left: 9.9014   Right: 9.7626
Total MI: -1.837

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  2.3078E+4    2.2456E+4
Count   (l_1)  4.0365E+6    3.4647E+6     174.9        154.3    
Length  (l_2)  4.2779E+5    3.4953E+5     18.54        15.56    
RMS Count      4.2741E+5    3.4915E+5     18.52        15.55    


(define pca (make-pseudo-cset-api))
(define psa (add-pair-stars pca))
(psa 'fetch-pairs)
Elapsed time to load csets: 2454 secs
(batch-all-pair-mi psa)
Finished with MI computations; this took 4.55 hours

(print-matrix-summary-report psa)
Summary Report for Correlation Matrix Word-Disjunct Pairs (aka Connector Sets)
Left type: WordNode    Right Type: LgAnd    Pair Type: LgWordCset
Wildcard: (ListLink (ctv 0 0 2.5749688e+08)
   (AnyNode "cset-word")
   (AnyNode "cset-disjunct")
)
Rows: 186573 Columns: 3401465
Size: 6975371 non-zero entries of 634621529445 possible
Fraction non-zero: 1.0991E-5 Sparsity (-log_2): 16.473
Total observations: 257496884.0  Avg obs per pair: 36.915
Entropy Total: 11.868   Left: 2.4858   Right: 9.8057
Total MI: -0.423

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  5.8326E+4    1.7086E+5
Count   (l_1)  3.2094E+6    9.5093E+7     55.03        556.6    
Length  (l_2)  2.4075E+6    1.2274E+7     41.28        71.84    
RMS Count      1.8036E+6    1.2272E+7     30.92        71.83    

OK, but this is wrong, we have to redoit.

------
Hand-repair

INSERT INTO typecodes VALUES (229, 'PseudoAnd');
INSERT INTO typecodes VALUES (230, 'PseudoWordCset');


select count(*) from atoms where type = 174;  -- 174==PseudoConnector
gives 241601

CREATE TEMP TABLE con AS SELECT uuid FROM atoms WHERE type=174;

select count(*) from atoms, con where atoms.outgoing[1]=con.uuid;
gives 3401462

-- 167 is LgAnd ....
select count(*) from atoms, con where atoms.outgoing[1]=con.uuid AND atoms.type=167;
give same result

-- change all of them to PseudoAnd
update atoms set type=229 FROM con where outgoing[1]=con.uuid and type=167;

How many LgAnds are left?
select count(*) from atoms where type=167; -- gives 3
select count(*) from atoms where type = 165;  -- 165==LgConnector
gives 2

CREATE TEMP TABLE lgs AS SELECT uuid FROM atoms WHERE type=167;
select count(*) from atoms, lgs where atoms.outgoing[2]=lgs.uuid;
536890 -- which is what we well need to delete

-- now the rest.

CREATE TEMP TABLE pan AS SELECT uuid FROM atoms WHERE type=229;
-- 229 is the new PseudoAnd
select count(*) from pan;  3401462

select count(*) from atoms, pan where atoms.outgoing[2]=pan.uuid;
gives 9839946

-- 169 is LgWordCset
select count(*) from atoms, pan where atoms.outgoing[2]=pan.uuid AND atoms.type=169;
gives 6438484

select count(*) from atoms, pan where atoms.outgoing[2]=pan.uuid AND atoms.type=21;
gives 3401462  which is as before. == (- 9839946 6438484)

so that makes sense too.

update atoms set type=230 FROM pan where outgoing[2]=pan.uuid and type=169;

------
May as well drop the bogus connectors, too??  Yes, we should.
select count(*) from atoms where type=169;
 536887 -- exactly as expected.

CREATE TEMP TABLE lws AS SELECT uuid FROM atoms WHERE type=169;
select count(*) from valuations, lws where valuations.atom=lws.uuid;

delete from valuations using lws where atom =lws.uuid;
delete from atoms where type=169;

DONE. Now redo the summaries.

redoing cset MI took
Finished with MI computations; this took 8.28 hours

(print-matrix-summary-report psa)
Summary Report for Correlation Matrix Word-Disjunct Pairs (aka Connector Sets)
Left type: WordNode    Right Type: PseudoAnd    Pair Type: PseudoWordCset
Wildcard: (ListLink (ctv 0 0 14382276)
   (AnyNode "cset-word")
   (AnyNode "cset-disjunct")
)
Rows: 175559 Columns: 3401462
Size: 6438484 non-zero entries of 597157267258 possible
Fraction non-zero: 1.0782E-5 Sparsity (-log_2): 16.501
Total observations: 14382276.0  Avg obs per pair: 2.2338
Entropy Total: 21.006   Left: 14.906   Right: 10.007
Total MI: -3.906

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  6.1010E+4    9176.    
Count   (l_1)  1.5853E+5    6.4221E+4     2.598        6.999    
Length  (l_2)  5694.        3476.         9.3332E-2    .3788    
RMS Count      5666.        3444.         9.2870E-2    .3753    

OK, 
so en_pairs_ttwo_mst seems to contain valid data.
So we are done, here, and its time to construct the next tranche.


---------- Try again. Here's what tone_mst says:
(use-modules (opencog) (opencog persist) (opencog persist-sql))
(use-modules (opencog nlp) (opencog nlp learn))
(use-modules (opencog analysis))
(sql-open "postgres:///en_pairs_tone_mst?user=ubuntu")
(fetch-all-words)

(define ala (make-any-link-api))
(define asa (add-pair-stars ala))
(asa 'fetch-pairs)  << 672 secs

(print-matrix-summary-report asa)  ; crash, of course. So rebuild .
(batch-all-pair-mi asa)

Start computing the basis
Support: found num left=138014 num right=139770 in 247 secs
Done with wild-card count N(x,*) and N(*,y) in 419 secs
Done computing N(*,*) total-count=139806259.0 in 17 secs
Going to do individual pair frequencies
Done computing 4886362 pairs in 268 secs
Start computing log P(*,y)
Done computing 138014 left-wilds in 18 secs  
Done computing 139770 right-wilds in 17 secs
Done storing 139770 left-wilds in 67 secs
Done storing 138014 right-wilds in 64 secs
Done computing 4886362 pair MI's in 2051 secs
Done storing 4886362 pairs in 3378 secs
Finished left entropy subtotals in 191 secs
Finished right entropy subtotals in 184 secs
Finished left MI subtotals in 193 secs
Finished right MI subtotals in 181 secs
Finished left support subtotals in 479 secs
Finished right support subtotals in 456 secs
Finished left norm totals in 86 secs
Finished right norm totals in 85 secs
Done storing 139770 left-wilds in 126 secs
Done storing 138014 right-wilds in 132 secs
Finished with MI computations; this took 2.388 hours

(print-matrix-summary-report asa)
Summary Report for Correlation Matrix Link Grammar ANY link Word Pairs
Left type: WordNode    Right Type: WordNode    Pair Type: ListLink
Rows: 138014 Columns: 139770
Size: 4886362 non-zero entries of 19290216780 possible
Fraction non-zero: 2.5331E-4 Sparsity (-log_2): 11.947
Total observations: 139806259.0  Avg obs per pair: 28.612
Entropy Total: 17.725   Left: 9.9308   Right: 9.8248
Total MI: -2.030

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  1.6405E+4    1.6483E+4
Count   (l_1)  1.9950E+6    1.8453E+6     121.6        112.0    
Length  (l_2)  2.2904E+5    1.9881E+5     13.96        12.06    
RMS Count      2.2878E+5    1.9854E+5     13.95        12.05    


Now do it again, for the disjuncts!

(sql-clear-stats)
(define pca (make-pseudo-cset-api))
(define psa (add-pair-stars pca))
(psa 'fetch-pairs)
Elapsed time to load csets: 1484 secs

(batch-all-pair-mi psa)
Finished with MI computations; this took 3.19 hours

(print-matrix-summary-report psa)

Summary Report for Correlation Matrix Word-Disjunct Pairs (aka Connector Sets)
Left type: WordNode    Right Type: LgAnd    Pair Type: LgWordCset
Wildcard: (ListLink (ctv 0 0 1.33363e+08)
   (AnyNode "cset-word")
   (AnyNode "cset-disjunct")
)
Rows: 139790 Columns: 1860796
Size: 3975919 non-zero entries of 260120672840 possible
Fraction non-zero: 1.5285E-5 Sparsity (-log_2): 15.998
Total observations: 133363005.0  Avg obs per pair: 33.543
Entropy Total: 11.921   Left: 2.4678   Right: 9.8636
Total MI: -0.410

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  3.3665E+4    1.2870E+5
Count   (l_1)  1.6849E+6    5.1241E+7     50.05        398.2    
Length  (l_2)  1.2139E+6    6.4911E+6     36.06        50.44    
RMS Count      1.0132E+6    6.4895E+6     30.10        50.42    


===============
Arghhhh Sanity check:
the LgWordCset's in these files are:

(LgWordCset 
    (WordNode "this")
    (LgAnd 
        (LgConnector 
            (LgConnectorNode "ANY")
            (LgConnDirNode "-")
            (LgConnMultiNode "@")
        )

vs.
    (LgWordCset
       (WordNode "playing")
       (LgAnd
          (PseudoConnector

Ugh.  The load is polluted!

Double check tone_mst...
dd(use-modules (opencog) (opencog persist) (opencog persist-sql))
(use-modules (opencog nlp) (opencog nlp learn) (opencog analysis))
(sql-open "postgres:///en_pairs_tone_mst?user=ubuntu")
(fetch-all-words)

(define pca (make-pseudo-cset-api))
(define psa (add-pair-stars pca))
(psa 'fetch-pairs)

So, tone, by itself, in sql, has:
LgWordCset: 404882 = 405K  unique csets and
LgWordCset: 125707119 << 126M disjunct observations.

tone_mst has via SQL:
   3975919 = 3.9M csets

(cog-count-atoms 'LgWordCset) <<< 3975919  exactly same as above

(sql-close)
(cog-delete-recursive (LgConnMultiNode "@"))

(cog-count-atoms 'LgWordCset) <<< 3571037 == 3.57M atoms Hmmm!
difference =  (- 3975919 3571037) = 404882 which is exactly tone by
itself.  Excellent.  Now recompute the cset stats....

(sql-open "postgres:///en_pairs_tone_mst?user=ubuntu")

(batch-all-pair-mi psa)
Finished with MI computations; this took 4.15 hours

(print-matrix-summary-report psa)

So this is very different than before. Fuck.

(print-matrix-summary-report psa)
Summary Report for Correlation Matrix Word-Disjunct Pairs (aka Connector Sets)
Left type: WordNode    Right Type: LgAnd    Pair Type: LgWordCset
Wildcard: (ListLink (ctv 0 0 7655886)
   (AnyNode "cset-word")
   (AnyNode "cset-disjunct")
)
Rows: 133022 Columns: 1860793
Size: 3571037 non-zero entries of 247526406446 possible
Fraction non-zero: 1.4427E-5 Sparsity (-log_2): 16.081
Total observations: 7655886.0  Avg obs per pair: 2.1439
Entropy Total: 20.558   Left: 14.711   Right: 10.004
Total MI: -4.156

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  3.4890E+4    6946.    
Count   (l_1)  9.1434E+4    3.4736E+4     2.621        5.001    
Length  (l_2)  2143.        1397.         6.1427E-2    .2011    
RMS Count      2107.        1368.         6.0395E-2    .1970    


---------- repair:
INSERT INTO typecodes VALUES (229, 'PseudoAnd');
INSERT INTO typecodes VALUES (230, 'PseudoWordCset');


select count(*) from atoms where type = 174;  -- 174==PseudoConnector
gives 182912

CREATE TEMP TABLE con AS SELECT uuid FROM atoms WHERE type=174;

select count(*) from atoms, con where atoms.outgoing[1]=con.uuid;
gives 1860793

-- 167 is LgAnd ....
select count(*) from atoms, con where atoms.outgoing[1]=con.uuid AND atoms.type=167;
give same result

-- change all of them to PseudoAnd
update atoms set type=229 FROM con where outgoing[1]=con.uuid and type=167;

How many LgAnds are left?
select count(*) from atoms where type=167; -- gives 3
wtf??? but this is exactly what is in tone, also!!!!!!! 
   XXX so any disjunct counting is borken!  fuuck.

select count(*) from atoms where type = 165;  -- 165==LgConnector
gives 2
wtf.  Also same as tone.

CREATE TEMP TABLE lgs AS SELECT uuid FROM atoms WHERE type=167;
select count(*) from atoms, lgs where atoms.outgoing[2]=lgs.uuid;
404882 -- which is exactly what got deleted. Very good.

-- now the rest.

CREATE TEMP TABLE pan AS SELECT uuid FROM atoms WHERE type=229;
-- 229 is the new PseudoAnd
select count(*) from pan;
so its 1860793 which is same as before.

select count(*) from atoms, pan where atoms.outgoing[2]=pan.uuid;
gives 5431830 

-- 169 is LgWordCset
select count(*) from atoms, pan where atoms.outgoing[2]=pan.uuid AND atoms.type=169;
gives 3571037

so what the heck has pseudoAnd as second, but is not an LgWordCset ????

its type=21 ... ListLink. 
(ListLink ; 17184167    --- I guess we stored the counts here. Hmmm. why?
   (AnyNode "cset-word")
   (PseudoAnd ...)

select count(*) from atoms, pan where atoms.outgoing[2]=pan.uuid AND atoms.type=21;
gives 1860793 which is as before. == (- 5431830 3571037)
so that makes sense too.

update atoms set type=230 FROM pan where outgoing[2]=pan.uuid and type=169;

------
May as well drop the bogus connectors, too??  Yes, we should.
select count(*) from atoms where type=169;
404882 -- exactly as expected.

CREATE TEMP TABLE lws AS SELECT uuid FROM atoms WHERE type=169;
select count(*) from valuations, lws where valuations.atom=lws.uuid;

delete from valuations using lws where atom =lws.uuid;
delete from atoms where type=169;

DONE.

---------- meanwhile, construct en_pairs_tthree_mst DONE
but first, in en_pairs_tthree, kill the bogus disjuncts.
select count(*) from atoms where type=169;  --- 1245661

Deleted. And take a new DB dump, while we are at it. DONE.

Computed the pair MI's they are in en_pairs_tthree now, see above. DONE.
Now merge in en_pairs_ttwo_mst
strategy:
-- load words and disjuncts from ttwo_mst
-- close db
-- load everything from en_pairs_tthree
-- save to en_pairs_tthree_mst

169 LgWordCset
 167 | LgAnd

(use-modules (opencog) (opencog persist) (opencog persist-sql))
(use-modules (opencog nlp) (opencog nlp learn))
(use-modules (opencog analysis))
(sql-open "postgres:///en_pairs_ttwo_mst?user=ubuntu")
(fetch-all-words)

(define pca (make-pseudo-cset-api))
(define psa (add-pair-stars pca))
(psa 'fetch-pairs)   <<< took 3449 secs
(sql-close)
(sql-open "postgres:///en_pairs_tthree?user=ubuntu")
(sql-load)
(sql-close)
(sql-open "postgres:///en_pairs_tthree_mst?user=ubuntu")
(sql-store) ; -- 46262710 = 46M atoms total
(sql-close)


---------------------------------------------------------------------
---------- meanwhile, finish stats work
(fetch-all-sims)

general idea: how many pairs are there out of N^2?
what is the distribution of pair memebership?

sims should be LLOBJ

Umm batch-all-pair-mi is where?

batch-sim should NOT store!
batch-sim-pairs 

So: 1) cutoff for sim  2) cutoff for store.

start 2.4G and run 0.3 sim
again 0.1 sim...

possible: (37413 * 37412)/2 = 699847578 = 700M pairs
estimate: 7.5% of these, so = 52M pairs!? Ouch.  .. 70-80 GB RAM
    and insanely slow ..  secs = 102 hrs = 4.2 days
running at 1.9K pairs/sec ouch.

4000 secs for 20x36K = 180/sec total collapse.

Try again:
(use-modules (opencog) (opencog persist) (opencog persist-sql))
(use-modules (opencog nlp) (opencog nlp learn))
; (sql-open "postgres:///en_pairs_supersim?user=linas")
(sql-open "postgres:///en_pairs_ultrasim?user=linas")
(use-modules (opencog cogserver))
(start-cogserver "opencog2.conf")
(use-modules (opencog analysis))
(fetch-all-words)

(define pca (make-pseudo-cset-api))
(define psa (add-pair-stars pca))
(psa 'fetch-pairs)
(print-matrix-summary-report psa)

(sql-clear-stats)
; 1524572 atoms in AS
(define ac (get-all-cset-words)) 
(length ac)
(load "gram-sim.scm")
(para-batch-sim-pairs ac 0.1)

oh fu... its running 3x because:
1) not_yet_stored
2) do_store_single_atom
FIXED.  num_get_links - num_got_links == total stores
   and  num_get_links == valuation update  Yayyy!!

OK, so: 1.5M atoms, 37413 words, now: 13M new atoms
so 13M / 37K = 343 atoms per incoming set.

OK. DONE. Now what?

binned-sims.dat
(define all-sims '())
(cog-map-type
   (lambda (sim)  (set! all-sims (cons sim all-sims)) #f)
   'SimilarityLink)
(length all-sims) -- 44139852 = 44M  wow
(define scored-sims (score sim-cosine all-sims))  ;; many hours
(define binned-sims (bin-count-simple scored-sims 300))


-------------------
FWIW, the crappy results from back-when: en_pairs_sim:

Summary Report for Correlation Matrix Word-Disjunct Pairs (aka Connector Sets)
Left type: WordNode    Right Type: LgAnd    Pair Type: LgWordCset
Wildcard: (ListLink (ctv 0 0 661104)
   (AnyNode "cset-word")
   (AnyNode "cset-disjunct")
)
Rows: 37413 Columns: 291637
Size: 446204 non-zero entries of 10911015081 possible
Fraction non-zero: 4.0895E-5 Sparsity (-log_2): 14.578
Total observations: 661104.0  Avg obs per pair: 1.4816
Entropy Total: 18.301   Left: 16.006   Right: 10.281
Total MI: -7.985

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  4122.        370.0
Count   (l_1)  8763.        680.7         2.126        1.839
Length  (l_2)  236.8        51.39         5.7452E-2    .1389
RMS Count      216.6        46.40         5.2550E-2    .1254

Notice that tone has maybe 200x mor observations!!!! 133M instead of
660K ... wow. en_pairs_sim also has:

Left type: WordNode    Right Type: WordNode    Pair Type: ListLink
Wildcard: (EvaluationLink (ctv 0 0 4.1823528e+08)
   (LinkGrammarRelationshipNode "ANY")
)
Rows: 395274 Columns: 396260
Size: 8880914 non-zero entries of 156631275240 possible
Fraction non-zero: 5.6699E-5 Sparsity (-log_2): 14.106
Total observations: 418235277.0  Avg obs per pair: 47.094
Entropy Total: 19.280   Left: 11.088   Right: 11.215
Total MI: -3.023

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  2.9904E+4    3.4828E+4                       
Count   (l_1)  4.4813E+6    5.2946E+6    149.9        152.0
Length  (l_2)  4.9537E+5    4.9524E+5    16.57        14.22
RMS Count      4.9502E+5    4.9482E+5    16.55        14.21

---------- meanwhile do the rone_mst DONE
Started  gamma-guten-r port 19505  feeder-term-7 / guile-term-6
guile -l mst-count-en-r.scm on term-6
9 June 10PM  3028 articles
12 June 2017 8PM DONE
Now compute the summaries.

(define pca (make-pseudo-cset-api))
(batch-pairs pca)  
COMMENT ON DATABASE en_pairs_rone_mst IS 'Clean MST-parse of tranche-1 and summary';

---------- meanwhile do the tthree_mst DONE
gamma-guten feeder-8 port 19005 ./guten-mst-en.sh
cog-term-1 guile -l mst-count-en.scm on term 1

Started 10 June 8AM -- 5712 articles
running at about 900 articles/day

---------- meanwhile do rtwo pairs   DONE
Started. beta-guten-r 4500 articles.  feeder-4 guile-3 port 17015
9 June 10PM done  12 June 1PM
now:
createdb -T en_pairs_r en_pairs_rtwo
COMMENT ON DATABASE en_pairs_rtwo IS 'Clean ANY-parse of tranche-1 and tranch-2';
pg_dump en_pairs_rtwo > en_pairs_rtwo.sql
DONE.

---------- meanwhile do rtwo_mst  DONE
started
copy rtwo to rtwo_mst this gets pairs
open rone_mst, load cset pairs
close rone_mst
open rtwo_mst
write cset pairs only (not the words)
close rtwo_mst

$ createdb -T en_pairs_rtwo en_pairs_rtwo_mst
(use-modules (opencog analysis))
(sql-open "postgres:///en_pairs_rone_mst?user=ubuntu")
(fetch-all-words)
(define pca (make-pseudo-cset-api))
(define psa (add-pair-stars pca))
(psa 'fetch-pairs)
(print-matrix-summary-report psa)
(sql-close)

(sql-open "postgres:///en_pairs_rtwo_mst?user=ubuntu")
(cog-map-type (lambda (cset) (store-atom cset) #f) 'PseudoWordCset)
(sql-close)

Oh, wait; we also have to compute the pairMI's!. Ooops, almost forgot.
(define ala (make-any-link-api))
(batch-pairs ala)   DONE

Started  gamma-guten-r port 19505  feeder-term-7 / guile-term-6
guile -l mst-count-en-r.scm on term-6
4500 articles
Started 13 June 2017 6:30PM  Done 6 hours later! wtf! last time, it was
too fast, also. ???  WTF. why? Bug?

(batch-pairs psa)  DONE

Well, there's a huge pile of errors in the MST log file.

---------- meanwhile do rthree pairs
guile-3 port 17015 feeder-4  5713 articles
Started 12 June 2017 2PM
Paused 24 hours later, == 800 articles/24 hours


---------- meanwhile, compute & cache similarity  DONE
; (sql-open "postgres:///en_pairs_tone_sim?user=ubuntu")

Wait, where?
Oh, gram-sim.
DONE.
then binned-sims

-----------
todo items:
* trim low observation counts ....
* implement sql delete function.
* see todo at bottom
* XXX r versions still fail to separate single-quotes
  Except I am having trouble reproducing this... lg any seems to work OK
* Also ." is not split .. which I also cannot reproduce.
* Hyphenated words should be split, by default. These can be
  reconstructed later. Split - dashes, long dashes, elipsis. DONE.

---------- debug hang:
latest bdgw from git does not solve it.
latest stable-2.2 guile does not solve it.

revert to distro bdwgc
#0  0x00007f362151c826 in __GI___sigsuspend (
    set=set@entry=0x7f36214b1740 <suspend_handler_mask>)
    at ../sysdeps/unix/sysv/linux/sigsuspend.c:30
#1  0x00007f3621293602 in GC_suspend_handler_inner
(dummy=dummy@entry=0x0, 
    context=context@entry=0x7fff6c807540) at pthread_stop_world.c:324
#2  0x00007f36212936cf in GC_suspend_handler (sig=30, info=<optimized
out>, 
    context=0x7fff6c807540) at pthread_stop_world.c:237
#3  <signal handler called>


thr 2: find_slot_map (
    cache=0x7f361fe85ab0, ip=0x1) at ../../libguile/vm.c:936
#1  scm_i_vm_mark_stack (vp=0xbdca3120, mark_stack_ptr=0x7f361fe85ef0, 
    mark_stack_limit=0x7f361fe95eb0) at ../../libguile/vm.c:1011
#2  0x00007f36212883be in GC_mark_from (mark_stack_top=0x7f361fe85ea0, 
    mark_stack_top@entry=0x7f361fe85f00, 
    mark_stack=mark_stack@entry=0x7f361fe85eb0, 
    mark_stack_limit=mark_stack_limit@entry=0x7f361fe95eb0) at
mark.c:784
#3  0x00007f36212889de in GC_do_local_mark
(local_mark_stack=0x7f361fe85eb0, 
    local_top=0x7f361fe85f00) at mark.c:1048
#4  0x00007f3621288bf8 in GC_mark_local (
    local_mark_stack=local_mark_stack@entry=0x7f361fe85eb0,
id=id@entry=1)
    at mark.c:1181
#5  0x00007f3621288f0a in GC_help_marker
(my_mark_no=my_mark_no@entry=195743)
    at mark.c:1249
#6  0x00007f3621292edc in GC_mark_thread (id=<optimized out>)
    at pthread_support.c:380


single-stepping:

scm_i_vm_mark_stack (vp=0xbdca3120, mark_stack_ptr=0x7f361fe85ef0, 
    mark_stack_limit=0x7f361fe95eb0) at ../../libguile/vm.c:975
975            fp = SCM_FRAME_DYNAMIC_LINK (fp))
(gdb) print fp
$1 = (union scm_vm_stack_element *) 0x7f36183d5e38
(gdb) step
973       for (fp = vp->fp, sp = vp->sp;
(gdb) 
979           for (slot = nlocals - 1; sp < fp; sp++, slot--)
(gdb) 
1011          slot_map = find_slot_map (SCM_FRAME_RETURN_ADDRESS (fp),
&cache);
(gdb) 
1006          sp = SCM_FRAME_PREVIOUS_SP (fp);
(gdb) print fp
$2 = (union scm_vm_stack_element *) 0x7f36183d5e38
(gdb) print sp
$3 = (union scm_vm_stack_element *) 0x7f36183d5e48
(gdb) step
1011          slot_map = find_slot_map (SCM_FRAME_RETURN_ADDRESS (fp),
&cache);
(gdb) 
find_slot_map (cache=0x7f361fe85ab0, ip=0x1) at ../../libguile/vm.c:932
932       size_t slot = (((scm_t_uintptr) ip) >> 2) %
SLOT_MAP_CACHE_SIZE;
(gdb) 
935       if (cache->entries[slot].ip == ip)
(gdb) 
scm_i_vm_mark_stack (vp=0xbdca3120, mark_stack_ptr=0x7f361fe85ef0, 
    mark_stack_limit=0x7f361fe95eb0) at ../../libguile/vm.c:1011
1011          slot_map = find_slot_map (SCM_FRAME_RETURN_ADDRESS (fp),
&cache);
(gdb) 
find_slot_map (cache=0x7f361fe85ab0, ip=0x1) at ../../libguile/vm.c:936
936         map = cache->entries[slot].map;
(gdb) 
scm_i_vm_mark_stack (vp=0xbdca3120, mark_stack_ptr=0x7f361fe85ef0, 
    mark_stack_limit=0x7f361fe95eb0) at ../../libguile/vm.c:975
975            fp = SCM_FRAME_DYNAMIC_LINK (fp))
(gdb) print fp
$4 = (union scm_vm_stack_element *) 0x7f36183d5e38

git tag -l
Try guile-2.2  v2.2.0 Wed Mar 15 09:02:52 2017
Try guile-2.1.8  v2.1.8 Fri Mar 10 11:01:04 2017 tried it - spins. its broke
   (breaks after about 300 cpu-min)

OK guile-2.0.11 on xenial crashes almost immediately with
guile: hashtab.c:137: vacuum_weak_hash_table: Assertion `removed <= len' failed.


Arguments with Curtis:
GC_register_my_thread
-------------------------------------------------------------------------

Bewlow has gone to
https://debbugs.gnu.org/cgi/bugreport.cgi?bug=27234

bug-guile@gnu.org.

Subject: Hang in GC, inf loop while walking frame pointers

what: guile-2.2-stable, from git.

I've got a large, complex, heavily multi-threaded guile program that
hangs during garbage collection; usually after running for half a day.
It hangs in a tight loop in scm_i_vm_mark_stack, spinning at 100% of CPU.

This is due to the for-loop line fp = SCM_FRAME_DYNAMIC_LINK (fp)) 
at libguile/vm.c line 975 failing to advance the frame pointer.
There's no "obvious" corruption in the stack; it simply looks like
the frame was incompletely set up, and so incrementing to the next
fp does not go anywhere.

I have recompiled guile with VM_ENABLE_ASSERTIONS and am trying to
reproduce the bug now.  The rest of this email is a record of a long
debug session isolating the problem, and showing that, overall, the
thread and stack data look more-or-less correct and uncorrupoted,
except for the inability to walk forward in the frame.

-- linas

Try again.
same as above: thread 4: find_slot_map
187 threads total.

#0  find_slot_map (cache=0x7f3e9b783ab0, ip=0x1) at
../../libguile/vm.c:935
935       if (cache->entries[slot].ip == ip)
(gdb) print slot
$1 = 0
(gdb) print cache->entries[slot].ip
$2 = (scm_t_uint32 *) 0x1
(gdb) print cache->entries[slot].map
$4 = (const scm_t_uint8 *) 0x0
(gdb) step
scm_i_vm_mark_stack (vp=0x755c1bd0, mark_stack_ptr=0x7f3e9b783f40, 
    mark_stack_limit=0x7f3e9b793eb0) at ../../libguile/vm.c:1011
1011        slot_map = find_slot_map (SCM_FRAME_RETURN_ADDRESS (fp), &cache);
(gdb) print fp
$5 = (union scm_vm_stack_element *) 0x7f3e94cdee38

#define SCM_FRAME_RETURN_ADDRESS(fp)    ((fp)[0].as_ip)
(gdb) print (fp)[0].as_ip
$6 = (scm_t_uint32 *) 0x1

OK that looks weird ... is this corrupted ?? but whatever,
because the returned slot_map is never used ... because ...

(gdb) step
scm_i_vm_mark_stack (vp=0x755c1bd0, mark_stack_ptr=0x7f3e9b783f40, 
    mark_stack_limit=0x7f3e9b793eb0) at ../../libguile/vm.c:975
975            fp = SCM_FRAME_DYNAMIC_LINK (fp))
(gdb) print fp
$7 = (union scm_vm_stack_element *) 0x7f3e94cdee38

frames.h:#define SCM_FRAME_DYNAMIC_LINK(fp)      ((fp) + (fp)[1].as_uint)
(gdb) print (fp)[1].as_uint
$8 = 0

OK, that seems bad, because now fp never advances, it just repeats
over and over with this same value.

(gdb) 
979           for (slot = nlocals - 1; sp < fp; sp++, slot--)
(gdb) print nlocals
$10 = -2
(gdb) print sp
$11 = (union scm_vm_stack_element *) 0x7f3e94cdee48
#define SCM_FRAME_NUM_LOCALS(fp, sp)    ((fp) - (sp))
(gdb) print fp
$12 = (union scm_vm_stack_element *) 0x7f3e94cdee38
(gdb) print  ((fp) - (sp))
$13 = -2
Ohh .. its not -16 because its -2 * sizeof (union scm_vm_stack_element *)
so that's OK.
So for loops is skipped, it should go to.
      sp = SCM_FRAME_PREVIOUS_SP (fp);
frames.h:#define SCM_FRAME_PREVIOUS_SP(fp)	((fp) + 2)

and so now it loops around and repeats.
(gdb) print cache
$19 = {entries = {{ip = 0x1, map = 0x0}, {ip = 0x0, 
      map = 0x0} <repeats 23 times>, {ip = 0x1a1b5e0, map = 0x0}, {ip = 0x0, 
      map = 0x0}, {ip = 0x0, map = 0x0}, {ip = 0x0, map = 0x0}, {ip = 0x0, 
      map = 0x0}, {ip = 0x0, map = 0x0}, {ip = 0x0, map = 0x0}, {ip = 0x0, 
      map = 0x0}}}
(gdb) print &cache
$20 = (struct slot_map_cache *) 0x7f3e9b783ab0

and so the loop repeates forever, because 
fp = SCM_FRAME_DYNAMIC_LINK (fp) never advances fp, because
(fp)[1].as_uint  is zero.

So where is fp pointing to?  recall fp == 0x7f3e94cdee38

(gdb) x/20x 0x7f3e94cdee00
0x7f3e94cdee00: 0x0000000000000904      0x000000000000200c
0x7f3e94cdee10: 0x0000000001a1b7e0      0x0000000001a1b5e0
0x7f3e94cdee20: 0x0000000000000004      0x000000000000200c
0x7f3e94cdee30: 0x0000000000169bd6      0x0000000000000001
0x7f3e94cdee40: 0x0000000000000000      0x000000000192acd0
0x7f3e94cdee50: 0x0000000001fa4bc0      0x0000000001a1c6d0
0x7f3e94cdee60: 0x0000000044507950      0x0000000000000002
0x7f3e94cdee70: 0x000000000005a6f5      0x00000000018febd0
0x7f3e94cdee80: 0x000000006d490d00      0x00007f3e9e97241c
0x7f3e94cdee90: 0x0000000000000002      0x00007f3e9e97241c


(gdb) x/s 0x7f3e94cdee60
0x7f3e94cdee60: "PyPD"      <<< ?? is this a meaningul string?
(gdb) x/s 0x7f3e94cdee81
0x7f3e94cdee81: "\rIm"      << how about this ???

So this does not look healthy.  How did we get here?

(gdb) print vp
$21 = (struct scm_vm *) 0x755c1bd0
(gdb) print mark_stack_ptr
$22 = (struct GC_ms_entry *) 0x7f3e9b783f40
(gdb) print mark_stack_limit
$23 = (struct GC_ms_entry *) 0x7f3e9b793eb0
(gdb) print upper
$24 = (void *) 0x7ffdd986
(gdb) print GC_greatest_plausible_heap_addr
$25 = (void *) 0x7ffdd986
(gdb) print lower
$26 = (void *) 0x17a1ff8

(gdb) print vp->fp
$27 = (union scm_vm_stack_element *) 0x7f3e94cdee18
(gdb) print vp->sp
$28 = (union scm_vm_stack_element *) 0x7f3e94cdee00
(gdb) print  vp->stack_top
$29 = (union scm_vm_stack_element *) 0x7f3e94cdf000

So lets walk manually. 
frames.h:#define SCM_FRAME_DYNAMIC_LINK(fp)      ((fp) + (fp)[1].as_uint)

(gdb) print (vp->fp) + (vp->fp)[1].as_uint
$31 = (union scm_vm_stack_element *) 0x7f3e94cdee38
So we are instanly in trouble! once through the loop, and we've got the broken fp

So how did we get here?

(gdb) print vp
$32 = (struct scm_vm *) 0x755c1bd0
(gdb) print *vp
$33 = {ip = 0x7f3e9e5a6378 <subr_stub_code+56>, sp = 0x7f3e94cdee00, 
  fp = 0x7f3e94cdee18, stack_limit = 0x7f3e94cde000, trace_level = 0, 
  sp_min_since_gc = 0x7f3e94cdee00, stack_size = 512, 
  stack_bottom = 0x7f3e94cde000, stack_top = 0x7f3e94cdf000, 
  overflow_handler_stack = 0x304, hooks = {0x4, 0x4, 0x4, 0x4, 0x4}, 
  resumable_prompt_cookie = 0x7f3d397f9440, engine = 1}

Looks plausible, not corrupted. Why is engine=1 ?? 
#define SCM_VM_REGULAR_ENGINE 0
#define SCM_VM_DEBUG_ENGINE 1
#define SCM_VM_NUM_ENGINES 2
#  define SCM_I_CURRENT_THREAD (scm_i_current_thread)

(gdb) print scm_i_current_thread
$34 = (scm_i_thread *) 0x0

OK, that's not excellent.
(gdb) print thread_count
$35 = 161

(gdb) bt
#0  scm_i_vm_mark_stack (vp=0x755c1bd0, mark_stack_ptr=0x7f3e9b783f40, 
    mark_stack_limit=0x7f3e9b793eb0) at ../../libguile/vm.c:1011
#1  0x00007f3e9db8835e in GC_mark_from (mark_stack_top=0x7f3e9b783ee0, 
    mark_stack_top@entry=0x7f3e9b783f00, 
    mark_stack=mark_stack@entry=0x7f3e9b783eb0, 
    mark_stack_limit=mark_stack_limit@entry=0x7f3e9b793eb0) at ../mark.c:772
#2  0x00007f3e9db8897e in GC_do_local_mark (local_mark_stack=0x7f3e9b783eb0, 
    local_top=0x7f3e9b783f00) at ../mark.c:1037
#3  0x00007f3e9db88b98 in GC_mark_local (
    local_mark_stack=local_mark_stack@entry=0x7f3e9b783eb0, id=id@entry=4)
    at ../mark.c:1170
#4  0x00007f3e9db88eaa in GC_help_marker (my_mark_no=my_mark_no@entry=80003)
    at ../mark.c:1238
#5  0x00007f3e9db92e3c in GC_mark_thread (id=<optimized out>)
    at ../pthread_support.c:380
#6  0x00007f3e9e2ae6ba in start_thread (arg=0x7f3e9b794700)
    at pthread_create.c:333
#7  0x00007f3e9dfdd82d in clone ()
    at ../sysdeps/unix/sysv/linux/x86_64/clone.S:109

so bdwgc is version gc7_6_0

So ../mark.c:772 is GET_HDR and GET_HDR is in
include/private/gc_hdrs.h

define GET_HDR(p, hhdr)  ... ((hhdr) = HDR_INNER(p) 
# define HDR_INNER(p) HDR_FROM_BI(BI(p),p)
#define HDR_FROM_BI(bi, p) \
                ((bi)->index[((word)(p) >> LOG_HBLKSIZE) & (BOTTOM_SZ - 1)])

This seems all wrong.. wtf ....

is it called by thread_mark ??
in libguile/thread.c:
  thread_gc_kind =
    GC_new_kind (GC_new_free_list (),
       GC_MAKE_PROC (GC_new_proc (thread_mark), 0),
       0, 1)
in bdwgc/misc.c  GC_new_proc
    GC_mark_procs[result] = proc
#define GC_mark_procs GC_arrays._mark_procs
#define PROC(descr) \
      (GC_mark_procs[((descr) >> GC_DS_TAG_BITS) & (GC_MAX_MARK_PROCS-1)])

      GC_obj_kinds[result].ok_descriptor = descr;  <<< this is where MAKE_PROC goes.

anyway ... in mark.c line 733
        case GC_DS_PROC:
          mark_stack_top--;
          credit -= GC_PROC_BYTES;
          mark_stack_top = (*PROC(descr))((word *)current_p, mark_stack_top,
                                          mark_stack_limit, ENV(descr));
          continue;
But that's the wrong line number.  line 772 is in 
        case GC_DS_PER_OBJECT:
          if ((signed_word)descr >= 0) {
            /* Descriptor is in the object.     */
            descr = *(word *)(current_p + descr - GC_DS_PER_OBJECT);

Oh, it goes to retry, which loops around and calls PROC which is thread_mark
which is called with args 
          mark_stack_top = (*PROC(descr))((word *)current_p, mark_stack_top,
                                          mark_stack_limit, ENV(descr));

(gdb) print current_p
$39 = (ptr_t) 0x7225d380 "@\325%r"

so back in libguile/threads.c line 84:
  const struct scm_i_thread *t = (struct scm_i_thread *) addr;

(gdb) print *(struct scm_i_thread *) current_p
$40 = {next_thread = 0x7225d540, handle = 0x5763f3b0, pthread = 139900934399744, 
  result = 0x4, exited = 0, guile_mode = 1, needs_unregister = 1, wake = 0x0, 
  sleep_cond = {__data = {__lock = 0, __futex = 0, __total_seq = 0, 
      __wakeup_seq = 0, __woken_seq = 0, __mutex = 0x0, __nwaiters = 0, 
      __broadcast_seq = 0}, __size = '\000' <repeats 47 times>, __align = 0}, 
  sleep_pipe = {151, 197}, freelists = 0x71cfe800, 
  pointerless_freelists = 0x71cfe780, dynamic_state = 0x71de7900, dynstack = {
    base = 0x698c3800, top = 0x698c3940, limit = 0x698c3a00}, 
  pending_asyncs = 0x304, block_asyncs = 0, continuation_root = 0x5763f340, 
  continuation_base = 0x7f3d397f9c90, vp = 0x755c1bd0, base = 0x7f3d397f9da0, 
  regs = {{__jmpbuf = {139905204221696, 139906923931021, 1, 139894281647232, 
        139906913276512, 0, 139906918327551, 8388608}, 
      __mask_was_saved = 964664752, __saved_mask = {__val = {0, 139900934399744, 
          139900934399744, 139900934397344, 139906923929400, 139893936840720, 
          1804170656, 139906913276512, 139900934399744, 139900934397344, 
          139900934397504, 139893936840720, 139906910859134, 139906913276484, 
          139906910857112, 27401856}}}}}

(gdb) print ((struct scm_i_thread *) current_p)->vp
$41 = (struct scm_vm *) 0x755c1bd0

which is exactly the vp we had before, so this is the correct thread.

So  ... all the values in *(struct scm_i_thread *) current_p look more or less OK;
its not corrupted. And all the values in *vp look more or less OK, its not corrrupted
except that engine=1 looks wrong.  So what's up with the weird stack looping?
Again: 
From before, we had:

(gdb) print *vp
$42 = {ip = 0x7f3e9e5a6378 <subr_stub_code+56>, sp = 0x7f3e94cdee00, 
  fp = 0x7f3e94cdee18, stack_limit = 0x7f3e94cde000, trace_level = 0, 
  sp_min_since_gc = 0x7f3e94cdee00, stack_size = 512, 
  stack_bottom = 0x7f3e94cde000, stack_top = 0x7f3e94cdf000, 
  overflow_handler_stack = 0x304, hooks = {0x4, 0x4, 0x4, 0x4, 0x4}, 
  resumable_prompt_cookie = 0x7f3d397f9440, engine = 1}

so fp, sp, stack_bottom, stack_top all are self-consistent with each other.
The problem is that
    fp = SCM_FRAME_DYNAMIC_LINK (fp)
goes nowhere, after the first iteration.

Is the frame corrupted? How? what does the rest of the stack look like?

(gdb) x/32x 0x7f3e94cdee00
0x7f3e94cdee00: 0x0000000000000904      0x000000000000200c
0x7f3e94cdee10: 0x0000000001a1b7e0      0x0000000001a1b5e0
0x7f3e94cdee20: 0x0000000000000004      0x000000000000200c  <<< theres the 4
0x7f3e94cdee30: 0x0000000000169bd6      0x0000000000000001 <<< there's the new fp
0x7f3e94cdee40: 0x0000000000000000      0x000000000192acd0 <<< there's the zero.
0x7f3e94cdee50: 0x0000000001fa4bc0      0x0000000001a1c6d0
0x7f3e94cdee60: 0x0000000044507950      0x0000000000000002
0x7f3e94cdee70: 0x000000000005a6f5      0x00000000018febd0
0x7f3e94cdee80: 0x000000006d490d00      0x00007f3e9e97241c
0x7f3e94cdee90: 0x0000000000000002      0x00007f3e9e97241c
0x7f3e94cdeea0: 0x0000000000000002      0x00007f3e8d797630
0x7f3e94cdeeb0: 0x0000000000000002      0x00007f3e86effacc
0x7f3e94cdeec0: 0x0000000000000003      0x000000006d490d00
0x7f3e94cdeed0: 0x00007f3e86eb8698      0x0000000000000002
0x7f3e94cdeee0: 0x00007f3e8e51f450      0x0000000000000008
0x7f3e94cdeef0: 0x0000000001a37c10      0x000000000192acd0


So... who sets up thread->vp ? 
/* #define VM_ENABLE_ASSERTIONS */
However, defining this breaks the build.

diff --git a/libguile/vm-engine.c b/libguile/vm-engine.c
index 6c88ebf..f0f8164 100644
--- a/libguile/vm-engine.c
+++ b/libguile/vm-engine.c
@@ -2050,11 +2050,11 @@ VM_NAME (scm_i_thread *thread, struct scm_vm *vp,
 
           if (!scm_module_system_booted_p)
             {
-              ASSERT (scm_is_true
+              ASSERT (scm_is_true(
                       scm_equal_p (modname,
                                    scm_list_2
                                    (SCM_BOOL_T,
-                                    scm_from_utf8_symbol ("guile"))));
+                                    scm_from_utf8_symbol ("guile")))));
               var = scm_lookup (sym);
             }
           else if (scm_is_true (SCM_CAR (modname)))
diff --git a/libguile/vm.c b/libguile/vm.c
index 18f2192..c26066e 100644
--- a/libguile/vm.c
+++ b/libguile/vm.c
@@ -63,7 +63,7 @@ static size_t page_size;
 
 /* The VM has a number of internal assertions that shouldn't normally be
    necessary, but might be if you think you found a bug in the VM. */
-/* #define VM_ENABLE_ASSERTIONS */
+#define VM_ENABLE_ASSERTIONS
 
 static void vm_expand_stack (struct scm_vm *vp,
                              union scm_vm_stack_element *new_sp) SCM_NOINLINE;


 GEN      guile-procedures.texi
/bin/bash: line 1: 24078 Broken pipe 

 ./meta/guile
Aborted
./libguile/guile
Aborted
gdb libguile/.libs/lt-guile

#0  0x00007ffff74f7428 in __GI_raise (sig=sig@entry=6)
    at ../sysdeps/unix/sysv/linux/raise.c:54
#1  0x00007ffff74f902a in __GI_abort () at abort.c:89
#2  0x00007ffff7b707c4 in vm_regular_engine (thread=0x7282, vp=0x806f30, 
    registers=0x6, resume=-145787864) at ../../libguile/vm-engine.c:2053
#3  0x00007ffff7b711d2 in scm_call_n (proc=0x832b30, argv=argv@entry=0x0, 
    nargs=nargs@entry=0) at ../../libguile/vm.c:1257
#4  0x00007ffff7af14e9 in scm_call_0 (proc=<optimized out>)
    at ../../libguile/eval.c:481
#5  0x00007ffff7b10568 in scm_primitive_load_path (args=<optimized out>)
    at ../../libguile/load.c:1248
#6  0x00007ffff7b6e976 in vm_regular_engine (thread=0x7282, vp=0x806f30, 
    registers=0x6, resume=-145787864) at ../../libguile/vm-engine.c:784

Oh. wtf. 


(define avg-time-taken
	(let ((last-gc (gc-stats))
			(start-time (get-internal-real-time))
			(run-time (get-internal-run-time)))
		(lambda () 
			(define now (get-internal-real-time))
			(define run (get-internal-run-time))
			(define cur (gc-stats))
			(define gc-time-taken (* 1.0e-9 (- (cdar cur) (cdar last-gc))))
			(define elapsed-time (* 1.0e-9 (- now start-time)))
			(define cpu-time (* 1.0e-9 (- run run-time)))
			(format #t "Elapsed time: ~5f secs. GC-time-taken: ~5f s or ~5f%	cpu-usage: ~5f%\n"
				elapsed-time gc-time-taken  (* 100 (/ gc-time-taken elapsed-time))
				(* 100 (/ cpu-time elapsed-time))
			)
			(set! last-gc cur)
			(set! start-time now)
			(set! run-time run))))


Anyway: it hangs without ever hitting any of the VM DEBUG asserts.
This time:

(gdb) print *vp
$1 = {ip = 0x7ffff7b87358 <subr_stub_code+56>, sp = 0x7fffdc617e00, 
  fp = 0x7fffdc617e18, stack_limit = 0x7fffdc617000, trace_level = 0, 
  sp_min_since_gc = 0x7fffdc617b58, stack_size = 512, 
  stack_bottom = 0x7fffdc617000, stack_top = 0x7fffdc618000, 
  overflow_handler_stack = 0x304, hooks = {0x4, 0x4, 0x4, 0x4, 0x4}, 
  resumable_prompt_cookie = 0x7fff857f9440, engine = 1}

(gdb) x/32x 0x7fffdc617e00
0x7fffdc617e00: 0x0000000000000904      0x000000000000630c
0x7fffdc617e10: 0x000000000089f7e0      0x000000000089f5e0
0x7fffdc617e20: 0x0000000000000004      0x000000000000630c
0x7fffdc617e30: 0x00000000000377d6      0x0000000000000001
0x7fffdc617e40: 0x0000000000000000      0x00000000007aecd0
0x7fffdc617e50: 0x00000000010de660      0x00000000008a06d0
0x7fffdc617e60: 0x000000003f543a40      0x0000000000000002
0x7fffdc617e70: 0x000000000000ddf5      0x0000000000782bd0
0x7fffdc617e80: 0x00000000130cbe20      0x00007ffff7f4d41c
0x7fffdc617e90: 0x0000000000000002      0x00007ffff7f4d41c
0x7fffdc617ea0: 0x0000000000000002      0x00007fffe7099630
0x7fffdc617eb0: 0x0000000000000002      0x00007fffe08f3acc
0x7fffdc617ec0: 0x0000000000000003      0x00000000130cbe20
0x7fffdc617ed0: 0x00007fffe08be698      0x0000000000000002
0x7fffdc617ee0: 0x00007fffe7c8e450      0x0000000000000008
0x7fffdc617ef0: 0x00000000008bbbe0      0x00000000007aecd0

Wow. More or less IDENTICAL to last time!!

what is vp->ip pointing at??

(gdb) x/16 0x7ffff7b87320
0x7ffff7b87320 <subr_stub_code>:        0x0000000a00000115      0x00000009000000b7
0x7ffff7b87330 <subr_stub_code+16>:     0x0000000000000000      0x0000000a00000215
0x7ffff7b87340 <subr_stub_code+32>:     0x00000009000000b7      0x0000000000000000
0x7ffff7b87350 <subr_stub_code+48>:     0x0000021800000217      0x000000b70000000a
0x7ffff7b87360 <subr_stub_code+64>:     0x0000000000000009      0x0000000a00000120
0x7ffff7b87370 <subr_stub_code+80>:     0x00000009000000b7      0x0000000000000000
0x7ffff7b87380 <subr_stub_code+96>:     0x0000000a00000315      0x00000009000000b7
0x7ffff7b87390 <subr_stub_code+112>:    0x0000000000000000      0x0000031700000216

WHo sets t->vp ???
thread_vm (scm_i_thread *t)
   t->vp = make_vm ();

So clearly, above is NOT a fresh stack, but is well-used.

(gdb) print vm_default_engine
$3 = 1

But ... #define SCM_VM_REGULAR_ENGINE 0
#define SCM_VM_DEBUG_ENGINE 1
 So who set it to 1??

#define FP_SLOT(i)           SCM_FRAME_SLOT (vp->fp, i)
#define SCM_FRAME_SLOT(fp,i)            ((fp) - (i) - 1)

      vp->fp = SCM_FRAME_SLOT (old_fp, proc - 1);
      SCM_FRAME_SET_DYNAMIC_LINK (vp->fp, old_fp);

frames.h:#define SCM_FRAME_DYNAMIC_LINK(fp)      ((fp) + (fp)[1].as_uint)
frames.h:#define SCM_FRAME_SET_DYNAMIC_LINK(fp, dl) ((fp)[1].as_uint = ((dl) - (fp)))

So I'm getting dl == fp ?? 
guile -l pair-count-en.scm

libguile/frames.h
@@ -104,7 +104,8 @@ union scm_vm_stack_element
 #define SCM_FRAME_RETURN_ADDRESS(fp)    ((fp)[0].as_ip)
 #define SCM_FRAME_SET_RETURN_ADDRESS(fp, ra) ((fp)[0].as_ip = (ra))
 #define SCM_FRAME_DYNAMIC_LINK(fp)      ((fp) + (fp)[1].as_uint)
-#define SCM_FRAME_SET_DYNAMIC_LINK(fp, dl) ((fp)[1].as_uint = ((dl) - (fp)))
+#define SCM_FRAME_SET_DYNAMIC_LINK(fp, dl)  { \
+((fp)[1].as_uint = ((dl) - (fp))) ; if ((dl) == (fp)) abort(); }
 #define SCM_FRAME_SLOT(fp,i)            ((fp) - (i) - 1)
 #define SCM_FRAME_LOCAL(fp,i)           (SCM_FRAME_SLOT (fp, i)->as_scm)
 #define SCM_FRAME_NUM_LOCALS(fp, sp)    ((fp) - (sp))

--- a/libguile/gsubr.c
+++ b/libguile/gsubr.c
@@ -169,7 +169,8 @@
        (generate-bytecode i)
        (setq i (1+ i)))))
 */
-static const scm_t_uint32 subr_stub_code[] = {
+// static const scm_t_uint32 subr_stub_code[] = {
+const scm_t_uint32 subr_stub_code[] = {
   /* C-u 1 0 M-x generate-bytecodes RET */
   /* 0 arguments */
   A(0),
--- a/libguile/vm.c
+++ b/libguile/vm.c
@@ -63,7 +63,7 @@ static size_t page_size;
 
 /* The VM has a number of internal assertions that shouldn't normally be
    necessary, but might be if you think you found a bug in the VM. */
-/* #define VM_ENABLE_ASSERTIONS */
+#define VM_ENABLE_ASSERTIONS
 
 static void vm_expand_stack (struct scm_vm *vp,
                              union scm_vm_stack_element *new_sp) SCM_NOINLINE;
@@ -952,6 +952,9 @@ enum slot_desc
     SLOT_DESC_UNUSED = 3
   };
 
+extern const scm_t_uint32 subr_stub_code[];
+scm_t_uint32 * pstub = (void*) &subr_stub_code;
+
 /* Mark the active VM stack region.  */
 struct GC_ms_entry *
 scm_i_vm_mark_stack (struct scm_vm *vp, struct GC_ms_entry *mark_stack_ptr,
@@ -967,6 +970,7 @@ scm_i_vm_mark_stack (struct scm_vm *vp, struct GC_ms_entry
*mark_stack_ptr,
   void *upper = (void *) GC_greatest_plausible_heap_addr;
   void *lower = (void *) GC_least_plausible_heap_addr;
   struct slot_map_cache cache;
+  union scm_vm_stack_element *fprev = NULL;
 
   memset (&cache, 0, sizeof (cache));
 
@@ -974,6 +978,14 @@ scm_i_vm_mark_stack (struct scm_vm *vp, struct GC_ms_entry
*mark_stack_ptr,
        fp < vp->stack_top;
        fp = SCM_FRAME_DYNAMIC_LINK (fp))
     {
+      if (fprev == fp)
+        {
+           printf("Oh no Mr Bill!! stack_size=%lu fp-bot = %lu ip-subr_stub_code=%lu engine=%d\n",
+           vp->stack_size, fp - vp->stack_bottom, vp->ip - pstub, vp->engine);
+           break;
+        }
+      fprev = fp;
+
       scm_t_ptrdiff nlocals = SCM_FRAME_NUM_LOCALS (fp, sp);
       size_t slot = nlocals - 1;
       for (slot = nlocals - 1; sp < fp; sp++, slot--)


Oh no Mr Bill!! stack_size=512 fp-bot = 455 ip-subr_stub_code=14  engine=1
Oh no Mr Bill!! stack_size=512 fp-bot = 455 ip-subr_stub_code=14  engine=1

after a wall-clock hour of runtime, it crashes:
#0  0x00007ffff7affb2a in scm_frame_instruction_pointer (frame=0x5bcae580)
    at ../../libguile/frames.c:346
frames.h:#define SCM_VM_FRAME_IP(f)	SCM_VM_FRAME_DATA (f)->ip
frames.h:#define SCM_VM_FRAME_DATA(x)	((struct scm_frame *)SCM_CELL_WORD_1 (x))
#define SCM_CELL_WORD_1(x) SCM_CELL_WORD ((x), 1)
#define SCM_CELL_WORD(x, n) SCM_GC_CELL_WORD ((x), (n))
gc.h:#define SCM_GC_CELL_WORD(x, n)   (SCM_UNPACK (SCM_GC_CELL_OBJECT ((x), (n))))
gc.h:#define SCM_GC_CELL_OBJECT(x, n) (((SCM *)SCM2PTR (x)) [n])
gc.h:#define SCM2PTR(x) ((scm_t_cell *) (SCM_UNPACK_POINTER (x)))
etc.

(gdb) x/8x  0x5bcae580
0x5bcae580:     0xffffffffa49232af      0x0000000000000000
0x5bcae590:     0xffffffffa396e59f      0x0000000000000000
0x5bcae5a0:     0xffffffffa4924287      0x0000000000000000
0x5bcae5b0:     0xffffffffa39d15df      0x0000000000000000

All of these look bad, and will clearly crash if derefernced.
(gdb) x 0xa49232af
0xa49232af:     Cannot access memory at address 0xa49232af
(gdb) x 0xffffffffa396e59f
0xffffffffa396e59f:     Cannot access memory at address 0xffffffffa396e59f



#1  0x00007ffff7b67331 in vm_debug_engine (thread=0x5bcae580, vp=0x5b62c480, 
    registers=0x7ffff7b04330 <scm_apply_subr+176>, resume=-536784)
    at ../../libguile/vm-engine.c:784
#2  0x00007ffff7b7128a in scm_call_n (proc=0x7fffede811e8, 
    argv=argv@entry=0x7ffe53ffddd8, nargs=nargs@entry=1)
    at ../../libguile/vm.c:1269
#3  0x00007ffff7af1568 in scm_call_1 (proc=<optimized out>, arg1=0x5bcae580)
    at ../../libguile/eval.c:487
#4  0x00007ffff7affd08 in scm_i_frame_print (frame=0x5bcae580, port=0x16f10160, 
    pstate=<optimized out>) at ../../libguile/frames.c:48
why are we printing???

#5  0x00007ffff7b33c4b in scm_prin1 (exp=exp@entry=0x5bcae580, 
    port=port@entry=0x16f10160, writingp=writingp@entry=1)
    at ../../libguile/print.c:817
#6  0x00007ffff7b34b11 in scm_write (obj=0x5bcae580, port=0x16f10160)
    at ../../libguile/print.c:1076

why are we writing?

#7  0x00007ffff7b67331 in vm_debug_engine (thread=0x5bcae580, vp=0x5b62c480, 
    registers=0x7ffff7b04330 <scm_apply_subr+176>, resume=-536784)
    at ../../libguile/vm-engine.c:784
#8  0x00007ffff7b7128a in scm_call_n (proc=0x7fffeddbed70, 
    argv=argv@entry=0x7ffe53ffe080, nargs=nargs@entry=4)
    at ../../libguile/vm.c:1269
#9  0x00007ffff7af1644 in scm_call_4 (proc=<optimized out>, 
    arg1=arg1@entry=0x59d5fee0, arg2=arg2@entry=0x59d5cf20, 
    arg3=arg3@entry=0x983520, arg4=arg4@entry=0x52) at ../../libguile/eval.c:508
#10 0x00007ffff7ae29a5 in display_backtrace_body (a=<optimized out>)
    at ../../libguile/backtrace.c:244

Ohh, why is this being done?

#11 0x00007ffff7b67331 in vm_debug_engine (thread=0x5bcae580, vp=0x5b62c480, 
    registers=0x7ffff7b04330 <scm_apply_subr+176>, resume=-536784)
    at ../../libguile/vm-engine.c:784
#12 0x00007ffff7b7128a in scm_call_n (proc=proc@entry=0x59d5cf00, 
    argv=argv@entry=0x0, nargs=nargs@entry=0) at ../../libguile/vm.c:1269
#13 0x00007ffff7af1549 in scm_call_0 (proc=proc@entry=0x59d5cf00)
    at ../../libguile/eval.c:481
#14 0x00007ffff7b600f9 in catch (tag=tag@entry=0x404, thunk=0x59d5cf00, 
    handler=0x59d5cee0, pre_unwind_handler=0x4) at ../../libguile/throw.c:137
#15 0x00007ffff7b60465 in scm_catch_with_pre_unwind_handler (key=key@entry=0x404, 
    thunk=<optimized out>, handler=<optimized out>, 
    pre_unwind_handler=<optimized out>) at ../../libguile/throw.c:254
#16 0x00007ffff7b6061f in scm_c_catch (tag=tag@entry=0x404, 
    body=body@entry=0x7ffff7ae2880 <display_backtrace_body>, 
    body_data=body_data@entry=0x7ffe53ffe460, 
    handler=handler@entry=0x7ffff7ae2c70 <error_during_backtrace>, 
    handler_data=<optimized out>, 
    pre_unwind_handler=pre_unwind_handler@entry=0x0, pre_unwind_handler_data=0x0)
    at ../../libguile/throw.c:377
#17 0x00007ffff7b6062e in scm_internal_catch (tag=tag@entry=0x404, 
    body=body@entry=0x7ffff7ae2880 <display_backtrace_body>, 
    body_data=body_data@entry=0x7ffe53ffe460, 
    handler=handler@entry=0x7ffff7ae2c70 <error_during_backtrace>, 
    handler_data=<optimized out>) at ../../libguile/throw.c:386
#18 0x00007ffff7ae2855 in scm_display_backtrace_with_highlights (
    stack=<optimized out>, port=<optimized out>, first=<optimized out>, 
    depth=<optimized out>, highlights=<optimized out>)
    at ../../libguile/backtrace.c:282

Yuck.
#19 0x00007fffecb62654 in opencog::SchemeEval::catch_handler(scm_unused_struct*,
scm_unused_struct*) (this=0x7ffe8c000980, tag=0x7a86e0, throw_args=0x5bcda980)
    at /home/ubuntu/src/atomspace/opencog/guile/SchemeEval.cc:420

Oh. Ewww. Something that got sent caused an exception.  But what?
Lets print to the log file.

#20 0x00007ffff7b67331 in vm_debug_engine (thread=0x5bcae580, vp=0x5b62c480, 
    registers=0x7ffff7b04330 <scm_apply_subr+176>, resume=-536784)
    at ../../libguile/vm-engine.c:784
#21 0x00007ffff7b7128a in scm_call_n (proc=proc@entry=0x5bcae600, 
    argv=<optimized out>, nargs=5) at ../../libguile/vm.c:1269
#22 0x00007ffff7af1a3b in scm_apply_0 (proc=proc@entry=0x5bcae600, args=0x304)
    at ../../libguile/eval.c:594
#23 0x00007ffff7b60177 in catch (tag=<optimized out>, thunk=0x5bcae620, 
    handler=0x5bcae600, pre_unwind_handler=0x5bcae5e0)
    at ../../libguile/throw.c:134
#24 0x00007fffecb62d29 in opencog::SchemeEval::do_eval(std::__cxx11::basic_string<char,
std::char_traits<char>, std::allocator<char> > const&) (this=0x7ffe8c000980, 
    expr=...) at /home/ubuntu/src/atomspace/opencog/guile/SchemeEval.cc:572
#25 0x00007fffecb62dda in opencog::SchemeEval::c_wrap_eval(void*) (
    p=0x7ffe8c000980)
    at /home/ubuntu/src/atomspace/opencog/guile/SchemeEval.cc:501
#26 0x00007ffff7aeb70a in c_body (d=0x7ffe53ffece0)
    at ../../libguile/continuations.c:422
#27 0x00007ffff7b67331 in vm_debug_engine (thread=0x5bcae580, vp=0x5b62c480, 
    registers=0x7ffff7b04330 <scm_apply_subr+176>, resume=-536784)
    at ../../libguile/vm-engine.c:784
<<<<<<<<<< first one is here.

#28 0x00007ffff7b7128a in scm_call_n (proc=proc@entry=0x5c6d3580, 
    argv=argv@entry=0x0, nargs=nargs@entry=0) at ../../libguile/vm.c:1269
#29 0x00007ffff7af1549 in scm_call_0 (proc=proc@entry=0x5c6d3580)
    at ../../libguile/eval.c:481
#30 0x00007ffff7b600f9 in catch (tag=tag@entry=0x404, thunk=0x5c6d3580, 
    handler=0x5c6d3560, pre_unwind_handler=0x5c6d3540)
    at ../../libguile/throw.c:137
#31 0x00007ffff7b60465 in scm_catch_with_pre_unwind_handler (key=key@entry=0x404, 
    thunk=<optimized out>, handler=<optimized out>, 
    pre_unwind_handler=<optimized out>) at ../../libguile/throw.c:254
#32 0x00007ffff7b6061f in scm_c_catch (tag=tag@entry=0x404, 
    body=body@entry=0x7ffff7aeb700 <c_body>, 
    body_data=body_data@entry=0x7ffe53ffece0, 
    handler=handler@entry=0x7ffff7aeb9a0 <c_handler>, 
    handler_data=handler_data@entry=0x7ffe53ffece0, 
    pre_unwind_handler=pre_unwind_handler@entry=0x7ffff7aeb800 <pre_unwind_handler>, pre_unwind_handler_data=0x7ff020) at ../../libguile/throw.c:377
#33 0x00007ffff7aebd10 in scm_i_with_continuation_barrier (
    body=body@entry=0x7ffff7aeb700 <c_body>, 
    body_data=body_data@entry=0x7ffe53ffece0, 
    handler=handler@entry=0x7ffff7aeb9a0 <c_handler>, 
    handler_data=handler_data@entry=0x7ffe53ffece0, 
    pre_unwind_handler=pre_unwind_handler@entry=0x7ffff7aeb800 <pre_unwind_handler>, pre_unwind_handler_data=0x7ff020) at ../../libguile/continuations.c:360
#34 0x00007ffff7aebdf5 in scm_c_with_continuation_barrier (func=<optimized out>, 
    data=<optimized out>) at ../../libguile/continuations.c:456
#35 0x00007ffff717f127 in GC_call_with_gc_active (
    fn=fn@entry=0x7ffff7b5e200 <with_guile_trampoline>, 
    client_data=client_data@entry=0x7ffe53ffedc0) at ../pthread_support.c:1343
#36 0x00007ffff7b5ec11 in with_guile (base=base@entry=0x7ffe53ffed90, 
    data=data@entry=0x7ffe53ffedc0) at ../../libguile/threads.c:688
#37 0x00007ffff7179132 in GC_call_with_stack_base (
    fn=fn@entry=0x7ffff7b5eb80 <with_guile>, arg=arg@entry=0x7ffe53ffedc0)
    at ../misc.c:1941
#38 0x00007ffff7b5efb8 in scm_i_with_guile (dynamic_state=<optimized out>, 
    data=<optimized out>, func=<optimized out>) at ../../libguile/threads.c:703
#39 scm_with_guile (func=<optimized out>, data=<optimized out>)
    at ../../libguile/threads.c:709
#40 0x00007fffecb62e5e in opencog::SchemeEval::eval_expr(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > const&) (
    this=0x7ffe8c000980, expr=...)
    at /home/ubuntu/src/atomspace/opencog/guile/SchemeEval.cc:473
#41 0x00007fffdef6eb6c in opencog::GenericShell::eval_loop (this=0x7fff69581ac0)
    at /home/ubuntu/src/opencog/opencog/cogserver/shell/GenericShell.cc:450




(observe-text "In the calmness of the evening, when the winds had sunk to rest, When no earthquake heaved its fury, burned no fire within my breast, Came a still small voice so tender, it the heart of Christ confessed: \"Unto thy God be true!\"")

Interesting. Unescaped quotes!  FIXED
also - unescaped carriage returns FIXED.
also sentence spliter fails when there are footnotes:
.[571]   FIXED
also at any time."[572]   FIXED
but also...
ERROR: In procedure fport_read: Connection reset by peer

Java eats .\n as a string.... but does not eat \n by itself.  FIXED
also it un-escapes the quotes.  FIXED
 Ohhh: right.\n[?].n   FIXED

skip setWordAndPos or rather use simplified form of it.
setWordAndPos
Remove from Linkable...
add loop for englsih when? in the algs... in Morphy? No, too late
in RelationExtractor.java: in 
FeatureNode fn = _parse.getLeft();
while (fn != null)
fn = fn.get("NEXT");


(use-modules (ice-9 textual-ports))
(define (fubar sent-txt)
   (let ((s (socket PF_INET SOCK_STREAM 0)))
      (connect s AF_INET (inet-pton AF_INET "127.0.0.1") 4445)
      (set-port-encoding! s "utf-8")
      (display sent-txt s) (display "\n" s)
      (format #t "Its ~A\n" (get-string-all s))
     (close-port s)))


Oh no Mr Bill!! stack_size=512 fp-bot = 455 ip-subr_stub_code=14 engine=1 Mon Jun  5 03:43:12 2017

Oh no Mr Bill!! stack_size=512 fp-bot = 455 ip-subr_stub_code=14 engine=1 Mon Jun  5 05:53:08 2017

Oh no Mr Bill!! stack_size=512 fp-bot = 455 ip-subr_stub_code=14 engine=1 Mon Jun  5 05:53:08 2017

Oh no Mr Bill!! stack_size=512 fp-bot = 455 ip-subr_stub_code=14 engine=1 Mon Jun  5 23:06:13 2017

This one has an exception half-an-hour earlier:
[2017-06-05 22:37:22:726] [INFO] Aiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiieee it
was this
: Backtrace: ...
In opencog/base/file-utils.scm:
    79:27  5 (exec-scm-from-port _)
In ice-9/boot-9.scm:
    849:4  4 (with-throw-handler _ _ _)
    849:4  3 (with-throw-handler _ _ _)
In unknown file:
           2 (string-concatenate-reverse (" (WordInstanceNode \"of@d7a23…" …) …)
In ice-9/boot-9.scm:
   759:25  1 (dispatch-exception 2 wrong-type-arg ("string-append" "Wrong…" …))
In unknown file:
           0 (apply-smob/1 #<catch-closure 2425880> wrong-type-arg "string-…" …)
ERROR: In procedure apply-smob/1:
ERROR: In procedure string-append: Wrong type (expecting string): (filename . #f)
ABORT: wrong-type-arg

But there are no files anywhere in this code...

[2017-06-05 23:06:14:154] [INFO] Aiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiieee it
was this: Backtrace:
In opencog/base/file-utils.scm:
    79:27  5 (exec-scm-from-port _)
In ice-9/boot-9.scm:
    849:4  4 (with-throw-handler _ _ _)
    849:4  3 (with-throw-handler _ _ _)
In unknown file:
           2 (string-concatenate-reverse ((#<tree-il (const "ANY")>)) "\n …" …)
In ice-9/boot-9.scm:
   759:25  1 (dispatch-exception 2 wrong-type-arg ("string-append" "Wrong…" …))
In unknown file:
           0 (apply-smob/1 #<catch-closure 276ce00> wrong-type-arg "string-…" …)

ERROR: In procedure apply-smob/1:
ERROR: In procedure string-append: Wrong type (expecting string):
(#<tree-il (const "ANY")>)
ABORT: wrong-type-arg


Oh no Mr Bill!! stack_size=512 fp-bot = 455 ip-subr_stub_code=14
engine=1 Tue Jun  6 02:39:21 2017

Oh no Mr Bill!! stack_size=512 fp-bot = 455 ip-subr_stub_code=14
engine=1 Tue Jun  6 02:39:21 2017

.... and then a crash:
the crash is related to a backtrace, again.


Thread 24232 "guile" received signal SIGSEGV, Segmentation fault.
[Switching to Thread 0x7ffee57fa700 (LWP 10775)]
0x00007ffff7b0d809 in scm_is_pair (x=0x0) at ../../libguile/pairs.h:159
159       return SCM_I_CONSP (x);
(gdb) bt
#0  0x00007ffff7b0d809 in scm_is_pair (x=0x0) at
../../libguile/pairs.h:159
#1  scm_ilength (sx=<optimized out>) at ../../libguile/list.c:190
#2  0x00007ffff7b0d859 in scm_list_p (x=<optimized out>)
    at ../../libguile/list.c:168
#3  0x00007ffff7b66381 in vm_debug_engine (thread=0x54569480,
vp=0x1644e990, 
    registers=0x0, resume=-536832) at ../../libguile/vm-engine.c:784
#4  0x00007ffff7b702fa in scm_call_n (proc=0x7fffeddbdd70, 
    argv=argv@entry=0x7ffee57f9070, nargs=nargs@entry=4)
    at ../../libguile/vm.c:1271
#5  0x00007ffff7af0694 in scm_call_4 (proc=<optimized out>, 
    arg1=arg1@entry=0x54c8fd90, arg2=arg2@entry=0x547a18c0, 
    arg3=arg3@entry=0x984520, arg4=arg4@entry=0x52)
    at ../../libguile/eval.c:508
#6  0x00007ffff7ae19f5 in display_backtrace_body (a=<optimized out>)
    at ../../libguile/backtrace.c:244
#7  0x00007ffff7b66381 in vm_debug_engine (thread=0x54569480,
vp=0x1644e990, 
    registers=0x0, resume=-536832) at ../../libguile/vm-engine.c:784
#8  0x00007ffff7b702fa in scm_call_n (proc=proc@entry=0x547a1700, 
    argv=argv@entry=0x0, nargs=nargs@entry=0) at ../../libguile/vm.c:1271
#9  0x00007ffff7af0599 in scm_call_0 (proc=proc@entry=0x547a1700)
    at ../../libguile/eval.c:481
#10 0x00007ffff7b5f149 in catch (tag=tag@entry=0x404, thunk=0x547a1700, 
---Type <return> to continue, or q <return> to quit---
    handler=0x547a16e0, pre_unwind_handler=0x4) at
../../libguile/throw.c:137
#11 0x00007ffff7b5f4b5 in scm_catch_with_pre_unwind_handler (
    key=key@entry=0x404, thunk=<optimized out>, handler=<optimized out>, 
    pre_unwind_handler=<optimized out>) at ../../libguile/throw.c:254
#12 0x00007ffff7b5f66f in scm_c_catch (tag=tag@entry=0x404, 
    body=body@entry=0x7ffff7ae18d0 <display_backtrace_body>, 
    body_data=body_data@entry=0x7ffee57f9450, 
    handler=handler@entry=0x7ffff7ae1cc0 <error_during_backtrace>, 
    handler_data=<optimized out>, 
    pre_unwind_handler=pre_unwind_handler@entry=0x0, 
    pre_unwind_handler_data=0x0) at ../../libguile/throw.c:377
#13 0x00007ffff7b5f67e in scm_internal_catch (tag=tag@entry=0x404, 
    body=body@entry=0x7ffff7ae18d0 <display_backtrace_body>, 
    body_data=body_data@entry=0x7ffee57f9450, 
    handler=handler@entry=0x7ffff7ae1cc0 <error_during_backtrace>, 
    handler_data=<optimized out>) at ../../libguile/throw.c:386
#14 0x00007ffff7ae18a5 in scm_display_backtrace_with_highlights (
    stack=<optimized out>, port=<optimized out>, first=<optimized out>, 
    depth=<optimized out>, highlights=<optimized out>)
    at ../../libguile/backtrace.c:282
#15 0x00007fffecb61684 in
opencog::SchemeEval::catch_handler(scm_unused_struct*,
scm_unused_struct*) (this=0x7fff98000980, tag=0x7a86e0,
throw_args=0x5148e850)
---Type <return> to continue, or q <return> to quit---
    at /home/ubuntu/src/atomspace/opencog/guile/SchemeEval.cc:422
#16 0x00007ffff7b66381 in vm_debug_engine (thread=0x54569480,
vp=0x1644e990, 
    registers=0x0, resume=-536832) at ../../libguile/vm-engine.c:784
#17 0x00007ffff7b702fa in scm_call_n (proc=proc@entry=0x54569500, 
    argv=<optimized out>, nargs=5) at ../../libguile/vm.c:1271
#18 0x00007ffff7af0a8b in scm_apply_0 (proc=proc@entry=0x54569500,
args=0x304)
    at ../../libguile/eval.c:594
#19 0x00007ffff7b5f1c7 in catch (tag=<optimized out>, thunk=0x54569520, 
    handler=0x54569500, pre_unwind_handler=0x545694e0)
    at ../../libguile/throw.c:134
#20 0x00007fffecb61d89 in
opencog::SchemeEval::do_eval(std::__cxx11::basic_string<char,
std::char_traits<char>, std::allocator<char> > const&) (
    this=0x7fff98000980, expr=...)
    at /home/ubuntu/src/atomspace/opencog/guile/SchemeEval.cc:576
#21 0x00007fffecb61e3a in opencog::SchemeEval::c_wrap_eval(void*) (
    p=0x7fff98000980)
    at /home/ubuntu/src/atomspace/opencog/guile/SchemeEval.cc:505
#22 0x00007ffff7aea75a in c_body (d=0x7ffee57f9ce0)
    at ../../libguile/continuations.c:422
#23 0x00007ffff7b66381 in vm_debug_engine (thread=0x54569480,
vp=0x1644e990, 
    registers=0x0, resume=-536832) at ../../libguile/vm-engine.c:784
#24 0x00007ffff7b702fa in scm_call_n (proc=proc@entry=0x545695c0, 
---Type <return> to continue, or q <return> to quit---
    argv=argv@entry=0x0, nargs=nargs@entry=0) at ../../libguile/vm.c:1271
#25 0x00007ffff7af0599 in scm_call_0 (proc=proc@entry=0x545695c0)
    at ../../libguile/eval.c:481
#26 0x00007ffff7b5f149 in catch (tag=tag@entry=0x404, thunk=0x545695c0, 
    handler=0x545695a0, pre_unwind_handler=0x54569580)
    at ../../libguile/throw.c:137
#27 0x00007ffff7b5f4b5 in scm_catch_with_pre_unwind_handler (
    key=key@entry=0x404, thunk=<optimized out>, handler=<optimized out>, 
    pre_unwind_handler=<optimized out>) at ../../libguile/throw.c:254
#28 0x00007ffff7b5f66f in scm_c_catch (tag=tag@entry=0x404, 
    body=body@entry=0x7ffff7aea750 <c_body>, 
    body_data=body_data@entry=0x7ffee57f9ce0, 
    handler=handler@entry=0x7ffff7aea9f0 <c_handler>, 
    handler_data=handler_data@entry=0x7ffee57f9ce0, 
    pre_unwind_handler=pre_unwind_handler@entry=0x7ffff7aea850
<pre_unwind_handler>, pre_unwind_handler_data=0x7ff020) at
../../libguile/throw.c:377
#29 0x00007ffff7aead60 in scm_i_with_continuation_barrier (
    body=body@entry=0x7ffff7aea750 <c_body>, 
    body_data=body_data@entry=0x7ffee57f9ce0, 
    handler=handler@entry=0x7ffff7aea9f0 <c_handler>, 
    handler_data=handler_data@entry=0x7ffee57f9ce0, 
    pre_unwind_handler=pre_unwind_handler@entry=0x7ffff7aea850
<pre_unwind_handl---Type <return> to continue, or q <return> to quit---
er>, pre_unwind_handler_data=0x7ff020) at
../../libguile/continuations.c:360
#30 0x00007ffff7aeae45 in scm_c_with_continuation_barrier (
    func=<optimized out>, data=<optimized out>)
    at ../../libguile/continuations.c:456
#31 0x00007ffff717e127 in GC_call_with_gc_active (
    fn=fn@entry=0x7ffff7b5d250 <with_guile_trampoline>, 
    client_data=client_data@entry=0x7ffee57f9dc0) at
../pthread_support.c:1343
#32 0x00007ffff7b5dc61 in with_guile (base=base@entry=0x7ffee57f9d90, 
    data=data@entry=0x7ffee57f9dc0) at ../../libguile/threads.c:688
#33 0x00007ffff7178132 in GC_call_with_stack_base (
    fn=fn@entry=0x7ffff7b5dbd0 <with_guile>,
arg=arg@entry=0x7ffee57f9dc0)
    at ../misc.c:1941
#34 0x00007ffff7b5e008 in scm_i_with_guile (dynamic_state=<optimized
out>, 
    data=<optimized out>, func=<optimized out>) at
../../libguile/threads.c:703
#35 scm_with_guile (func=<optimized out>, data=<optimized out>)
    at ../../libguile/threads.c:709
#36 0x00007fffecb61ebe in
opencog::SchemeEval::eval_expr(std::__cxx11::basic_string<char,
std::char_traits<char>, std::allocator<char> > const&) (
    this=0x7fff98000980, expr=...)
    at /home/ubuntu/src/atomspace/opencog/guile/SchemeEval.cc:477
#37 0x00007fffdef6def4 in opencog::GenericShell::eval_loop (
    this=0x7ffee8253d50)
---Type <return> to continue, or q <return> to quit---
    at
/home/ubuntu/src/opencog/opencog/cogserver/shell/GenericShell.cc:497
#38 0x00007fffeb71dc80 in ?? () from
/usr/lib/x86_64-linux-gnu/libstdc++.so.6
#39 0x00007ffff78916ba in start_thread (arg=0x7ffee57fa700)
    at pthread_create.c:333
#40 0x00007ffff75c782d in clone ()
    at ../sysdeps/unix/sysv/linux/x86_64/clone.S:109
(gdb) 


Oh no Mr Bill!! stack_size=512 fp-bot = 455 ip-subr_stub_code=14 engine=1 Tue Jun  6 10:16:44 2017

Oh no Mr Bill!! stack_size=512 fp-bot = 455 ip-subr_stub_code=14 engine=1 Tue Jun  6 10:16:44 2017

Oh no Mr Bill!! stack_size=512 fp-bot = 455 ip-subr_stub_code=14 engine=1 Tue Jun  6 18:27:01 2017

Oh no Mr Bill!! stack_size=512 fp-bot = 455 ip-subr_stub_code=14 engine=1 Tue Jun  6 18:27:01 2017


----
This time, no prints at all!! just hit abort:
scheme@(guile-user)> 
Thread 451 "guile" received signal SIGABRT, Aborted.
[Switching to Thread 0x7ffd25ffb700 (LWP 5037)]
(gdb) bt
#0  0x00007ffff74f6428 in __GI_raise (sig=sig@entry=6)
    at ../sysdeps/unix/sysv/linux/raise.c:54
#1  0x00007ffff74f802a in __GI_abort () at abort.c:89
#2  0x00007ffff7af22f4 in compute_assigned (exp=<optimized out>, 
    assigned=assigned@entry=0x24ba1c0) at ../../libguile/expand.c:1268
#3  0x00007ffff7af2309 in compute_assigned (exp=<optimized out>, 
    assigned=assigned@entry=0x24ba1c0) at ../../libguile/expand.c:1185
#4  0x00007ffff7af2388 in compute_assigned (exp=<optimized out>, 
    assigned=assigned@entry=0x24ba1c0) at ../../libguile/expand.c:1227
#5  0x00007ffff7af2309 in compute_assigned (exp=<optimized out>, 
    assigned=assigned@entry=0x24ba1c0) at ../../libguile/expand.c:1185
#6  0x00007ffff7af2309 in compute_assigned (exp=exp@entry=0xd0366c0, 
    assigned=assigned@entry=0x24ba1c0) at ../../libguile/expand.c:1185
#7  0x00007ffff7af3e1e in scm_convert_assignment (exp=0xd0366c0)
    at ../../libguile/expand.c:1570
#8  0x00007ffff7b12a45 in scm_memoize_expression (exp=<optimized out>)
    at ../../libguile/memoize.c:641
#9  0x00007ffff7b66381 in vm_debug_engine (thread=0xabe, vp=0xc65240, 
    registers=0x6, resume=-145791960) at ../../libguile/vm-engine.c:784
#10 0x00007ffff7b702fa in scm_call_n (proc=0x7fffe7c9d4a8, 
    argv=argv@entry=0x7ffd25ffa300, nargs=nargs@entry=3)
    at ../../libguile/vm.c:1271
#11 0x00007ffff7af063f in scm_call_3 (proc=<optimized out>, 
    arg1=<optimized out>, arg2=<optimized out>, arg3=<optimized out>)
    at ../../libguile/eval.c:501

well, that's unexpected....
(gdb) print exp
$1 = <optimized out>

wtf....

another crazy:

Thread 11590 "guile" received signal SIGSEGV, Segmentation fault.
[Switching to Thread 0x7fff437fe700 (LWP 1316)]
0x00007ffff7b2b067 in encode_escape_sequence (ch=-134642584, 
    buf=buf@entry=0x7fff437fcd70 "\\x00e3c0") at
../../libguile/ports.c:3053
3053              buf[i++] = hex[ch / 16];
(gdb) bt
#0  0x00007ffff7b2b067 in encode_escape_sequence (ch=-134642584, 
    buf=buf@entry=0x7fff437fcd70 "\\x00e3c0") at
../../libguile/ports.c:3053


ch is -134642584

(gdb) print/x ch
$9 = 0xf7f98468
So clearly ports.c fails to check for positive.


Oh no Mr Bill!! stack_size=512 fp-bot = 455 ip-subr_stub_code=14  engine=1
Tue Jun  6 20:27:36 2017

Oh no Mr Bill!! stack_size=512 fp-bot = 455 ip-subr_stub_code=14  engine=1
Wed Jun  7 02:06:40 2017

Oh no Mr Bill!! stack_size=512 fp-bot = 455 ip-subr_stub_code=14  engine=1
Wed Jun  7 02:06:40 2017

Oh no Mr Bill!! stack_size=512 fp-bot = 455 ip-subr_stub_code=14  engine=1
Wed Jun  7 06:04:23 2017

Oh no Mr Bill!! stack_size=512 fp-bot = 455 ip-subr_stub_code=14  engine=1
Wed Jun  7 06:04:23 2017

Thread 326311 "guile" received signal SIGSEGV, Segmentation fault.
[Switching to Thread 0x7ffe457fa700 (LWP 13958)]
iprin1 (exp=0x0, port=0x85864500, pstate=0x71165c50)
    at ../../libguile/print.c:611
611           switch (SCM_TYP7 (exp))

#0  iprin1 (exp=0x0, port=0x85864500, pstate=0x71165c50)
    at ../../libguile/print.c:611
#1  0x00007ffff7b32ad0 in scm_iprin1 (exp=<optimized out>, 
    port=<optimized out>, pstate=<optimized out>) at
../../libguile/print.c:544
#2  0x00007ffff7b60787 in scm_i_variable_print (exp=0x86b77de0, 
    port=0x85864500, pstate=0x71165c50) at ../../libguile/variable.c:41
#3  0x00007ffff7b32c9b in scm_prin1 (exp=exp@entry=0x86b77de0, 
    port=port@entry=0x85864500, writingp=writingp@entry=1)
    at ../../libguile/print.c:817
#4  0x00007ffff7b33b61 in scm_write (obj=0x86b77de0, port=0x85864500)
    at ../../libguile/print.c:1076
#5  0x00007ffff7b66381 in vm_debug_engine (thread=0x0, vp=0x19a7c60, 
    registers=0xfffffffffffa7a74, resume=16) at
../../libguile/vm-engine.c:784
#6  0x00007ffff7b702fa in scm_call_n (proc=0x7fffeddbdd70, 
    argv=argv@entry=0x7ffe457f9070, nargs=nargs@entry=4)
    at ../../libguile/vm.c:1271
#7  0x00007ffff7af0694 in scm_call_4 (proc=<optimized out>, 
    arg1=arg1@entry=0x8759cc40, arg2=arg2@entry=0x86101be0, 
    arg3=arg3@entry=0x983520, arg4=arg4@entry=0x52)
    at ../../libguile/eval.c:508
#8  0x00007ffff7ae19f5 in display_backtrace_body (a=<optimized out>)
    at ../../libguile/backtrace.c:244


----------------
anotehr:
Thread 213118 "guile" received signal SIGSEGV, Segmentation fault.
[Switching to Thread 0x7fff61ffb700 (LWP 11550)]
scm_ipruk (hdr=0x7ffff7b87ec8 "immediate", ptr=0xffffffff81480f9f, 
    port=0x7ed4f6a0) at ../../libguile/print.c:946
946           scm_uintprint (SCM_CELL_WORD_0 (ptr), 16, port);
(gdb) bt
#0  scm_ipruk (hdr=0x7ffff7b87ec8 "immediate", ptr=0xffffffff81480f9f, 
    port=0x7ed4f6a0) at ../../libguile/print.c:946
#1  0x00007ffff7b32b73 in print_vector_or_weak_vector (v=0x7feff9e0, 
    len=<optimized out>, ref=0x7ffff7b73ac0 <scm_c_weak_vector_ref>, 
    port=0x7ed4f6a0, pstate=0x847400) at ../../libguile/print.c:561
#2  0x00007ffff7b33245 in iprin1 (exp=0x7feff9e0, port=0x7ed4f6a0, 
    pstate=0x847400) at ../../libguile/print.c:743
#3  0x00007ffff7b32c9b in scm_prin1 (exp=exp@entry=0x7feff9e0, 
    port=port@entry=0x7ed4f6a0, writingp=writingp@entry=1)
    at ../../libguile/print.c:817
#4  0x00007ffff7b33b61 in scm_write (obj=0x7feff9e0, port=0x7ed4f6a0)
    at ../../libguile/print.c:1076
#5  0x00007ffff7b66381 in vm_debug_engine (thread=0x7e25ea80,
vp=0x160d2360, 
    registers=0x4d, resume=8) at ../../libguile/vm-engine.c:784
#6  0x00007ffff7b702fa in scm_call_n (proc=0x7fffeddbdd70, 
    argv=argv@entry=0x7fff61ffa070, nargs=nargs@entry=4)
    at ../../libguile/vm.c:1271
#7  0x00007ffff7af0694 in scm_call_4 (proc=<optimized out>, 
    arg1=arg1@entry=0x7eabfee0, arg2=arg2@entry=0x7eabefa0, 
    arg3=arg3@entry=0x983520, arg4=arg4@entry=0x52)
    at ../../libguile/eval.c:508
#8  0x00007ffff7ae19f5 in display_backtrace_body (a=<optimized out>)

-----------------
Another one:

Thread 230572 "guile" received signal SIGSEGV, Segmentation fault.
[Switching to Thread 0x7ffec77fe700 (LWP 3880)]
scm_reverse (lst=lst@entry=0x80003e30) at ../../libguile/list.c:346
#0  scm_reverse (lst=lst@entry=0x80003e30) at ../../libguile/list.c:346
#1  0x00007ffff7b4d1ea in scm_string_concatenate_reverse (ls=0x80003e30, 
    final_string=0x7fc19520, end=<optimized out>)
    at ../../libguile/srfi-13.c:2465
#2  0x00007ffff7b66381 in vm_debug_engine (
    thread=0x7ffff73cd260 <GC_allocate_ml>, vp=0x7c1fd3f0, 
    registers=0x7ffff73cd260 <GC_allocate_ml>, resume=1)
    at ../../libguile/vm-engine.c:784
#3  0x00007ffff7b702fa in scm_call_n (proc=0x7fffe7c9d4a8, 
    argv=argv@entry=0x7ffec77fd540, nargs=nargs@entry=3)
    at ../../libguile/vm.c:1271
#4  0x00007ffff7af063f in scm_call_3 (proc=<optimized out>, 
    arg1=<optimized out>, arg2=<optimized out>, arg3=<optimized out>)
    at ../../libguile/eval.c:501
#5  0x00007ffff7b66381 in vm_debug_engine (
    thread=0x7ffff73cd260 <GC_allocate_ml>, vp=0x7c1fd3f0, 
    registers=0x7ffff73cd260 <GC_allocate_ml>, resume=1)
    at ../../libguile/vm-engine.c:784
#6  0x00007ffff7b702fa in scm_call_n (proc=proc@entry=0x7cc865a0, 
    argv=argv@entry=0x0, nargs=nargs@entry=0) at ../../libguile/vm.c:1271
#7  0x00007ffff7af0599 in scm_call_0 (proc=proc@entry=0x7cc865a0)
    at ../../libguile/eval.c:481
#8  0x00007ffff7b5f149 in catch (tag=<optimized out>, thunk=0x7cc865a0, 
    handler=0x7cc86580, pre_unwind_handler=0x7cc86560)
    at ../../libguile/throw.c:137
#9  0x00007fffecb61d89 in opencog::SchemeEval::do_eval(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > const&) (
    this=0x7fff3c000980, expr=...)
    at /home/ubuntu/src/atomspace/opencog/guile/SchemeEval.cc:576

Well, that's different: for the first time ever, it is NOT in an
exception context!!!














GC_MALLOC_ATOMIC GC_malloc_atomic
scm_gc_malloc_pointerless
scm_gc_strndup
=======================
other guile bugs:
 (acos 1.0)  can return small imaginaey number
 (fold of reals can return small imaginary parts

=======================
total unique pairs
1) no way to get all pairs...
2) support not computed or stored.. DONE
3) stored support not fetchable FIXED with report-API
4) store left and right sizes DONE
cache-all-pair-freqs returs total 

* sep out bin-counting code into own file DONE
add-subtotal-mi-compute DONE

call-only-once in sing
fetch-all-words in sing
add-pair-freq-api in mst

(use-modules (opencog) (opencog persist) (opencog persist-sql))
(use-modules (opencog nlp) (opencog nlp learn))
(use-modules (opencog analysis))
(sql-open "postgres:///en_pairs_sim?user=linas")
(fetch-all-words)

(define ala (make-any-link-api))
(ala 'fetch-pairs)  << 1099 secs 1074 1028
(batch-short ala)
(batch-all-pair-mi ala)

Support: found num left=395274 num right=396260 in 426 secs << 395, ph:527
Done with wild-card count N(x,*) and N(*,y) in 1259 secs << ph:1300
Done computing N(*,*) total-count=418235277.0 in 51 secs << ph:46
Going to do individual pair frequencies
Done computing 8880914 pairs in 1074 secs  << 1007 ph:872
Start computing log P(*,y)
Done computing 396260 left-wilds in 61 secs << ph:51
Done storing 396260 left-wilds in 121 secs << ph:115
Done computing 395274 right-wilds in 55 secs << ph:51
Done with -log P(*,y), start -log P(x,*)
Done storing 395274 right-wilds in 121 secs << ph:127
Done computing -log P(x,*) and P(*,y)
Going to do individual pair MI
Too many heap sections: Increase MAXHINCR or MAX_HEAP_SECTS
Fuck.

alloc.c:        ABORT("Too many heap sections: Increase MAXHINCR or
MAX_HEAP_SECTS");
MAX_HEAP_SECTS
include/private/gc_priv.h:#   define MAXHINCR 4096

define HBLKSIZE 4096
include/private/gc_priv.h:#
 define MAX_HEAP_SECTS 8192  if -DLARGE_CONFIG
--enable-large-config
--enable-parallel-mark didn't do this.

Done computing 8880914 pair MI's in 3590 secs
Done storing 8880914 pairs in 4190 secs
Going to do column and row subtotals
Finished left entropy subtotals in 580 secs
Finished right entropy subtotals in 517 secs
Finished left MI subtotals in 353 secs
Finished right MI subtotals in 330 secs
Finished left support subtotals in 1021 secs << 772 after star fix
Finished right support subtotals in 961 secs << 745
Going to compute the left, right and total entropy
Finished left norm totals in 210 secs << 232
Finished right norm totals in 210 secs << 237
Done computing totals in 2360 secs
Start saving left-wildcards
Done storing 396260 left-wilds in 224 secs
Done storing 395274 right-wilds in 230 secs
Finished with MI computations


========================================================
support stats

|(*,y)| = number of non-zero entries for column y

sum_y |(*,y)| = right-support

sqrt [ sum_x N^2 (x,*) / num-rows ]

left-length(y) = sqrt(sum_x N^2(x,y)) = col-length
so sum over rights
divide by num-rights == num cols
so this is right-legnth

<xun> = sum_y N(*,y) / num-cols
      = N(*,*) / num-cols

<0w> = sum_y p(*,y) |(*,y)|

<xw> = s x p
    = sum_y p(*,y) N(*,y)

but p(*,y) = N(*,y) / N(*,*)

<x^2w> = s x^2 p 
       = sum_y p(*,y) N^2(*,y)

s (x- <xw>)^2  p =

<x^2w> - 2<xw> s x p + <xw>^2
= <x^2w> - <xw>^2

anyway, its not clear that's what we want, anyway.  Do we want count
variation? or length variation?  length variation is trite if we've got
totals. But count-variation requires....

2d 2 obj, each = 1, avg=1

<x^2w> = 1/2 + 1/2 = 1 ... 
so for lensq, needed to divide by support.
and for avg, need to divide by support too.


Argh. Sim has the old style. pair-entropy

(define fla (add-pair-freq-api ala))
(define rla (add-report-api ala))
(rla 'left-dim)
(rla 'right-dim)
(rla 'num_pairs)
(rla 'left-entropy)
(rla 'right-entropy)
(rla 'total-entropy)
(rla 'total-mi)

(define pca (make-pseudo-cset-api))
(pca 'fetch-pairs)
(batch-all-pair-mi pca)  
(define fca (add-pair-freq-api pca))
(define ac (get-all-cset-words))

5205

(fca 'pair-mi  xxxx)
So:
(EvaluationLink  ; 388
 (LinkGrammarRelationshipNode "ANY")
  (ListLink (AnyNode "left-word") (WordNode "one-point")))
has no "*-Entropy Key-* why?
because not computeed ... why?
Going to do MI column and row subtotals
should be 'cache-all-subtotals
Going to compute the left, right and total entropy

(define wca (add-pair-stars pca))
(define fca (add-pair-freq-api wca))
(define rb (wca 'right-basis))
(define dj (car rb))
(define lwd (pca 'left-wildcard dj))
 (fca 'left-wild-entropy dj)

      (define (left-sum FN)
         (fold
            (lambda (right-item sum)
               (+ sum (FN right-item)))
            0 rb))

      (define (right-sum FN)
         (fold
            (lambda (left-item sum)
               (+ sum (FN left-item)))
            0 (wca 'left-basis)))

argh. compute-left-entropy is wrong... FIXED
(define rca (add-report-api wca))
(rca 'set-entropy le re tent)
wild-wild-counta DONE
time for totlaa DONE

(define (an llobj) 
	(lambda (message . args)
		(case message ((name) "the big old name")
		(else (apply llobj (cons message args))))))


atom->getKeys()
    std::set<Handle> getKeys() const;

todo: print times  DONE
todo: create a report. DONE
todo: investigate exception DONE

todo: how many words, on average, go into a pair?
what about hubiness? in the graph con sense?
i.e avg incomiing avg outgoing (i.e. left, right support sizes)

avg left-support: non-zero / num-lefts(rows) 
left-size: tot count /num-lefts<F8>x

avg length
( err... left-length 'rigt-basis

===============================================================
(use-modules (opencog) (opencog persist) (opencog persist-sql))
(use-modules (opencog nlp) (opencog nlp learn))
(use-modules (opencog matrix))
(sql-open "postgres:///en_pairs_sim?user=linas")
(sql-open "postgres:///en_pairs_ttwo_mst?user=linas")
(sql-open "postgres:///en_pairs_ttwo_sim?user=linas")
(fetch-all-words)

(define pca (make-pseudo-cset-api))
(define psa (add-pair-stars pca))
(psa 'fetch-pairs)

(define fsa (add-subtotal-filter psa 2 2 4))
(define fsi (add-subtotal-filter psa 50 30 10))
(define pna (add-pair-count-api psa))
(define pfa (add-pair-freq-api psa))
(define pta (make-thresh-pca pfa))
(define aw (get-all-cset-words))
(define w (car aw))
(define cset (cog-incoming-by-type w 'LgWordCset))
(define dj (gdr (car cset)))

(define feig (pta 'left-initial))
(define lm (pta 'left-mult feig))
(lm dj)

(define lit (pta 'left-iterate feig))
(lit w)

(pta 'left-norm feig)
without caching:
scheme@(guile-user)> (pta 'left-norm feig)
left-norm took 0 seconds
$22 = 1.0000000000001292   OK still good.  This is sum over 37413 items
(define cfg (pta 'make-cache feig))
(pta 'left-norm cfg)
left-norm took 1 seconds  <<< OK makes sense


(pta 'left-norm (pta 'make-cache feig)) <<  461 seconds - 81 atoms/sec
ouch! this hashing sucks!  
OK, problem: all atoms hashing to same value.  OK fixed.

(define lm (pta 'left-mult feig))
(pta 'right-norm lm)
right-norm took 16 seconds  <<  
right-norm took 9 seconds  << baseline, no caching

(define clm (pta 'left-mult cfg))
(pta 'right-norm clm)
right-norm took 11 seconds << with caching. Mkaes sense, since the
                            cache is a lot slower than feig.
$23 = 1.8948456865590222e-4

-----
(define cclm (pta 'make-cache clm))
(pta 'right-norm cclm)
right-norm took 14 seconds  <<< first time  makes sense
(pta 'right-norm cclm)
right-norm took 1 seconds  << makes sense

------
(define lit (pta 'left-iterate feig))
(pta 'left-norm lit)
left-norm took 2699 seconds  << yow
$24 = 1.8266495662334775e-7

(define clit (pta 'right-mult cclm))
(pta 'left-norm clit)
left-norm took 18 seconds  << huh. weird. 
left-norm took 10 seconds
left-norm took 10 seconds
left-norm took 10 seconds

------
So this is excellent. Lets try it front to back.

(define alit (pta 'right-mult (pta 'make-cache (pta 'left-mult feig))))
(pta 'left-norm alit)
left-norm took 22 seconds << excellent
left-norm took 11 seconds
left-norm took 12 seconds

OK, we are golden I think


(define pta (make-thresh-pca pfa))
(define lit (pta 'left-iterate feig 1))
(define lit2 (pta 'left-iterate lit 1))
(pta 'left-print lit 20)

Wow. Like 4 iterations and its converged already!


(define fsa (add-subtotal-filter psa 2 2 4))
(fsa 'right-stars w)
(fsa 'left-basis-size)
(fsa 'right-basis-size)

(WordNode ",")
(define  dj (car (psa 'right-basis)))  ; crazy
(define pna (add-pair-count-api psa))  
(pna 'left-wild-count dj)    ; gives 4.0
(length (psa 'left-stars dj)) gives 1
so its entirely in just one: (WordNode ",") which has 4 obs.
so filter should cut this entirely, but it doesn't...

(define cm (Word ","))
(length (psa 'right-stars cm)) ; 281776

         (length (filter
            (lambda (PAIR)
                  (< 30 (pna 'left-wild-count (gdr PAIR)))) for each OK
            (psa 'right-stars cm)))  loop over all djs

-------------
OK, so the cut to use is the last one:

(define fsi (add-subtotal-filter psa 50 30 10))
(define pfi (add-pair-freq-api fsi))
(define pti (make-thresh-pca pfi))

(define feig (pti 'left-initial))
(pti 'left-norm feig)

(define lm (pti 'left-mult feig))

(length (pti 'right-basis))  ;  14377
(define dj (car (pti 'right-basis)))

(lm dj)  ; 8.730046003535126e-9

(define lit (pti 'left-iterate feig 1))
(define w (car (pti 'left-basis)))
(lit w)  ; 5.29078468146764e-4  left-norm took 133 seconds

(pti 'right-norm lm) ; 4.12871026183e-4  right-norm took 39 seconds

(pti 'left-print lit 20)
(define lit2 (pti 'left-iterate lit 1))
(pti 'left-print lit2 20)
(define lit3 (pti 'left-iterate lit2 1))
(pti 'left-print lit3 20)
(define lit4 (pti 'left-iterate lit3 1))
(pti 'left-print lit4 20)

Wow. Like 4 iterations and its converged already!

--------------------
OK, knockout time.  Kill the period.
(define fsj (add-knockout-filter fsi (list (Word ".")) '()))
(define pfj (add-pair-freq-api fsj))
(define ptj (make-thresh-pca pfj))
(define lit (ptj 'left-iterate feig 4))

Hmm. 
(length (pti 'right-stars (Word "."))) ;  2031

the 1403  106378.0
and  1225  96276.0
to 1276  96308.0
” 506  45809.0
,  1703  111982.0
a  958  73760.0
in 750  56751.0
of 890  64753.0
his 691  48728.0
it  606 44211.0
with 480 33681.0
him 425 30345.0
that 729 49714.0
for 479 33092.0

(define psi (add-support-compute pti))
(psi 'right-count (Word "."))  341112.0
--------------------

OK, cosine time.  Overload the pair-freq method.

Need a left and right unit. DONE.

(define pci (make-cosine-matrix pfi))
(define pti (make-thresh-pca pci 'left-unit))
(define lit (pti 'left-iterate feig 4))
(pti 'left-print lit 20)

OK, that didn't work out very much. Why?
(WordNode "." . 0.9342344830920888)
(WordNode "," . 0.24827492849839902)
(WordNode "the" . 0.14147241205706643)
(WordNode "to" . 0.11305294927260087)
(WordNode "and" . 0.10935602770196484)
(WordNode "a" . 0.06263713832111492)
((WordNode "of" . 0.05345591470333568)
((WordNode "was"  . 0.04159803271278564)


(cset-vec-cosine  (WordNode ".") (WordNode ",")) = 0.5411980781755208
(cset-vec-cosine  (WordNode "the") (WordNode ",")) = 0.6949870533623743
(cset-vec-cosine  (WordNode "the") (WordNode ".")) = 0.7239559271562869
(cset-vec-cosine  (WordNode "the") (WordNode "to")) = 0.7812122780640004
(cset-vec-cosine  (WordNode "the") (WordNode "a")) = 0.8863119467021999

(define ac (pti 'left-basis))
(define top-cset-words
   (filter (lambda (wrd) (< 200 (cset-vec-word-observations wrd))) ac))
(length top-cset-words)
4918
(sql-open "postgres:///en_pairs_ttwo_sim?user=linas")

(define poi (add-pair-cosine-compute pti))
(poi 'right-cosine WORD-A WORD-B)

(para-batch-sim-pairs top-cset-words 0.5)

--------------------------
Whoa, is this working as expected?  Lets check.
(define fsi (add-subtotal-filter psa 50 30 10))
(define pfi (add-pair-freq-api fsi))
well, that's a problem: pfi is returning bogus values
for this filtered thing.  Well, as long as no one uses them?
Crap.  Wait, what?
(define pci (make-cosine-matrix pfi))
(define pti (make-power-iter-pca pci 'right-unit))

(define wv (pti 'make-left-unit (list (WordNode "the"))))
(wv (WordNode "the"))  ; 1 OK
(define wm (pti 'left-iterate wv 1))
(wm (WordNode "the"))   ;; ---- wtf  Oh; renormalization does this.

(define psi (add-support-compute pti))
(psi 'right-support (Word "the"))  ; 1403
(psi 'right-length (Word "the")) ; 9761.855971074354 OK correct for
counts...

(define asi (add-support-compute pci 'right-unit))
(asi 'right-support (Word "the"))  ; 1403 OK

; OK, so here, asi should when asked for a pair, return
; the normalized vector component. So the length should be 1.0
(asi 'right-length (Word "the"))  wtf!? count si crazy too. OK FIXED
; OK, so frq is too low. where is it from?  its from pfi, which is giving
; us freq. so actually looks OK, and length is wrong, since its a count
; len, not a freq len.

(define cset (car (pci 'right-stars (Word "the"))))

(define acc (add-pair-cosine-compute pfi))
(acc 'right-cosine (Word "the") (Word "the"))
; 0.9807641990591952 because the partials are deficient.  FIXED
;  Can we fix this?  FIXED
-- it uses support, to get lengths, which uses freq to get freq, which
   is wrong but still ends up using add-support-api which is wrong.  FIXED
-- it uses star-obj to get stars. which should be filtered stars.

So: 
 (acc 'right-cosine (Word "the") (Word "a")) ; 0.8971244127293886 XXX

Should be 0.8964505696268208

(sqrt (acc 'right-product (Word "the") (Word "the"))) ;
9761.855971074354  OK so that agrees with support, now.

Hmm But its off. 
(acc 'right-cosine (Word "the") (Word "yes"))  ;0.48396212182787846 XXX
(acc 'right-cosine (Word "yes") (Word "the")) ; 0.38874316832684397  OK
(wm (WordNode "yes")) ; 0.38488729600833205
wm symm:              ; 0.38488729600833205  so symmetrical and little OFF!!

OK, wtf!
(define acn (add-pair-cosine-compute fsi))
(define acc (add-pair-cosine-compute pfi))

(psi 'right-length (Word "the")) ; 9761.855971074354 OK correct for
(psi 'right-length (Word "yes")) ; 187.6432785899884

(acn 'right-product (Word "the") (Word "yes"))  ; 886496.0 was wrong, FIXED.
(acn 'right-product (Word "yes") (Word "the")) ; 712079.0 this was OK.

(/ 886496.0 (* 9761.855971074354 187.6432785899884)) = 0.48396212182787846

ohh. The stars .. but then the cutter is not preventing seeing bad
counts because it does not overload the get-count.

overload ... item-pair and pair-count  Done, but this doesn' change pti

(define acc (add-pair-cosine-compute pfi))
(acc 'right-product (Word "the") (Word "yes")) ; 712079.0 wtf! actuall OK
(acc 'right-product (Word "yes") (Word "the")) ; 712079.0 also

(/ 712079.0 (* 9761.855971074354 187.6432785899884)) = 0.38874316832684397

Arghhh. wm is a little off from cosine!!  why?

(define acf (add-pair-cosine-compute pfi 'pair-freq))
(acf 'right-cosine (Word "yes") (Word "the")) ; 0.384887296008332
 --- which is wrong, cause it bypassed the cutoff

sooo ... pfi gives different results than the count API...
because maybe count not filtered correctly, still????

cosine creates fold, says "use pair-freq"
fold uses pair-freq and bypasses filtering!

solutions:
1) pair-freq should check w/ filter. All of freq-api should.
2) filter should provide pair-freq.
3) avoid cached freq, since its inaccurate in general.
4) freq-api should check for filter, and respond differently.  How?
5) api's refuse to work with filters; filter blocks API.

OK, I think that's running reliably now. DONE.

(apply LLOBJ (cons message args)
-----------------------------------------------------------------
(define grate
	(let ((lg 0.00001) (ls 0.00001) (tm (current-time)))
		(lambda() 
			(define now (current-time))
			(define fra (/ (- sent-cnt ls) (- gc-cnt lg) ))
			(define dt (- now tm))
			(format #t "delta-t=~A frac=~f gc-rate=~f\n"
				dt fra (/ dt (- gc-cnt lg)))
			(set! tm (- now 00001))
			(set! lg gc-cnt)
			(set! ls sent-cnt))))
-----------------------------------------------------------------
So again: stats.

Redo earlier work: but with fixed filtering.  line 9305 above

(define fsi (add-subtotal-filter psa 50 30 10))
(define pti (make-power-iter-pca fsi))

(define feig (pti 'make-left-unit (fsi 'left-basis)))
(length (fsi 'left-basis))  ; 13122
(feig (Word "the")) ; = 1/sqrt (13122)
(length (pti 'right-basis)) ; 

(define lit (pti 'left-iterate feig 1))
(define w (car (pti 'left-basis)))
(WordNode "cloud")
(lit w)  ;  7.963841319884063e-4
left-norm took 582 seconds

(define lit2 (pti 'left-iterate lit 1))
(pti 'left-print lit2 20)

(define lit4 (pti 'left-iterate lit3 1))
(pti 'left-print lit4 20)

OK, this needs a few more steps to converge, but gives same results as
before. Yayy!
------------------------------------------
OK, cosine time.  adapt from line 9364

(define pci (make-cosine-matrix fsi))
(define pti (make-power-iter-pca pci 'left-unit))
(define lit (pti 'left-iterate feig 4))
(define lit2 (pti 'left-iterate lit 4))

Substantially similar but not identical results:
the lit1 results are closer.
(pti 'left-print lit2 20)
((WordNode "." . 0.9762388252965614)
((WordNode "," . 0.14180449500019524)
((WordNode "the" . 0.08346874712036408)
((WordNode "to" . 0.07062641675278085)
((WordNode "and" . 0.07032844639726361)
((WordNode "a" . 0.04157464373827347)
((WordNode "of" . 0.03604121229169698)
((WordNode "”" . 0.029226311035184596)
((WordNode "in" . 0.028139776676391105)
((WordNode "that" . 0.026246992008664854)
((WordNode "was" . 0.02540012588054255)
((WordNode "his" . 0.024322426008004088)
((WordNode "he" . 0.023323167571591752)

cosines? 
(define poi (add-pair-cosine-compute pti))
(poi 'right-cosine WORD-A WORD-B)

(poi 'right-cosine  (Word ".") (Word ",")) ; 0.548721899627726
(poi 'right-cosine  (Word ".") (Word ".")) = 0.9999999999999999
(poi 'right-cosine  (Word ".") (Word "the")) = 0.7306741325101412
(poi 'right-cosine  (Word ".") (Word "to")) = 0.6453504435435683
(poi 'right-cosine  (Word ".") (Word "and")) = 0.6683619269954274
(poi 'right-cosine  (Word ".") (Word "a")) = 0.6271733855216901

(poi 'right-cosine  (Word ",") (Word "the")) = 0.7105031050865372
(poi 'right-cosine  (Word ",") (Word "to")) = 0.8240420194068381
(poi 'right-cosine  (Word ",") (Word "and")) = 0.8877149213148245
(poi 'right-cosine  (Word ",") (Word "a")) = 0.7645779363007278
(poi 'right-cosine  (Word "the") (Word "the")) = 0.9999999999999999
(poi 'right-cosine  (Word "the") (Word "to")) = 0.7904174107721877
(poi 'right-cosine  (Word "the") (Word "and")) = 0.7436842107977618
(poi 'right-cosine  (Word "the") (Word "a")) = 0.8964505696268208
(poi 'right-cosine  (Word "to") (Word "and")) = 0.9061808294998355
(poi 'right-cosine  (Word "to") (Word "a")) = 0.8567320046759815
(poi 'right-cosine  (Word "and") (Word "a")) = 0.7545793156905689


OK, substaintially similar to before, about 8% larger.
 So we double-checked our data, fixed the bugs, and its good. 
Now what?
-----------------------------------------------------------------
(define ac (pti 'left-basis))
(define top-cset-words
   (filter (lambda (wrd) (< 1500 (cset-vec-word-observations wrd))) ac))
(length top-cset-words)
(length top-cset-words) = 803

(define (mkcos wa wb) (cons (cons wa wb) (poi 'right-cosine wa wb)))

(define (coprs wrd wrds)
	(map (lambda (wb) (mkcos wrd wb)) wrds))

(define (allprs wrds lst)
	(if (null? wrds) lst
		(allprs (cdr wrds) (append (coprs (car wrds) (cdr wrds)) lst))))

(define asprs (allprs top-cset-words '()))
(length asprs) = 322003

(define also (sort asprs (lambda (a b) (> (cdr a) (cdr b)))))
(take also 200) ;; see below

(define lcprs
(filter
 (lambda (scp)
	(and (char-lower-case? (car (string->list (cog-name (caar scp)))))
       (char-lower-case? (car (string->list (cog-name (cdar scp)))))))
  also))

(length lcprs) = 239778




(use-modules (system repl server))
(spawn-server)
rlwrap telnet localhost 37146

The top 200 of the above:
(He, She) . 0.997345758
(Her, His) . 0.996268828
(nodded, sighed) . 0.99601656
(There, It) . 0.995809996
(He, It) . 0.995435813
(Dallas, Two-Bit) . 0.995062883
(Dallas, Jim) . 0.994875764
(But, When) . 0.994776669
(Two-Bit, Mai) . 0.994641695
(Aster, Mai) . 0.994363834
(He, There) . 0.994337552
(After, With) . 0.994303242
(Sandy, Bunny) . 0.994181214
(One, All) . 0.99409611
(Then, But) . 0.99408755
(She, It) . 0.994054139
(And, But) . 0.99404553
(Gene, Mai) . 0.99381092
(Then, When) . 0.993778539
(Jim, Mai) . 0.993727250
(For, With) . 0.993687969
(There, She) . 0.993678998
(It, They) . 0.993620758
(Two-Bit, Jim) . 0.993559994
(That, It) . 0.99348913
(His, All) . 0.993405770
(Ross, Jim) . 0.993276220
(Two-Bit, Gene) . 0.993190381
(It, This) . 0.993141274
(One, His) . 0.993081512
(He, His) . 0.993057520
(Now, Here) . 0.993019266
(For, But) . 0.992958261
(There, His) . 0.992797376
(At, With) . 0.992753993
(There, They) . 0.992725314
(Dallas, Mai) . 0.992627449
(But, That) . 0.992603728
(Richard, Anna) . 0.992601407
(There, This) . 0.992485293
(Gene, Jim) . 0.992427189
(For, After) . 0.992407193
(They, The) . 0.992382512
(She, His) . 0.991863215
(When, With) . 0.991836780
(Dallas, Gene) . 0.991791358
(smiled, sighed) . 0.991786864
(After, At) . 0.991678895
(For, At) . 0.991640239
(He, Her) . 0.991640030
(Now, But) . 0.99161025
(smiled, nodded) . 0.991579848
(After, When) . 0.991579720
(His, It) . 0.99155633
(That, This) . 0.991516495
(She, They) . 0.991503829
(laughed, asked) . 0.991476047
(One, There) . 0.991343749
(For, Then) . 0.991257404
(One, It) . 0.991256062
(His, The) . 0.991234256
(Now, So) . 0.991134393
(For, All) . 0.991128043
(There, All) . 0.99111722
(It, All) . 0.991093382
(Hiccup, Mai) . 0.991088746
(It, The) . 0.991087621
(For, When) . 0.991060842
(Then, After) . 0.99103343
(That, There) . 0.99100824
(He, They) . 0.990965962
(And, So) . 0.990895373
(But, All) . 0.990827920
(Jack, Demelza) . 0.990804758
(Her, She) . 0.990769217
(That, All) . 0.990720297
(Bunny, Anna) . 0.990713341
(Her, There) . 0.990708057
(He, This) . 0.990600114
(After, Even) . 0.990597163
(As, When) . 0.990560365
(Aster, Anna) . 0.990540130
(Margaret, Jim) . 0.990520388
(He, That) . 0.990497589
(Aster, Gene) . 0.99039301
(Sandy, Aster) . 0.990387947
(Then, With) . 0.990387390
(As, With) . 0.990361068
(Then, As) . 0.99034848
(She, This) . 0.990270109
(This, They) . 0.990171297
(Richard, John) . 0.990166796
(He, The) . 0.990001224
(There, The) . 0.989960300
(Aster, Hiccup) . 0.989888481
(His, They) . 0.989796499
(Then, That) . 0.989791187
(Her, The) . 0.989757803
(Ross, Margaret) . 0.98975517
(Bunny, Tooth) . 0.989753554
(Demelza, Anna) . 0.989723864
(But, With) . 0.989686041
(But, It) . 0.989666595
(That, His) . 0.989488364
(She, The) . 0.989417566
(He, But) . 0.989407999
(Richard, Ross) . 0.989276354
(He, Then) . 0.989261202
(At, Even) . 0.989197444
(Pitch, Demelza) . 0.989162716
(He, All) . 0.98912848
(For, That) . 0.989083210
(Margaret, Mai) . 0.988996494
(That, She) . 0.988974985
(Pitch, Ross) . 0.98891348
(Pitch, John) . 0.988908738
(All, This) . 0.988904006
(Sandy, Anna) . 0.988798684
(Ross, Mai) . 0.988786842
(Her, It) . 0.988778883
(Then, All) . 0.988676101
(Bunny, Hiccup) . 0.988607248
(Her, They) . 0.988558601
(And, That) . 0.988510273
(Sandy, Hiccup) . 0.988502544
(For, Here) . 0.988465756
(His, This) . 0.988433038
(That, When) . 0.988401578
(Then, At) . 0.988371519
(Then, It) . 0.988369524
(At, There) . 0.988350034
(So, But) . 0.988346421
(For, There) . 0.988324599
(Aster, Two-Bit) . 0.988296335
(Ross, Anna) . 0.988264218
(All, The) . 0.988254573
(This, The) . 0.988248820
(Ross, Demelza) . 0.988230903
(Richard, Demelza) . 0.988228650
(Anna, Mai) . 0.988222252
(One, Her) . 0.988219868
(He, One) . 0.98818965
(There, With) . 0.9881787
(Gene, Margaret) . 0.988139740
(But, After) . 0.988126
(But, This) . 0.988098723
(But, His) . 0.988057331
(Richard, Bunny) . 0.988050499
(Her, All) . 0.988048392
(Then, There) . 0.98801170
(Ross, John) . 0.988011020
(Bunny, Demelza) . 0.987989404
(And, Now) . 0.987989085
(One, The) . 0.987973231
(But, There) . 0.987836677
(One, That) . 0.987799175
(When, All) . 0.987739822
(Sandy, Demelza) . 0.987734391
(But, As) . 0.987733581
(nodded, Mai) . 0.987722642
(For, Now) . 0.987711666
(Richard, Margaret) . 0.987683845
(Richard, Sandy) . 0.987624417
(Then, And) . 0.987609330
(Then, His) . 0.987578038
(Richard, Pitch) . 0.987549191
(It, With) . 0.987521448
(Aster, Jim) . 0.987507205
(Even, With) . 0.987479957
(For, It) . 0.987479776
(Dallas, Ross) . 0.987453815
(laughed, sighed) . 0.987427226
(Aster, Bunny) . 0.987377192
(Richard, Francis) . 0.98734084
(But, Here) . 0.987333229
(All, With) . 0.98731580
(One, This) . 0.987267291
(For, This) . 0.987236319
(Aster, Ross) . 0.987205054
(John, Anna) . 0.987190883
(For, His) . 0.987144501
(That, They) . 0.987130294
(For, As) . 0.987098321
(Ross, Two-Bit) . 0.987032831
(And, When) . 0.987003352
(Then, She) . 0.986940328
(But, She) . 0.986857973
(Aster, Demelza) . 0.986831710
(Hiccup, Demelza) . 0.986821933
(When, It) . 0.986787674
(Yes, Oh) . 0.9867814
(Richard, Aster) . 0.986772251
(She, All) . 0.986771596
(Margaret, Anna) . 0.986743199
(For, And) . 0.986722258
(After, As) . 0.986701581
(Now, That) . 0.986653929
(Ross, Gene) . 0.98659473
(As, There) . 0.986564698
(Then, Now) . 0.986558599

----------

(nodded, sighed) . 0.99601656
(smiled, nodded) . 0.991579848
(laughed, asked) . 0.991476047
(laughed, sighed) . 0.987427226

The top 20 non-capitalized:

(((WordNode "nodded" . (WordNode "sighed" ) . 0.996016567043952)
(smiled, sighed) . 0.9917868640114925) 
(smiled, nodded) . 0.9915798481917005) 
(laughed, asked) . 0.9914760479256299) 
(laughed, sighed) . 0.9874272267287744) 
(smiled, laughed) . 0.9858859081908571) 
(nodded, laughed) . 0.9826039675475831) 
(she, he) . 0.981876892746973) 
(on, with) . 0.9816995328349034) 
(with, in) . 0.9792626952550025) 
(around, over) . 0.9770136201691976) 
(asked, sighed) . 0.9769922567018301) 
(into, from) . 0.9769095700320374) 
(off, down) . 0.9753902427048208) 
(on, from) . 0.9747012785336783) 
(on, in) . 0.9746021337920453) 
(smiled, asked) . 0.97447306776569) 
(into, through) . 0.972188886981962) 
(nodded, asked) . 0.9721627408838814) 
(on, for) . 0.9719692162741662))

The first non-preps, non-verbs

(would, could) . 0.9718788037224313) 
(an, a) . 0.9716791745530755) 
(night, day) . 0.9707165794699689) 
(evening, morning) . 0.9702929323741435)
(water, fire) . 0.9670737755352151) 
(black, white) . 0.9666152160018894) 
(head, hands) . 0.9665686866713692) 
(an, some) . 0.965654580040422) 
(throat, chest) . 0.9647259995951039) 
(floor, table) . 0.9643904394443693) 
(did, really) . 0.9643071841661717) 
(bed, window) . 0.9642793931193115) 
(upon, through) . 0.9640223642503675) 
(shoulders, chest) . 0.9636889297135423)
(child, question) . 0.9631387627819359)
(didn’t, didn't) . 0.9628278593174421)
(mind, life) . 0.9619200398737651)
(three, two) . 0.9618460862079484) 
(truth, evening) . 0.9614428353471973) 
(window, table) . 0.9613977436755163) 
(night, morning) . 0.9612113069050774) 
(quite, almost) . 0.9609898949120979) 

-----------------------------------------------------------------
Repeat the above, but for the overlap

(define (mk-ovl wa wb) (cons (cons wa wb) (poi 'right-overlap wa wb)))

(define (ovl-prs wrd wrds)
	(map (lambda (wb) (mk-ovl wrd wb)) wrds))

(define (all-ovl wrds lst)
	(if (null? wrds) lst
		(all-ovl (cdr wrds) (append (ovl-prs (car wrds) (cdr wrds)) lst))))

(define top-cset-words
   (filter (lambda (wrd) (< 1500 (cset-vec-word-observations wrd))) ac))
(define ultra-cset-words
   (filter (lambda (wrd) (< 3500 (cset-vec-word-observations wrd))) ac))

(length ultra-cset-words) = 383

(define ovprs (all-ovl top-cset-words '()))
(define ovuprs (all-ovl ultra-cset-words '()))
(length ovprs) ; = 322003
(length ovuprs) ; = 73153

(define ovso (sort ovprs (lambda (a b) (> (cdr a) (cdr b)))))
(define ovuso (sort ovuprs (lambda (a b) (> (cdr a) (cdr b)))))
(take ovso 200) ;; see below
(take ovuso 200) ;; see below

The below are  ovso -- the 1500 cutoff.
Some look great, some look like stinkers.
(act . foot) . 0.875
(laid . pushed) . 0.846153846
(Sandy . Bunny) . 0.842105263
(start . act) . 0.84
(soft . control) . 0.838709677
(thoughts . heavy) . 0.833333333
(Mary . Sandy) . 0.833333333
(teeth . throat) . 0.826086956
(Sandy . it's) . 0.823529411
(wide . shoulder) . 0.821428571
(shut . King) . 0.818181818
(entered . drew) . 0.809523809
(act . walk) . 0.807692307
(wide . foot) . 0.807692307
(teeth . shoulder) . 0.807692307
(town . darkness) . 0.807692307
(became . pretty) . 0.806451612
(soft . touch) . 0.806451612
(wide . blue) . 0.8
(wide . evening) . 0.8
(warm . step) . 0.8
(warm . letter) . 0.8
(ran . across) . 0.8
(Mary . wait) . 0.8
(Jack’s . Pitch’s) . 0.8
(soft . closed) . 0.794117647
(wide . further) . 0.793103448
(shut . town) . 0.791666666
(Sandy . Anna) . 0.789473684
(move . control) . 0.787878787
(deep . heavy) . 0.787878787
(except . heavy) . 0.785714285
(legs . itself) . 0.785714285
(he’s . you’re) . 0.78260869
(teeth . hot) . 0.78260869
(sister . shut) . 0.78260869
(strong . pretty) . 0.78125
(thoughts . control) . 0.78125
(glass . chest) . 0.777777777
(wide . act) . 0.777777777
(wide . slightly) . 0.777777777
(Aster . Anna) . 0.777777777
(kiss . chest) . 0.777777777
(conversation . view) . 0.777777777
(Mary . it's) . 0.777777777
(control . further) . 0.774193548
(thoughts . shoulder) . 0.774193548
(evening . shoulder) . 0.774193548
(soft . leaving) . 0.774193548
(book . window) . 0.774193548
(Prince . usual) . 0.772727272
(step . five) . 0.769230769
(wide . throat) . 0.769230769
(warm . act) . 0.769230769
(teeth . wide) . 0.769230769
(teeth . chest) . 0.769230769
(wide . control) . 0.766666666
(wide . low) . 0.766666666
(loved . touch) . 0.766666666
(expression . breath) . 0.764705882
(Aster . Hiccup) . 0.764705882
(Sandy . Aster) . 0.764705882
(pain . fear) . 0.763157894
(Bunny . Anna) . 0.761904761
(friend . family) . 0.761904761
(space . food) . 0.76
(warm . presence) . 0.76
(town . presence) . 0.76
(spirit . group) . 0.76
(sister . view) . 0.76
(everyone . straight) . 0.758620689
(four . five) . 0.758620689
(talking . completely) . 0.758620689
(wide . outside) . 0.758620689
(wide . heavy) . 0.758620689
(town . control) . 0.758620689
(heavy . red) . 0.757575757
(control . seeing) . 0.757575757
(blue . evening) . 0.757575757
(raised . pretty) . 0.757575757
(wife . heavy) . 0.757575757
(talking . wife) . 0.757575757
(soft . thoughts) . 0.757575757
(blue . high) . 0.756756756
(quiet . fear) . 0.756756756
(away . off) . 0.755555555
(true . tears) . 0.75
(top . corner) . 0.75
(strong . heavy) . 0.75
(thoughts . further) . 0.75
(usual . Tooth) . 0.75
(closed . near) . 0.75
(foot . corner) . 0.75
(blue . further) . 0.75
(George . Francis) . 0.75
(George . North) . 0.75
(act . cried) . 0.75
(act . lady) . 0.75
(show . turn) . 0.75
(wide . except) . 0.75
(wide . watch) . 0.75
(he’s . it's) . 0.75
(dropped . placed) . 0.75
(soft . further) . 0.75
(position . act) . 0.75
(position . glass) . 0.75
(town . usual) . 0.75
(wait . Sandy) . 0.75
(Tom . Aster) . 0.75
(deep . strong) . 0.75
(shut . foot) . 0.75
(shut . step) . 0.75
(late . thoughts) . 0.75
(spirit . wide) . 0.75
(sister . presence) . 0.75
(year . move) . 0.742857142
(heavy . low) . 0.741935483
(control . heavy) . 0.741935483
(leaving . control) . 0.741935483
(shoulder . control) . 0.741935483
(shoulder . low) . 0.741935483
(outside . low) . 0.741935483
(holding . bring) . 0.741935483
(wide . thoughts) . 0.741935483
(soft . wide) . 0.741935483
(quiet . except) . 0.741935483
(spirit . strong) . 0.741935483
(slightly . walk) . 0.740740740
(moving . throat) . 0.740740740
(shoulder . throat) . 0.740740740
(except . shoulders) . 0.740740740
(fight . walk) . 0.740740740
(George . giving) . 0.740740740
(outside . throat) . 0.740740740
(talking . presence) . 0.740740740
(sit . walk) . 0.740740740
(surprise . kiss) . 0.740740740
(start . surprise) . 0.740740740
(conversation . letter) . 0.740740740
(spirit . town) . 0.740740740
(spirit . slightly) . 0.740740740
(spirit . shoulders) . 0.740740740
(sister . talking) . 0.740740740
(sister . lady) . 0.740740740
(living . shut) . 0.740740740
(inside . past) . 0.74
(replied . cried) . 0.739130434
(alone . round) . 0.739130434
(shut . hot) . 0.739130434
(shut . easy) . 0.739130434
(shut . corner) . 0.739130434
(yourself . shut) . 0.739130434
(yourself . King) . 0.739130434
(ran . near) . 0.738095238
(several . cut) . 0.736842105
(Aster . Bunny) . 0.736842105
(during . control) . 0.735294117
(live . stay) . 0.735294117
(Jack’s . thoughts) . 0.735294117
(above . inside) . 0.734693877
(Francis . North) . 0.733333333
(shoulder . heavy) . 0.733333333
(thoughts . space) . 0.733333333
(force . glass) . 0.733333333
(outside . shoulder) . 0.733333333
(outside . moving) . 0.733333333
(talking . heavy) . 0.733333333
(laid . bring) . 0.733333333
(laid . touch) . 0.733333333
(wide . touch) . 0.733333333
(warm . tears) . 0.733333333
(town . thoughts) . 0.733333333
(quiet . step) . 0.733333333
(loved . makes) . 0.733333333
(living . wide) . 0.733333333
(high . fear) . 0.731707317
(pulled . met) . 0.731707317
(five . food) . 0.730769230
(figure . war) . 0.730769230
(black . white) . 0.730769230
(foot . shoulders) . 0.730769230
(act . step) . 0.730769230
(act . letter) . 0.730769230
(certainly . carried) . 0.730769230
(warm . foot) . 0.730769230
(start . foot) . 0.730769230
(start . step) . 0.730769230
(town . foot) . 0.730769230
(town . war) . 0.730769230
(shut . wide) . 0.730769230
(shut . straight) . 0.730769230
(spirit . teeth) . 0.730769230
(spirit . staff) . 0.730769230
(expression . eye) . 0.729729729
(thoughts . blood) . 0.729729729
(thoughts . arm) . 0.729729729
(evening . fear) . 0.729729729
(blue . fear) . 0.729729729
(wife . person) . 0.729729729
(wife . red) . 0.729729729729


====================================================================
How about the 3500 cutoff?
Meh.

(away . off) . 0.755555555
(black . white) . 0.730769230
(off . over) . 0.71856287
(whole . end) . 0.701754385
(herself . myself) . 0.701754385
(both . three) . 0.696629213
(quite . almost) . 0.695121951
(each . every) . 0.694736842
(night . place) . 0.693181818
(held . stood) . 0.692307692
(used . hard) . 0.692307692
(water . end) . 0.689655172
(off . through) . 0.687943262
(turned . went) . 0.686868686
(air . end) . 0.685185185
(side . behind) . 0.68493150
(called . end) . 0.684210526
(stood . started) . 0.683333333
(didn’t . didn't) . 0.682926829
(off . around) . 0.681159420
(mother . father) . 0.680851063
(away . through) . 0.676691729
(people . last) . 0.675675675
(these . both) . 0.673076923
(end . reason) . 0.672413793
(off . very) . 0.670886075
(away . around) . 0.669230769
(down . over) . 0.666666666
(whole . feeling) . 0.666666666
(woman . boy) . 0.666666666
(doing . point) . 0.666666666
(night . day) . 0.666666666
(into . over) . 0.665116279
(around . through) . 0.664122137
(away . things) . 0.663934426
(before . over) . 0.661691542
(face . around) . 0.661417322
(own . its) . 0.661290322
(end . along) . 0.661016949
(given . reason) . 0.661016949
(days . end) . 0.660714285
(held . started) . 0.660714285
(mother . course) . 0.66037735
(arms . half) . 0.66037735
(much . good) . 0.660130718
(mother . woman) . 0.66
(never . has) . 0.659574468
(come . go) . 0.659420289
(upon . through) . 0.659090909
(away . own) . 0.658914728
(off . too) . 0.658064516
(between . behind) . 0.657894736
(must . should) . 0.657657657
(side . along) . 0.656716417
(anything . nothing) . 0.656565656
(feeling . hard) . 0.65625
(held . began) . 0.65625
(days . years) . 0.655737704
(called . taken) . 0.655737704
(room . face) . 0.655462184
(hair . reason) . 0.655172413
(its . every) . 0.654867256
(against . behind) . 0.654761904
(house . place) . 0.65432098
(behind . towards) . 0.652173913
(stood . began) . 0.652173913
(than . over) . 0.652173913
(very . over) . 0.651933701
(old . young) . 0.65168539
(each . its) . 0.651376146
(these . people) . 0.651376146
(next . until) . 0.651162790
(upon . around) . 0.651162790
(rest . feeling) . 0.650793650
(both . well) . 0.650485436
(end . feeling) . 0.65
(behind . under) . 0.65
(whole . along) . 0.65
(course . end) . 0.65
(who . off) . 0.65
(great . place) . 0.65
(night . best) . 0.649350649
(point . smile) . 0.649122807
(whole . black) . 0.649122807
(whole . point) . 0.649122807
(whole . white) . 0.649122807
(others . white) . 0.649122807
(days . whole) . 0.649122807
(off . well) . 0.64885496
(around . against) . 0.648648648
(things . men) . 0.648148148
(things . nothing) . 0.648148148
(alone . whole) . 0.648148148
(half . point) . 0.648148148
(though . while) . 0.648148148
(off . down) . 0.647727272
(night . same) . 0.647727272
(away . well) . 0.647540983
(behind . along) . 0.647058823
(last . first) . 0.647058823
(went . stood) . 0.647058823
(must . might) . 0.647058823
(taken . words) . 0.647058823
(then . now) . 0.646511627
(side . door) . 0.646341463
(feeling . years) . 0.646153846
(course . years) . 0.646153846
(good . very) . 0.645569620
(along . towards) . 0.645161290
(taken . reason) . 0.645161290
(little . over) . 0.645
(must . may) . 0.644444444
(end . smile) . 0.644067796
(really . also) . 0.643678160
(both . men) . 0.643564356
(most . great) . 0.643478260
(most . men) . 0.643478260
(point . kept) . 0.642857142
(hair . black) . 0.642857142
(hair . white) . 0.642857142
(arms . close) . 0.642857142
(case . end) . 0.642857142
(get . make) . 0.642384105
(place . mind) . 0.642105263
(night . people) . 0.642105263
(until . why) . 0.641975308
(side . whole) . 0.641791044
(water . body) . 0.641791044
(large . half) . 0.641509433
(upon . off) . 0.640845070
(day . place) . 0.640776699
(used . along) . 0.640625
(got . felt) . 0.640350877
(never . can) . 0.64
(mother . point) . 0.64
(both . every) . 0.64
(always . also) . 0.639534883
(between . against) . 0.639534883
(off . being) . 0.639455782
(than . some) . 0.63934426
(held . moved) . 0.63934426
(away . upon) . 0.639097744
(another . every) . 0.638888888
(those . these) . 0.638888888
(other . over) . 0.638613861
(behind . door) . 0.638554216
(saw . heard) . 0.638554216
(away . over) . 0.638554216
(once . well) . 0.63809523
(something . even) . 0.638036809
(along . white) . 0.637931034
(called . kept) . 0.637931034
(case . course) . 0.637931034
(around . very) . 0.637583892
(small . young) . 0.6375
(would . could) . 0.637323943
(old . own) . 0.637168141
(off . two) . 0.636942675
(against . without) . 0.636363636
(black . point) . 0.636363636
(body . end) . 0.636363636
(hair . new) . 0.636363636
(days . point) . 0.636363636
(little . very) . 0.636363636
(room . around) . 0.636363636
(will . never) . 0.635802469
(off . never) . 0.635761589
(himself . off) . 0.635761589
(most . off) . 0.635714285
(people . life) . 0.635514018
(men . three) . 0.635416666
(each . both) . 0.635416666
(gave . behind) . 0.635135135
(used . wanted) . 0.635135135
(used . tried) . 0.634920634
(through . over) . 0.634730538
(two . first) . 0.634615384
(each . another) . 0.634615384
(alone . point) . 0.634615384
(large . father) . 0.634615384
(mouth . point) . 0.634615384
(both . almost) . 0.634408602
(once . ever) . 0.634408602
(taken . keep) . 0.633802816
(between . towards) . 0.633802816
(both . without) . 0.633663366
(away . most) . 0.633587786
(away . its) . 0.633587786
(against . under) . 0.633333333
(water . feet) . 0.633333333
(water . ground) . 0.633333333
(held . kept) . 0.633333333
(much . off) . 0.632911392
(other . little) . 0.632850241
(ever . well) . 0.632653061
(large . mother) . 0.632653061
(those . each) . 0.632653061
(upon . every) . 0.632478632
(whole . behind) . 0.632352941
(called . keep) . 0.632352941


----------------
How about scatter-plots?
We've got from before:
(define top-cset-words
   (filter (lambda (wrd) (< 1500 (cset-vec-word-observations wrd))) ac))
(define ovprs (all-ovl top-cset-words '()))
(length ovprs) ; = 322003

so: 
1) rank the top-cset-words
2) create a pixel array.


(define ranked-csw (sort top-cset-words
	(lambda (a b) (> (cset-vec-word-observations a) (cset-vec-word-observations b)))))

(take ranked-csw 20) OK, that worked.

But ovprs is not stored in atomspace ....
what's faster: looking it up, or on-the-fly recompute?


(define short-csw (take ranked-csw 20))


(write-flo "/tmp/scat-overlap.flo" (take ranked-csw 100)
   (lambda (wa wb) (poi 'right-overlap wa wb)))


(write-flo "/tmp/scat-cosine.flo" (take ranked-csw 100)
   (lambda (wa wb) (poi 'right-cosine wa wb)))

(define (get-cos wa wb)
	(define cos-fkey (PredicateNode "*-Cosine Filtered Key-*")) 
	(define (get-val PR)
		(cog-value-ref (cog-value PR cos-fkey) 0))
	(define (set-val PR VAL)
		(cog-set-value! PR cos-fkey (FloatValue VAL)))
	(define wpr (ListLink wa wb))
	(define got
		(catch #t
			(lambda () (get-val wpr))
			(lambda (key . args) #f)))
	(if got got
		(let ((val (poi 'right-cosine wa wb)))
			(set-val wpr val)
			val)))

(define (get-cos wa wb)
	(define cos-fkey (PredicateNode "*-Cosine Filtered Key-*"))
	(pair-sym-cache wa wb cos-fkey 
		(lambda (wx wy) (poi 'right-cosine wx wy))))


(define rankw (Word "the"))
(define cranked-csw (sort top-cset-words
	(lambda (a b) (> (get-cos rankw a) (get-cos rankw b)))))

(write-flo "/tmp/scat-pcos.flo" (take cranked-csw 20)
   (lambda (wa wb) (get-cos wa wb)))

; Create a sorted list of words, such that the next word in the list has
; the highest cosine of all to the previous word in the list.
(define (drank-helper wlist drl)
	(define rest (cdr wlist))
	(format #t "duude enter wlsi=~A\n   and drl=~A\n" (length wlist) drl)
	; If the list is one item long, we are done.
	(if (null? rest) (cons (car wlist) drl)
		; Otherwise, find the word with the highest cosine to the previous
		; word that was picked.  rankw is the previous one picked.
		; next-rankw will be th next one.
		(let ((rankw (car drl))
				(next-rankw '()))
			(fold
				(lambda (item biggest)
					(define cosi (get-cos rankw item))
					(if (and (> cosi biggest) (not (equal? item rankw)))
						(begin (set! next-rankw item) cosi) biggest))
				-1e20
				wlist)
			(drank-helper 
				(remove (lambda (w) (equal? w next-rankw)) wlist)
				(cons next-rankw drl)))))

(define (drank wlist)
	(drank-helper (cdr wlist) (cons (car wlist) '())))

(define dranked-csw (drank (take ranked-csw 40)))
(define eranked-csw (drank (take ranked-csw 100)))
(define franked-csw (drank (take ranked-csw 300)))

(write-flo "/tmp/scat-dcos.flo" dranked-csw
   (lambda (wa wb) (get-cos wa wb)))

(write-flo "/tmp/scat-fcos.flo" franked-csw (lambda (wa wb) (get-cos wa wb)))


(define (p4 wa wb)
	(define co (get-cos wa wb))
	(* co co co co))

(write-flo "/tmp/scat-ecos4.flo" eranked-csw (lambda (wa wb) (p4 wa wb)))


(write-flo "/tmp/scat-xxx.flo" (take ranked-csw 100)
   (lambda (wa wb) (get-cos wa wb)))

(define n 0)
(for-each (lambda (w) (format #t "~A ~A" n w) (set! n (+ n 1))) franked-csw)

287 (WordNode "up" (ctv 1 0 626139))
288 (WordNode "back" (ctv 1 0 412057))
289 (WordNode "her" (ctv 1 0 1601673))
290 (WordNode "it" (ctv 1 0 1888598))
291 (WordNode "she" (ctv 1 0 929359))
292 (WordNode "he" (ctv 1 0 2349317))
293 (WordNode "there" (ctv 1 0 413356))
294 (WordNode "they" (ctv 1 0 677009))
295 (WordNode "if" (ctv 1 0 428894))
296 (WordNode "when" (ctv 1 0 448962))
297 (WordNode "but" (ctv 1 0 927405))
298 (WordNode "and" (ctv 1 0 5909625))
299 (WordNode "," (ctv 1 0 12471397))


126 (WordNode "No" (ctv 1 0 102421))
127 (WordNode "A" (ctv 1 0 179271))
128 (WordNode "So" (ctv 1 0 100275))
129 (WordNode "If" (ctv 1 0 138542))
130 (WordNode "We" (ctv 1 0 118551))
131 (WordNode "In" (ctv 1 0 151798))
132 (WordNode "As" (ctv 1 0 106652))
133 (WordNode "That" (ctv 1 0 106222))
134 (WordNode "This" (ctv 1 0 136409))
135 (WordNode "They" (ctv 1 0 191230))
136 (WordNode "The" (ctv 1 0 988411))
137 (WordNode "His" (ctv 1 0 144276))
138 (WordNode "She" (ctv 1 0 414833))
139 (WordNode "He" (ctv 1 0 944556))
140 (WordNode "It" (ctv 1 0 443522))
141 (WordNode "There" (ctv 1 0 153165))
142 (WordNode "At" (ctv 1 0 74095))
143 (WordNode "For" (ctv 1 0 74285))
144 (WordNode "Then" (ctv 1 0 100133))
145 (WordNode "When" (ctv 1 0 108786))
146 (WordNode "But" (ctv 1 0 327961))
147 (WordNode "And" (ctv 1 0 289634))
148 (WordNode "You" (ctv 1 0 214860))
149 (WordNode "I" (ctv 1 0 2106188))
150 (WordNode "John" (ctv 1 0 75731))
151 (WordNode "Jim" (ctv 1 0 92333))
152 (WordNode "Ross" (ctv 1 0 202513))
153 (WordNode "Pitch" (ctv 1 0 157986))
154 (WordNode "Jack" (ctv 1 0 373882))

How aobout CMI ?

(make-afunc-cache AFUNC)

(define (make-wild-summer LST)
" Perform wild-card sum get-cos(ITEM, *) with * in LST "
	(define (summer item)
		(fold (lambda (it acc) (+ acc (get-cos it item))) 0 LST))
	(make-afunc-cache summer))

(define summer-100 (make-wild-summer (take ranked-csw 100)))

(define (wild-sum ITEM) (summer-100 ITEM))

(define (wild-wild LST)
	(fold (lambda (it acc) (+ acc (wild-sum it))) 0 LST))

(define wild-wild-100 (wild-wild (take ranked-csw 100)))

; compute the cosine-MI as defined in the diary, as CMI
(define (cos-mi wa wb)
	(define csim (* (get-cos wa wb) wild-wild-100))
	(define sla (wild-sum wa))
	(define slb (wild-sum wb))
	(- 0 (/ (log (/ csim (* sla slb))) (log 2.0)))
)

(get-cos (Word "any") (Word "little")) = 0.6364163540230326
(wild-sum (Word "any") (take ranked-csw 100))
(wild-sum (Word "little") (take ranked-csw 100))

(cos-mi (Word "any") (Word "little")) = 0.17795006068910382

(write-flo "/tmp/scat-cosmi.flo" (take ranked-csw 100) cos-mi)

(for-each
	(lambda (w) (format #t "Its ~A = ~A\n" w (cos-mi w (Word "he"))))
	(take ranked-csw 100))

(map (lambda (w) (cons w (cos-mi w (Word "he"))))
	(take ranked-csw 100))

(sort 
	(map (lambda (w) (cons w (cos-mi w (Word "he"))))
		(take ranked-csw 100))
	(lambda (a b) (> (cdr a) (cdr b))))

-----------------------------------------------------------------
---------
wtf. get-pair-count takes a LL pair, but wild-card return hi-level.
so how do wildcards works?

(define flim '(a b c))

(define (mkit ARG)
	(let ((arg ARG))
		(lambda () (format #t "duude its ~A and ~A\n" ARG arg))))

(define f (mkit flim))
(set! flim  '(d e f))

(set! (cdr flim) '(g h ))

=========================================================================
Multiple MST bugs:  OK all of these are fixed, I think. DONE
1) left-wall is not being inserted, so do not get those links.

(Word "###LEFT-WALL###")

Bug:
 (observe-mst "17 Book IV., § 23.")
tokenize-text 
strip-prefli "§"
string-ref: Value out of range: 0

(observe-mst "PLATE X.—_Bedroom, by De Vries “Cubiculum.”_ ]")
strip-sufli Value out of range: -1

 (observe-mst "*****")
pick-best-cost-pair  line 255
In procedure car: Wrong type argument in position 1 (expecting pair): ()
ABORT: wrong-type-arg

(mst-parse-text "***** fff")

=========================================================================
update typecodes set typename='ConnectorSeq' where typename='PseudoAnd';
update typecodes set typename='Section' where typename='PseudoWordCset';
update typecodes set typename='ConnectorDir' where typename='LgConnDirNode';
update typecodes set typename='Connector' where typename='PseudoConnector';

=========================================================================

 (batch-all-pair-mi psa)
Start computing the basis
Support: found num left=378412 num right=7179408 in 10185 secs
Done with wild-card count N(x,*) and N(*,y) in 27072 secs
fuuuu
opencog/matrix/compute-mi.scm:251:32:
opencog/matrix/compute-mi.scm:251:32: Throw to key `bad-summation' with
args `(count-all-pairs "Error: pair-counts unequal: 31507286.0
31506142.0\n")'.

Hmm. Try again.
 (use-modules (opencog) (opencog cogserver))
 (use-modules (opencog persist) (opencog persist-sql))
 (use-modules (opencog nlp) (opencog nlp learn))
 (use-modules (opencog matrix))
 (start-cogserver "opencog-mst-en.conf")
 (sql-open "postgres:///en_pairs_tthree_mst?user=ubuntu&password=asdf")
 (define pca (make-pseudo-cset-api))
 (define psa (add-pair-stars pca))
 (batch-pairs psa)

=========================================================================

now what.
oncurrent_stack<LLConnection*>::pop(LLConnection*&)

current conn_pool free=30 of 54
current conn_pool free=13 of 54
current conn_pool free=7 of 54
current conn_pool free=7 of 54
current conn_pool free=6 of 54   <<<< 22 seconds!!  set (24,8)

current conn_pool free=40 of 54
current conn_pool free=40 of 54
current conn_pool free=42 of 54
current conn_pool free=40 of 54
current conn_pool free=44 of 54   <<< 23 secs!! (set 8,8)

current conn_pool free=18 of 32
current conn_pool free=9 of 32
current conn_pool free=0 of 32
current conn_pool free=2 of 32
current conn_pool free=0 of 32
current conn_pool free=0 of 32  <<< 25 secs (24, 8)

fetch-pairs doesn't seem to multi-thread oh wait it does

omp 8 8  runs with ... 
222% on guile  or lesss
38%  x 8 on postgres   = 3.04
(free = 13 of 18 12 of 18, 10 of 18 ...)
total cpu: 66:08
Elapsed time to load ANY-link pairs: 1802 secs

12 12 runs with
240%  
28% x 12 = 3.36
total cpu: 73:05
Elapsed time to load ANY-link pairs: 1847 secs
(free = 14 of 18 10 of 18 8 of 18 .... 13 of 18

again: 72:23
load ANY-link pairs: 1819 secs

=========================================================================
system repl common)
repl-default-option-set! prompt "foo"

approx 12:30 PM
oww. clean start, approx 320K atom and 1.6M ob in 2 hours elapsed.
--> approx 800K obs/hour

Again: start exactly: 15:12 
15:32:  297K values -> 900K obs/hour.
16:15:  941K values 
16:42: 1320K values -> 1M obs/hour ... using the REPL shell

Or ... using the cogserver: start 21:43:47
at 17:04: 975K -> almost 3M obs/hour wow. Big diff...
at 18:20: 4M -> 2.5M/hour

43009543 values in 73425 secs = 586/sec = 2.10M/hour
... and its stable.
91M after 43 hours = 2.086M/hour
112780771 in 193627 = 582/sec = 2.10M/hour

-----
how about MST?
start 18:45 -- ouch 12K in 10 mins -- 72K/hour
                    17K in 15 mins -- 68K/hour

again: baseline 17500 at 19:08  and then it crashes. Ouch.

NonREPL:  fed by four threads
103K MST updates in 20 mins = 300K/hour
245K MST after 1 hour
1.91M MST after 11 hours = 170K/hour

Non-REPL: fed by one thread:
239K MST updates in 30 mins exactly: 480K/hour
1040259 in 14667 = 71/sec = 255K/hour
1385628 in 22727 = 61/sec = 220K/hour

529655 in 5247 = 101/sec = 364K/hour

=========================================================================
Error estimates

(define lpr (Evaluation
	(LinkGrammarRelationshipNode "ANY")
	(List (Word "big") (Word "deal"))))

count is 1039
(define apr (Evaluation
   (LinkGrammarRelationshipNode "ANY")
	(ListLink (AnyNode "left-word") (AnyNode "right-word"))))
6.3884586e+08 == 638845863.0

(/ 1039 638845863.0) = 1.626370397267486e-6
ln2 = 19.2299127083157

(define  freq-key (PredicateNode "*-FrequencyKey-*"))
(cog-value lpr freq-key)  log = 19.229913

estimate:
(1/log2 + ln2) = 19.2299127083157 - 1.4426950408889634 =
               = 17.787217667426738
sqrt(p) = 0.0012752922791530912 
sqrt (p) * (1+log) = 0.022683901358884775
sqrt (N) = 25275.400352912315
abs err = 8.97469517481691e-7

rel err = abs / p = 0.5518235692124971

so its 19 +/- 0.5 error... not bad...

 (use-modules (opencog))
 (use-modules (opencog persist) (opencog persist-sql))
 (use-modules (opencog nlp) (opencog nlp learn))
 (use-modules (opencog matrix))
 (sql-open "postgres:///en_pairs_mst?user=linas")
So
(define star-obj (add-pair-stars pair-obj))
(define cnt-obj (add-pair-count-api star-obj))
(define frq-obj (add-pair-freq-api star-obj))

(define wild-wild (cnt-obj 'wild-wild-count))
(define sqw (sqrt wild-wild))

(define (do-one-pair lipr)
	(define pr-freq (sqrt (frqobj 'pair-freq lipr)))
	(define pr-logli (- (frqobj 'pair-logli lipr) 1.4426950408889634))
	(* pr-freq pr-logli))

(define (do-one-pair lipr) (frqobj 'pair-freq lipr))

(define (right-loop left-item)
	(fold
		(lambda (lipr sum) (+ sum (do-one-pair lipr)))
		0
		(star-obj 'right-stars left-item)))
	
(define (get-tot-error)
	(define n 0)
	(fold
		(lambda (lefty sum)
			(format #t "sum=~A for ~A of ~A\n" sum n (star-obj 'left-basis-size)) 
			(set! n (+ n 1))
			; (+ sum (/ (right-loop lefty) sqw))
			(+ sum (right-loop lefty)))
		0
		(star-obj 'left-basis)))

This gave 0.17825659639240693 for rthree but its wrong

(define (wtf-do-one-pair lipr)
	(define pr-freq (sqrt (frqobj 'pair-freq lipr)))
	(define pr-logli (- (frqobj 'pair-logli lipr) 1.4426950408889634))
	(format #t "Its ~A and ~A \n" lipr pr-freq)
	(* pr-freq pr-logli))

(define (wtf-right-loop left-item)
	(fold
		(lambda (lipr sum) (+ sum (wtf-do-one-pair lipr)))
		0
		(star-obj 'right-stars left-item)))

WTF ... get a pr-freq of zero for 
 ((EvaluationLink (ctv 1 0 6)
   (LinkGrammarRelationshipNode "ANY")
   (ListLink
      (WordNode "substantively" (ctv 1 0 16))
      (WordNode "events" (ctv 1 0 35225))
   )
)
)

That can't be right so wtf??? 

(cog-value wtf freq-key) gives nothing! !???

(wtf-right-loop (WordNode "substantively" )) 

(ListLink (Word "substantively") (Word "events"))    ; count of 6
(ListLink (Word "substantively") (Word "important"))  ; count of  13
(ListLink (Word "substantively") (Any "right-word"))   count of 19

so marginal counts OK.
check them all..

(define (get-tot)
	(define n 0)
	(define lsz (star-obj 'left-basis-size))
	(fold
		(lambda (lefty sum)
			(if (eq? 0 (modulo n 1000))
				(format #t "sum=~A for ~A of ~A\n" sum n lsz))
			(set! n (+ n 1))
			; (+ sum (right-loop lefty))
			; (+ sum (cnt-obj 'right-wild-count lefty))
			(+ sum (frq-obj 'right-wild-freq lefty))
			; (+ sum (right-cnt lefty))
			; (+ sum (right-frq lefty))
		) 0 (star-obj 'left-basis)))

So the right-marginal sum works out.  638845863.0 

double check...
(define (right-cnt left-item)
	(fold
		(lambda (lipr sum) (+ sum (pair-obj 'pair-count lipr)))
		0 (star-obj 'right-stars left-item)))

(define (right-frq left-item)
	(fold
		(lambda (lipr sum) (+ sum (frq-obj 'pair-freq lipr)))
		0 (star-obj 'right-stars left-item)))

This eplicit check reports 638845863.0 so that's perfect.
All atoms got loaded. Just some of the values did not.
why?

The freq is short: 0.9777130000000336 i.e. short by 
14237957.7 = 14M out of 639M

Points at failed-to-store or failed-to-load?


(ListLink (Word "substantively") (Word "events"))    ; count of 6
(ListLink (Word "substantively") (Any "right-word"))   count of 19

(Word "substantively")  uuid= 32131120
(Word "events") uuid= 50491
(AnyNode "right-word") = uuid 33712509
select * from atoms where outgoing = '{32131120, 50491}' -> 32131316 = List
LinkGrammarRelationshipNode "ANY" is 7

(Evalu = uuid  32131317
 -->                      
en_pairs_rthree_mall=> select * from valuations where atom=32131317;
   key    |   atom   | type |   floatvalue    | stringvalue | linkvalue 
----------+----------+------+-----------------+-------------+-----------
        1 | 32131317 |    7 | {1,0,6}         |             | 
 33712529 | 32131317 |    1 | {0,26.66593,0}  |    FrequencyKey
 35436504 | 32131317 |    1 | {-0,-12.283042} |    MI key
(3 rows)

(* 638845863.0  (expt 2 -26.66593)) so taht's correct.
So correct values are in the DB, but they were not loaded into
atomspace.

And all MST parsing results are bad.... Shit

either....values not loaded, or values not set

batch-word-pair.scm: fetch-incoming-set any-pair-pred
../../guile/PersistSCM.cc: &PersistSCM::fetch_incoming_set
as->fetch_incoming_set
 _backing_store->getIncomingSet(_atom_table
SQLBackingStore.cc
AtomStorage::getInc

SQLAtomStorage::getIncomingSet buff
hi = table.add(hi, false);
get_atom_values(hi); at line 1523 hi is in the atom table.
  .. is tlbuf addAtom squonky?
esponse::get_all_values_cb lines 304


is it a uuid cockup?
Add prints to get_atom_values.
is it ? print in atom->setValue

So: en_pairs_mst on fanny:
 * counts sum, 
 * no missing values on load.
 * right-wild-freqs fail to sum.
   -- 0.962623000000125 reproducible
 * right-freqs are missing 40%!!!  ... 0.6004660000000038
 * (WordNode "the") has no count on it !!! wtf???
   its missing in the DB too...so that's bad.

(car (star-obj 'left-basis) (WordNode "sumatraus")
right-stars:
 to  18
original 2
describe  8
the 4
 'right-wild-count = 32 OK
 'right-wild-freq = 0.0
(frq-obj 'pair-freq (list-ref (star-obj 'right-stars (WordNode "sumatraus")) 3))

sumatraus = 2371938357
original = 645821
List= 2371941696
ANY = 152
Eval link = 2371941697
select * from valuations where atom=2371941697; 
select * from atoms where name='*-FrequencyKey-*'; = 2440463582

again, SQL is in order.
whoa ... 
(cog-value  (star-obj 'item-pair  (list-ref (star-obj 'right-stars
(WordNode "sumatraus")) 1)) (Predicate "*-FrequencyKey-*"))
is perfect!

(frq-obj 'pair-freq (list-ref (star-obj 'right-stars (WordNode "sumatraus")) 1))
is  wrong/absent...

(pair-obj 'item-pair  (list-ref (star-obj 'right-stars (WordNode "sumatraus")) 1))
is correct.

Ohhh....

(cog-set-value! (Word "the") (Predicate "foobar") (FloatValue 1.0e-12))

Fuuuuuu

Fixed with this: 
https://github.com/opencog/atomspace/pull/1295
-------------------------------------
en_pairs_rthree_mall restart

delete disjuncts.

delete from atoms where type = 233 ConnectorSeq

  231 | Connector
  232 | ConnectorDir
  233 | ConnectorSeq
  234 | Section


MSTConnector
PseudoConnector 
MSTLinkNode  174 175 176


CREATE TEMP TABLE lws AS SELECT uuid FROM atoms WHERE type=234;
select count(*) from valuations, lws where valuations.atom=lws.uuid;

delete from valuations using lws where atom =lws.uuid;
delete from atoms where type=234;

=========================================================================

postgres:///en_pairs_ttwo_sim?user=linas

Has a pile of cosines that should be stored ...

has 802x802 cosines. Which were hard to come by.
(its ranked-csw) (length ranked-csw)

Its just ListLink of the pairs. So to store it:

(sql-open "postgres:///en_pairs_ttwo_sim?user=linas")
(for-each
	(lambda (wordl)
		(for-each
			(lambda (wordr) (store-atom (ListLink wordl wordr)))
			ranked-csw))
	ranked-csw)

dammit. Kaboom. Start from scratch.


(define foo (add-support-compute poi))
(foo 'right-length (WordNode "###LEFT-WALL###"))
72 can go now  108 is next
108 can go 162 is next
162 done 243 is next

(define left-marg (make-left-summer (take ranked-csw 108) get-cos))

(define cos-wild-wild
	(fold (lambda (it acc) (+ acc (left-marg it))) 0 (take ranked-csw 108)))


(define get-cmi (make-get-cmi (take ranked-csw 108)))

(define (mk-cmi-prs wa LST)
	(map (lambda (wb) (get-cmi wa wb)) LST)

(define (mk-all-cmi-prs LST)
	(map (lambda (wa) (mk-cmi-prs wa LST) LST)))

(define (make-all-cmi WLST RSLT)
   (define wlen (length WLST))
   (if (< 0 wlen)
      (let* ((head (car WLST))
            (rest (cdr WLST))
         	(prs (map (lambda (w) (get-cmi head w)) WLST))
			)
         (format #t "Pairs remaining: ~A\n" wlen)
         (make-all-cmi rest (concatenate prs RSLT)))
		RSLT))

(define all-cmi (make-sym-pairs (take ranked-csw 108) get-cmi))
(define all-cmi (make-sym-pairs (take ranked-csw 162) get-cmi))

(define ranked-cmi (sort all-cmi (lambda (a b) (> (cdr a) (cdr b)))))

. But 7.366558296223725  0.001619248635083709
. She 5.439150360752608  0.006026945058317777
. And 5.325353892901934  0.007068524421558074
. He 5.1641299882215455  0.007253773644001228

(define all-cmi (make-sym-pairs (take ranked-csw 162) 
	(lambda (wa wb) (* (get-cos wa wb) (get-cmi wa wb)))))

(define ranked-cmi (sort all-cmi (lambda (a b) (> (cdr a) (cdr b)))))

product:
(WordNode ";")  (WordNode "said")) . 0.296607939087752) 
(WordNode "said")  (WordNode "upon")) . 0.29633824003351183) 
(WordNode "from")  (WordNode "Jack")) . 0.2937570566264612) 
(WordNode ";")  (WordNode "Jack")) . 0.2936624229096209) 
(WordNode "with")  (WordNode "said")) . 0.2923745344239661) 
(WordNode "I")  (WordNode ";")) . 0.2919811998332135) 
(WordNode "on")  (WordNode "said")) . 0.29101313047631) 
(WordNode "from")  (WordNode "said")) . 0.29024498064059373) 
(WordNode "on")  (WordNode "Jack")) . 0.28978802747511617) 
(WordNode "I")  (WordNode "from")) . 0.2890086903794695))

(get-cos (WordNode ";")  (WordNode "said")) $92 = 0.2723589177762356
(get-cos (WordNode "said")  (WordNode "upon")) $95 = 0.332603453209047

(get-cos (WordNode "from")  (WordNode "Jack")) 0.3158230495038972
(get-cos (WordNode ";")  (WordNode "Jack"))  0.25023554371175
(get-cos (WordNode "with")  (WordNode "said"))  0.3469959252702303
(get-cos (WordNode "I")  (WordNode ";"))  0.2607676762450459
(get-cos (WordNode "on")  (WordNode "said"))  0.3738730234710499
(get-cos (WordNode "from")  (WordNode "said")) 
(get-cos (WordNode "on")  (WordNode "Jack")) 
(get-cos (WordNode "I")  (WordNode "from")) 

(get-cmi (WordNode ";")  (WordNode "said"))  1.0890333296574446
(get-cmi (WordNode "said")  (WordNode "upon")) 0.8909656143806125
(get-cmi (WordNode "from")  (WordNode "Jack")) 0.930131784516368
(get-cmi (WordNode ";")  (WordNode "Jack"))  1.1735440079923058
(get-cmi (WordNode "with")  (WordNode "said"))  0.8425878032898321
(get-cmi (WordNode "I")  (WordNode ";"))  
(get-cmi (WordNode "on")  (WordNode "said")) 



=========================================================================
	
GC inf loop. ... 6121046016  observe-mst
=========================================================================
zh


 (use-modules (opencog))
 (use-modules (opencog persist) (opencog persist-sql))
 (use-modules (opencog nlp) (opencog nlp learn))
 (use-modules (opencog matrix))
 (sql-open "postgres:///zh_pairs?user=ubuntu&password=asdf")

(use-modules (opencog cogserver))
(start-cogserver)

(define ala (make-any-link-api))
(define als (add-pair-stars ala))
(batch-pairs als)

(print-matrix-summary-report als)

Rows: 158038 Columns: 158991
Size: 5922477 non-zero entries of 25126619658 possible
Fraction non-zero: 2.3571E-4 Sparsity (-log_2): 12.051
Total observations: 728947854.0  Avg obs per pair: 123.08
Entropy Total: 18.452   Left: 10.265   Right: 10.207
Total MI: -2.020  < wrong sign

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  6819.        6411.    
Count   (l_1)  3.7360E+6    3.1244E+6     547.9        487.4    
Length  (l_2)  2.8408E+5    2.4156E+5     41.66        37.68    
RMS Count      2.8231E+5    2.3990E+5     41.40        37.42    

mv submitted to gamma-pages wc | 135242

guile -l mst-count-zh.scm

als are teh stars

Too many heap sections: Increase MAXHINCR or MAX_HEAP_SECTS
LARGE_CONFIG



=========================================================================

Aieee
Expect our sailing in a few hours.
At six this morning, came on a tremendous gale of wind.
The wind altered sufficiently to allow us to escape from the Downs.
She turned to walk to the gate where her carriage was waiting.
The Sabbath day at Burnhead was a long, long day. 
He wore a new white sailor suit with pockets.

Maie threw back her veil and smiled

It is the same old tale, I suppose?
The girl gave a little laugh.

#LEFT  The      -3.54169132577798    << bad
#LEFT  girl     0.0477763132765396
#LEFT  gave     -0.709298163143728   << bad
#LEFT  a        1.20476206351401     << maybe ok
#LEFT  little   0.748512923494237
#LEFT  laugh    0.344735358535928

The  girl       -3.70796523865541
The  gave       -0.100239485796575
The  a          3.79004006078384       <<< bad
The  little     -1.63241818246397
The  laugh      0.713357934442026

the  girl       -2.05346491148124
the  gave       1.27996427879419
the  a          2.78647534800109
the  little     -0.751899481316491
the  laugh      1.38444380659843


girl  gave      -1.39996148448708
girl  a         0.208481595111202
girl  little    1.289110990041
girl  laugh     -0.183992976805794

gave  a         -2.96100943228456
gave  little    -1.67864014666756
gave  laugh     -3.18817482182013

a  little       -3.7409985984943
a  laugh        -2.98654866737527

little  laugh   -3.25530927504408

WTF. Is there a sign reversal????

little laugh N = 496.0         p = 7.764001126512734e-7 OK logli = 20.29669633683304 OK
 *     laugh N = 50356.0   OK  p = 7.88233953077974e-5  OK logli = 13.631016579715935  OK
little   *   N = 658993.0  OK  p = 0.00103153677305726  OK logli = 9.92098903216119  OK
 *       *   N = 638845863.0  OK

MI = 20.29 - 13.63 - 9.92 = -3.25



(define (foo-parse-text plain-text)
   (define word-strs (tokenize-text plain-text))
   (define word-list (map (lambda (str) (WordNode str)) word-strs))
   (define pair-obj (make-any-link-api))
   (define mi-source (add-pair-freq-api pair-obj))
   (define scorer (make-score-fn mi-source 'pair-fmi))
	(define nsco (lambda (left-atom right-atom distance)
			(define sco (scorer left-atom right-atom distance))
			(if (< sco -1000) sco (- sco))))

   ; Process the list of words.
   (mst-parse-atom-seq word-list nsco)
)


Action plan:
* add minus sign to the MI code. in the matrix directory. DONE.
* provide a conversion script for the databases NEVER
* delete the mst databases.  DONE
  en_pairs_rthree_mst   18 GB 
  en_pairs_rthree_mall  29 GB 
  en_pairs_rtwo_mst     22 GB
  en_pairs_tthree_mst   41 GB

  en_pairs_mst           7 GB
  en_pairs_sim           9 GB
  en_pairs_ttwo_mst     15 GB
  en_pairs_ttwo_sim     17 GB
  en_pairs_ultrasim     23 GB
  
* uppdate status of all collections DONE
  e.g. en_pairs_ttwo_sim on fanny is junk.
* restart MST.
* Redo the report on disjuncts!

=========================================================================
The current Mandarin dataset has enough English in it to parse even
simple English, not well, but not terribly badly, either.  Basically,
the wikipedia articles contain scattered English, and this is treated
just like everything else.

The cost is the MI of that pair.   The integers are the word-ordinals.

(print-mst  "this is a test")
2 . this   <-->  3 . is  cost= 12.596325047561628
3 . is   <-->  4 . a  cost= 10.684454066752686
1 . ###LEFT-WALL###   <-->  3 . is  cost= 0.5236859955283215
1 . ###LEFT-WALL###   <-->  5 . test  cost= -0.8277888080021967

(print-mst  "it is surprising that this works")
5 . that   <-->  7 . works  cost= 12.824735708193995
5 . that   <-->  6 . this  cost= 11.23043475606367
3 . is   <-->  5 . that  cost= 8.50983391898189
2 . it   <-->  3 . is  cost= 12.720811706832116
1 . ###LEFT-WALL###   <-->  7 . works  cost= 0.7545942265555112


Some random sentences:

也 常 在 工 業 上 與 實 驗 室 中 ， 用 於 有 機 合 成 中 的 強 鹼 （ 超 強 鹼 ）  。

長 時 間 都 跟 男 人 接 觸 ， 不 擅 長 對 待 女 孩 子 。

把 蕾 當 作 戀 人 看 待 ， 記 憶 力 比 一 般 人 優 異 。

道 德 学 社 创 始 人 。

然 而 ， 此 混 战 亦 可 坚 持 三 十 六 日 。


These are segmented so that its two hanzi per pair. There is NO word
segmentation!! I am hoping that word segmentation will happen
"automatically".  See below.

I do not yet have software to draw the graphs.  You will have to do this
by hand, for now.

The parses:

(print-mst  "也 常 在 工 業 上 與 實 驗 室 中 ， 用 於 有  機 合 成 中 的 強 鹼 （ 超 強 鹼 ）  。")
9 . 實   <-->  10 . 驗  cost= 8.67839880455297
10 . 驗   <-->  11 . 室  cost= 7.808708535957656
5 . 工   <-->  11 . 室  cost= 3.628109329166861
5 . 工   <-->  6 . 業  cost= 5.267964316861255
8 . 與   <-->  9 . 實  cost= 1.5154639602692228
11 . 室   <-->  18 . 合  cost= 1.3112275389754586
18 . 合   <-->  19 . 成  cost= 2.8487390406796376
2 . 也   <-->  19 . 成  cost= 1.3284690162639947
2 . 也   <-->  3 . 常  cost= 2.670074279865112
2 . 也   <-->  4 . 在  cost= 1.5999478270616105
19 . 成   <-->  27 . 鹼  cost= 1.0648751602654372
23 . 鹼   <-->  27 . 鹼  cost= 7.397179300260998
22 . 強   <-->  23 . 鹼  cost= 6.6278644991783935
26 . 強   <-->  27 . 鹼  cost= 6.6278644991783935
25 . 超   <-->  26 . 強  cost= 4.233373422153647
21 . 的   <-->  23 . 鹼  cost= 2.189776253921316
23 . 鹼   <-->  24 . （  cost= 2.0228678213402027
20 . 中   <-->  21 . 的  cost= 0.7882106238577222
11 . 室   <-->  13 . ，  cost= 0.7204578405457767
13 . ，   <-->  15 . 於  cost= 1.3787498338128241
14 . 用   <-->  15 . 於  cost= 2.3097280192674408
13 . ，   <-->  16 . 有  cost= 0.8940307468617856
16 . 有   <-->  17 . 機  cost= 1.5798315464927484
12 . 中   <-->  13 . ，  cost= 0.702836797299172
19 . 成   <-->  29 . 。  cost= 0.5752920624938298
28 . ）   <-->  29 . 。  cost= 1.1524305408117694
6 . 業   <-->  7 . 上  cost= -0.02469597819435876
1 . ###LEFT-WALL###   <-->  2 . 也  cost= -0.5802694975440783


scheme@(guile-user)> (print-mst  "長 時 間 都 跟 男 人 接 觸 ， 不 擅 長 對 待  女
孩 子 。")
9 . 接   <-->  10 . 觸  cost= 8.386123586043663
9 . 接   <-->  16 . 待  cost= 5.500641386527644
15 . 對   <-->  16 . 待  cost= 4.527961561831734
4 . 間   <-->  9 . 接  cost= 3.011954338244294
3 . 時   <-->  4 . 間  cost= 5.53719025855275
2 . 長   <-->  4 . 間  cost= 1.4431523444018381
2 . 長   <-->  19 . 子  cost= 1.6192113159084691
18 . 孩   <-->  19 . 子  cost= 6.867211688834326
17 . 女   <-->  18 . 孩  cost= 7.309507215753307
13 . 擅   <-->  16 . 待  cost= 1.4396781889010661
13 . 擅   <-->  14 . 長  cost= 7.846183142809686
12 . 不   <-->  13 . 擅  cost= 4.148490791614584
11 . ，   <-->  13 . 擅  cost= 2.360114646965709
4 . 間   <-->  5 . 都  cost= 0.9693867850594948
5 . 都   <-->  6 . 跟  cost= 2.3990108227984237
6 . 跟   <-->  7 . 男  cost= 1.3528584177181244
7 . 男   <-->  8 . 人  cost= 2.705451519003308
2 . 長   <-->  20 . 。  cost= 0.9405658895019222
1 . ###LEFT-WALL###   <-->  2 . 長  cost= -0.11680557768830013


scheme@(guile-user)> (print-mst  "把 蕾 當 作 戀 人 看 待 ， 記 憶 力 比 一 般  人 優 異 。")
11 . 記   <-->  12 . 憶  cost= 9.984319885371686
6 . 戀   <-->  12 . 憶  cost= 4.479455917846746
6 . 戀   <-->  17 . 人  cost= 3.346336621332618
6 . 戀   <-->  7 . 人  cost= 3.346336621332618
6 . 戀   <-->  19 . 異  cost= 3.1326057184954585
18 . 優   <-->  19 . 異  cost= 7.429036103043035
12 . 憶   <-->  13 . 力  cost= 2.9092434467610424
7 . 人   <-->  8 . 看  cost= 1.5817340934392554
8 . 看   <-->  9 . 待  cost= 6.40562791854984
6 . 戀   <-->  16 . 般  cost= 1.532540145438297
15 . 一   <-->  16 . 般  cost= 6.011468981031394
14 . 比   <-->  16 . 般  cost= 2.133858423252395
19 . 異   <-->  20 . 。  cost= 1.062610265554028
5 . 作   <-->  20 . 。  cost= 0.9473091730162793
4 . 當   <-->  5 . 作  cost= 1.8844566876556712
2 . 把   <-->  4 . 當  cost= 1.601964785223224
2 . 把   <-->  3 . 蕾  cost= 3.301384076256177
1 . ###LEFT-WALL###   <-->  4 . 當  cost= 1.4277603296921786
8 . 看   <-->  10 . ，  cost= 0.7854131431579994


scheme@(guile-user)> (print-mst  "道 德 学 社 创 始 人 。")
6 . 创   <-->  7 . 始 cost= 5.70773284687867
4 . 学   <-->  6 . 创  cost= 3.061665951119931
6 . 创   <-->  8 . 人  cost= 2.1724657173546227
4 . 学   <-->  5 . 社  cost= 1.2513192358165952
8 . 人   <-->  9 . 。  cost= 0.9996485775966537
2 . 道   <-->  9 . 。  cost= 0.566680489393292
2 . 道   <-->  3 . 德  cost= 2.4802112908263467
1 . ###LEFT-WALL###   <-->  2 . 道  cost= -0.4271902589965446


scheme@(guile-user)> (print-mst  "然 而 ， 此 混 战 亦 可 坚 持 三 十 六 日 。") 
10 . 坚   <-->  11 . 持  cost= 8.090136242433331
2 . 然   <-->  10 . 坚  cost= 3.986785521916751
2 . 然   <-->  3 . 而  cost= 5.260819401185174
1 . ###LEFT-WALL###   <-->  2 . 然  cost= 1.960750908016161
2 . 然   <-->  5 . 此  cost= 1.6401055467853318
4 . ，   <-->  5 . 此  cost= 1.9045829576234112
5 . 此   <-->  8 . 亦  cost= 1.6941756040836786
8 . 亦   <-->  9 . 可  cost= 3.9818559895630496
5 . 此   <-->  7 . 战  cost= 0.7150479036642032
6 . 混   <-->  7 . 战  cost= 3.4641015339868524
11 . 持   <-->  16 . 。  cost= 0.667356443539326
11 . 持   <-->  12 . 三  cost= -0.082652373159668
12 . 三   <-->  13 . 十  cost= 4.910027341075681
13 . 十   <-->  14 . 六  cost= 6.198613466629329
13 . 十   <-->  15 . 日  cost= 1.2911435674834095
scheme@(guile-user)> 


FYI, here are comparable parses, for English, using the English pair dataset.
They are mostly good, with occasional mediocre links.

 (print-mst "It is the same old tale, I suppose")
9 . I   <-->  10 . suppose  cost= 5.30352500612982
1 . ###LEFT-WALL###   <-->  9 . I  cost= 1.81488162256983
1 . ###LEFT-WALL###   <-->  2 . It  cost= 3.58403195375127
2 . It   <-->  3 . is  cost= 4.74100503452483
8 . ,   <-->  9 . I  cost= 1.05294445305262
7 . tale   <-->  8 . ,  cost= 1.04077920118952
5 . same   <-->  7 . tale  cost= 2.71210690237531
4 . the   <-->  5 . same  cost= 3.45495315601723
6 . old   <-->  7 . tale  cost= 2.49777533091725

scheme@(guile-user)> (print-mst "The girl gave a little laugh")
5 . a   <-->  6 . little  cost= 3.7409985984943
6 . little   <-->  7 . laugh  cost= 3.25530927504408
4 . gave   <-->  7 . laugh  cost= 3.18817482182013
3 . girl   <-->  4 . gave  cost= 1.39996148448708
2 . The   <-->  3 . girl  cost= 3.70796523865541
1 . ###LEFT-WALL###   <-->  2 . The  cost= 3.54169132577798

scheme@(guile-user)> (print-mst "He wore a new white sailor suit with pockets")
7 . sailor   <-->  8 . suit  cost= 5.49215876834077
5 . new   <-->  8 . suit  cost= 5.1696331184917
6 . white   <-->  7 . sailor  cost= 4.43134225309288
3 . wore   <-->  8 . suit  cost= 3.5690512406128
2 . He   <-->  3 . wore  cost= 4.4474126513332
1 . ###LEFT-WALL###   <-->  2 . He  cost= 3.64809278899352
8 . suit   <-->  10 . pockets  cost= 3.39943721825401
3 . wore   <-->  4 . a  cost= 3.26884788962874
8 . suit   <-->  9 . with  cost= 1.22919683159134

scheme@(guile-user)> (print-mst "Maie threw back her veil and smiled")
2 . Maie   <-->  8 . smiled  cost= 6.90160018627178
2 . Maie   <-->  3 . threw  cost= 6.8332928881085
3 . threw   <-->  4 . back  cost= 4.35035476889946
3 . threw   <-->  6 . veil  cost= 3.23768129913487
5 . her   <-->  6 . veil  cost= 3.70652214281638
1 . ###LEFT-WALL###   <-->  8 . smiled  cost= 1.75135762004661
7 . and   <-->  8 . smiled  cost= 1.67365955937873

    +------->WV------->+--MVs-+---CV->+     
    +--Wd--+-Sp*i+--I--+Osm+  +Cs+-Sp-+--O-+
    |      |     |     |   |  |  |    |    |
LEFT-WALL I.p will.v do.v it if you say.v so 


   +--MVs-+---CV->+     
   |      +Cs+-Sp-+--O--+
   |      |  |    |     |     
   ?     if  ?  say     ? 


         +Cs+
         |  |
         if  ?  


guile-mst-zh> MST-Processing file >>>止-灣/汤加国徽<<<

(define (print-mst TXT)
	(define (prt-mpr MPR)
		(format #t "~D . ~A  <--> ~D . ~A  \t  MI = ~6F\n"
			(car (caar MPR)) (cog-name (cdr (caar MPR)))
			(car (cdar MPR)) (cog-name (cdr (cdar MPR)))
			(cdr MPR)
	))
	(for-each prt-mpr (mst-parse-text TXT))
)


(print-mst "然杜氏 恶 撰 ， 述 一漏 百 ， 且 多 谬误 。")
(print-mst "丙寅年 夏日 ， 王门 胡氏 焚香 敬撰 。")
(print-mst "今书 已成 ， 余喜 史家 案头 ， 又 添 新书 ， 更喜 日后 家事 ， 彼无 遁词 ， 遂 成此序 。")
(print-mst "母猪 的 价格 暴涨 ， 可见 事态 之 严重 。")
(print-mst "干爷 ， 你 不是 这么 教导 我们 的 吗 ？")

Hi Ben, Ruiting,

Below are MST parses of five sentences. Just as before, an MI value
of 4 or below is usually junk, and 10 or above is high confidence.
This dataset probably does not contain MI's above 25; larger datasets
would.

These are 5 sentences I picked from wangxiaobo-7

I will have non-clustered link-grammar parses in about 3 days or so.
I expect that they will be of higher quality, but who knows.

If all goes well, I might have (non-clustered) English LG parses
later today.

--linas

The parses below are completely random junk. About half of the words
have been observed once and only once, and are thus have no meaningful
statistical sample.

(print-mst "然杜氏 恶 撰 ， 述 一漏 百 ， 且 多 谬误 。")
6 . 述  <--> 7 . 一漏     MI = 21.128
4 . 撰  <--> 6 . 述       MI = 19.009
2 . 然杜氏  <--> 4 . 撰   MI = 18.885
7 . 一漏  <--> 8 . 百     MI = 16.029
2 . 然杜氏  <--> 3 . 恶   MI = 15.179
6 . 述  <--> 12 . 谬误    MI = 13.671
7 . 一漏  <--> 10 . 且    MI = 12.479
6 . 述  <--> 11 . 多      MI = 7.7579
1 . ###LEFT-WALL###  <--> 2 . 然杜氏      MI = 3.6985
4 . 撰  <--> 13 . 。      MI = 2.6162
5 . ，  <--> 6 . 述       MI = 2.3806
9 . ，  <--> 10 . 且      MI = 2.3653

(print-mst "丙寅年 夏日 ， 王门 胡氏 焚香 敬撰 。")
5 . 王门  <--> 6 . 胡氏   MI = 21.478
6 . 胡氏  <--> 7 . 焚香   MI = 21.471
7 . 焚香  <--> 8 . 敬撰   MI = 21.301
2 . 丙寅年  <--> 5 . 王门 MI = 18.049
2 . 丙寅年  <--> 3 . 夏日 MI = 19.518
8 . 敬撰  <--> 9 . 。     MI = 4.0183
1 . ###LEFT-WALL###  <--> 2 . 丙寅年      MI = 3.6985
4 . ，  <--> 5 . 王门     MI = 2.7025

(print-mst "今书 已成 ， 余喜 史家 案头 ， 又 添 新书 ， 更喜 日后 家事 ， 彼无 遁词 ， 遂 成此序 。")
17 . 彼无  <--> 18 . 遁词 MI = 21.236
18 . 遁词  <--> 21 . 成此序       MI = 19.366
15 . 家事  <--> 18 . 遁词 MI = 18.688
13 . 更喜  <--> 15 . 家事 MI = 19.674
20 . 遂  <--> 21 . 成此序 MI = 18.160
14 . 日后  <--> 15 . 家事 MI = 16.529
11 . 新书  <--> 13 . 更喜 MI = 15.155
10 . 添  <--> 15 . 家事   MI = 12.060
21 . 成此序  <--> 22 . 。 MI = 4.0183
9 . 又  <--> 10 . 添      MI = 3.9017
7 . 案头  <--> 9 . 又     MI = 3.9325
5 . 余喜  <--> 7 . 案头   MI = 18.569
5 . 余喜  <--> 6 . 史家   MI = 20.508
3 . 已成  <--> 5 . 余喜   MI = 16.793
2 . 今书  <--> 3 . 已成   MI = 17.234
1 . ###LEFT-WALL###  <--> 2 . 今书        MI = 3.6985
16 . ，  <--> 17 . 彼无   MI = 3.1355
18 . 遁词  <--> 19 . ，   MI = 3.0673
12 . ，  <--> 13 . 更喜   MI = 2.9131
4 . ，  <--> 5 . 余喜     MI = 2.6880
8 . ，  <--> 9 . 又       MI = 1.2527


(print-mst "母猪 的 价格 暴涨 ， 可见 事态 之 严重 。")
4 . 价格  <--> 5 . 暴涨   MI = 16.213
5 . 暴涨  <--> 7 . 可见   MI = 13.902
2 . 母猪  <--> 5 . 暴涨   MI = 12.817
7 . 可见  <--> 8 . 事态   MI = 10.562
8 . 事态  <--> 10 . 严重  MI = 8.6693
8 . 事态  <--> 9 . 之     MI = 6.1207
5 . 暴涨  <--> 6 . ，     MI = 3.1828
3 . 的  <--> 4 . 价格     MI = 2.8438
7 . 可见  <--> 11 . 。    MI = 1.7341
1 . ###LEFT-WALL###  <--> 7 . 可见        MI = 0.9190

(print-mst "干爷 ， 你 不是 这么 教导 我们 的 吗 ？")
2 . 干爷  <--> 7 . 教导   MI = 9.8548
7 . 教导  <--> 8 . 我们   MI = 6.5231
2 . 干爷  <--> 6 . 这么   MI = 5.1008
2 . 干爷  <--> 4 . 你     MI = 4.5330
2 . 干爷  <--> 5 . 不是   MI = 2.7742
1 . ###LEFT-WALL###  <--> 2 . 干爷        MI = 2.7416
2 . 干爷  <--> 3 . ，     MI = 2.0854
7 . 教导  <--> 10 . 吗    MI = 1.9647
10 . 吗  <--> 11 . ？     MI = 7.6251
8 . 我们  <--> 9 . 的     MI = 0.7513

run/mst-one.sh run/ss-one.sh

OK what borked?

(print-mst "丙寅年 夏日 ， 王门 胡氏 焚香 敬撰 。")
a 5 . 王门     <--> 6 . 胡氏   MI = 21.478
b 6 . 胡氏     <--> 7 . 焚香   MI = 21.471
c 7 . 焚香     <--> 8 . 敬撰   MI = 21.301
d 2 . 丙寅年   <--> 5 . 王门   MI = 18.049
e 2 . 丙寅年   <--> 3 . 夏日   MI = 19.518   OK its there.
f 8 . 敬撰     <--> 9 . 。     MI = 4.0183
g 1 . LEFT-WALL<--> 2 . 丙寅年 MI = 3.6985
h 4 . ，      <--> 5 . 王门    MI = 2.7025


                                        near+    far+
丙寅年.399826              (g)TXYJK- & eTPYYP+ & dTRZZG+
 夏日.232814                eTPYYP- 
                            far-      near-
 王门.270759                dTRZZG- & (h)TRZZH- & aTRZZI+
 胡氏.349378                aTRZZI- & bTVWZI+
 焚香.506188                bTVWZI- & cTPSCX+
 敬撰.227735                cTPSCX- & (f)TPSCY+

-------------------
wtf this one two

(print-mst "然杜氏 恶 撰 ， 述 一漏 百 ， 且 多 谬误 。")
a 6 . 述  <--> 7 . 一漏     MI = 21.128
b 4 . 撰  <--> 6 . 述       MI = 19.009
c 2 . 然杜氏  <--> 4 . 撰   MI = 18.885
d 7 . 一漏  <--> 8 . 百     MI = 16.029
e 2 . 然杜氏  <--> 3 . 恶   MI = 15.179
f 6 . 述  <--> 12 . 谬误    MI = 13.671
g 7 . 一漏  <--> 10 . 且    MI = 12.479
h 6 . 述  <--> 11 . 多      MI = 7.7579
i 1 . ###LEFT-WALL###  <--> 2 . 然杜氏      MI = 3.6985
j 4 . 撰  <--> 13 . 。      MI = 2.6162
k 5 . ，  <--> 6 . 述       MI = 2.3806
l 9 . ，  <--> 10 . 且      MI = 2.3653


然杜氏.274017              (i)TSEOZ- & eTSEPA+ & cTSEPB+
恶.490429                  eTSEPA-
撰.425002                  cTSEPB- & bTYVJC+ & (j)TVWQA+

                            near-      far-
述.524662                  (k)TVWZA- & bTYVJC- & aTWBEZ+ & hTXAHR+ & fTLYRB+
一漏.353033                aTWBEZ- & dTWBFA+ & gTIVQI+
多.375900                  hTXAHR-
谬误.163229                fTLYRB-
百.519512                  dTWBFA-
且.115701                  (l)TBOFC- & dTIVQI-

Above should link, but its not ... why?

wrong commas: expect:
,  with TVWZA+
, with TBOFC+

l->r pass removed 117441
LEFT-WALL[15044] 然杜氏[3] 恶[1] 撰[3] ，[10192] 述[5] 一漏[3] 百[2] ，[10192] 且[5] 多[136] 谬误[1] 。[10] 

r->l pass removed 35544
LEFT-WALL[3] 然杜氏[3] 恶[1] 撰[3] ，[3] 述[5] 一漏[3] 百[1] ，[1] 且[2] 多[2] 谬误[1] 。[3] 

l->r pass removed 0
print_expression_sizes(sent);
prepare/exprune.c:			size += size_of_expression(x->exp);
LEFT-WALL[3] 然杜氏[3] 恶[1] 撰[3] ，[3] 述[5] 一漏[3] 百[1] ，[1] 且[2] 多[2] 谬误[1] 。[3] 

for (d=sent->word[i].d; d != NULL; d = d->next) c++; is the dj count ..
sent->word[i].alternatives[0]
++++ Finished expression pruning             0.09 seconds

build_disjuncts_for_exp

line 171
After expanding expressions into disjuncts:LEFT-WALL(2) 然杜氏(1) 恶(1) 撰(1) ，(1) 述(1) 一漏(1) 百(1) ，(0) 且(1) 多(2) 谬误(1) 。(3) 

So expression prunning removed the comma ... why?  Because of cost-max
!cost-max = 50
d->left
void print_connector_list(Connector * e);
void print_disjunct_list(Disjunct * c);

wrong commas: expect:
,  with TVWZA+
, with TBOFC+

Hmm first comma did have: TBOFC+ TVWZA+ but that is all....

，


------------------------------------------------------------

Also bad line-wrapping: 
母猪 的 价格 暴涨 ， 可见 事态 之 严重 。
glyph_width += mk_wcwidth(ws[i]);

wchar_t  wc;
mbstate_t mbss;
memset(&mbss, 0, sizeof(mbss));

mbrtowc(&wc, ssss, MB_CUR_MAX, nbss);
wc = xxx
glyph_width = mk_wcwidth(wc);



ERROR: In procedure gc:
ERROR: In procedure dbi-close: Wrong type argument in position 1: #<finalized smob 556c0402ec00>
 This is still an issue....


LG expects:
test: D- & Os- (near- & far-) & (close+) & (far+)




-------------------------------------------------------------
export stuff
en_pairs_tthree_mst 8 gb
Not just  en_pairs_rone.sql.bz2  and to the rest by hand just for junk.

(sql-open "postgres:///en_pairs_rone?user=linas")

(observe-mst "He wandered through the fog")
(observe-mst "He thought about home")

!!fog
Found expression for word fog: Debug: TI-
Token "fog" matches nothing in the dictionary.

###LEFT-WALL###: TB+
He: TB- & TG+
thought: TG- & TD+
about: TD- & TE+
home: TE-
LEFT-WALL  -> LEFT-WALL
UNKNOWN-WORD

seg fault

Both He's have the wrong disjunct -- classname! ah OK

   (define mi-source (add-pair-freq-api pair-obj))
pair-fmi

------------------------

en_pairs_rfive_mi
(sql-open "postgres:///en_pairs_rfive_mtwo?user=linas")
 (define pca (make-pseudo-cset-api))
 (define psa (add-pair-stars pca))
;  (batch-pairs psa)
(psa 'fetch-pairs)
(print-matrix-summary-report psa)

(define psc (add-pair-count-api psa))
(define psf (add-pair-freq-api psa))

Rows: 137078 Columns: 6239997
Size: 8629163 non-zero entries of 855366308766 possible
Fraction non-zero: 1.0088E-5 Sparsity (-log_2): 16.597
Total observations: 18489594.0  Avg obs per pair: 2.1427
Entropy Total: 20.957   Left: 19.143   Right: 9.7111
Total MI: 7.8969

                 Left         Right     Avg-left     Avg-right
                 ----         -----     --------     ---------
Support (l_0)  4.8875E+4    145.4
Count   (l_1)  2.2958E+5    3440.         4.697        23.66
Length  (l_2)  1.3729E+4    1773.         .2809        12.19
RMS Count      1.3696E+4    1732.         .2802        11.91


(length all-csets)
$16 = 8629163
expect approx 8629163 + 3*137078 + 2*6239997 =  21520391 = 21.5M atoms, approx.

Actual: 21651917 which is 131526 more than expected ...
and is 43GB virt = 2KB/atom
and elapsed= 4543 secs = 4.77K atoms/sec
cpu time: 435:31.67 = 26131 secs -? 5.75 parallel

heap: 1421955072
45.036 
Uhh oh.

NO MI for DJ (WordNode \"Jud\") ...

(Section (WordNode "Jud") 
   (ConnectorSeq (Connector (WordNode "Prudie") (ConnectorDir "+"))))

(define psf (add-pair-freq-api psa))
(fetch-incoming-by-type (WordNode "Jud") 'Section)
(psf 'pair-fmi  ... throws)
(PredicateNode "*-Mutual Info Key-*") 

(cog-keys jud) doesn't list it. ... it was not saved.
how to recomp only one MI?
count=3

left-wild=17.7478927873962
right-wild = 15.6685349957829
wild-wild:  18489594 

so freq should be: 1.622534275225297e-7
logli = 22.55524770945383
fmi = 10.861180073725272
mi = 1.7622636939013273e-6

set-pair-freq
set-pair-mi

(Section (WordNode "set") 
 (ConnectorSeq  (Connector (WordNode "watch")  (ConnectorDir "+"))))

count=4
right-wild-count 5698.0 
right-wild-logli 11.6639703038511
left 15.478432112403

logli=22.140210210174985
fmi = 5.0021922060791155
mi = 2.1633790336337293e-7 * above

Whoa .. store atom didn't work!? Yes it did ....

(Section         66400472
(WordNode "set")    310
 (ConnectorSeq      64865853
  (Connector        64865826
  (WordNode "watch")  69402
 (ConnectorDir "+") 64841132
)))

So fetch-atom is not working....
get_atom_values is called...

getLink
doGetLink  yes ...
setValue yes... called 1,2,3 times
but cog-keys still shows junk.

oc_to_string

(Section                73785651
(WordNode "Reinaert")   11727194
  (ConnectorSeq         73785641
  (Connector            73785640
(WordNode "Isengrim")   11727422
  (ConnectorDir "+")))) 64841132

Ahhh!  Soo .. no MI was stored for this!   it was lost!

Also: not fetchable if been open a long time ... !?

count=1
wild-wild = 18489594
right-wild-logli = 18.8182821152876
left- = 18.8922826967314

so fmi = 13.570354601844016

cog-logger
(use-modules (opencog logger))

@0x7ffc6ba59e40:
getLink
doGetLink   its in TLB so we are good ...
get_atom_values

@0x7ffc6ba59d90:  is what sql works with.

get_all_values_cb
atom->setValue
... fails because atom in TLB has no atomspace!!!!
    _atom_space->_value_table.addValuation(key, getHandle(), value);
which is why its not printing...

but fetches after individual access do work corrctly.
Soits the bulk fretch of all apirs that failed to date TLB...

(load-atoms-of-type 'Section)
getIncomingByType
getIncoming
      hi = table.add(hi, false);
      _tlbuf.addAtom(hi, p->uuid);

wait ... atom->setAtomSpace(_as); does happn so wtf...!?

x/4a 0x7ffc6ba59e40
(gdb) x/4a 0x7ffc6ba59e40
0x7ffc6ba59e40: 0x7f26dfca8440  0x7f26dfca8430
(gdb) x 0x7f26dfca8440
0x7f26dfca8440: 0x7f303c11e1b8 <_ZTVN7opencog4LinkE+16>

(gdb) print *this                             
$15 = {<> = {<> = {_M_weak_this = {<No data fields>}}, 
    _vptr.ProtoAtom = 0x7f303c11e1b8 <vtable for opencog::Link+16>,
    _type = 127}, _flags = 0 '\000', _content_hash = 11383300620556476978,
  _atom_space = 0x0, _truthValue = {<No data fields>},
  _mtx = {<No data fields>}, _incoming_set = {<No data fields>}}        

So... 

atomspace should be 0x55595edc1590

(gdb) x/16 0x7f26dfca8440
0x7f26dfca8440: 0x7f303c11e1b8 <_ZTVN7opencog4LinkE+16> 0x7f26dfca8440
0x7f26dfca8450: 0x7f26dfca8430  0x353635383700007f  << type=7f = 127 good
0x7f26dfca8460: 0x9df99b9a63c0a232      0x55595edc1590 << atomspace is good
0x7f26dfca8470: 0x5559659b7c10  0x5559659b7c00
0x7f26dfca8480: 0x0     0x0
0x7f26dfca8490: 0x0     0x0

whereas tlb is holding:
$26 = (struct Handle &) @0x7ffc6ba59d90: {<No data fields>}
(gdb) x 0x7ffc6ba59d90
0x7ffc6ba59d90: 0x7f26dfca8240

(gdb) x/12 0x7f26dfca8240
0x7f26dfca8240: 0x7f303c11e1b8 <_ZTVN7opencog4LinkE+16> 0x7f26dfca8240
0x7f26dfca8250: 0x7f26dfca8230  0x7f26df00007f << type=7f = 127 good
0x7f26dfca8260: 0x9df99b9a63c0a232      0x0  << hash is same, atomspace bad
0x7f26dfca8270: 0x5559659b7c10  0x5559659b7c00
0x7f26dfca8280: 0x0     0x0
0x7f26dfca8290: 0x0     0x0

      _tlbuf.addAtom(hi, p->uuid);

(define sec (Section (WordNode "Reinaert") (ConnectorSeq (Connector
(WordNode "Isengrim") (ConnectorDir "+")))))

(define foo (Predicate "foo"))
(cog-value sec foo)
(cog-set-value! sec foo (FloatValue 1 ))
wtf
"Atom not in atomspace" ??? Ahh!

Atom::setValue from 
        8: SQLAtomStorage.cc:307
opencog::SQLAtomStorage::Response::get_all_values_cb()
10: SQLAtomStorage.cc:1687  :getLink

so doGetLink top-code returned an atom that's not in the AS.

doGetLink does no table insert directly! cause table not available.
But the tlb resolve fixes it up for us! Cause the fetch was already
in the as.

vs. the incoming set .... 
getIncomingByType  1566
getIncoming  1502
  ... get_recursive_if_not_exists  1459
        does a _tlbuf.addAtom(link, p->uuid);
             but that link is not in AS yet.
  add lnk to table
  get values of tabled link
   _tlbuf.addAtom(hi, p->uuid); 
      but some other ato already in tlb....

  so:
   h is in the as.
   hr is == h

   _handle_map.find(hr); returns ... !?

So the second addAtom fails to resolve or update ad the first failed to
resolve.

ValuationPtr  .. s a triple, and thus is too much.
Atom has pairs of key, ProtoAtomPtr&  

Remove the valuation table, do not even build it. DONE
remove special-case for tv in sql  DONE

==================
United:
States+  36

domain- domain- the- the- States+ States+ 80
the- domain- anyone- in- th- States+ 40
outside- the- States+  51
owns- the- States+ States+  108
status- outside- the- States+



99  2.8848641655886156 "Prince"

Prince  773

Andrew+ 626
Vasili+ 149
Andrew's+ 46
Edouard+ 46
Hans+ 33
Bagration+ 32
the- Andrew+ 27 
the- Wales+ 27
Hippolyte+ 21 
Arthur+ 21
the- 17
Bolkonski+ 16
Natasha- Andrew+ 18
The- Andrew+ 15
Vasili's+ 14
"-  Andrew+  11
LEFT-WALL- Edouard+ 11

112  2.801255090459977 "his" -- 49 dj > 200
140  2.6103991212010254 "think" -- 6 dj > 200
148  2.5431777546500145 "was"  -- 35
161  2.4965609797013926 "head" -- 5
171  2.4537177541729895 "middle" --  1
195  2.382483370288248 "long" -- 5 
196  2.3804440649017935 "day" -- 2
208  2.3244970859184058 "going" -- 2

think: 5462
I- 1321
you- 308
do- you- 211
don't- 265
to- 244
I- it+ 202

head:  5961
his- 777
shook- .+ 751
shook- 683
her- 358
his- .+ 238

long  5412
a- 385
as+ 335
how- 236
a- time+ 212
enough+ 201


How many words?
(psf 'left-basis-size)
(psf 'right-basis-size)

(define (escquote STR BEG)
	(define pos (string-index STR (lambda (C) (equal? C #\')) BEG))
	(if pos
		(escquote
			(string-replace STR "''" pos pos 1 2)
			(+ pos 2))
		STR))

		(string-replace "fo's" "''" 2 2 1 2)

zen_pairs_mst
(export-all-csets "dict-zen.db" "ZH_cn")
Store 800855 csets

Mandarin word pairs + MI values; Ruitings segemented text

--------------------

1) filter the dictionary write...
e.g. 
(define pca (make-pseudo-cset-api) 
(define psa (add-pair-stars pca))
(psa 'left-basis-size)  137078
(psa 'right-basis-size)  6239997
(length (psa 'all-pairs))  8629163

(define fca (add-subtotal-filter psa 50 50 10 #f))
(define fsa (add-pair-stars fca))
(fsa 'left-basis-size)  14666
(fsa 'right-basis-size)  23565
(length (fsa 'all-pairs))  76834

Need a map over all elts exists, its the looper.
get rid of all-csets DONE

(define cnt 0)
(define (cntr x) (set! cnt (+ cnt 1)))
(define looper (add-loop-api psa))
(looper 'for-each-pair cntr)

fuuuu 
(define fsf (add-pair-freq-api fsa))
(psf 'pair-fmi sec) works
(fsf 'pair-fmi sec) fails

(define (foo x) (format #f "bar ~D" x))
(define* (st FOO   #:optional (ID (FOO 2)))
	(format #t "hey its ~A\n" ID))

(define (foo LLOBJ)
      (lambda (message . args)
         (case message
            ((id)     "cset")
            (else     (apply LLOBJ (cons message args)))
      )))


2) replace cset-vec-cosine by filtered cosine  in gram-sim DONE

(define fsf (add-pair-freq-api fsa))
	(define fsm (add-similarity-api fsa #f))
	(define fsb (batch-similarity fsa #f))
	(fsb 'batch-compute)
	(fsb 'paralel-batch 3)

3) use filter-specific predicate.  DONE
4) wait .. batch in matrix?

5) make graph of filtering ... why? we can already guess...

filters?
   (define key-name
      (if (LLOBJ 'filters?)
         (string-append "*-Norm Key " (LLOBJ 'id))
         "*-Norm Key-*"))

6) create generic API to fetch and store values on matrix by key name
   well, maybe not...
7) create generic product matix kind-of-done-ish
8) create generic cosine matrix. kind-of-done-ish
9) fetch all atoms with key  DONE
   this will make fetching cosines better!?

--------------------------------------------

Fuuuu
He looked away
link-grammar/prepare/exprune.c:318
#0  expression_prune (sent=sent@entry=0x555555928f50)
    at ../../link-grammar/prepare/exprune.c:318
#1  0x00007ffff7b6f2e8 in sentence_parse (sent=0x555555928f50, 
    opts=0x55555576f580) at ../../link-grammar/api.c:700

x->exp == 0
he.2549 has no exp....

sqlite> select * from Morphemes where subscript='he.2549';
he|he.2549|(he.2549)

he.2025041
has no disjunct.
NULL X_node


sqlite3 bad.db
.mode insert
.output dump_all.sql
.dump
.exit

sqlite3 renew.db
.read dump_all.sql

ant ant-optional
-------------------

(for-each
	(lambda (item)
		(format #t "wtf ~A\n" (/ (log (first item)) (log 2.0))) )
	(take sorted-lensq-norm 50))

(define binned-sqlen-norm (bin-count 
	(take sorted-lensq-norm 50 )
	50
   (lambda (item) 
		(define val (/ (log (first item)) (log 2.0)))
   	(format #t "wtf ~A\n" val)
		val)
   (lambda (item) 1)
   1.0 30.0))


(define cnt 0)
(define many (cog-count-atoms 'SimilarityLink))
(define (sto at)
	(store-atom at)
	(set! cnt (+ cnt 1))
	(if (eqv?  0 (modulo cnt 1000))
		(format #t "stored ~A of ~A\n" cnt many))
	#f)
 (cog-map-type sto 'SimilarityLink)
16:04

almost exactly 1/3rd have sim > 0.5 ... 
total = 142270 sim links

198 dupes ... how is that possible??

select count(*) from atoms where type=27; -- 142270 so that's perfect.
where are the dupes coming from?

----------------
617

(define (print-connector CON)
	(string-append (cog-name (gar CON)) (cog-name (gdr CON)) " "))

(define (section->dj-str SEC)
	(string-concatenate 
		(map print-connector (cog-outgoing-set (gdr SEC))))
)

(define (print-disjuncts WORD)
	(define all-secs (cog-incoming-by-type WORD 'Section))
	(define sorted-secs (sort all-secs
		 (lambda (a b) (> (get-count a) (get-count b)))))
	(define (prt-one con)
		(format #t "~D  ~A\n" (get-count con) (section->dj-str con)))
	(for-each prt-one sorted-secs))

porch .. horses

fsm .... filteres similarity
   (define fca (add-subtotal-filter psa 50 50 10 #f))
   (define fsa (add-pair-stars fca))
	(define fsm (add-similarity-api fsa #f))
	(define fsb (batch-similarity fsa #f))

(fsb 'compute-similarity (Word "porch") (Word "horses"))
(fsa 'right-stars (Word "porch")) 
(fsa 'right-stars (Word "horses"))

Fuu
"cset cut-50-50-10"

"*-SimKey cset cut-50-50-10"

(cog-map-type sto 'SimilarityLink)

(define cos-key (Predicate "*-Cosine Sim Key-*"))
(define cut-key (Predicate "*-SimKey cset cut-50-50-10"))
(define (mov-sim ato)
	(define sim (cog-value ato cos-key))
	(cog-set-value! ato cut-key sim)
	(cog-set-value! ato cos-key (FloatValue 0.0))
	#f)
(cog-map-type mov-sim 'SimilarityLink)

(define pss (add-similarity-api psa #f))
(define psb (batch-similarity psa #f))
(define (new-sim ato)
	(define fsim (pss 'compute-similarity (gar ato) (gdr ato)))
	(cog-set-value! ato cos-key (FloatValue fsim))
	#f)

(cog-map-type new-sim 'SimilarityLink)

(define (kill-sim ato)
	(define sim (cog-value-ref (cog-value ato cos-key) 0))
	(if (< sim 1.0e-25)
	   (cog-set-value! ato cos-key #f))
	#f)
(cog-map-type kill-sim 'SimilarityLink)

(define scnt 0)
(define (showone ato)
	(if (not (null? (cog-value ato cos-key)))
		(begin
			(format #t "yo ~A ~A\n"
				(cog-value-ref (cog-value ato cos-key) 0) ato)
			(set! scnt (+ scnt 1))))
	#f)
(cog-map-type showone 'SimilarityLink)

(define (cntone ato)
	(define val (cog-value ato cos-key))
	(if
; (not (null? val))
;  (and (not (null? val)) (< 1e-10 (cog-value-ref val 0)))
  (and (not (null? val)) (<= 0.1 (cog-value-ref val 0)))
(begin (set! scnt (+ scnt 1))
  (store-atom ato)
)) #f)

(define scnt 0)
(cog-map-type cntone 'SimilarityLink)
(define (rpt) (set! scnt 0) (cog-map-type cntone 'SimilarityLink) scnt)



2932
3052 + (69*68)/2 - (37*36)/2 = 4732
4700 + (130 * 129) / 2 - (69*68)/2 = 10739
10708 + (427 * 426)/ 2 - (130 * 129) / 2 = 93274.0

17199 at 11:50  -> shoot for about 30K at 512 - 245 = 29890
37044 when done (- (* 0.5 427 426) (* 0.5 245 244))) = 98105


Fuuuu.
(define psu (add-support-api psa))
(psu 'right-length

(define psm (add-similarity-api psa #f))
(define pac (add-pair-cosine-compute psa))

 (define (compute-sim A B)
   (define val (psm 'pair-similarity (cog-link 'SimilarityLink A B)))
     (if 
; (and (not (null? val)) (< 1.0e-6 (cog-value-ref val 0)))
 (not (null? val)) 
(format #t "Already got one ~A ~A ~A \n" (cog-value-ref val 0) A B)
(begin (format #t "Gonna do it for ~A=~D ~A=~D\n"
A (length (cog-incoming-by-type A 'Section))
B (length (cog-incoming-by-type B 'Section)))
      (psm 'set-pair-similarity
           (SimilarityLink A B) 
          (FloatValue (pac 'right-cosine A  B))))))

;          (compute-right-cosine A  B)))))

(define (batch-simlist ITEM ITEM-LIST)
   (for-each (lambda (item) (compute-sim ITEM item)) ITEM-LIST))

(define (make-pairs ITM-LST)
            (if (not (null? ITM-LST))
               (begin
			(batch-simlist (car ITM-LST) (cdr ITM-LST))
                  (make-pairs (cdr ITM-LST)))))

      (define (compute-right-cosine ROW-A ROW-B)
         (define prod (compute-right-product ROW-A ROW-B))
         (define deno (exact->inexact (*
            (get-right-length ROW-A)
            (get-right-length ROW-B))))
         (if (eqv? 0.0 deno) 0.0 (/ prod deno)))

(define ptm (add-tuple-math psa * 'pair-count))
(define prd (add-support-compute ptm))

      (define (compute-right-product ROW-A ROW-B)
         (prd 'right-count (list ROW-A ROW-B)))

      (define (get-right-length ROW) (psu 'right-length ROW))

Q: does star basis behave corectly on the tuple?
A: duddn't matter only stars are used.

(define ptms (add-pair-stars ptm))
 (ptms 'right-stars (list ROW-A ROW-B))

Replace below by hash:

	(define (get-right-union TUPLE)
		(let* ((start-time (current-time))
				(res (delete-duplicates!
			(append-map!
				(lambda (item) (map! gdr (psa 'right-stars item)))
				TUPLE))))
			(format #t "tooks ~A secs\n" (- (current-time) start-time))
			res))


(define (make-union)
	(define cache (make-hash-table))
	(define (atom-hash ATOM SZ) (modulo (cog-handle ATOM) SZ))
	(define (atom-assoc ATOM ALIST)
		(find (lambda (pr) (equal? ATOM (car pr))) ALIST))
			
	(lambda (ITEM)
		(if ITEM
			(hashx-set! atom-hash atom-assoc cache ITEM #f)
			(let ((ats '()))
				(hash-for-each-handle
					(lambda (PR) (set! ats (cons (car PR) ats)))
					cache)
				ats))))

(define atom-set (make-union))

(for-each atom-set (map! gdr (psa 'right-stars W)))

wall -- 64125
at -- 28773
sum = 92898 
wall-at: 92322
last: 94888

finally: 317206 = (797 * 796) / 2  for len=128

'item-pair   return hi-pr only if lopr
'make-pair


(define good-sims
   (filter
      (lambda (sim) (and
            (< 0.5 (sim-cosine sim))
            (< 8 (cset-vec-word-len (gar sim)))
            (< 8 (cset-vec-word-len (gdr sim)))))
      all-sims))


Notes: Chapter- or LEFT-WALL- or End-;  27 total
Summary: Chapter- or LEFT-WALL-;  44 total 

Rting: (LEFT-WALL- & :+) or (LEFT-WALL- & :+ & Audiences+) or
(LEFT-WALL- & :+ & Explicit+) or (LEFT-WALL- & :+ & Mature+)

    (define (pair-cos A B)
       (define cos-key (PredicateNode "*-Cosine Sim Key-*"))
       (define SIM (SimilarityLink A B))
		(define val (cog-value SIM cos-key))
(if (equal? A B) 1.0
   (if (not (null? val)) (cog-value-ref val 0) 0.0)))


sorted-word-obs
 vs. (psu 'right-length a)
cset-vec-word-observations

(psu 'right-support      64215.0
(psu 'right-count       972963.0
(psc 'right-wild-count  972963.0
(psu 'right-length      122353.945

(define psu (add-support-api psa))


dranked:

LEFT-WALL -- ... .. .... *** Two Bit - The “ And But So Perhaps Though When As Then While If Have Can Did Do Will Thank Are Where Who What Why How Or Now Here This That It There He She I You We They Some One Most Instead However Besides Well Oh Ah No Yes Yeah Good Ham 2 1 4 3 A Mai Demelza Richard John George nothing something anything everything it there who which that what where when until as because since if before while little small large good great second woman man child boy girl king house city village world town country ship sun latter land others children people men things them us me him her his my your their our the this every another leave take get find see hear speak move stop fight be make give show keep bring meet follow call ask tell help go live stay talk turn run change use read say understand remember know think suppose guess hope promise believe mean am myself fear thought knew saw felt found called happy fine certain new single word moment minute year day night evening morning way book letter party distance light fire forest room air sea earth ground floor table subject story line case question place time thing person family soul heart body own wife brother sister father mother daughter son hands face feet mouth eyes hand mind friends friend thoughts arm arms chest staff words office past water door window truth same whole best present first last least once home back down up at over on in by from upon under through into for with such having like quite only also still born gone already been seen done taken known given brought made making taking after above among between of all near against to will can cannot may must might would should could did does was is seems seemed appeared used began tried wanted needed meant came went turned continued said says spoke had has always never ever usual possible well soon far much late bad strong big young white black dark blue closed opened open hold put stand sleep answer try return come enough ready trying going supposed beginning rest sound corner direction presence name side power nature one most part kind sort number lot bit couple matter group other two three four five ten several many some out length force death life voice hair husband lips head shoulder eye bed business point state view sense feeling thinking saying now indeed therefore however sir yes God dear lady poor old dead wrong right here doing glad afraid sure sorry coming close hard long short real different clear probably certainly simply just almost not hardly easily feel have shall wish need want seem next following Queen captain wall future general London work himself herself smiled sighed nodded asked replied cried got stood sat looked look smile chance reason means longer doubt idea end edge bottom top account instead perhaps and or but though although then thus yet even really heard left lost passed met were are do love told gave took held followed behind within half an raised free better less more rather often true alone again ) too so very pretty a its these those anyone you we they he she North Jack Pitch Ross Jim Dallas Telzey Goth Sir san together along off away around round about how why – ; , : … ! . ? — All From In On By To With After For It’s It's Not Just Even At See paragraph spirit cause middle sight front spite charge form attention throat breath money law human few hundred thousand years hours minutes days times later ago ' " ” 」 ’ _ etc Mr Mrs Dr sama don ul looking especially nor either each any no finally suddenly slowly quietly Mary King Lord Lady Miss Captain I'm I’m My Her His Your ( ‘ Illustration Stats Category Rating Fandom Character Warning Is Really Please Father Mother May course being without let set sitting drawing living high heavy cold public fact particular full relief order hour individual General outside both talking able happened exactly else hell non re self S t six natural than fell deep wide deal agree don’t don't didn’t didn't received paid care drop provide York agreement ape medium author laws terms works forward forth shook enjoyed originally access permission instance chapter comment St Princess Old New Summary Notes Our THE # * Of { including Prince notes states copies copy ‐ YOU THIS OF OR Section CHAPTER Chapter + | Project eBook eBooks Gutenberg } P tax States fee electronic associated Archive Foundation United & copyright Literary donations License trademark distribution refund Van distributing Ooal Additional Posted archive Tags  

"Ham" "2" "1" "4" "3" "A" "Mai" "Demelza" "Richard" "John" "George" "nothing" "something" "anything" "everything" "it" "there" "who" "which" "that" "what" "where" "when" "until" "as" "because" "since" 

Ham .. 2  0.721
2 .. 1  0.881
1 .. 4  0.791
4 .. 3  0.835
3 .. A  0.375
A .. Mai  0.351
Mai .. Demelza  0.615
Demelza .. Richard  0.515
Richard .. John  0.602
John .. George  0.648
George .. nothing  0.342
nothing .. something  0.483
something .. anything  0.549
anything .. everything  0.369
everything .. it  0.496
it .. there  0.743
there .. who  0.416
who .. which  0.618
which .. that  0.580
that .. what  0.730
what .. where  0.722
where .. when  0.830
when .. until  0.886
until .. as  0.807
as .. because  0.728
because .. since  0.707


-------------------
overlap similarity again. This time, a newer way:

(define acc (add-pair-cosine-compute psa))
(define pso (add-similarity-api psa #f "Overlap"))
(define psob (batch-similarity psa #f "Overlap" 0.0
	(lambda (x y) (acc 'right-overlap x y))

and then do the pslon thing....
Nahh skip it.

--------------------
Redo PCA.
First, filter all words of length 128 or more.:w

(define cos-key (PredicateNode "*-Cosine Sim Key-*"))

add-similarity-api foo #f
make-cosine-matrix

-----------------
Bitseat Tadesse
/home/linas/ftp/script-to-download-books.sh

sent splitter quotation marks mishandled. 
” after a period is part of that sentence, not the next. also ’

Hmm. was working on zh_pairs_mst !!

find mst-articles |wc   12245
find gamma-pages  |wc  123000
find beta-pages   |wc  883737
ls -la headings |wc =  23
find alpha-data   |wc 1018949

mst+gamma+beta= 1018982 - 23 = 1018959 - crap = alpha-data

zh-wp-tranche-1

todo:
-- maybe save zh_pairs_mst
-- maybe copy tranche

its NOT big-5
CN-GB sort-of works...
iconv: illegal input sequence at position 7594
CN no
GB no
GB2312 no
GB13000 ---- yes
GB18030 -- yes!
GBK -- yes

use 7z -x not unzip
iconv -f  GB18030 -t UTF-8 
find *.txt | iconv -f  GB18030 -t UTF-8  | xargs 

find tmp/*.txt | while read f; do cat $f | iconv -f  GB18030 -t UTF-8  > `echo $f.utf8 | iconv -f  GB18030 -t UTF-8`; rm $f ; done

lg-get-dict-entry  WORD
lg-conn-type-match?
lg-conn-linkable?

lg_conn_linkable CON CON
lg_conn_type_match

LGDictReader
   /* Recurse, if it's a regex match */
   regex_name = match_regex(dict->regex_root, word);
   if (regex_name)
       dn_head = dictionary_lookup_wild(dict, word);

echo "始知 天理 有 循环 。" | ./submit-one.pl localhost 17008 observe-text
echo "站 在 旁边 的 一名 老者 问 ： “ 不 就是 一个 女子 么 ？" | ./submit-one.pl localhost 17008 observe-text


prior to start:
atoms: 6111927
valuations: 6938625

Suppress printing of "Warning: Combinatorial explosion!" DONE
except its still printing dict ver wtf.

remove the relex check  Punt from ss-nosplit-one.sh

  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND    
26784 ubuntu    30  10 12.463g 1.495g  34788 S 207.3  0.6  12:24.44 guile      
26784 ubuntu    30  10 13.065g 7.990g  34788 S 232.0  3.2   1483:55 guile      
foo cnt=951 rate=1.1375598073147588
vs slog of 0.43 previously, after 24 hours
foo cnt=104494 rate=2.8365047910446783

Again with minimal:
(monitor-rate "foo")                                        
foo cnt=571 rate=4.167883182665671
foo cnt=1836 rate=4.636363625198028
foo cnt=8922 rate=3.7725158547155386
foo cnt=71196 rate=4.316740435086596


  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND    
 3792 ubuntu    30  10 12.392g 1.270g  35144 S 291.3  0.5   7:37.33 guile      
 3792 ubuntu    30  10 12.886g 4.362g  35252 S 287.3  1.7 108:03.44 guile      
 3792 ubuntu    30  10 13.053g 6.788g  35252 S 222.7  2.7 694:53.99 guile      

cogserver: if it fails the first time, its says runing the second tim
and then stop crashes

  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND    
27600 ubuntu    30  10 12.905g 3.073g  34772 S 283.0  1.2  57:47.82 guile      

(monitor-rate "foo")
foo cnt=10805 rate=7.71785713759977
foo cnt=20403 rate=7.336569576772133
foo cnt=25451 rate=7.197680993533868

Still rate-limited by atomspace insert-delete.

Maybe provide a minimal parse!  Wow!   DONE
Need only: LinkGrammarRelationshipNode WordInstanceNode for pairs

update-word-counts -- just needs WordInstanceLink for parses
update-lg-link-counts -- just needs the Evals for links
; update-disjunct-counts -- word-inst-get-cset needs csets
; update-clique-pair-counts -- needs numbering. WordSequenceLink

No one needs the link instances.  DONE

remove use-relex-server DONE
-----------
Bugs: the mst parse algo is O^5 and yuret gives a nice O^3 also
False. Curtis was mistaken when he said this. DONE.

--------
/dev/md127 on /data 
/dev/md127 on /home2/linas/lxc-local-containers/learn-en/rootfs/var/lib/postgres
fstab!!!

cd /home2/linas/lxc-local-containers/learn-zh
cp -pr --parents rootfs/var/lib/postgresql /data/lxc-databases/learn-zh/

wtf:
 fatal flex scanner internal error--end of buffer missed
en_pairs_rfive_mi

Need lock. DONE.
--------------

also -- dump the all-atoms thing!!!!

line 460 of compute-mi.scm do-one-pair
(right-loop
(WordNode "fields" 

(define psf (add-pair-freq-api psa))
(define (dop lipr)
	(format #t "yo ~A" lipr )
	(format #t "has ~A\n" (psf 'pair-freq lipr))
)
(for-each dop rs)

(Section
   (WordNode "fields")
   (ConnectorSeq
      (Connector (WordNode "the" ) (ConnectorDir "-"))
      (Connector (WordNode "broad" ) (ConnectorDir "-"))
      (Connector (WordNode "rice" ) (ConnectorDir "+"))
      (Connector (WordNode "passes" ) (ConnectorDir "+"))
      (Connector (WordNode "." ) (ConnectorDir "+"))
   )
)

(psf 'set-pair-freq fa  1.285376022487705e-8)

change make-batch-mi 
store-pairs
make-store

store-atom
SQLAtomStorage::flushStoreQueue
deleteValuation(const Handle& key, const Handle& atom)
get_uuid_column_cb
get_incoming_uuid_cb
uvec

Handle getAtom(UUID);
get_atom_values

(use-modules (opencog) (opencog persist) (opencog persist-sql))
(sql-open "postgres:///opencog_test?user=opencog_tester&password=cheese")

(cog-delete  (Concept "AAA"))
(define b (Concept "BBB"))

h1 2 3 4 are nodes
hl hl2 hl3
delete hl3 then hl2 then hl

wait -- were teh uuids removed? yes they were.

cog-delete-recursive is wierd
how to find handles....  handle_to_scm won't work.

-----------------
(define subtotal-obj (add-subtotal-mi-compute psa))
(subtotal-obj 'cache-all-subtotals)

         (for-each cache-left-entropy (star-obj 'right-basis))

(define fail '())
(define (cle rig) (set! fail rig) (psf  'left-wild-freq rig))
(for-each cle (psa 'right-basis))

(define fail '())
(define (wtf rig)
	(for-each (lambda (pr) (set! fail pr) (psf 'pair-mi pr))
		(psa 'left-stars rig)))
(for-each wtf (psa 'right-basis))

(define cs 
(ConnectorSeq
   (Connector (WordNode "the") (ConnectorDir "-"))
   (Connector (WordNode "broad") (ConnectorDir "-"))
   (Connector (WordNode "rice") (ConnectorDir "+"))
   (Connector (WordNode "passes") (ConnectorDir "+"))
   (Connector (WordNode ".") (ConnectorDir "+"))))
fields, again!
(cog-set-tv!  (ListLink (AnyNode "cset-word") cs) (ctv 1 0 1))

(define lw (ListLink (AnyNode "cset-word") cs))
(define sec (Section  (WordNode "fields") cs))
(psf 'set-left-wild-freq cs (psf 'pair-freq sec))
(store-atom sec)
(store-atom cs)

(psf 'pair-mi  sec)


(define fail '())
(define (cle rig) (set! fail rig) (psf  'right-wild-freq rig))
(for-each cle (psa 'left-basis))
--------------------


(fetch-all-words)

(define aw (get-all-words))
(length aw)

(define abw '())

; Look for foo[!]
(define (is-bad? wstr)
	(define wlen (string-length wstr))
	(if (< 2 wlen)
		(let ((ope (string-ref wstr (- wlen 3)))
				(clo (string-ref wstr (- wlen 1))))
			(and (equal? #\[ ope) (equal? #\] clo)))
		#f))
	

; Look for trailing blank.
(define (is-bad? wstr)
	(define wlen (string-length wstr))
	(equal? #\space  (string-ref wstr (- wlen 1))))
	


(define (is-numeric? wstr)
	(char-set-contains? char-set:digit (string-ref wstr 0)))

(define (is-alpha? wstr)
	(and
		(char-set-contains? char-set:letter (string-ref wstr 0))
		(char-set-contains? char-set:letter 
			(string-ref wstr (- (string-length wstr) 1)))))

; Look for embedded punctuation.
; embeded OK short-dash, periiods quote. -’'.
; period colon comma if numeric.  :.,·
; dot-if-numeric is OK.
; Embedded bad: two or more dots, two or more dashes
; —
; leading or trailing _
; more than one dash.
(define (is-bad? wstr)
	(define wlen (string-length wstr))
	(define punc (string-index wstr char-set:punctuation))
	(cond
		; If no punctuation, then OK.
		((not punc) #f)
		; If unit-length then OK
		((= 1 wlen) #f)
		; If numeric, and punct is dot or comma, then its OK
		((and (is-numeric? wstr)
			(char-set-contains? (->char-set ".,:·") (string-ref wstr punc))) #f)

		; Starts with a . ends with a digit.
		((and (equal? #\. (string-ref wstr 0))
			(char-set-contains? char-set:digit (string-ref wstr (- wlen 1)))) #f)

		; If embeded dash, single-quote is OK.
		; note the second dash is actually "e2 80 90"
		((and (is-alpha? wstr)
			(char-set-contains? (->char-set "-‐’'") (string-ref wstr punc))) #f)

		; Embedded multi-periods OK, if not consecutive.
		((and (is-alpha? wstr)
			(equal? #\. (string-ref wstr punc))
			(< punc (- wlen 1))
			(not  (equal? #\. (string-ref wstr (+ punc 1))))) #f)

		; else its bad
		(else #t))
)

fly‐leaf
hair‐shirt

English: all embeded punct: 342245
Bad embeded punct: 231044
conservative bad punct: 228416
(length (get-all-words))  ; 851964
after: 623548

(define cnt 0)
(define start 0)
(define (get-bad wrdnod)
	(define wstr (cog-name wrdnod))
	; (define wlen (string-length wstr))
	(if (is-bad? wstr)
		(begin
			(set! cnt (+ cnt 1))
			; (set! abw (cons wrdnod abw))
			(cog-delete-recursive wrdnod)
			(if (equal? 0 (modulo cnt 1000))
				(let ((end (current-time)))
					(format #t "deleted ~D ~A in ~A secs\n"
		 				cnt wstr (- end start))
					(set! start end)))
		)))

(define start (current-time))
(for-each get-bad (get-all-words))

----------
en_pairs_rfive_mst
Again: en_pairs_mfive_mst:
total of 522243 words == 522K words appearing in disjuncts
total of 851964 words when all are considered Uhh oh.
After (fetch-all-words) have 
zero with []
zero trailing blanks
228416 which embeded punct.  Same as before

after deletion, have

(define (first-bad wrdnod)
	(define wstr (cog-name wrdnod))
	(if (is-bad? wstr)
		(begin
          (format #t "~A\n" wstr)  (foobar))))

_châtelaines  15:07
... delete needs what index??
CREATE INDEX incoming_idx on Atoms USING GIN(outgoing);

 report -- fetch only thte stats for reporting.
print-matrix-summary-report

fetch incoming set of (LLOBJ 'wild-wild))

(fetch-incoming-set (AnyNode "cset-word"))
75GB in size
(length (cog-incoming-set (AnyNode "cset-word"))) ; 25162435 = 25M
(cog-report-counts)
((ListLink . 25162435) (Connector . 1032779) 
(ConnectorSeq . 25162434) (WordNode . 522243) 
(fetch-incoming-set (AnyNode "cset-disjunct"))
above is before;
afterwards have
((ListLink . 24169074)  (Connector .  988068) 
(ConnectorSeq . 23670834) (WordNode . 623548) 

so ... a little shrinkage, not that much,..

Overall, we expect .... 
24M conseq + 24M any-con-list-links + 35M sections = 83M atoms
plus 2M slop = 85M!? atoms

82GB for 59M atoms = 1.4K/atom
expect about 115GB when done... actual 113GB
81350152 atoms

((ListLink . 24169074) (SchemaNode . 1) (PredicateNode . 11) (Connector .
971810) (ConnectorDir . 2) (ConnectorSeq . 23670834) (Section . 31914870)
(WordNode . 623548) (AnyNode . 2))

Elapsed time to load csets: 22555 secs -- 6+ hours! ouch
Finished loading sparse matrix pairs
Start computing the basis

(define psa (add-pair-stars pca))
(batch-all-pair-mi psa)
Support: found num left= 444903 num right= 23444293 in 1014 secs
Done with wild-card count N(x,*) and N(*,y) in 29048 secs
Done computing N(*,*) total-count= 69447009.0 in 1101 secs
Going to do individual pair frequencies
Done computing 31914870 pairs in 925 secs



----------
zh only has 5653 bad words...

with txn, running at 7 secs-ish or sometime12 12-14 ish
deleted 1000 阿紫道[!] in 111 secs
deleted 2000 一百二十斤[!] in 97 secs
deleted 3000 可呼守用[!] in 205 secs
deleted 4000 這玉才[!] in 158 secs
deleted 5000 真有假[!] in 68 secs
deleted 6000 吹号[!] in 73 secs
deleted 7000 诺扑乐[!] in 78 secs
deleted 8000 找起[!] in 75 secs
deleted 9000 碎砖[!] in 87 secs
deleted 10000 地向床[!] in 82 secs
deleted 11000 安恬[!] in 98 secs


without txn, run at ... 
deleted 1000 肢体冲突[!] in 91 secs
deleted 2000 掮客[!] in 96 secs
deleted 3000 华然[!] in 106 secs
deleted 4000 诚诚[!] in 125 secs
deleted 5000 那陷[!] in 115 secs


write queue is always a store....

(fetch-all-words)


84894 
2 .... 18 

reg: 377872  RSS  fetch in 75  total of 
max-load=3 -- 376524  piffle


zen: before
atoms  45733040 = 45M
vals:  26941144 = 27M
468821  words...
383945 bad words ... x 0.1secs/word = 10 hours. Yikes!

zen_three: 351295 words ... 266419 bad ones. Discard thios POS.

again, restart: 

zen_pairs_two
zen_pairs_three

why so slow?
---
SELECT key FROM Valuations WHERE atom = 
SELECT uuid FROM Atoms WHERE outgoing @> ARRAY[CAST(%lu AS BIGINT)]
SELECT * FROM Valuations WHERE key = %lu AND atom = %lu;
DELETE FROM Valuations WHERE key = %lu AND atom = %lu

\di+ 
!!Missing:
CREATE INDEX ON Valuations (key);  but not needed either...
queue them up...

select waiting, state, query_start, query from pg_stat_activity;
state_change

wtf: SELECT * FROM Atoms WHERE type = -- from loadType wtf??? OK, idle.

CREATE INDEX incoming_idx on Atoms USING GIN(outgoing);

EXPLAIN ANALYZE
SELECT uuid FROM Atoms WHERE outgoing @> ARRAY[CAST(39859733 AS BIGINT)];
17 seconds to run query


wtf zh gets a trailing blank!  dammit
1392 of them.

(use-modules (opencog exec))
(cog-execute! (LgParse (PhraseNode "派  解  嚎  嗒") (LgDict "any")))
(cog-get-atoms 'WordNode)

-------------
WTF Now what!????
(cog-report-counts)
95M value updates
1,5M in tlb
1.8M links
90M writes

was: 1554375
(cog-count-atoms 'NumberNode)
(delete-sentence SENT)

1608119
1607958
(cog-count-atoms 'SentenceNode) ;4779

(define cnt 0)
(for-each (lambda (sent)
		(set! cnt (+ cnt 1))
		(format #t "delete ~D\n" cnt)
		(if (cog-atom? sent) (delete-sentence sent)))
	(cog-get-atoms 'SentenceNode))

61377

2471125 atoms 209 sentences = approx 547844 atoms = 2621 atoms/sent
134574

359 now in zen
sentence too long, contains more than 254 words

456 now with 2
477 with 0
489
no leak with update-counts
998 with 0
no leak with delete-sentence either. WTF

1028 with 0
Bingo! 
Now  1345 with 0

-------------------------------------------
Bugs fixed

Bugs: get rid of [!] in words DONE

Bugs: cleanup zen due to above DONE
      what about zen_pairs_three? Ans: its junk!  Delete! DONE

Bugs: clean up zh due to above    DONE

Bugs: get rid of all-atoms in matrix  DONE

Bugs: split sent: quote after period DONE

------------------------------------------
OK, so ... where was I?
-- computed similarity for huge number of English pairs.
I think this is in en_pairs_rfive_mtwo on fanny.
 86498236 |     1 |   89 |      0 | *-SimKey cset cut-50-50-10 |
 86355966 |     1 |   89 |      0 | *-Cosine Sim Key-*         |

select count(*) from valuations where key=86498236; --  142270 = 
select count(*) from valuations where key=86355966; -- 1457522 = 1.4M

-- Need to re-graph cos sim for this much larger set.
   (define psm (add-similarity-api psa #f)
   (psm 'fetch-pairs)  -- size = 1.4GB i.e. 1KB/atom fetched at
       rate of 1K atoms/sec
   there are 1058120  sims of length > 0.1

	(define n 0)
   (cog-map-type (lambda (ato) (set! n (+ n 1)) #f) 'WordNode) 
   have 5843 words that are in similarity-pairs.
   By contrast, there are  .... fuuu what is in this dataset????


-- cleaned up dashes .. did I save this DB? Yes, done - en_pairs_cfive.
   kind-of should redo MI calcs, and MST parsing. See below,
   not done yet.
   * This dataset is too big to fit in RAM...
   * clean up infix punct in rfive_mfive call it rfive_mfx

-- Need to redo the PCA.... DONE
   
-- If two words are similar, then ... 
   * issue a uniq group ID
   * sum the counts
   


lxc-ls --active
lxc-stop -n xxx

pg_dump zen_pairs

$(id -nu)
write portno to file?

1) root to kill all lxc
2) each lxc to shutdown cleanly
   send (sql-cose) to portno .. which portno?

ERROR:  could not create unique index "valuations_key_atom_idx"
DETAIL:  Key (key, atom)=(1, 3853322) is duplicated.
CREATE INDEX ON Valuations (key, atom); 

/etc/init.d/rc.local

rc-local.service
/lib/systemd/system/rc-local.service.d
rc-local-shutdown.service
/etc/rc.local.shutdown

except /etc/rc.local.shutdown did not actually run. Crap.
Why?

=======
mhatta:
Request dtor calls
   ConsoleSocket::OnRequestComplete which does nothing but print...
   ConsoleSocket::put() decrements use count.

handle_connection on socket remote close does 
SetCloseAndDelete
fractional line is dispatched in the thread of handle_connection
 ... using OnLine which just calls shell...
  but befoer the fractional line is done, the socket is closed.
  because ServerSocket::SetCloseAndDelete runs

fuck.
OK, remote end closes, 
ServerSocket::handle_connection prints that its leaving...
calls dtor on ConsoleSocket
Generic shell is finishing up....

First one:
ServerSocket::handle_connection()   yes    too
[ConsoleSocket] OnConnection        yes    too
[ConsoleSocket] OnLine [scm hush]   yes    too
...
[ConsoleSocket] OnRequestComplete   yes    too
[GenericShell] enter eval loop      yes    too
[GenericShell] line disc: expr      yes    tooo
[GenericShell] start eval of       ............?   also missgin 2x
ServerSocket::exiting handle_connection()   yes   too
[ConsoleSocket] destructor          yes    too
                        .................... start eval of for third
ServerSocket::Send(                 .... miss   ... miss
[GenericShell] dtor, wait for eval thread  yes    too
                         .....................  Send( the second delayed!!
                         ...................... Send third

Below only happens if self-destruct runs
[GenericShell] finishing; eval of  ..... not in orig  ... miss in third
[GenericShell] exit eval loop       yes   too
[GenericShell] dtor, joined eval thread  yes too

------------------------
wait ... 
concurrent_set uses std:less... Handle

a->operator<
... use atoms_less

------------------------
zen = 101M before  (+ 55m val)
en = 56M  + 28M

how?
1) fetch words

2) fetch incoming for one word
3) do left+right MI for that word
4) do marginals for taht word
5) delete the pair.

------------------------
linear
tuple math
fold 
----------------------
(define pca (make-pseudo-cset-api))
(define psa (add-dynamic-stars pca))
(define pcos (add-pair-cosine-compute psa))
(define psup (add-support-compute psa))

(define ptu (

right-cosine compute-right-cosine
/ get-right-length "short"

(length (psa 'right-stars  (Word "short")))  ; 1840
(length (psa 'right-stars  (Word "tall")))   ; 971
(psup 'right-length (Word "short"))  ;   208.86119792819346
(psup 'right-length (Word "tall"))  ; 64.00781202322104
(pcos 'right-product (Word "tall") (Word "short")) ; 800.0

(length (psa 'right-stars  (Word "the"))) ; 215324
(define nou (get-dj-words (Word "the")))  ; length = 37718
(define nou (get-dj-words (Word "tall"))) ; length = 685
(length nou)
(make-gram-class psa nou 0)

(define nou (rank-by-observations nou))
(define nou (drop nou 20))
(assign-to-classes psa 0.3 nou '())

(load-atoms-of-type 'WordClassNode)
(define cls (cog-get-atoms 'WordClassNode))

(loop-over-words psa 0.3 nou cls)

---------------------

(define gra (merge-ortho psa (Word "building") (Word "jungle") 0.0))

"island" -- "hill"

(orthogonalize (WordClassNode "island hill") (WordNode "island"))
windows tree trees shadows

(Section (ctv 1 0 15)
   (WordClassNode "island hill")
   (ConnectorSeq (Connector (WordNode "this") (ConnectorDir "-")))
)
(define this (ConnectorSeq (Connector (WordNode "this") (ConnectorDir "-"))))
(cog-link 'Section (Word "island") this)
island - 0.42243511
hill - 0
windows - 0 
tree - 1.8939653
path - 0
group - 15 before ortho  9.1974925 after
affair - 5.3677896 affter

(cog-get-atoms 'WordClassNode)
(drop nou 39) - restart at 646
(drop nou 12) - restart at 634
(drop nou 34) - restart at 600
by support ot by length....

(assign-to-classes psa 0.3 nou '())
(for-each (lambda (cls)
	(if (eq? 1 (length (cog-incoming-set cls)))
		(cog-delete-recursive cls)))
	(cog-get-atoms 'WordClassNode))
--------------
953620 atoms
total loads = 924632
total stores = 29350
valuation updates = 70232
write items=42976
_num_atom_removes
_num_atom_recursive_removes
_num_valuation_removes
76 flushes in 2000 secs ouch
SELECT key FROM Valuations WHERE atom = 
CREATE INDEX incoming_idx on Atoms USING GIN(outgoing);

SELECT uuid FROM Atoms WHERE outgoing @> ARRAY[CAST(%lu AS BIGINT)]
DELETE FROM Atoms WHERE uuid =  uuid is primary

664 total initially and 658 finally .. meh

is it idempotent?
664 again ... 
(assign-to-classes psa 0.3 nou '())

(define (copy-sect TO FRM)
	(for-each (lambda (sect)
		(store-atom (Section TO (cog-outgoing-atom sect 1)))
		(cog-delete sect))
	(cog-incoming-by-type FRM 'Section)))

(for-each (lambda (cls)
	(define mem (cog-incoming-by-type cls 'MemberLink))
	(if (eq? 1 (length mem)) (begin
		(format #t "hey ~A\n" mem)
		(copy-sect (Word (cog-name cls)) cls)
		(cog-delete-recursive cls)
	)))
	(cog-get-atoms 'WordClassNode))


 (define iset (cog-incoming-by-type (Word "run") 'Section))
(define seq (cog-outgoing-atom (car iset) 1))

(define psup (add-support-compute psa))
(define pss (add-support-api psa))
(fetch-incoming-set seq)
(pss 'left-count seq)

delete-dup-atoms

Oof -- need to fetch secions, need to fetch Connector too
done.


=========================================================================
out-of-control GC

try:  (gc-disable) 

Tomas writes:
> To just add one more: total memory usage (gc and non-gc) seems to enter
> the gc triggering heuristics [1] (I couldn't follow in detail how, and
> I don't know whether this is still valid in the 2.2 branch).
> 
> It just might be that Guile is seeing the outrageous process's memory
> footprint and tries desperately to free some memory (which of course
> can't suceed in your case because most memory usage isn't "guile's").
> 
> [1] http://git.savannah.gnu.org/cgit/guile.git/tree/libguile/gc.c?h=v2.0.13#n770

Hans writes:

> Does it have to do with this issue [1], that the Boehm GC initially
> uses a small amount of heap. One can use say
>   export GC_INITIAL_HEAP_SIZE=50G
> on the shell command line before running the program.
> 
> 1. https://github.com/Macaulay2/M2/issues/500

Mark Weaver writes:
> http://www.hboehm.info/gc/gcdescr.html

and see eail about this.

=========================================================================
OK-ish misses the mark:
arxiv 1703.08314v1 coecke Interacting conceptual spaces


crappier:
Symbolic, Distributed and Distributional Representations for Natural
Language Processing in the Era of Deep Learning: a Survey
arxiv  1702.00764v1

=========================================================================


Crazy idea: iterate; the places we end up at should be the dependents
since everything points at them, and they never point away.

Bugs: relex is returning incorrect disjuncts because LG is reporting the 
multi-connectors only ... with the incorrect mutiplicities.
??? Is this still an issue? 

Bugs: using ListLink for the partial sums on csets... why???
      (ListLink (AnyNode "cset-word") (ConnectorSeq...))
      instead of (Section ...)

Bugs: graphing takes too long.

Bugs: follow up on the guile hang bug - its a string parsing thing.

Bugs: while mst parsing, guile goes GC-crazy after a while, and
      never recovers. (doesn't happen with shorter dist links.)

Items: create LG feederbacker

Bugs: cleanup embedded dashes in en  DONE
     -- save en_pairs_r again DONE
     -- should pboably recompute pair-MI after above,
     -- maybe recompute mst?? (since it was so quick!?)

Bugs: sentences with more than 254 words....

Bugs: make postgres run nice. half-done, w/ renice.

Bugs: lxc containers not shutting down correctly during power loss

Bugs/feat:  no way to compute marginals incrementally, if the DB does
      not fit in RAM.
